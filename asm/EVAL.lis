asm/EVAL.asm:
     1                          	; TITLE BBC BASIC (C) R.T.RUSSELL 1981-2025
     2                          	INCLUDE "constants.inc"
asm/constants.inc:
     1                          ; BBC BASIC Z80 - Shared Constants
     2                          ; Extracted from source modules to avoid duplicate definitions
     3                          
     4                          ; ASCII control characters
     5                          LF      EQU     0AH
     6                          CR      EQU     0DH
     7                          ; Note: ESC conflicts with label in AMOS.Z80, not included
     8                          BEL     EQU     7
     9                          BS      EQU     8
    10                          HT      EQU     9
    11                          VT      EQU     0BH
    12                          ; Note: DEL conflicts with label in MAIN.Z80, not included
    13                          
    14                          ; CP/M system addresses
    15                          ; Note: BDOS conflicts with label in DIST.Z80, not included
    16                          FCB     EQU     5CH
    17                          DSKBUF  EQU     80H
    18                          FCBSIZ  EQU     128+36+2
    19                          
    20                          ; Token values
    21                          TAND    EQU     80H
    22                          TOR     EQU     84H
    23                          TBY     EQU     0FH
    24                          TERROR  EQU     85H
    25                          TLINE   EQU     86H
    26                          TOFF    EQU     87H
    27                          TSTEP   EQU     88H
    28                          TSPC    EQU     89H
    29                          TTAB    EQU     8AH
    30                          TELSE   EQU     8BH
    31                          TTHEN   EQU     8CH
    32                          TLINO   EQU     8DH
    33                          TTO     EQU     0B8H
    34                          TCASE   EQU     0C8H
    35                          TWHILE  EQU     0C7H
    36                          TWHEN   EQU     0C9H
    37                          TOF     EQU     0CAH
    38                          TENDCASE EQU    0CBH
    39                          TOTHERWISE EQU  0CCH
    40                          TENDIF  EQU     0CDH
    41                          TENDWHILE EQU   0CEH
    42                          TCALL   EQU     0D6H
    43                          TDATA   EQU     0DCH
    44                          TDEF    EQU     0DDH
    45                          TDIM    EQU     0DEH
    46                          TEND    EQU     0E0H
    47                          TFOR    EQU     0E3H
    48                          TGOSUB  EQU     0E4H
    49                          TGOTO   EQU     0E5H
    50                          TIF     EQU     0E7H
    51                          TLOCAL  EQU     0EAH
    52                          TMODE   EQU     0EBH
    53                          TNEXT   EQU     0EDH
    54                          TON     EQU     0EEH
    55                          TPROC   EQU     0F2H
    56                          TREM    EQU     0F4H
    57                          TREPEAT EQU     0F5H
    58                          TREPORT EQU     0F6H
    59                          TRESTORE EQU    0F7H
    60                          TRETURN EQU     0F8H
    61                          TSTOP   EQU     0FAH
    62                          TTRACE  EQU     0FCH
    63                          TUNTIL  EQU     0FDH
    64                          TWIDTH  EQU     0FEH
    65                          TEXIT   EQU     10H
    66                          
    67                          ; Error codes
    68                          BADOP   EQU     1
    69                          DIVBY0  EQU     18
    70                          ; Note: TOOBIG conflicts with label in MAIN.Z80, not included
    71                          NGROOT  EQU     21
    72                          LOGRNG  EQU     22
    73                          ACLOST  EQU     23
    74                          EXPRNG  EQU     24
    75                          
asm/EVAL.asm:
     3                          ;
     4                          ;BBC BASIC INTERPRETER - Z80 VERSION
     5                          ;EVALUATE EXPRESSION MODULE - "EVAL"
     6                          ;(C) COPYRIGHT R.T.RUSSELL 1981-2025
     7                          ;
     8                          ;THE NAME BBC BASIC IS USED WITH THE PERMISSION
     9                          ;OF THE BRITISH BROADCASTING CORPORATION AND IS
    10                          ;NOT TRANSFERRABLE TO A FORKED OR DERIVED WORK.
    11                          ;
    12                          ;VERSION 2.3, 07-05-1984
    13                          ;VERSION 3.0, 08-03-1987
    14                          ;VERSION 5.0, 31-05-2024
    15                          ;VERSION 5.1, 28-12-2024
    16                          ;VERSION 5.2, 11-01-2025
    17                          ;VERSION 5.3, 16-03-2025 (Shifts moved to new codes)
    18                          ;
    19                          ;BINARY FLOATING POINT REPRESENTATION:
    20                          ; 32 BIT SIGN-MAGNITUDE NORMALIZED MANTISSA
    21                          ; 8 BIT EXCESS-128 SIGNED EXPONENT
    22                          ; SIGN BIT REPLACES MANTISSA MSB (IMPLIED "1")
    23                          ; MANTISSA=0 & EXPONENT=0 IMPLIES VALUE IS ZERO.
    24                          ;
    25                          ;BINARY INTEGER REPRESENTATION:
    26                          ; 32 BIT 2'S-COMPLEMENT SIGNED INTEGER
    27                          ; "EXPONENT" BYTE = 0 (WHEN PRESENT)
    28                          ;
    29                          ;NORMAL REGISTER ALLOCATION: MANTISSA - HLH'L'
    30                          ;                            EXPONENT - C
    31                          ;
    32                          	PUBLIC EXPR
    33                          	PUBLIC EXPRN
    34                          	PUBLIC EXPRI
    35                          	PUBLIC EXPRS
    36                          	PUBLIC ITEMI
    37                          	PUBLIC CONS
    38                          	PUBLIC LOADS
    39                          	PUBLIC VAL0
    40                          	PUBLIC SFIX
    41                          	PUBLIC STR
    42                          	PUBLIC HEXSTR
    43                          	PUBLIC LOAD4
    44                          	PUBLIC LOADN
    45                          	PUBLIC DLOAD5
    46                          	PUBLIC TEST
    47                          	PUBLIC ZERO
    48                          	PUBLIC COMMA
    49                          	PUBLIC BRAKET
    50                          	PUBLIC DECODE
    51                          	PUBLIC PUSHS
    52                          	PUBLIC POPS
    53                          	PUBLIC SEARCH
    54                          	PUBLIC SCP
    55                          	PUBLIC LETARR
    56                          ;
    57                          	EXTERN MUL16
    58                          	EXTERN ERROR
    59                          	EXTERN SYNTAX
    60                          	EXTERN CHANEL
    61                          	EXTERN CHNL
    62                          	EXTERN STOREN
    63                          	EXTERN STORE4
    64                          	EXTERN STORE5
    65                          	EXTERN STACCS
    66                          	EXTERN CHECK
    67                          	EXTERN USR
    68                          	EXTERN VAR
    69                          	EXTERN FN
    70                          	EXTERN XEQ
    71                          	EXTERN NXT
    72                          	EXTERN X14OR5
    73                          	EXTERN MODIFY
    74                          	EXTERN MODIFS
    75                          	EXTERN TERMQ
    76                          ;
    77                          	EXTERN GETVAR
    78                          	EXTERN LEXAN2
    79                          	EXTERN RANGE
    80                          	EXTERN GETTOP
    81                          ;
    82                          	EXTERN STAVAR
    83                          	EXTERN PAGE
    84                          	EXTERN LOMEM
    85                          	EXTERN HIMEM
    86                          	EXTERN RANDOM
    87                          	EXTERN COUNT
    88                          	EXTERN LISTON
    89                          	EXTERN PC
    90                          	EXTERN ERL
    91                          	EXTERN ERR
    92                          	EXTERN ACCS
    93                          	EXTERN ERRTXT
    94                          	EXTERN KEYWDS
    95                          	EXTERN KEYWDL
    96                          	EXTERN FREE
    97                          	EXTERN BUFFER
    98                          ;
    99                          	EXTERN OSRDCH
   100                          	EXTERN OSOPEN
   101                          	EXTERN OSBGET
   102                          	EXTERN OSSTAT
   103                          	EXTERN GETCSR
   104                          	EXTERN GETIME
   105                          	EXTERN GETIMS
   106                          	EXTERN GETEXT
   107                          	EXTERN GETPTR
   108                          	EXTERN OSKEY
   109                          ;
   110                          	EXTERN POINT
   111                          	EXTERN ADVAL
   112                          	EXTERN TINTFN
   113                          	EXTERN MODEFN
   114                          	EXTERN WIDFN
   115                          ;
   116                          	EXTERN FPP
   117                          ;
   118                          FUNTOK	EQU	8DH		;1st FUNCTION TOKEN
   119                          TMOD	EQU	83H
   120                          TLEN	EQU	0A9H
   121                          ; TTO EQU	0B8H
   122                          ; TDIM EQU	0DEH
   123                          ; TEND EQU	0E0H
   124                          ; TMODE EQU	0EBH
   125                          ; TREPORT EQU	0F6H
   126                          ; TWIDTH EQU	0FEH
   127                          TTINT	EQU	0AH
   128                          ; TBY EQU	0FH
   129                          ;
   130                          ;TABLE OF ADDRESSES FOR FUNCTIONS:
   131                          ;
   132  0000  e008              FUNTBL:	DEFW	DECODE		;Line number
   133  0002  da04              	DEFW	OPENIN		;OPENIN
   134  0004  f704              	DEFW	PTR		;PTR
   135  0006  ac04              	DEFW	PAGEV		;PAGE
   136  0008  ff04              	DEFW	TIMEV		;TIME
   137  000a  a204              	DEFW	LOMEMV		;LOMEM
   138  000c  a704              	DEFW	HIMEMV		;HIMEM
   139  000e  4b05              	DEFW	ABS		;ABS
   140  0010  8705              	DEFW	ACS		;ACS
   141  0012  0000              	DEFW	ADVAL		;ADVAL
   142  0014  8f04              	DEFW	ASC		;ASC
   143  0016  7f05              	DEFW	ASN		;ASN
   144  0018  8305              	DEFW	ATN		;ATN
   145  001a  6b04              	DEFW	BGET		;BGET
   146  001c  6b05              	DEFW	COS		;COS
   147  001e  ca04              	DEFW	COUNTV		;COUNT
   148  0020  5305              	DEFW	DEG		;DEG
   149  0022  c004              	DEFW	ERLV		;ERL
   150  0024  c504              	DEFW	ERRV		;ERR
   151  0026  ab05              	DEFW	EVAL		;EVAL
   152  0028  7305              	DEFW	EXP		;EXP
   153  002a  ef04              	DEFW	EXT		;EXT
   154  002c  7809              	DEFW	ZERO		;FALSE
   155  002e  0000              	DEFW	FN		;FN
   156  0030  7904              	DEFW	GET		;GET
   157  0032  7404              	DEFW	INKEY		;INKEY
   158  0034  2407              	DEFW	INSTR		;INSTR(
   159  0036  5f05              	DEFW	INT		;INT
   160  0038  9c04              	DEFW	LEN		;LEN
   161  003a  7705              	DEFW	LN		;LN
   162  003c  7b05              	DEFW	LOG		;LOG
   163  003e  4f05              	DEFW	CPL		;NOT
   164  0040  d704              	DEFW	OPENUP		;OPENUP
   165  0042  d504              	DEFW	OPENOT		;OPENOUT
   166  0044  4705              	DEFW	PI		;PI
   167  0046  0000              	DEFW	POINT		;POINT(
   168  0048  5404              	DEFW	POS		;POS
   169  004a  5705              	DEFW	RAD		;RAD
   170  004c  d805              	DEFW	RND		;RND
   171  004e  5b05              	DEFW	SGN		;SGN
   172  0050  6f05              	DEFW	SIN		;SIN
   173  0052  6305              	DEFW	SQR		;SQR
   174  0054  6705              	DEFW	TAN		;TAN
   175  0056  b104              	DEFW	TOPV		;TO(P)
   176  0058  3c05              	DEFW	TRUE		;TRUE
   177  005a  0000              	DEFW	USR		;USR
   178  005c  9e05              	DEFW	VAL		;VAL
   179  005e  5a04              	DEFW	VPOS		;VPOS
   180  0060  a507              	DEFW	CHRS		;CHR$
   181  0062  ac07              	DEFW	GETS		;GET$
   182  0064  0e08              	DEFW	INKEYS		;INKEY$
   183  0066  4e08              	DEFW	LEFTS		;LEFT$(
   184  0068  1e08              	DEFW	MIDS		;MID$(
   185  006a  7c08              	DEFW	RIGHTS		;RIGHT$(
   186  006c  3809              	DEFW	STRS		;STR$
   187  006e  a608              	DEFW	STRING		;STRING$(
   188  0070  5f04              	DEFW	EOF		;EOF
   189  0072  6806              	DEFW	SUM		;SUM
   190                          ;
   191                          TCMD	EQU	FUNTOK+($-FUNTBL)/2
   192                          ;
   193                          ; CR EQU	0DH
   194                          ; LF EQU	0AH
   195                          AND	EQU	80H
   196                          DIV	EQU	81H
   197                          EOR	EQU	82H
   198                          MOD	EQU	83H
   199                          OR	EQU	84H
   200                          ;
   201  0074  2a05              SOPTBL:	DEFW	SLE		;<= (STRING)
   202  0076  3205              	DEFW	SNE		;<>
   203  0078  2405              	DEFW	SGE		;>=
   204  007a  1705              	DEFW	SLT		;<
   205  007c  3805              	DEFW	SEQ		;=
   206  007e  1d05              	DEFW	SGT		;>
   207                          ;
   208                          ;EXPR - VARIABLE-TYPE EXPRESSION EVALUATION
   209                          ; Expression type is returned in A'F':
   210                          ; Numeric - A' bit 7=0, F' sign bit cleared.
   211                          ; String - A' bit 7=1, F' sign bit set.
   212                          ;Floating-point or integer result returned in HLH'L'C
   213                          ; Integer result denoted by C=0 and HLH'L' non-zero.
   214                          ;String result returned in string accumulator, DE set.
   215                          ;
   216                          ;Hierarchy is: (1) Variables, functions,
   217                          ; constants, bracketed expressions.
   218                          ; (2) ^
   219                          ; (3) * / MOD DIV
   220                          ; (4) + -
   221                          ; (5) = <> <= >= > <
   222                          ; (6) AND
   223                          ; (7) EOR OR
   224                          ;
   225  0080  cd9500            EXPR:	CALL	EXPR1		;GET FIRST OPERAND
   226  0083  fe82              EXPR0A:	CP	EOR		;CHECK OPERATOR
   227  0085  2803              	JR	Z,EXPR0B
   228  0087  fe84              	CP	OR
   229  0089  c0                	RET	NZ
   230  008a  cdf309            EXPR0B:	CALL	SAVE		;SAVE FIRST OPERAND
   231  008d  cd9500            	CALL	EXPR1		;GET SECOND OPERAND
   232  0090  cd030a            	CALL	DOIT		;DO OPERATION
   233  0093  18ee              	JR	EXPR0A		;CONTINUE
   234                          ;
   235  0095  cda600            EXPR1:	CALL	EXPR2
   236  0098  fe80              EXPR1A:	CP	AND
   237  009a  c0                	RET	NZ
   238  009b  cdf309            	CALL	SAVE
   239  009e  cda600            	CALL	EXPR2
   240  00a1  cd030a            	CALL	DOIT
   241  00a4  18f2              	JR	EXPR1A
   242                          ;
   243  00a6  cd1e01            EXPR2:	CALL	EXPR3
   244  00a9  cdea09            	CALL	RELOPQ
   245  00ac  c0                	RET	NZ
   246  00ad  47                	LD	B,A
   247  00ae  fd23              	INC	IY		;BUMP OVER OPERATOR
   248  00b0  cd0000            	CALL	NXT
   249  00b3  cdea09            	CALL	RELOPQ		;COMPOUND OPERATOR?
   250  00b6  2007              	JR	NZ,EXPR2B
   251  00b8  fd23              	INC	IY
   252  00ba  b8                	CP	B
   253  00bb  281c              	JR	Z,SHIFT		;SHIFT OR ==
   254  00bd  80                	ADD	A,B
   255  00be  47                	LD	B,A
   256  00bf  78                EXPR2B:	LD	A,B
   257  00c0  08                	EX	AF,AF'
   258  00c1  faf100            	JP	M,EXPR2S
   259  00c4  08                	EX	AF,AF'
   260  00c5  d604              	SUB	4
   261  00c7  fe3a              	CP	'>'-4
   262  00c9  2002              	JR	NZ,EXPR2C
   263  00cb  c602              	ADD	A,2
   264  00cd  e60f              EXPR2C:	AND	0FH
   265  00cf  cdf709            EXPR2D:	CALL	SAVE1
   266  00d2  cd1e01            	CALL	EXPR3
   267  00d5  cd030a            	CALL	DOIT		;Must NOT be "JP DOIT"
   268  00d8  c9                	RET
   269                          ;
   270  00d9  fe3d              SHIFT:	CP	'='
   271  00db  28e2              	JR	Z,EXPR2B	;==
   272  00dd  cd0000            	CALL	NXT
   273  00e0  cdea09            	CALL	RELOPQ
   274  00e3  2007              	JR	NZ,SHIFT1
   275  00e5  b8                	CP	B
   276  00e6  c20000            	JP	NZ,SYNTAX
   277  00e9  fd23              	INC	IY
   278  00eb  04                	INC	B
   279  00ec  78                SHIFT1:	LD	A,B
   280  00ed  d610              	SUB	16
   281  00ef  18de              	JR	EXPR2D
   282                          ;
   283  00f1  08                EXPR2S:	EX	AF,AF'
   284  00f2  3d                	DEC	A
   285  00f3  e607              	AND	7
   286  00f5  cd9909            	CALL	PUSHS		;SAVE STRING ON STACK
   287  00f8  f5                	PUSH	AF		;SAVE OPERATOR
   288  00f9  cd1e01            	CALL	EXPR3		;SECOND STRING
   289  00fc  08                	EX	AF,AF'
   290  00fd  f2ec01            	JP	P,MISMAT
   291  0100  f1                	POP	AF
   292  0101  4b                	LD	C,E		;LENGTH OF STRING #2
   293  0102  d1                	POP	DE
   294  0103  210000            	LD	HL,0
   295  0106  39                	ADD	HL,SP
   296  0107  43                	LD	B,E		;LENGTH OF STRING #1
   297  0108  d5                	PUSH	DE
   298  0109  110000            	LD	DE,ACCS
   299  010c  eb                	EX	DE,HL
   300  010d  cd3b0a            	CALL	DISPT2
   301  0110  d1                	POP	DE
   302  0111  eb                	EX	DE,HL
   303  0112  2600              	LD	H,0
   304  0114  39                	ADD	HL,SP
   305  0115  f9                	LD	SP,HL
   306  0116  eb                	EX	DE,HL
   307  0117  af                	XOR	A		;NUMERIC MARKER
   308  0118  4f                	LD	C,A		;INTEGER MARKER
   309  0119  08                	EX	AF,AF'
   310  011a  fd7e00            	LD	A,(IY)
   311  011d  c9                	RET
   312                          ;
   313  011e  cd6c01            EXPR3:	CALL	EXPR4
   314  0121  fe2d              EXPR3A:	CP	'-'
   315  0123  2808              	JR	Z,EXPR3B
   316  0125  fe2b              	CP	'+'
   317  0127  c0                	RET	NZ
   318  0128  08                	EX	AF,AF'
   319  0129  fa3801            	JP	M,EXPR3S
   320  012c  08                	EX	AF,AF'
   321  012d  cdf309            EXPR3B:	CALL	SAVE
   322  0130  cd6c01            	CALL	EXPR4
   323  0133  cd030a            	CALL	DOIT
   324  0136  18e9              	JR	EXPR3A
   325                          ;
   326  0138  08                EXPR3S:	EX	AF,AF'
   327  0139  fd23              	INC	IY		;BUMP PAST '+'
   328  013b  cd9909            	CALL	PUSHS		;SAVE STRING ON STACK
   329  013e  cd6c01            	CALL	EXPR4		;SECOND STRING
   330  0141  08                	EX	AF,AF'
   331  0142  f2ec01            	JP	P,MISMAT
   332  0145  4b                	LD	C,E		;C=LENGTH
   333  0146  d1                	POP	DE
   334  0147  d5                	PUSH	DE
   335  0148  210000            	LD	HL,ACCS
   336  014b  54                	LD	D,H
   337  014c  79                	LD	A,C
   338  014d  b7                	OR	A
   339  014e  280e              	JR	Z,EXP3S3
   340  0150  45                	LD	B,L
   341  0151  6f                	LD	L,A		;SOURCE
   342  0152  83                	ADD	A,E
   343  0153  5f                	LD	E,A		;DESTINATION
   344  0154  3e13              	LD	A,19
   345  0156  386b              	JR	C,ERROR2	;"String too long"
   346  0158  d5                	PUSH	DE
   347  0159  1d                	DEC	E
   348  015a  2d                	DEC	L
   349  015b  edb8              	LDDR			;COPY
   350  015d  d1                	POP	DE
   351  015e  d9                EXP3S3:	EXX
   352  015f  c1                	POP	BC
   353  0160  cdb709            	CALL	POPS		;RESTORE FROM STACK
   354  0163  d9                	EXX
   355  0164  f680              	OR	80H		;FLAG STRING
   356  0166  08                	EX	AF,AF'
   357  0167  fd7e00            	LD	A,(IY)
   358  016a  18b5              	JR	EXPR3A
   359                          ;
   360  016c  cd9201            EXPR4:	CALL	EXPR5
   361  016f  fe2a              EXPR4A:	CP	'*'
   362  0171  280b              	JR	Z,EXPR4B
   363  0173  fe2f              	CP	'/'
   364  0175  2807              	JR	Z,EXPR4B
   365  0177  fe83              	CP	MOD
   366  0179  2803              	JR	Z,EXPR4B
   367  017b  fe81              	CP	DIV
   368  017d  c0                	RET	NZ
   369  017e  cdf309            EXPR4B:	CALL	SAVE
   370  0181  cd9201            	CALL	EXPR5
   371  0184  cd030a            	CALL	DOIT
   372  0187  18e6              	JR	EXPR4A
   373                          ;
   374  0189  7b                EXPR45:	LD	A,E
   375  018a  fe2b              	CP	'+'
   376  018c  28de              	JR	Z,EXPR4
   377  018e  fe2d              	CP	'-'
   378  0190  28da              	JR	Z,EXPR4
   379  0192  cd4e02            EXPR5:	CALL	ITEM
   380  0195  b7                	OR	A		;TEST TYPE
   381  0196  08                	EX	AF,AF'		;SAVE TYPE
   382  0197  cd0000            EXPR5A:	CALL	NXT
   383  019a  fe5e              	CP	'^'
   384  019c  c0                	RET	NZ
   385  019d  cdf309            	CALL	SAVE
   386  01a0  cd4e02            	CALL	ITEM
   387  01a3  b7                	OR	A
   388  01a4  08                	EX	AF,AF'
   389  01a5  cd030a            	CALL	DOIT
   390  01a8  18ed              	JR	EXPR5A
   391                          ;
   392  01aa  cd8000            EXPRN:	CALL	EXPR
   393  01ad  08                	EX	AF,AF'
   394  01ae  f0                	RET	P
   395  01af  183b              	JR	MISMAT
   396                          ;
   397  01b1  cd8000            EXPRI:	CALL	EXPR
   398  01b4  08                	EX	AF,AF'
   399  01b5  f29605            	JP	P,SFIX
   400  01b8  1832              	JR	MISMAT
   401                          ;
   402  01ba  cd8000            EXPRS:	CALL	EXPR
   403  01bd  08                	EX	AF,AF'
   404  01be  f8                	RET	M
   405  01bf  182b              	JR	MISMAT
   406                          ;
   407  01c1  3e1c              BADHEX:	LD	A,28
   408  01c3  c30000            ERROR2:	JP	ERROR		;"Bad HEX or binary"
   409                          ;
   410  01c6  d9                NEGATE:	EXX
   411  01c7  7c                	LD	A,H
   412  01c8  2f                	CPL
   413  01c9  67                	LD	H,A
   414  01ca  7d                	LD	A,L
   415  01cb  2f                	CPL
   416  01cc  6f                	LD	L,A
   417  01cd  d9                	EXX
   418  01ce  7c                	LD	A,H
   419  01cf  2f                	CPL
   420  01d0  67                	LD	H,A
   421  01d1  7d                	LD	A,L
   422  01d2  2f                	CPL
   423  01d3  6f                	LD	L,A
   424  01d4  d9                ADD1:	EXX
   425  01d5  23                	INC	HL
   426  01d6  7c                	LD	A,H
   427  01d7  b5                	OR	L
   428  01d8  d9                	EXX
   429  01d9  3e00              	LD	A,0		;NUMERIC MARKER
   430  01db  c0                	RET	NZ
   431  01dc  23                	INC	HL
   432  01dd  c9                	RET
   433                          ;
   434  01de  cd4e02            ITEMI:	CALL	ITEM
   435  01e1  b7                	OR	A
   436  01e2  f29605            	JP	P,SFIX
   437  01e5  1805              	JR	MISMAT
   438                          ;
   439  01e7  cd4e02            ITEMS:	CALL	ITEM
   440  01ea  b7                	OR	A
   441  01eb  f8                	RET	M
   442  01ec  3e06              MISMAT:	LD	A,6
   443  01ee  18d3              	JR	ERROR2		;"Type mismatch"
   444                          ;
   445  01f0  cd8000            ITEM1:	CALL	EXPR		;BRACKETED EXPR
   446  01f3  cd2e0a            	CALL	BRAKET
   447  01f6  08                	EX	AF,AF'
   448  01f7  c9                	RET
   449                          ;
   450  01f8  cd4e02            ITEMN:	CALL	ITEM
   451  01fb  b7                	OR	A
   452  01fc  f0                	RET	P
   453  01fd  18ed              	JR	MISMAT
   454                          ;
   455                          ;HEX - Get hexadecimal constant.
   456                          ;   Inputs: ASCII string at (IY)
   457                          ;  Outputs: Integer result in H'L'HL, C=0, A7=0.
   458                          ;           IY updated (points to delimiter)
   459                          ;
   460  01ff  cd7809            HEX:	CALL	ZERO
   461  0202  cdd709            	CALL	HEXDIG
   462  0205  38ba              	JR	C,BADHEX
   463  0207  fd23              HEX1:	INC	IY
   464  0209  e60f              	AND	0FH
   465  020b  0604              	LD	B,4
   466  020d  d9                HEX2:	EXX
   467  020e  29                	ADD	HL,HL
   468  020f  d9                	EXX
   469  0210  ed6a              	ADC	HL,HL
   470  0212  10f9              	DJNZ	HEX2
   471  0214  d9                	EXX
   472  0215  b5                	OR	L
   473  0216  6f                	LD	L,A
   474  0217  d9                	EXX
   475  0218  cdd709            	CALL	HEXDIG
   476  021b  30ea              	JR	NC,HEX1
   477  021d  af                	XOR	A
   478  021e  c9                	RET
   479                          ;
   480                          ;BIN - Get binary constant.
   481                          ;   Inputs: ASCII string at (IY)
   482                          ;  Outputs: Integer result in H'L'HL, C=0, A=0.
   483                          ;           IY updated (points to delimiter)
   484                          ;
   485  021f  cd7809            BIN:	CALL	ZERO
   486  0222  cdca09            	CALL	BINDIG
   487  0225  389a              	JR	C,BADHEX
   488  0227  fd23              BIN1:	INC	IY
   489  0229  cb1f              	RR	A
   490  022b  d9                	EXX
   491  022c  ed6a              	ADC	HL,HL
   492  022e  d9                	EXX
   493  022f  ed6a              	ADC	HL,HL
   494  0231  cdca09            	CALL	BINDIG
   495  0234  30f1              	JR	NC,BIN1
   496  0236  af                	XOR	A
   497  0237  c9                	RET
   498                          ;
   499                          ;MINUS - Unary minus.
   500                          ;   Inputs: IY = text pointer
   501                          ;  Outputs: Numeric result, same type as argument.
   502                          ;           Result in H'L'HLC
   503                          ;
   504  0238  cdf801            MINUS:	CALL	ITEMN
   505  023b  0d                MINUS0:	DEC	C
   506  023c  0c                	INC	C
   507  023d  2887              	JR	Z,NEGATE	;ZERO/INTEGER
   508  023f  7c                	LD	A,H
   509  0240  ee80              	XOR	80H		;CHANGE SIGN (FP)
   510  0242  67                	LD	H,A
   511  0243  af                	XOR	A		;NUMERIC MARKER
   512  0244  c9                	RET
   513                          ;
   514  0245  cd0000            ADDROF:	CALL	VAR
   515  0248  e5                	PUSH	HL
   516  0249  d9                	EXX
   517  024a  e1                	POP	HL
   518  024b  c3cf04            	JP	COUNT1
   519                          ;
   520                          ;ITEM - VARIABLE TYPE NUMERIC OR STRING ITEM.
   521                          ;Item type is returned in A: Bit 7=0 numeric.
   522                          ; Bit 7=1 string.
   523                          ;Numeric item returned in HLH'L'C.
   524                          ;String item returned in string accumulator,
   525                          ; DE addresses byte after last (E=length).
   526                          ;
   527  024e  cd0000            ITEM:	CALL	CHECK
   528  0251  cd0000            	CALL	NXT
   529  0254  fd23              	INC	IY
   530  0256  fe8d              	CP	FUNTOK
   531  0258  3808              	JR	C,ITEM0
   532  025a  fec7              	CP	TCMD
   533  025c  da410a            	JP	C,DISPAT	;FUNCTIONS
   534  025f  c3af03            	JP	EXTRAS		;DIM, END, MODE, REPORT$, WIDTH
   535                          ;
   536  0262  fe3a              ITEM0:	CP	':'
   537  0264  3025              	JR	NC,ITEM2	;VARIABLES
   538  0266  fe30              	CP	'0'
   539  0268  307b              	JR	NC,CON		;NUMERIC CONSTANT
   540  026a  fe28              	CP	'('
   541  026c  2882              	JR	Z,ITEM1		;EXPRESSION
   542  026e  fe2d              	CP	'-'
   543  0270  28c6              	JR	Z,MINUS		;UNARY MINUS
   544  0272  fe2b              	CP	'+'
   545  0274  2882              	JR	Z,ITEMN		;UNARY PLUS
   546  0276  fe2e              	CP	'.'
   547  0278  286b              	JR	Z,CON		;NUMERIC CONSTANT
   548  027a  fe26              	CP	'&'
   549  027c  2881              	JR	Z,HEX		;HEX CONSTANT
   550  027e  fe25              	CP	'%'
   551  0280  289d              	JR	Z,BIN		;BINARY CONSTANT
   552  0282  fe22              	CP	'"'
   553  0284  2872              	JR	Z,CONS		;STRING CONSTANT
   554  0286  fe0a              	CP	TTINT
   555  0288  ca4f04            	JP	Z,TINT		;TINT FUNCTION
   556  028b  fe83              ITEM2:	CP	TMOD
   557  028d  cacc06            	JP	Z,MODFUN	;MOD
   558  0290  fe5e              	CP	'^'
   559  0292  28b1              	JR	Z,ADDROF	;^ OPERATOR
   560  0294  fd2b              	DEC	IY
   561  0296  cd0000            	CALL	GETVAR		;VARIABLE
   562  0299  202f              	JR	NZ,NOSUCH
   563  029b  cb77              	BIT	6,A
   564  029d  207e              	JR	NZ,ARRAY
   565  029f  b7                	OR	A
   566  02a0  fa8b03            	JP	M,LOADS		;STRING VARIABLE
   567  02a3  cb57              LOADN:	BIT	2,A
   568  02a5  0e00              	LD	C,0
   569  02a7  2816              	JR	Z,LOAD1		;BYTE VARIABLE
   570  02a9  cb47              	BIT	0,A
   571  02ab  2803              	JR	Z,LOAD4		;INTEGER VARIABLE
   572  02ad  dd4e04            LOAD5:	LD	C,(IX+4)
   573  02b0  d9                LOAD4:	EXX
   574  02b1  dd6e00            	LD	L,(IX+0)
   575  02b4  dd6601            	LD	H,(IX+1)
   576  02b7  d9                	EXX
   577  02b8  dd6e02            	LD	L,(IX+2)
   578  02bb  dd6603            	LD	H,(IX+3)
   579  02be  c9                	RET
   580                          ;
   581  02bf  210000            LOAD1:	LD	HL,0
   582  02c2  d9                	EXX
   583  02c3  2600              	LD	H,0
   584  02c5  dd6e00            	LD	L,(IX+0)
   585  02c8  d9                	EXX
   586  02c9  c9                	RET
   587                          ;
   588  02ca  da0000            NOSUCH:	JP	C,SYNTAX
   589  02cd  3a0000            	LD	A,(LISTON)
   590  02d0  cb6f              	BIT	5,A
   591  02d2  3e1a              	LD	A,26
   592  02d4  2036              	JR	NZ,ERROR0	;"No such variable"
   593  02d6  fd23              NOS1:	INC	IY
   594  02d8  cd0000            	CALL	RANGE
   595  02db  30f9              	JR	NC,NOS1
   596  02dd  dd210000          	LD	IX,PC
   597  02e1  af                	XOR	A
   598  02e2  4f                	LD	C,A
   599  02e3  18cb              	JR	LOAD4
   600                          ;
   601                          ;CON - Get unsigned numeric constant from ASCII string.
   602                          ;   Inputs: ASCII string at (IY-1)
   603                          ;  Outputs: Variable-type result in HLH'L'C
   604                          ;           IY updated (points to delimiter)
   605                          ;           A7 = 0 (numeric marker)
   606                          ;
   607  02e5  fd2b              CON:	DEC	IY
   608  02e7  fde5              	PUSH	IY
   609  02e9  dde1              	POP	IX
   610  02eb  3e24              	LD	A,36
   611  02ed  cd0000            	CALL	FPP
   612  02f0  381a              	JR	C,ERROR0
   613  02f2  dde5              	PUSH	IX
   614  02f4  fde1              	POP	IY
   615  02f6  af                	XOR	A
   616  02f7  c9                	RET
   617                          ;
   618                          ;CONS - Get string constant from ASCII string.
   619                          ;   Inputs: ASCII string at (IY)
   620                          ;  Outputs: Result in string accumulator.
   621                          ;           D = MS byte of ACCS, E = string length
   622                          ;           A7 = 1 (string marker)
   623                          ;           IY updated
   624                          ;
   625  02f8  110000            CONS:	LD	DE,ACCS
   626  02fb  fd7e00            CONS3:	LD	A,(IY)
   627  02fe  fd23              	INC	IY
   628  0300  fe22              	CP	'"'
   629  0302  280b              	JR	Z,CONS2
   630  0304  12                CONS1:	LD	(DE),A
   631  0305  1c                	INC	E
   632  0306  fe0d              	CP	CR
   633  0308  20f1              	JR	NZ,CONS3
   634  030a  3e09              	LD	A,9
   635  030c  c30000            ERROR0:	JP	ERROR		;"Missing """
   636                          ;
   637  030f  fd7e00            CONS2:	LD	A,(IY)
   638  0312  fe22              	CP	'"'
   639  0314  fd23              	INC	IY
   640  0316  28ec              	JR	Z,CONS1
   641  0318  fd2b              	DEC	IY
   642  031a  3e80              	LD	A,80H		;STRING MARKER
   643  031c  c9                	RET
   644                          ;
   645  031d  3e0e              ARRAY:	LD	A,14		;'Bad use of array'
   646  031f  18eb              	JR	ERROR0
   647                          ;
   648                          ; ARRLEN - Get start address and number of elements of an array
   649                          ;   Inputs: HL addresses array descriptor
   650                          ;  Outputs: HL = address of first element
   651                          ;           DE = total number of elements
   652                          ;           A = 0
   653                          ; Destroys: A,B,C,D,E,H,L,flags
   654                          ;
   655  0321  7e                ARRLEN:	LD	A,(HL)		;Number of dimensions
   656  0322  23                	INC	HL
   657  0323  b7                	OR	A
   658  0324  28f7              	JR	Z,ARRAY
   659  0326  110100            	LD	DE,1
   660  0329  4e                ARLOOP:	LD	C,(HL)
   661  032a  23                	INC	HL
   662  032b  46                	LD	B,(HL)		;BC = size of this dimension
   663  032c  23                	INC	HL
   664  032d  eb                	EX	DE,HL
   665  032e  f5                	PUSH	AF
   666  032f  d5                	PUSH	DE
   667  0330  cd0000            	CALL	MUL16		;HL=HL*BC
   668  0333  d1                	POP	DE
   669  0334  f1                	POP	AF
   670  0335  eb                	EX	DE,HL
   671  0336  3d                	DEC	A
   672  0337  20f0              	JR	NZ,ARLOOP
   673  0339  c9                	RET
   674                          ;
   675  033a  cd0000            GETARR:	CALL	NXT
   676  033d  cd0000            	CALL	GETVAR
   677  0340  2088              	JR	NZ,NOSUCH
   678  0342  cb77              	BIT	6,A
   679  0344  37                	SCF
   680  0345  2883              	JR	Z,NOSUCH
   681  0347  e68f              	AND	8FH
   682  0349  47                	LD	B,A		;Type + size
   683  034a  7e                GETAR1:	LD	A,(HL)
   684  034b  23                	INC	HL
   685  034c  66                	LD	H,(HL)
   686  034d  6f                	LD	L,A
   687  034e  e6fe              	AND	0FEH
   688  0350  b4                	OR	H
   689  0351  28ca              	JR	Z,ARRAY		;Bad use of array
   690  0353  c9                	RET
   691                          ;
   692  0354  cd0000            GETARB:	CALL	NXT
   693  0357  fe28              	CP	'('
   694  0359  20df              	JR	NZ,GETARR
   695  035b  fd23              	INC	IY
   696  035d  cd3a03            	CALL	GETARR
   697  0360  cd2e0a            	CALL	BRAKET
   698  0363  c9                	RET
   699                          ;
   700  0364  cb57              DLOADN:	BIT	2,A
   701  0366  0600              	LD	B,0
   702  0368  2816              	JR	Z,DLOAD1	;BYTE VARIABLE
   703  036a  cb47              	BIT	0,A
   704  036c  2803              	JR	Z,DLOAD4	;INTEGER VARIABLE
   705  036e  dd4604            DLOAD5:	LD	B,(IX+4)
   706  0371  d9                DLOAD4:	EXX
   707  0372  dd5e00            	LD	E,(IX+0)
   708  0375  dd5601            	LD	D,(IX+1)
   709  0378  d9                	EXX
   710  0379  dd5e02            	LD	E,(IX+2)
   711  037c  dd5603            	LD	D,(IX+3)
   712  037f  c9                	RET
   713                          ;
   714  0380  110000            DLOAD1:	LD	DE,0
   715  0383  d9                	EXX
   716  0384  1600              	LD	D,0
   717  0386  dd5e00            	LD	E,(IX+0)
   718  0389  d9                	EXX
   719  038a  c9                	RET
   720                          ;
   721  038b  110000            LOADS:	LD	DE,ACCS
   722  038e  1f                	RRA
   723  038f  3010              	JR	NC,LOADS2	;FIXED STRING
   724  0391  cdb002            	CALL	LOAD4
   725  0394  d9                	EXX
   726  0395  7d                	LD	A,L
   727  0396  d9                	EXX
   728  0397  b7                	OR	A
   729  0398  4f                	LD	C,A
   730  0399  3e80              REPDUN:	LD	A,80H		;STRING MARKER
   731  039b  c8                	RET	Z
   732  039c  0600              	LD	B,0
   733  039e  edb0              	LDIR
   734  03a0  c9                	RET
   735                          ;
   736  03a1  dde5              LOADS2:	PUSH	IX
   737  03a3  e1                	POP	HL
   738  03a4  7e                LOADS3:	LD	A,(HL)
   739  03a5  12                	LD	(DE),A
   740  03a6  23                	INC	HL
   741  03a7  fe0d              	CP	CR
   742  03a9  28ee              	JR	Z,REPDUN
   743  03ab  1c                	INC	E
   744  03ac  20f6              	JR	NZ,LOADS3
   745  03ae  c9                	RET			;RETURN NULL STRING
   746                          ;
   747                          ; Version 5 extensions:
   748                          ;
   749  03af  feeb              EXTRAS:	CP	TMODE
   750  03b1  ca0000            	JP	Z,MODEFN	;MODE
   751  03b4  fefe              	CP	TWIDTH
   752  03b6  ca0000            	JP	Z,WIDFN		;WIDTH
   753  03b9  fef6              	CP	TREPORT
   754  03bb  2811              	JR	Z,REPORS	;REPORT$
   755  03bd  fee0              	CP	TEND
   756  03bf  2807              	JR	Z,ENDFUN	;END
   757  03c1  fede              	CP	TDIM
   758  03c3  2844              	JR	Z,DIMFUN	;DIM
   759  03c5  c30000            SYNERR:	JP	SYNTAX		; 'Syntax error'
   760                          ;
   761                          ; END (function)
   762                          ;
   763  03c8  2a0000            ENDFUN:	LD	HL,(FREE)
   764  03cb  c3cf04            	JP	COUNT1
   765                          ;
   766                          ; REPORT$
   767                          ;
   768  03ce  fd7e00            REPORS:	LD	A,(IY)
   769  03d1  fe24              	CP	'$'
   770  03d3  20f0              	JR	NZ,SYNERR
   771  03d5  fd23              	INC	IY
   772  03d7  2a0000            	LD	HL,(ERRTXT)
   773  03da  110000            	LD	DE,ACCS
   774  03dd  7e                REPCPY:	LD	A,(HL)
   775  03de  b7                	OR	A
   776  03df  28b8              	JR	Z,REPDUN
   777  03e1  eda0              	LDI
   778  03e3  fea0              	CP	160
   779  03e5  eadd03            	JP	PE,REPCPY
   780  03e8  fe0a              	CP	LF
   781  03ea  28f1              	JR	Z,REPCPY
   782  03ec  1d                	DEC	E
   783  03ed  e5                	PUSH	HL
   784  03ee  210000            	LD	HL,KEYWDS
   785  03f1  010000            	LD	BC,KEYWDL
   786  03f4  edb1              	CPIR
   787  03f6  06a0              	LD	B,160
   788  03f8  fe91              	CP	145
   789  03fa  eafe03            	JP	PE,REPTOK
   790  03fd  04                	INC	B
   791  03fe  7e                REPTOK:	LD	A,(HL)
   792  03ff  eda0              	LDI
   793  0401  b8                	CP	B
   794  0402  eafe03            	JP	PE,REPTOK
   795  0405  e1                	POP	HL
   796  0406  1d                	DEC	E
   797  0407  18d4              	JR	REPCPY
   798                          ;
   799                          ; DIM(array()[,sub])
   800                          ;
   801  0409  cd0000            DIMFUN:	CALL	NXT
   802  040c  fe28              	CP	'('
   803  040e  2009              	JR	NZ,DIMF0
   804  0410  fd23              	INC	IY
   805  0412  cd1904            	CALL	DIMF0
   806  0415  cd2e0a            	CALL	BRAKET
   807  0418  c9                	RET
   808                          ;
   809  0419  cd3a03            DIMF0:	CALL	GETARR
   810  041c  e5                	PUSH	HL
   811  041d  cd0000            	CALL	NXT
   812  0420  1e00              	LD	E,0
   813  0422  fe2c              	CP	','
   814  0424  200b              	JR	NZ,DIMF1
   815  0426  fd23              	INC	IY
   816  0428  cdb101            	CALL	EXPRI
   817  042b  d9                	EXX
   818  042c  eb                	EX	DE,HL
   819  042d  1c                	INC	E
   820  042e  1d                	DEC	E
   821  042f  2819              	JR	Z,BADSUB
   822  0431  e1                DIMF1:	POP	HL
   823  0432  7e                	LD	A,(HL)
   824  0433  23                	INC	HL
   825  0434  bb                	CP	E
   826  0435  3813              	JR	C,BADSUB
   827  0437  1d                	DEC	E
   828  0438  fa4504            	JP	M,DIMF3
   829  043b  19                	ADD	HL,DE
   830  043c  19                	ADD	HL,DE
   831  043d  7e                	LD	A,(HL)
   832  043e  23                	INC	HL
   833  043f  66                	LD	H,(HL)
   834  0440  6f                	LD	L,A
   835  0441  2b                	DEC	HL
   836  0442  c3cf04            DIMF2:	JP	COUNT1
   837                          
   838  0445  6f                DIMF3:	LD	L,A
   839  0446  2600              	LD	H,0
   840  0448  18f8              	JR	DIMF2
   841                          ;
   842  044a  3e0f              BADSUB:	LD	A,15
   843  044c  c30000            	JP	ERROR			;"Bad subscript"
   844                          ;
   845                          ;VARIABLE-TYPE FUNCTIONS:
   846                          ;
   847                          ;Result returned in HLH'L'C (floating point)
   848                          ;Result returned in HLH'L' (C=0) (integer)
   849                          ;Result returned in string accumulator & DE (string)
   850                          ;All registers destroyed.
   851                          ;IY (text pointer) updated.
   852                          ;Bit 7 of A indicates type: 0 = numeric, 1 = string.
   853                          ;
   854                          ;
   855                          ;POS - horizontal cursor position.
   856                          ;VPOS - vertical cursor position.
   857                          ;EOF - return status of file.
   858                          ;BGET - read byte from file.
   859                          ;INKEY - as GET but wait only n centiseconds.
   860                          ;GET - wait for keypress and return ASCII value.
   861                          ;GET(n) - input from Z80 port n.
   862                          ;ASC - ASCII value of string.
   863                          ;LEN - length of string.
   864                          ;LOMEM - location of dynamic variables.
   865                          ;HIMEM - top of available RAM.
   866                          ;PAGE - start of current text page.
   867                          ;TOP - address of first free byte after program.
   868                          ;ERL - line number where last error occurred.
   869                          ;ERR - number of last error.
   870                          ;COUNT - number of printing characters since CR.
   871                          ;Results are integer numeric.
   872                          ;
   873  044f  cd0000            TINT:	CALL	TINTFN
   874  0452  187b              	JR	COUNT1
   875  0454  cd0000            POS:	CALL	GETCSR
   876  0457  eb                	EX	DE,HL
   877  0458  1875              	JR	COUNT1
   878  045a  cd0000            VPOS:	CALL	GETCSR
   879  045d  1870              	JR	COUNT1
   880  045f  cd0000            EOF:	CALL	CHANEL
   881  0462  cd0000            	CALL	OSSTAT
   882  0465  ca3c05            	JP	Z,TRUE
   883  0468  c37809            	JP	ZERO
   884  046b  cd0000            BGET:	CALL	CHANEL		;CHANNEL NUMBER
   885  046e  cd0000            	CALL	OSBGET
   886  0471  6f                	LD	L,A
   887  0472  1859              	JR	COUNT0
   888  0474  cd0e08            INKEY:	CALL	INKEYS
   889  0477  1819              	JR	ASC0
   890  0479  cd0000            GET:	CALL	NXT
   891  047c  fe28              	CP	'('
   892  047e  200a              	JR	NZ,GET0
   893  0480  cdde01            	CALL	ITEMI		;PORT ADDRESS
   894  0483  d9                	EXX
   895  0484  44                	LD	B,H
   896  0485  4d                	LD	C,L
   897  0486  ed68              	IN	L,(C)		;INPUT FROM PORT BC
   898  0488  1843              	JR	COUNT0
   899  048a  cdac07            GET0:	CALL	GETS
   900  048d  1808              	JR	ASC1
   901  048f  cde701            ASC:	CALL	ITEMS
   902  0492  af                ASC0:	XOR	A
   903  0493  bb                	CP	E
   904  0494  ca3c05            	JP	Z,TRUE		;NULL STRING
   905  0497  2a0000            ASC1:	LD	HL,(ACCS)
   906  049a  1831              	JR	COUNT0
   907  049c  cde701            LEN:	CALL	ITEMS
   908  049f  eb                	EX	DE,HL
   909  04a0  182b              	JR	COUNT0
   910  04a2  2a0000            LOMEMV:	LD	HL,(LOMEM)
   911  04a5  1828              	JR	COUNT1
   912  04a7  2a0000            HIMEMV:	LD	HL,(HIMEM)
   913  04aa  1823              	JR	COUNT1
   914  04ac  2a0000            PAGEV:	LD	HL,(PAGE)
   915  04af  181e              	JR	COUNT1
   916  04b1  fd7e00            TOPV:	LD	A,(IY)
   917  04b4  fd23              	INC	IY		;SKIP "P"
   918  04b6  fe50              	CP	'P'
   919  04b8  c20000            	JP	NZ,SYNTAX	;"Syntax Error"
   920  04bb  cd0000            	CALL	GETTOP
   921  04be  180f              	JR	COUNT1
   922  04c0  2a0000            ERLV:	LD	HL,(ERL)
   923  04c3  180a              	JR	COUNT1
   924  04c5  2a0000            ERRV:	LD	HL,(ERR)
   925  04c8  1803              	JR	COUNT0
   926  04ca  2a0000            COUNTV:	LD	HL,(COUNT)
   927  04cd  2600              COUNT0:	LD	H,0
   928  04cf  d9                COUNT1:	EXX
   929  04d0  af                	XOR	A
   930  04d1  4f                	LD	C,A		;INTEGER MARKER
   931  04d2  67                	LD	H,A
   932  04d3  6f                	LD	L,A
   933  04d4  c9                	RET
   934                          ;
   935                          ;OPENIN - Open a file for reading.
   936                          ;OPENOUT - Open a file for writing.
   937                          ;OPENUP - Open a file for reading or writing.
   938                          ;Result is integer channel number (0 if error)
   939                          ;
   940  04d5  af                OPENOT:	XOR	A
   941  04d6  21                	DEFB	21H		;SKIP NEXT 2 BYTES
   942  04d7  3e02              OPENUP:	LD	A,2
   943  04d9  21                	DEFB	21H		;SKIP NEXT 2 BYTES
   944  04da  3e01              OPENIN:	LD	A,1
   945  04dc  f5                	PUSH	AF		;SAVE OPEN TYPE
   946  04dd  cde701            	CALL	ITEMS		;FILENAME
   947  04e0  3e0d              	LD	A,CR
   948  04e2  12                	LD	(DE),A
   949  04e3  f1                	POP	AF		;RESTORE OPEN TYPE
   950  04e4  c6ff              	ADD	A,-1		;AFFECT FLAGS
   951  04e6  210000            	LD	HL,ACCS
   952  04e9  cd0000            	CALL	OSOPEN
   953  04ec  6f                	LD	L,A
   954  04ed  18de              	JR	COUNT0
   955                          ;
   956                          ;EXT - Return length of file.
   957                          ;PTR - Return current file pointer.
   958                          ;Results are integer numeric.
   959                          ;
   960  04ef  cd0000            EXT:	CALL	CHANEL
   961  04f2  cd0000            	CALL	GETEXT
   962  04f5  1812              	JR	TIME0
   963                          ;
   964  04f7  cd0000            PTR:	CALL	CHANEL
   965  04fa  cd0000            	CALL	GETPTR
   966  04fd  180a              	JR	TIME0
   967                          ;
   968                          ;TIME - Return current value of elapsed time.
   969                          ;Result is integer numeric.
   970                          ;
   971  04ff  fd7e00            TIMEV:	LD	A,(IY)
   972  0502  fe24              	CP	'$'
   973  0504  2809              	JR	Z,TIMEVS
   974  0506  cd0000            	CALL	GETIME
   975  0509  d5                TIME0:	PUSH	DE
   976  050a  d9                	EXX
   977  050b  e1                	POP	HL
   978  050c  af                	XOR	A
   979  050d  4f                	LD	C,A
   980  050e  c9                	RET
   981                          ;
   982                          ;TIME$ - Return date/time string.
   983                          ;Result is string
   984                          ;
   985  050f  fd23              TIMEVS:	INC	IY		;SKIP $
   986  0511  cd0000            	CALL	GETIMS
   987  0514  3e80              	LD	A,80H		;MARK STRING
   988  0516  c9                	RET
   989                          ;
   990                          ;String comparison:
   991                          ;
   992  0517  cd7509            SLT:	CALL	SCP
   993  051a  d0                	RET	NC
   994  051b  181f              	JR	TRUE
   995                          ;
   996  051d  cd7509            SGT:	CALL	SCP
   997  0520  c8                	RET	Z
   998  0521  d8                	RET	C
   999  0522  1818              	JR	TRUE
  1000                          ;
  1001  0524  cd7509            SGE:	CALL	SCP
  1002  0527  d8                	RET	C
  1003  0528  1812              	JR	TRUE
  1004                          ;
  1005  052a  cd7509            SLE:	CALL	SCP
  1006  052d  280d              	JR	Z,TRUE
  1007  052f  d0                	RET	NC
  1008  0530  180a              	JR	TRUE
  1009                          ;
  1010  0532  cd7509            SNE:	CALL	SCP
  1011  0535  c8                	RET	Z
  1012  0536  1804              	JR	TRUE
  1013                          ;
  1014  0538  cd7509            SEQ:	CALL	SCP
  1015  053b  c0                	RET	NZ
  1016  053c  3eff              TRUE:	LD	A,-1
  1017  053e  d9                	EXX
  1018  053f  67                	LD	H,A
  1019  0540  6f                	LD	L,A
  1020  0541  d9                	EXX
  1021  0542  67                	LD	H,A
  1022  0543  6f                	LD	L,A
  1023  0544  3c                	INC	A
  1024  0545  4f                	LD	C,A
  1025  0546  c9                	RET
  1026                          ;
  1027                          ;PI - Return PI (3.141592654)
  1028                          ;Result is floating-point numeric.
  1029                          ;
  1030  0547  3e23              PI:	LD	A,35
  1031  0549  1843              	JR	FPP1
  1032                          ;
  1033                          ;ABS - Absolute value
  1034                          ;Result is numeric, variable type.
  1035                          ;
  1036  054b  3e10              ABS:	LD	A,16
  1037  054d  183a              	JR	FPPN
  1038                          ;
  1039                          ;NOT - Complement integer.
  1040                          ;Result is integer numeric.
  1041                          ;
  1042  054f  3e1a              CPL:	LD	A,26
  1043  0551  1836              	JR	FPPN
  1044                          ;
  1045                          ;DEG - Convert radians to degrees
  1046                          ;Result is floating-point numeric.
  1047                          ;
  1048  0553  3e15              DEG:	LD	A,21
  1049  0555  1832              	JR	FPPN
  1050                          ;
  1051                          ;RAD - Convert degrees to radians
  1052                          ;Result is floating-point numeric.
  1053                          ;
  1054  0557  3e1b              RAD:	LD	A,27
  1055  0559  182e              	JR	FPPN
  1056                          ;
  1057                          ;SGN - Return -1, 0 or +1
  1058                          ;Result is integer numeric.
  1059                          ;
  1060  055b  3e1c              SGN:	LD	A,28
  1061  055d  182a              	JR	FPPN
  1062                          ;
  1063                          ;INT - Floor function
  1064                          ;Result is integer numeric.
  1065                          ;
  1066  055f  3e17              INT:	LD	A,23
  1067  0561  1826              	JR	FPPN
  1068                          ;
  1069                          ;SQR - square root
  1070                          ;Result is floating-point numeric.
  1071                          ;
  1072  0563  3e1e              SQR:	LD	A,30
  1073  0565  1822              	JR	FPPN
  1074                          ;
  1075                          ;TAN - Tangent function
  1076                          ;Result is floating-point numeric.
  1077                          ;
  1078  0567  3e1f              TAN:	LD	A,31
  1079  0569  181e              	JR	FPPN
  1080                          ;
  1081                          ;COS - Cosine function
  1082                          ;Result is floating-point numeric.
  1083                          ;
  1084  056b  3e14              COS:	LD	A,20
  1085  056d  181a              	JR	FPPN
  1086                          ;
  1087                          ;SIN - Sine function
  1088                          ;Result is floating-point numeric.
  1089                          ;
  1090  056f  3e1d              SIN:	LD	A,29
  1091  0571  1816              	JR	FPPN
  1092                          ;
  1093                          ;EXP - Exponential function
  1094                          ;Result is floating-point numeric.
  1095                          ;
  1096  0573  3e16              EXP:	LD	A,22
  1097  0575  1812              	JR	FPPN
  1098                          ;
  1099                          ;LN - Natural log.
  1100                          ;Result is floating-point numeric.
  1101                          ;
  1102  0577  3e18              LN:	LD	A,24
  1103  0579  180e              	JR	FPPN
  1104                          ;
  1105                          ;LOG - base-10 logarithm.
  1106                          ;Result is floating-point numeric.
  1107                          ;
  1108  057b  3e19              LOG:	LD	A,25
  1109  057d  180a              	JR	FPPN
  1110                          ;
  1111                          ;ASN - Arc-sine
  1112                          ;Result is floating-point numeric.
  1113                          ;
  1114  057f  3e12              ASN:	LD	A,18
  1115  0581  1806              	JR	FPPN
  1116                          ;
  1117                          ;ATN - arc-tangent
  1118                          ;Result is floating-point numeric.
  1119                          ;
  1120  0583  3e13              ATN:	LD	A,19
  1121  0585  1802              	JR	FPPN
  1122                          ;
  1123                          ;ACS - arc-cosine
  1124                          ;Result is floating point numeric.
  1125                          ;
  1126  0587  3e11              ACS:	LD	A,17
  1127  0589  f5                FPPN:	PUSH	AF
  1128  058a  cdf801            	CALL	ITEMN
  1129  058d  f1                	POP	AF
  1130  058e  cd0000            FPP1:	CALL	FPP
  1131  0591  da0000            	JP	C,ERROR
  1132  0594  af                	XOR	A
  1133  0595  c9                	RET
  1134                          ;
  1135                          ;SFIX - Convert to fixed-point notation
  1136                          ;
  1137  0596  3e26              SFIX:	LD	A,38
  1138  0598  18f4              	JR	FPP1
  1139                          ;
  1140                          ;SFLOAT - Convert to floating-point notation
  1141                          ;
  1142  059a  3e27              SFLOAT:	LD	A,39
  1143  059c  18f0              	JR	FPP1
  1144                          ;
  1145                          ;VAL - Return numeric value of string.
  1146                          ;Result is variable type numeric.
  1147                          ;
  1148  059e  cde701            VAL:	CALL	ITEMS
  1149  05a1  af                VAL0:	XOR	A
  1150  05a2  12                	LD	(DE),A
  1151  05a3  dd210000          	LD	IX,ACCS
  1152  05a7  3e24              	LD	A,36
  1153  05a9  18e3              	JR	FPP1
  1154                          ;
  1155                          ;EVAL - Pass string to expression evaluator.
  1156                          ;Result is variable type (numeric or string).
  1157                          ;
  1158  05ab  cde701            EVAL:	CALL	ITEMS
  1159  05ae  3e0d              	LD	A,CR
  1160  05b0  12                	LD	(DE),A
  1161  05b1  fde5              	PUSH	IY
  1162  05b3  110000            	LD	DE,ACCS
  1163  05b6  fd210000          	LD	IY,ACCS
  1164  05ba  0e00              	LD	C,0
  1165  05bc  cd0000            	CALL	LEXAN2		;TOKENISE
  1166  05bf  12                	LD	(DE),A
  1167  05c0  13                	INC	DE
  1168  05c1  af                	XOR	A
  1169  05c2  cd9909            	CALL	PUSHS		;PUT ON STACK
  1170  05c5  fd210200          	LD	IY,2
  1171  05c9  fd39              	ADD	IY,SP
  1172  05cb  cd8000            	CALL	EXPR
  1173  05ce  fde1              	POP	IY
  1174  05d0  fd39              	ADD	IY,SP
  1175  05d2  fdf9              	LD	SP,IY		;ADJUST STACK POINTER
  1176  05d4  fde1              	POP	IY
  1177  05d6  08                	EX	AF,AF'
  1178  05d7  c9                	RET
  1179                          ;
  1180                          ;RND - Random number function.
  1181                          ; RND gives random integer 0-&FFFFFFFF
  1182                          ; RND(-n) seeds random number & returns -n.
  1183                          ; RND(0) returns last value in RND(1) form.
  1184                          ; RND(1) returns floating-point 0-0.99999999.
  1185                          ; RND(n) returns random integer 1-n.
  1186                          ;
  1187  05d8  dd210000          RND:	LD	IX,RANDOM
  1188  05dc  cd0000            	CALL	NXT
  1189  05df  fe28              	CP	'('
  1190  05e1  281c              	JR	Z,RND5		;ARGUMENT FOLLOWS
  1191  05e3  cdad02            	CALL	LOAD5
  1192  05e6  cb19              RND1:	RR	C
  1193  05e8  0620              	LD	B,32
  1194  05ea  d9                RND2:	EXX			;CALCULATE NEXT
  1195  05eb  ed6a              	ADC	HL,HL
  1196  05ed  d9                	EXX
  1197  05ee  ed6a              	ADC	HL,HL
  1198  05f0  cb5d              	BIT	3,L
  1199  05f2  2801              	JR	Z,RND3
  1200  05f4  3f                	CCF
  1201  05f5  10f3              RND3:	DJNZ	RND2
  1202  05f7  cb11              RND4:	RL	C		;SAVE CARRY
  1203  05f9  cd0000            	CALL	STORE5		;STORE NEW NUMBER
  1204  05fc  af                	XOR	A
  1205  05fd  4f                	LD	C,A
  1206  05fe  c9                	RET
  1207  05ff  cdde01            RND5:	CALL	ITEMI
  1208  0602  dd210000          	LD	IX,RANDOM
  1209  0606  cb7c              	BIT	7,H		;NEGATIVE?
  1210  0608  37                	SCF
  1211  0609  20ec              	JR	NZ,RND4		;SEED
  1212  060b  cdd908            	CALL	TEST
  1213  060e  f5                	PUSH	AF
  1214  060f  41                	LD	B,C
  1215  0610  eb                	EX	DE,HL
  1216  0611  d9                	EXX
  1217  0612  eb                	EX	DE,HL
  1218  0613  cdad02            	CALL	LOAD5
  1219  0616  c4e605            	CALL	NZ,RND1		;NEXT IF NON-ZERO
  1220  0619  d9                	EXX			;SCRAMBLE (CARE!)
  1221  061a  0e7f              	LD	C,7FH
  1222  061c  cb7c              RND6:	BIT	7,H		;FLOAT
  1223  061e  2008              	JR	NZ,RND7
  1224  0620  d9                	EXX
  1225  0621  29                	ADD	HL,HL
  1226  0622  d9                	EXX
  1227  0623  ed6a              	ADC	HL,HL
  1228  0625  0d                	DEC	C
  1229  0626  20f4              	JR	NZ,RND6
  1230  0628  cbbc              RND7:	RES	7,H		;POSITIVE 0-0.999999
  1231  062a  f1                	POP	AF
  1232  062b  c8                	RET	Z		;ZERO ARGUMENT
  1233  062c  d9                	EXX
  1234  062d  7b                	LD	A,E
  1235  062e  3d                	DEC	A
  1236  062f  b2                	OR	D
  1237  0630  d9                	EXX
  1238  0631  b3                	OR	E
  1239  0632  b2                	OR	D
  1240  0633  c8                	RET	Z		;ARGUMENT=1
  1241  0634  0600              	LD	B,0		;INTEGER MARKER
  1242  0636  3e0a              	LD	A,10
  1243  0638  cd0000            	CALL	FPP		;MULTIPLY
  1244  063b  da0000            	JP	C,ERROR
  1245  063e  cd9605            	CALL	SFIX
  1246  0641  c3d401            	JP	ADD1
  1247                          ;
  1248                          ;SUMLEN(array())
  1249                          ;
  1250  0644  fd23              SUMLEN:	INC	IY		;Skip LEN
  1251  0646  cd5403            	CALL	GETARB
  1252  0649  cb78              	BIT	7,B
  1253  064b  caec01            	JP	Z,MISMAT	;Type mismatch
  1254  064e  cd2103            	CALL	ARRLEN
  1255  0651  e5                	PUSH	HL
  1256  0652  dde1              	POP	IX		;IX addresses array
  1257  0654  af                	XOR	A
  1258  0655  67                	LD	H,A
  1259  0656  6f                	LD	L,A
  1260  0657  47                	LD	B,A
  1261  0658  dd4e00            SUMLN1:	LD	C,(IX)
  1262  065b  09                	ADD	HL,BC
  1263  065c  0e04              	LD	C,4
  1264  065e  dd09              	ADD	IX,BC
  1265  0660  1b                	DEC	DE		;Count elements
  1266  0661  7a                	LD	A,D
  1267  0662  b3                	OR	E
  1268  0663  20f3              	JR	NZ,SUMLN1
  1269  0665  c3cf04            	JP	COUNT1
  1270                          ;
  1271                          ;SUM(array())
  1272                          ;
  1273  0668  cd0000            SUM:	CALL	NXT
  1274  066b  fea9              	CP	TLEN
  1275  066d  28d5              	JR	Z,SUMLEN
  1276  066f  cd5403            	CALL	GETARB
  1277  0672  cb78              	BIT	7,B
  1278  0674  2027              	JR	NZ,SUMSTR
  1279  0676  c5                	PUSH	BC
  1280  0677  cd2103            	CALL	ARRLEN
  1281  067a  e5                	PUSH	HL
  1282  067b  dde1              	POP	IX		;IX addresses array
  1283  067d  cd7809            	CALL	ZERO
  1284  0680  f1                	POP	AF		;A = element size
  1285  0681  d5                SUMUP:	PUSH	DE
  1286  0682  f5                	PUSH	AF
  1287  0683  cd6403            	CALL	DLOADN
  1288  0686  3e0b              	LD	A,11
  1289  0688  cd0000            	CALL	FPP
  1290  068b  da0000            	JP	C,ERROR
  1291  068e  f1                	POP	AF
  1292  068f  1600              	LD	D,0
  1293  0691  5f                	LD	E,A
  1294  0692  dd19              	ADD	IX,DE		;Bump to next element
  1295  0694  d1                	POP	DE
  1296  0695  1b                	DEC	DE		;Count elements
  1297  0696  47                	LD	B,A
  1298  0697  7a                	LD	A,D
  1299  0698  b3                	OR	E
  1300  0699  78                	LD	A,B
  1301  069a  20e5              	JR	NZ,SUMUP
  1302  069c  c9                	RET
  1303                          ;
  1304                          ;SUM(string array)
  1305                          ;
  1306  069d  cd2103            SUMSTR:	CALL	ARRLEN
  1307  06a0  e5                	PUSH	HL
  1308  06a1  dde1              	POP	IX		;IX addresses array
  1309  06a3  eb                	EX	DE,HL
  1310  06a4  110000            	LD	DE,ACCS
  1311  06a7  0600              	LD	B,0
  1312  06a9  e5                SUMST1:	PUSH	HL
  1313  06aa  dd4e00            	LD	C,(IX)
  1314  06ad  79                	LD	A,C
  1315  06ae  b7                	OR	A
  1316  06af  280e              	JR	Z,SUMST2
  1317  06b1  83                	ADD	A,E
  1318  06b2  3e13              	LD	A,19
  1319  06b4  da0000            	JP	C,ERROR		;"String too long"
  1320  06b7  dd6e02            	LD	L,(IX+2)
  1321  06ba  dd6603            	LD	H,(IX+3)
  1322  06bd  edb0              	LDIR
  1323  06bf  e1                SUMST2:	POP	HL
  1324  06c0  0e04              	LD	C,4
  1325  06c2  dd09              	ADD	IX,BC
  1326  06c4  2b                	DEC	HL		;Count elements
  1327  06c5  7c                	LD	A,H
  1328  06c6  b5                	OR	L
  1329  06c7  20e0              	JR	NZ,SUMST1
  1330  06c9  f680              	OR	80H
  1331  06cb  c9                	RET
  1332                          ;
  1333                          ;MOD(array())
  1334                          ;
  1335  06cc  cd5403            MODFUN:	CALL	GETARB
  1336  06cf  cb78              	BIT	7,B
  1337  06d1  c2ec01            	JP	NZ,MISMAT
  1338  06d4  c5                	PUSH	BC
  1339  06d5  cd2103            	CALL	ARRLEN
  1340  06d8  e5                	PUSH	HL
  1341  06d9  dde1              	POP	IX		;IX addresses array
  1342  06db  cd7809            	CALL	ZERO
  1343  06de  f1                	POP	AF		;A = element size
  1344  06df  d5                MODUP:	PUSH	DE
  1345  06e0  f5                	PUSH	AF
  1346  06e1  c5                	PUSH	BC
  1347  06e2  e5                	PUSH	HL
  1348  06e3  d9                	EXX
  1349  06e4  e5                	PUSH	HL
  1350  06e5  d9                	EXX
  1351  06e6  cda302            	CALL	LOADN
  1352  06e9  af                	XOR	A
  1353  06ea  47                	LD	B,A
  1354  06eb  57                	LD	D,A
  1355  06ec  5f                	LD	E,A
  1356  06ed  d9                	EXX
  1357  06ee  57                	LD	D,A
  1358  06ef  1e02              	LD	E,2
  1359  06f1  d9                	EXX
  1360  06f2  3e0e              	LD	A,14
  1361  06f4  dde5              	PUSH	IX
  1362  06f6  cd0000            	CALL	FPP		;Square
  1363  06f9  dde1              	POP	IX
  1364  06fb  da0000            	JP	C,ERROR
  1365  06fe  d9                	EXX
  1366  06ff  eb                	EX	DE,HL
  1367  0700  e1                	POP	HL
  1368  0701  d9                	EXX
  1369  0702  eb                	EX	DE,HL
  1370  0703  e1                	POP	HL
  1371  0704  79                	LD	A,C
  1372  0705  c1                	POP	BC
  1373  0706  47                	LD	B,A
  1374  0707  3e0b              	LD	A,11
  1375  0709  cd0000            	CALL	FPP		;Accumulate
  1376  070c  da0000            	JP	C,ERROR
  1377  070f  f1                	POP	AF
  1378  0710  1600              	LD	D,0
  1379  0712  5f                	LD	E,A
  1380  0713  dd19              	ADD	IX,DE		;Bump to next element
  1381  0715  d1                	POP	DE
  1382  0716  1b                	DEC	DE		;Count elements
  1383  0717  47                	LD	B,A
  1384  0718  7a                	LD	A,D
  1385  0719  b3                	OR	E
  1386  071a  78                	LD	A,B
  1387  071b  20c2              	JR	NZ,MODUP
  1388  071d  3e1e              	LD	A,30
  1389  071f  cd0000            	CALL	FPP		;Square root
  1390  0722  af                	XOR	A
  1391  0723  c9                	RET
  1392                          ;
  1393                          ;INSTR - String search.
  1394                          ;Result is integer numeric.
  1395                          ;
  1396  0724  cdba01            INSTR:	CALL	EXPRS		;STRING TO SEARCH
  1397  0727  cd220a            	CALL	COMMA
  1398  072a  cd9909            	CALL	PUSHS		;SAVE STRING ON STACK
  1399  072d  cdba01            	CALL	EXPRS		;SUB-STRING
  1400  0730  c1                	POP	BC
  1401  0731  210000            	LD	HL,0
  1402  0734  39                	ADD	HL,SP		;HL ADDRESSES MAIN
  1403  0735  c5                	PUSH	BC		;C = MAIN STRING LENGTH
  1404  0736  43                	LD	B,E		;B = SUB-STRING LENGTH
  1405  0737  cd0000            	CALL	NXT
  1406  073a  fe2c              	CP	','
  1407  073c  3e00              	LD	A,0
  1408  073e  2017              	JR	NZ,INSTR1
  1409  0740  fd23              	INC	IY		;SKIP COMMA
  1410  0742  c5                	PUSH	BC		;SAVE LENGTHS
  1411  0743  e5                	PUSH	HL		;SAVE MAIN ADDRESS
  1412  0744  cd9909            	CALL	PUSHS
  1413  0747  cdb101            	CALL	EXPRI
  1414  074a  c1                	POP	BC
  1415  074b  cdb709            	CALL	POPS
  1416  074e  e1                	POP	HL		;RESTORE MAIN ADDRESS
  1417  074f  c1                	POP	BC		;RESTORE LENGTHS
  1418  0750  d9                	EXX
  1419  0751  7d                	LD	A,L
  1420  0752  d9                	EXX
  1421  0753  b7                	OR	A
  1422  0754  2801              	JR	Z,INSTR1
  1423  0756  3d                	DEC	A
  1424  0757  110000            INSTR1:	LD	DE,ACCS		;DE ADDRESSES SUB
  1425  075a  cd7107            	CALL	SEARCH
  1426  075d  d1                	POP	DE
  1427  075e  2803              	JR	Z,INSTR2	;N.B. CARRY CLEARED
  1428  0760  ed62              	SBC	HL,HL
  1429  0762  39                	ADD	HL,SP
  1430  0763  ed72              INSTR2:	SBC	HL,SP
  1431  0765  eb                	EX	DE,HL
  1432  0766  2600              	LD	H,0
  1433  0768  39                	ADD	HL,SP
  1434  0769  f9                	LD	SP,HL
  1435  076a  eb                	EX	DE,HL
  1436  076b  cd2e0a            	CALL	BRAKET
  1437  076e  c3cf04            	JP	COUNT1
  1438                          ;
  1439                          ;SEARCH - Search string for sub-string
  1440                          ;   Inputs: Main string at HL length C
  1441                          ;           Sub-string at DE length B
  1442                          ;           Starting offset A
  1443                          ;  Outputs: NZ - not found
  1444                          ;           Z - found at location HL-1
  1445                          ;           Carry always cleared
  1446                          ;
  1447  0771  c5                SEARCH:	PUSH	BC
  1448  0772  0600              	LD	B,0
  1449  0774  4f                	LD	C,A
  1450  0775  09                	ADD	HL,BC		;NEW START ADDRESS
  1451  0776  c1                	POP	BC
  1452  0777  91                	SUB	C
  1453  0778  3028              	JR	NC,SRCH4
  1454  077a  ed44              	NEG
  1455  077c  4f                	LD	C,A		;REMAINING LENGTH
  1456  077d  1a                SRCH1:	LD	A,(DE)
  1457  077e  c5                	PUSH	BC
  1458  077f  0600              	LD	B,0
  1459  0781  edb1              	CPIR			;FIND FIRST CHARACTER
  1460  0783  79                	LD	A,C
  1461  0784  c1                	POP	BC
  1462  0785  201b              	JR	NZ,SRCH4
  1463  0787  4f                	LD	C,A
  1464  0788  05                	DEC	B		;Bug fix
  1465  0789  b8                	CP	B		;Bug fix
  1466  078a  04                	INC	B		;Bug fix
  1467  078b  3815              	JR	C,SRCH4		;Bug fix
  1468  078d  c5                	PUSH	BC
  1469  078e  d5                	PUSH	DE
  1470  078f  e5                	PUSH	HL
  1471  0790  05                	DEC	B
  1472  0791  2808              	JR	Z,SRCH3		;FOUND !
  1473  0793  13                SRCH2:	INC	DE
  1474  0794  1a                	LD	A,(DE)
  1475  0795  be                	CP	(HL)
  1476  0796  2003              	JR	NZ,SRCH3
  1477  0798  23                	INC	HL
  1478  0799  10f8              	DJNZ	SRCH2
  1479  079b  e1                SRCH3:	POP	HL
  1480  079c  d1                	POP	DE
  1481  079d  c1                	POP	BC
  1482  079e  20dd              	JR	NZ,SRCH1
  1483  07a0  af                	XOR	A		;Z, NC
  1484  07a1  c9                	RET			;FOUND
  1485                          ;
  1486  07a2  f6ff              SRCH4:	OR	0FFH		;NZ, NC
  1487  07a4  c9                	RET			;NOT FOUND
  1488                          ;
  1489                          ;CHR$ - Return character with given ASCII value.
  1490                          ;Result is string.
  1491                          ;
  1492  07a5  cdde01            CHRS:	CALL	ITEMI
  1493  07a8  d9                	EXX
  1494  07a9  7d                	LD	A,L
  1495  07aa  180a              	JR	GET1
  1496                          ;
  1497                          ;GET$ - Return key pressed as string, or read from file
  1498                          ;Result is string.
  1499                          ;
  1500  07ac  cd0000            GETS:	CALL	NXT
  1501  07af  fe23              	CP	'#'
  1502  07b1  2806              	JR	Z,GET2
  1503  07b3  cd0000            	CALL	OSRDCH
  1504  07b6  37                GET1:	SCF
  1505  07b7  185c              	JR	INKEY1
  1506                          ;
  1507  07b9  cd0000            GET2:	CALL	CHNL		;File channel
  1508  07bc  cd0000            	CALL	NXT
  1509  07bf  fe0f              	CP	TBY
  1510  07c1  2804              	JR	Z,GET3
  1511  07c3  feb8              	CP	TTO
  1512  07c5  200c              	JR	NZ,GET4
  1513  07c7  fd23              GET3:	INC	IY
  1514  07c9  f5                	PUSH	AF
  1515  07ca  d5                	PUSH	DE
  1516  07cb  cdde01            	CALL	ITEMI		;Get BY or TO qualifier
  1517  07ce  d9                	EXX
  1518  07cf  44                	LD	B,H
  1519  07d0  4d                	LD	C,L
  1520  07d1  d1                	POP	DE
  1521  07d2  f1                	POP	AF
  1522  07d3  210000            GET4:	LD	HL,ACCS
  1523  07d6  feb8              	CP	TTO
  1524  07d8  2808              	JR	Z,GET5
  1525  07da  51                	LD	D,C		;Maximum count
  1526  07db  010001            	LD	BC,100H		;Default
  1527  07de  fe0f              	CP	TBY
  1528  07e0  2804              	JR	Z,GET6
  1529  07e2  1600              GET5:	LD	D,0
  1530  07e4  cbc8              	SET	1,B		;Flag no count
  1531  07e6  c5                GET6:	PUSH	BC
  1532  07e7  cd0000            	CALL	OSBGET
  1533  07ea  c1                	POP	BC
  1534  07eb  cb48              	BIT	1,B
  1535  07ed  2814              	JR	Z,GET10
  1536  07ef  b9                	CP	C
  1537  07f0  2818              	JR	Z,GET9		;NUL (or supplied term)
  1538  07f2  cb78              	BIT	7,B
  1539  07f4  2008              	JR	NZ,GET7
  1540  07f6  cb40              	BIT	0,B
  1541  07f8  2808              	JR	Z,GET8
  1542  07fa  fe0a              	CP	LF
  1543  07fc  280c              	JR	Z,GET9		;LF
  1544  07fe  fe0d              GET7:	CP	CR
  1545  0800  2808              	JR	Z,GET9		;CR
  1546  0802  b7                GET8:	OR	A
  1547  0803  77                GET10:	LD	(HL),A
  1548  0804  2c                	INC	L
  1549  0805  15                	DEC	D
  1550  0806  3802              	JR	C,GET9		;EOF
  1551  0808  20dc              	JR	NZ,GET6
  1552  080a  eb                GET9:	EX	DE,HL
  1553  080b  3e80              	LD	A,80H
  1554  080d  c9                	RET
  1555                          ;
  1556                          ;INKEY$ - Wait up to n centiseconds for keypress.
  1557                          ; Return key pressed as string or null
  1558                          ; string if time elapsed.
  1559                          ;Result is string.
  1560                          ;
  1561  080e  cdde01            INKEYS:	CALL	ITEMI
  1562  0811  d9                	EXX
  1563  0812  cd0000            	CALL	OSKEY
  1564  0815  110000            INKEY1:	LD	DE,ACCS
  1565  0818  12                	LD	(DE),A
  1566  0819  3e80              	LD	A,80H
  1567  081b  d0                	RET	NC
  1568  081c  1c                	INC	E
  1569  081d  c9                	RET
  1570                          ;
  1571                          ;MID$ - Return sub-string.
  1572                          ;Result is string.
  1573                          ;
  1574  081e  cdba01            MIDS:	CALL	EXPRS
  1575  0821  cd220a            	CALL	COMMA
  1576  0824  cd9909            	CALL	PUSHS		;SAVE STRING ON STACK
  1577  0827  cdb101            	CALL	EXPRI
  1578  082a  c1                	POP	BC
  1579  082b  cdb709            	CALL	POPS
  1580  082e  d9                	EXX
  1581  082f  7d                	LD	A,L
  1582  0830  d9                	EXX
  1583  0831  b7                	OR	A
  1584  0832  280d              	JR	Z,MIDS1
  1585  0834  3d                	DEC	A
  1586  0835  6f                	LD	L,A
  1587  0836  93                	SUB	E
  1588  0837  1e00              	LD	E,0
  1589  0839  3006              	JR	NC,MIDS1
  1590  083b  ed44              	NEG
  1591  083d  4f                	LD	C,A
  1592  083e  cd9d08            	CALL	RIGHT1
  1593  0841  cd0000            MIDS1:	CALL	NXT
  1594  0844  fe2c              	CP	','
  1595  0846  281a              	JR	Z,LEFT1
  1596  0848  cd2e0a            	CALL	BRAKET
  1597  084b  3e80              	LD	A,80H
  1598  084d  c9                	RET
  1599                          ;
  1600                          ;LEFT$ - Return left part of string.
  1601                          ;Carry cleared if entire string returned.
  1602                          ;Result is string.
  1603                          ;
  1604  084e  cdba01            LEFTS:	CALL	EXPRS
  1605  0851  cd0000            	CALL	NXT
  1606  0854  fe2c              	CP	','
  1607  0856  280a              	JR	Z,LEFT1
  1608  0858  cd2e0a            	CALL	BRAKET
  1609  085b  7b                	LD	A,E
  1610  085c  b7                	OR	A
  1611  085d  281a              	JR	Z,LEFT3
  1612  085f  1d                	DEC	E
  1613  0860  1817              	JR	LEFT3
  1614                          ;
  1615  0862  fd23              LEFT1:	INC	IY
  1616  0864  cd9909            	CALL	PUSHS		;SAVE STRING ON STACK
  1617  0867  cdb101            	CALL	EXPRI
  1618  086a  c1                	POP	BC
  1619  086b  cdb709            	CALL	POPS
  1620  086e  cd2e0a            	CALL	BRAKET
  1621  0871  d9                	EXX
  1622  0872  7d                	LD	A,L
  1623  0873  d9                	EXX
  1624  0874  bb                	CP	E
  1625  0875  3002              	JR	NC,LEFT3
  1626  0877  6b                	LD	L,E		;FOR RIGHT$
  1627  0878  5f                LEFT2:	LD	E,A
  1628  0879  3e80              LEFT3:	LD	A,80H		;STRING MARKER
  1629  087b  c9                	RET
  1630                          ;
  1631                          ;RIGHT$ - Return right part of string.
  1632                          ;Result is string.
  1633                          ;
  1634  087c  cdba01            RIGHTS:	CALL	EXPRS
  1635  087f  cd0000            	CALL	NXT
  1636  0882  fe2c              	CP	','
  1637  0884  280c              	JR	Z,RIGHT0
  1638  0886  cd2e0a            	CALL	BRAKET
  1639  0889  7b                	LD	A,E
  1640  088a  b7                	OR	A
  1641  088b  28ec              	JR	Z,LEFT3
  1642  088d  3d                	DEC	A
  1643  088e  0e01              	LD	C,1
  1644  0890  180a              	JR	RIGHT2
  1645                          ;
  1646  0892  cd6208            RIGHT0:	CALL	LEFT1
  1647  0895  d0                	RET	NC
  1648  0896  1c                	INC	E
  1649  0897  1d                	DEC	E
  1650  0898  c8                	RET	Z
  1651  0899  4b                	LD	C,E
  1652  089a  7d                	LD	A,L
  1653  089b  93                	SUB	E
  1654  089c  6f                RIGHT2:	LD	L,A
  1655  089d  0600              RIGHT1:	LD	B,0
  1656  089f  62                	LD	H,D
  1657  08a0  58                	LD	E,B
  1658  08a1  edb0              	LDIR			;MOVE
  1659  08a3  3e80              	LD	A,80H
  1660  08a5  c9                	RET
  1661                          ;
  1662                          ;STRING$ - Return n concatenations of a string.
  1663                          ;Result is string.
  1664                          ;
  1665  08a6  cdb101            STRING:	CALL	EXPRI
  1666  08a9  cd220a            	CALL	COMMA
  1667  08ac  d9                	EXX
  1668  08ad  7d                	LD	A,L
  1669  08ae  d9                	EXX
  1670  08af  f5                	PUSH	AF
  1671  08b0  cdba01            	CALL	EXPRS
  1672  08b3  cd2e0a            	CALL	BRAKET
  1673  08b6  f1                	POP	AF
  1674  08b7  b7                	OR	A
  1675  08b8  28be              	JR	Z,LEFT2		;N=0
  1676  08ba  3d                	DEC	A
  1677  08bb  4f                	LD	C,A
  1678  08bc  3e80              	LD	A,80H		;STRING MARKER
  1679  08be  c8                	RET	Z
  1680  08bf  1c                	INC	E
  1681  08c0  1d                	DEC	E
  1682  08c1  c8                	RET	Z		;NULL STRING
  1683  08c2  43                	LD	B,E
  1684  08c3  62                	LD	H,D
  1685  08c4  2e00              	LD	L,0
  1686  08c6  c5                STRIN1:	PUSH	BC
  1687  08c7  7e                STRIN2:	LD	A,(HL)
  1688  08c8  23                	INC	HL
  1689  08c9  12                	LD	(DE),A
  1690  08ca  1c                	INC	E
  1691  08cb  3e13              	LD	A,19
  1692  08cd  ca0000            	JP	Z,ERROR		;"String too long"
  1693  08d0  10f5              	DJNZ	STRIN2
  1694  08d2  c1                	POP	BC
  1695  08d3  0d                	DEC	C
  1696  08d4  20f0              	JR	NZ,STRIN1
  1697  08d6  3e80              	LD	A,80H
  1698  08d8  c9                	RET
  1699                          ;
  1700                          ;SUBROUTINES
  1701                          ;
  1702                          ;TEST - Test HLH'L' for zero
  1703                          ;  Outputs: Z-flag set & A=0 if zero
  1704                          ; Destroys: A,F
  1705                          ;
  1706  08d9  7c                TEST:	LD	A,H
  1707  08da  b5                	OR	L
  1708  08db  d9                	EXX
  1709  08dc  b4                	OR	H
  1710  08dd  b5                	OR	L
  1711  08de  d9                	EXX
  1712  08df  c9                	RET
  1713                          ;
  1714                          ;DECODE - Decode line number in pseudo-binary.
  1715                          ;   Inputs: IY = Text pointer.
  1716                          ;  Outputs: HL=0, H'L'=line number, C=0.
  1717                          ; Destroys: A,C,H,L,H',L',IY,F
  1718                          ;
  1719  08e0  d9                DECODE:	EXX
  1720  08e1  fd7e00            	LD	A,(IY)
  1721  08e4  fd23              	INC	IY
  1722  08e6  17                	RLA
  1723  08e7  17                	RLA
  1724  08e8  67                	LD	H,A
  1725  08e9  e6c0              	AND	0C0H
  1726  08eb  fdae00            	XOR	(IY)
  1727  08ee  fd23              	INC	IY
  1728  08f0  6f                	LD	L,A
  1729  08f1  7c                	LD	A,H
  1730  08f2  17                	RLA
  1731  08f3  17                	RLA
  1732  08f4  e6c0              	AND	0C0H
  1733  08f6  fdae00            	XOR	(IY)
  1734  08f9  fd23              	INC	IY
  1735  08fb  67                	LD	H,A
  1736  08fc  d9                	EXX
  1737  08fd  af                	XOR	A
  1738  08fe  4f                	LD	C,A
  1739  08ff  67                	LD	H,A
  1740  0900  6f                	LD	L,A
  1741  0901  c9                	RET
  1742                          ;
  1743                          ;HEXSTR - convert numeric value to HEX string.
  1744                          ;   Inputs: HLH'L'C = integer or floating-point number
  1745                          ;  Outputs: String in string accumulator.
  1746                          ;           E = string length. D = ACCS/256
  1747                          ;
  1748  0902  fd23              HEXSTS:	INC	IY		;SKIP TILDE
  1749  0904  cdf801            	CALL	ITEMN
  1750  0907  cd0d09            	CALL	HEXSTR
  1751  090a  3e80              	LD	A,80H
  1752  090c  c9                	RET
  1753                          ;
  1754  090d  cd9605            HEXSTR:	CALL	SFIX
  1755  0910  010800            	LD	BC,8
  1756  0913  110000            	LD	DE,ACCS
  1757  0916  c5                HEXST1:	PUSH	BC
  1758  0917  0604              	LD	B,4
  1759  0919  af                	XOR	A
  1760  091a  d9                HEXST2:	EXX
  1761  091b  29                	ADD	HL,HL
  1762  091c  d9                	EXX
  1763  091d  ed6a              	ADC	HL,HL
  1764  091f  17                	RLA
  1765  0920  10f8              	DJNZ	HEXST2
  1766  0922  c1                	POP	BC
  1767  0923  0d                	DEC	C
  1768  0924  f8                	RET	M
  1769  0925  2806              	JR	Z,HEXST3
  1770  0927  b7                	OR	A
  1771  0928  2003              	JR	NZ,HEXST3
  1772  092a  b8                	CP	B
  1773  092b  28e9              	JR	Z,HEXST1
  1774  092d  c690              HEXST3:	ADD	A,90H
  1775  092f  27                	DAA
  1776  0930  ce40              	ADC	A,40H
  1777  0932  27                	DAA
  1778  0933  12                	LD	(DE),A
  1779  0934  13                	INC	DE
  1780  0935  47                	LD	B,A
  1781  0936  18de              	JR	HEXST1
  1782                          ;
  1783                          ;Function STR - convert numeric value to ASCII string.
  1784                          ;   Inputs: HLH'L'C = integer or floating-point number.
  1785                          ;  Outputs: String in string accumulator.
  1786                          ;           E = length, D = ACCS/256
  1787                          ;           A = 80H (type=string)
  1788                          ;
  1789                          ;First normalise for decimal output:
  1790                          ;
  1791  0938  cd0000            STRS:	CALL	NXT
  1792  093b  fe7e              	CP	'~'
  1793  093d  28c3              	JR	Z,HEXSTS
  1794  093f  cdf801            	CALL	ITEMN
  1795  0942  dd210000          	LD	IX,STAVAR
  1796  0946  dd7e03            	LD	A,(IX+3)
  1797  0949  b7                	OR	A
  1798  094a  dd217209          	LD	IX,G9-1		;G9 FORMAT
  1799  094e  2804              	JR	Z,STR0
  1800  0950  dd210000          STR:	LD	IX,STAVAR
  1801  0954  110000            STR0:	LD	DE,ACCS
  1802  0957  3e25              	LD	A,37
  1803  0959  cd0000            	CALL	FPP
  1804  095c  da0000            	JP	C,ERROR
  1805  095f  ddcb0246          	BIT	0,(IX+2)
  1806  0963  3e80              STR1:	LD	A,80H		;STRING MARKER
  1807  0965  c8                	RET	Z
  1808  0966  79                	LD	A,C
  1809  0967  c604              	ADD	A,4
  1810  0969  bb                STR2:	CP	E
  1811  096a  28f7              	JR	Z,STR1
  1812  096c  eb                	EX	DE,HL
  1813  096d  3620              	LD	(HL),' '	;TRAILING SPACE
  1814  096f  23                	INC	HL
  1815  0970  eb                	EX	DE,HL
  1816  0971  18f6              	JR	STR2
  1817                          ;
  1818  0973  0900              G9:	DEFW	9
  1819                          ;
  1820                          ;STRING COMPARE
  1821                          ;Compare string (DE) length B with string (HL) length C.
  1822                          ;Result preset to false.
  1823                          ;
  1824  0975  cd8209            SCP:	CALL	SCP0
  1825  0978  3e00              ZERO:	LD	A,0
  1826  097a  d9                	EXX
  1827  097b  67                	LD	H,A
  1828  097c  6f                	LD	L,A
  1829  097d  d9                	EXX
  1830  097e  67                	LD	H,A
  1831  097f  6f                	LD	L,A
  1832  0980  4f                	LD	C,A
  1833  0981  c9                	RET
  1834                          ;
  1835  0982  04                SCP0:	INC	B
  1836  0983  0c                	INC	C
  1837  0984  05                SCP1:	DEC	B
  1838  0985  280a              	JR	Z,SCP2
  1839  0987  0d                	DEC	C
  1840  0988  280c              	JR	Z,SCP3
  1841  098a  1a                	LD	A,(DE)
  1842  098b  be                	CP	(HL)
  1843  098c  c0                	RET	NZ
  1844  098d  13                	INC	DE
  1845  098e  23                	INC	HL
  1846  098f  18f3              	JR	SCP1
  1847  0991  b7                SCP2:	OR	A
  1848  0992  0d                	DEC	C
  1849  0993  c8                	RET	Z
  1850  0994  37                	SCF
  1851  0995  c9                	RET
  1852  0996  b7                SCP3:	OR	A
  1853  0997  0c                	INC	C
  1854  0998  c9                	RET
  1855                          ;
  1856                          ;PUSH$ - SAVE STRING ON STACK.
  1857                          ;   Inputs: String in string accumulator.
  1858                          ;           E = string length.
  1859                          ;           A - saved on stack.
  1860                          ; Destroys: B,C,D,E,H,L,IX,SP,F
  1861                          ;
  1862  0999  210000            PUSHS:	LD	HL,ACCS
  1863  099c  cd0000            	CALL	CHECK
  1864  099f  dde1              	POP	IX		;RETURN ADDRESS
  1865  09a1  b7                	OR	A		;CLEAR CARRY
  1866  09a2  54                	LD	D,H
  1867  09a3  4b                	LD	C,E
  1868  09a4  ed52              	SBC	HL,DE
  1869  09a6  39                	ADD	HL,SP
  1870  09a7  f9                	LD	SP,HL
  1871  09a8  47                	LD	B,A
  1872  09a9  c5                	PUSH	BC
  1873  09aa  2809              	JR	Z,PUSHS1	;ZERO LENGTH
  1874  09ac  eb                	EX	DE,HL
  1875  09ad  0600              	LD	B,0
  1876  09af  68                	LD	L,B		;L=0
  1877  09b0  edb0              	LDIR			;COPY TO STACK
  1878  09b2  cd0000            	CALL	CHECK
  1879  09b5  dde9              PUSHS1:	JP	(IX)		;"RETURN"
  1880                          ;
  1881                          ;POP$ - RESTORE STRING FROM STACK.
  1882                          ;   Inputs: C = string length.
  1883                          ;  Outputs: String in string accumulator.
  1884                          ;           E = string length.
  1885                          ; Destroys: B,C,D,E,H,L,IX,SP,F
  1886                          ;
  1887  09b7  dde1              POPS:	POP	IX		;RETURN ADDRESS
  1888  09b9  210000            	LD	HL,0
  1889  09bc  44                	LD	B,H		;B=0
  1890  09bd  39                	ADD	HL,SP
  1891  09be  110000            	LD	DE,ACCS
  1892  09c1  0c                	INC	C
  1893  09c2  0d                	DEC	C
  1894  09c3  2802              	JR	Z,POPS1		;ZERO LENGTH
  1895  09c5  edb0              	LDIR			;COPY FROM STACK
  1896  09c7  f9                POPS1:	LD	SP,HL
  1897  09c8  dde9              	JP	(IX)		;"RETURN"
  1898                          ;
  1899  09ca  fd7e00            BINDIG:	LD	A,(IY)
  1900  09cd  fe30              	CP	'0'
  1901  09cf  d8                	RET	C
  1902  09d0  fe32              	CP	'1'+1
  1903  09d2  3f                	CCF
  1904  09d3  d8                	RET	C
  1905  09d4  d630              	SUB	'0'
  1906  09d6  c9                	RET
  1907                          ;
  1908  09d7  fd7e00            HEXDIG:	LD	A,(IY)
  1909  09da  fe30              	CP	'0'
  1910  09dc  d8                	RET	C
  1911  09dd  fe3a              	CP	'9'+1
  1912  09df  3f                	CCF
  1913  09e0  d0                	RET	NC
  1914  09e1  fe41              	CP	'A'
  1915  09e3  d8                	RET	C
  1916  09e4  d637              	SUB	'A'-10
  1917  09e6  fe10              	CP	16
  1918  09e8  3f                	CCF
  1919  09e9  c9                	RET
  1920                          ;
  1921  09ea  fe3e              RELOPQ:	CP	'>'
  1922  09ec  d0                	RET	NC
  1923  09ed  fe3d              	CP	'='
  1924  09ef  d0                	RET	NC
  1925  09f0  fe3c              	CP	'<'
  1926  09f2  c9                	RET
  1927                          ;
  1928  09f3  fd23              SAVE:	INC	IY
  1929  09f5  e60f              	AND	0FH
  1930  09f7  08                SAVE1:	EX	AF,AF'
  1931  09f8  faec01            	JP	M,MISMAT
  1932  09fb  08                	EX	AF,AF'
  1933  09fc  e3                	EX	(SP),HL
  1934  09fd  d9                	EXX
  1935  09fe  e5                	PUSH	HL
  1936  09ff  d9                	EXX
  1937  0a00  f5                	PUSH	AF
  1938  0a01  c5                	PUSH	BC
  1939  0a02  e9                	JP	(HL)
  1940                          ;
  1941  0a03  08                DOIT:	EX	AF,AF'
  1942  0a04  faec01            	JP	M,MISMAT
  1943  0a07  d9                	EXX
  1944  0a08  c1                	POP	BC		;RETURN ADDRESS
  1945  0a09  d9                	EXX
  1946  0a0a  79                	LD	A,C
  1947  0a0b  c1                	POP	BC
  1948  0a0c  47                	LD	B,A
  1949  0a0d  f1                	POP	AF		;OPERATOR
  1950  0a0e  d9                	EXX
  1951  0a0f  eb                	EX	DE,HL
  1952  0a10  e1                	POP	HL
  1953  0a11  d9                	EXX
  1954  0a12  eb                	EX	DE,HL
  1955  0a13  e1                	POP	HL
  1956  0a14  d9                	EXX
  1957  0a15  c5                	PUSH	BC
  1958  0a16  d9                	EXX
  1959  0a17  cd0000            	CALL	FPP
  1960  0a1a  381c              	JR	C,ERROR1
  1961  0a1c  af                	XOR	A
  1962  0a1d  08                	EX	AF,AF'		;TYPE
  1963  0a1e  fd7e00            	LD	A,(IY)
  1964  0a21  c9                	RET
  1965                          ;
  1966  0a22  cd0000            COMMA:	CALL	NXT
  1967  0a25  fd23              	INC	IY
  1968  0a27  fe2c              	CP	','
  1969  0a29  c8                	RET	Z
  1970  0a2a  3e05              	LD	A,5
  1971  0a2c  180a              	JR	ERROR1		;"Missing ,"
  1972                          ;
  1973  0a2e  cd0000            BRAKET:	CALL	NXT
  1974  0a31  fd23              	INC	IY
  1975  0a33  fe29              	CP	')'
  1976  0a35  c8                	RET	Z
  1977  0a36  3e1b              	LD	A,27
  1978  0a38  c30000            ERROR1:	JP	ERROR		;"Missing )"
  1979                          ;
  1980  0a3b  e5                DISPT2:	PUSH	HL
  1981  0a3c  217400            	LD	HL,SOPTBL
  1982  0a3f  1806              	JR	DISPT0
  1983                          ;
  1984  0a41  e5                DISPAT:	PUSH	HL
  1985  0a42  d68d              	SUB	FUNTOK
  1986  0a44  210000            	LD	HL,FUNTBL
  1987  0a47  c5                DISPT0:	PUSH	BC
  1988  0a48  87                	ADD	A,A
  1989  0a49  4f                	LD	C,A
  1990  0a4a  0600              	LD	B,0
  1991  0a4c  09                	ADD	HL,BC
  1992  0a4d  7e                	LD	A,(HL)
  1993  0a4e  23                	INC	HL
  1994  0a4f  66                	LD	H,(HL)
  1995  0a50  6f                	LD	L,A
  1996  0a51  c1                	POP	BC
  1997  0a52  e3                	EX	(SP),HL
  1998  0a53  c9                	RET			;OFF TO ROUTINE
  1999                          ;
  2000  0a54  7a                STOREA:	LD	A,D
  2001  0a55  d5                	PUSH	DE
  2002  0a56  e5                	PUSH	HL
  2003  0a57  dde3              	EX	(SP),IX
  2004  0a59  b7                	OR	A
  2005  0a5a  fa6b0a            	JP	M,STORA1
  2006  0a5d  cda302            	CALL	LOADN
  2007  0a60  dde3              	EX	(SP),IX
  2008  0a62  cd0000            	CALL	MODIFY
  2009  0a65  e1                	POP	HL
  2010  0a66  d1                	POP	DE
  2011  0a67  4a                	LD	C,D
  2012  0a68  0600              	LD	B,0
  2013  0a6a  c9                	RET
  2014                          ;
  2015  0a6b  d5                STORA1:	PUSH	DE
  2016  0a6c  cd8b03            	CALL	LOADS
  2017  0a6f  e1                	POP	HL
  2018  0a70  dde3              	EX	(SP),IX
  2019  0a72  cd0000            	CALL	MODIFS
  2020  0a75  e1                	POP	HL
  2021  0a76  d1                	POP	DE
  2022  0a77  010400            	LD	BC,4
  2023  0a7a  c9                	RET
  2024                          ;
  2025                          ; Assign to whole array:
  2026                          ; array1() = array expression
  2027                          ; array1() = n1,n2,n3,n4...
  2028                          ; array1() = n (n copied into all elements)
  2029                          ;
  2030                          ; Inputs: D = type (65, 68, 69, 193)
  2031                          ;         E = opcode ('=' for store, '+','-' etc. for modify)
  2032                          ;         HL = IX = VARPTR
  2033                          ;         IY = text pointer
  2034                          ;
  2035  0a7b  cbb2              LETARR:	RES	6,D		;Lose array marker
  2036  0a7d  d5                	PUSH	DE		;Save type & opcode
  2037  0a7e  cd4a03            	CALL	GETAR1		;Get and check indirect link
  2038  0a81  cd2103            	CALL	ARRLEN		;DE = elements, HL addresses first
  2039  0a84  c1                	POP	BC
  2040  0a85  78                	LD	A,B		;A = type
  2041  0a86  d5                	PUSH	DE
  2042  0a87  c5                	PUSH	BC
  2043  0a88  e5                	PUSH	HL
  2044  0a89  cd0000            	CALL	X14OR5		;DE = size in bytes
  2045  0a8c  42                	LD	B,D
  2046  0a8d  4b                	LD	C,E
  2047  0a8e  dde1              	POP	IX
  2048  0a90  d1                	POP	DE
  2049                          ;
  2050                          ; (SP) = number of elements
  2051                          ; BC = size in bytes
  2052                          ; DE = type & opcode
  2053                          ; IX = address of first element
  2054                          ;
  2055                          ; allocate space on stack and zero it:
  2056                          ;
  2057  0a91  af                	XOR	A		;Clear carry and zero error code
  2058  0a92  ed62              	SBC	HL,HL
  2059  0a94  39                	ADD	HL,SP		;HL = SP
  2060  0a95  ed42              	SBC	HL,BC
  2061  0a97  389f              	JR	C,ERROR1	;'No room'
  2062  0a99  c5                	PUSH	BC
  2063  0a9a  ed4b0000          	LD	BC,(FREE)
  2064  0a9e  04                	INC	B		;Safety margin
  2065  0a9f  ed42              	SBC	HL,BC
  2066  0aa1  09                	ADD	HL,BC
  2067  0aa2  c1                	POP	BC
  2068  0aa3  3893              	JR	C,ERROR1	;'No room'
  2069  0aa5  f9                	LD	SP,HL
  2070  0aa6  3600              LETA0:	LD	(HL),0
  2071  0aa8  23                	INC	HL
  2072  0aa9  0b                	DEC	BC
  2073  0aaa  78                	LD	A,B
  2074  0aab  b1                	OR	C
  2075  0aac  20f8              	JR	NZ,LETA0	;Clear allocated stack
  2076  0aae  4e                	LD	C,(HL)
  2077  0aaf  23                	INC	HL
  2078  0ab0  46                	LD	B,(HL)
  2079  0ab1  67                	LD	H,A
  2080  0ab2  6f                	LD	L,A
  2081  0ab3  39                	ADD	HL,SP
  2082                          ;
  2083                          ;	CALL	NXT
  2084                          ;	CP	TEVAL		;;EVAL not currently supported
  2085                          ;
  2086  0ab4  cdbc0a            	CALL	EXPRA
  2087  0ab7  f9                	LD	SP,HL		;Update stack pointer
  2088  0ab8  c1                	POP	BC		;Level stack
  2089  0ab9  c30000            	JP	XEQ
  2090                          ;
  2091                          ; EXPRA - Evaluate array expression, strictly left-to-right;
  2092                          ; Note: String array arithmetic (concatenation) is not supported
  2093                          ; because it would require a way of recovering freed string space.
  2094                          ;
  2095                          ;   Inputs: BC = number of elements
  2096                          ;           DE = type & opcode
  2097                          ;           HL = address of temporary stack space
  2098                          ;           IX = address of first element of array
  2099                          ;  Outputs: HL = value to set stack pointer to
  2100                          ;
  2101  0abc  3e3d              EXPRA:	LD	A,'='
  2102  0abe  fd2b              	DEC	IY
  2103  0ac0  fd23              EXPRA1:	INC	IY
  2104  0ac2  d5                	PUSH	DE
  2105  0ac3  c5                	PUSH	BC
  2106  0ac4  e5                	PUSH	HL
  2107  0ac5  dde5              	PUSH	IX
  2108  0ac7  5f                	LD	E,A		;Operator
  2109  0ac8  cd360b            	CALL	ITEMA
  2110  0acb  dde1              	POP	IX
  2111  0acd  e1                	POP	HL
  2112  0ace  c1                	POP	BC
  2113  0acf  d1                	POP	DE
  2114  0ad0  cd0000            	CALL	NXT
  2115  0ad3  fe2c              	CP	','		;List?
  2116  0ad5  2813              	JR	Z,EXPRA3
  2117  0ad7  cd0000            	CALL	TERMQ
  2118  0ada  20e4              	JR	NZ,EXPRA1
  2119                          ;
  2120                          ; Update destination array from stack:
  2121                          ;
  2122  0adc  c5                EXPRA2:	PUSH	BC
  2123  0add  cd540a            	CALL	STOREA		;(IX) <- (HL)
  2124  0ae0  09                	ADD	HL,BC
  2125  0ae1  dd09              	ADD	IX,BC
  2126  0ae3  c1                	POP	BC
  2127  0ae4  0b                	DEC	BC
  2128  0ae5  78                	LD	A,B
  2129  0ae6  b1                	OR	C
  2130  0ae7  20f3              	JR	NZ,EXPRA2
  2131  0ae9  c9                	RET
  2132                          ;
  2133                          ; Update destination array from list (n.b. not transferred via stack):
  2134                          ;
  2135  0aea  c5                EXPRA3:	PUSH	BC
  2136  0aeb  cd540a            	CALL	STOREA		;(IX) <- (HL)
  2137  0aee  fd23              EXPRA4:	INC	IY		;Bump past comma
  2138  0af0  09                	ADD	HL,BC
  2139  0af1  dd09              	ADD	IX,BC
  2140  0af3  c1                	POP	BC
  2141  0af4  0b                	DEC	BC
  2142  0af5  78                	LD	A,B
  2143  0af6  b1                	OR	C
  2144  0af7  c8                	RET	Z
  2145  0af8  c5                	PUSH	BC
  2146  0af9  d5                	PUSH	DE
  2147  0afa  e5                	PUSH	HL
  2148  0afb  dde5              	PUSH	IX
  2149  0afd  cb7a              	BIT	7,D
  2150  0aff  200e              	JR	NZ,EXPRA5
  2151  0b01  d5                	PUSH	DE
  2152  0b02  cdaa01            	CALL	EXPRN
  2153  0b05  d1                	POP	DE
  2154  0b06  dde1              	POP	IX
  2155  0b08  dde5              	PUSH	IX
  2156  0b0a  cd0000            	CALL	MODIFY
  2157  0b0d  180c              	JR	EXPRA6
  2158                          ;
  2159  0b0f  d5                EXPRA5:	PUSH	DE
  2160  0b10  cdba01            	CALL	EXPRS
  2161  0b13  e1                	POP	HL
  2162  0b14  dde1              	POP	IX
  2163  0b16  dde5              	PUSH	IX
  2164  0b18  cd0000            	CALL	MODIFS
  2165  0b1b  dde1              EXPRA6:	POP	IX
  2166  0b1d  e1                	POP	HL
  2167  0b1e  d1                	POP	DE
  2168  0b1f  010400            	LD	BC,4
  2169  0b22  cb7a              	BIT	7,D
  2170  0b24  2001              	JR	NZ,EXPRA7
  2171  0b26  4a                	LD	C,D
  2172  0b27  cd0000            EXPRA7:	CALL	NXT
  2173  0b2a  fe2c              	CP	','
  2174  0b2c  28c0              	JR	Z,EXPRA4
  2175  0b2e  d1                	POP	DE
  2176  0b2f  09                EXPRA8:	ADD	HL,BC		;Skip remaining elements
  2177  0b30  1b                	DEC	DE
  2178  0b31  7a                	LD	A,D
  2179  0b32  b3                	OR	E
  2180  0b33  20fa              	JR	NZ,EXPRA8
  2181  0b35  c9                	RET
  2182                          ;
  2183                          ; ITEMA: evaluate and operate on array item
  2184                          ;   Inputs: D = type
  2185                          ;           E = operator ('=' for first item)
  2186                          ;           BC = number of elements
  2187                          ;           HL = pointer to destination on stack
  2188                          ;           IY = text pointer
  2189                          ;  Outputs: IY updated
  2190                          ; Destroys: Everything except SP
  2191                          ;
  2192  0b36  cd0000            ITEMA:	CALL	NXT
  2193  0b39  e5                	PUSH	HL		;Pointer to destination
  2194  0b3a  c5                	PUSH	BC		;Number of elements
  2195  0b3b  fde5              	PUSH	IY		;In case normal expression
  2196  0b3d  d5                	PUSH	DE		;Ditto
  2197  0b3e  fe2d              	CP	'-'
  2198  0b40  200c              	JR	NZ,ITEMA1	;Not unary minus
  2199  0b42  7b                	LD	A,E
  2200  0b43  fe3d              	CP	'='
  2201  0b45  2007              	JR	NZ,ITEMA1	;Not unary minus
  2202  0b47  fd23              	INC	IY		;Bump past '-'
  2203  0b49  cd0000            	CALL	NXT
  2204  0b4c  1e2d              	LD	E,'-'		;Unary minus
  2205  0b4e  d5                ITEMA1:	PUSH	DE		;Type and operator
  2206  0b4f  cd0000            	CALL	GETVAR
  2207  0b52  d1                	POP	DE		;Type & operator
  2208  0b53  2056              	JR	NZ,ITEMA4	;Non-array expression
  2209  0b55  cb77              	BIT	6,A
  2210  0b57  2852              	JR	Z,ITEMA4	;Not a whole array
  2211  0b59  c1                	POP	BC		;Junk saved original op
  2212  0b5a  c1                	POP	BC		;Junk saved text pointer
  2213  0b5b  cbb7              	RES	6,A
  2214  0b5d  ba                	CP	D
  2215  0b5e  c2ec01            	JP	NZ,MISMAT	;'Type mismatch'
  2216  0b61  d5                	PUSH	DE		;Save type & operator again
  2217  0b62  cd4a03            	CALL	GETAR1
  2218  0b65  cd2103            	CALL	ARRLEN
  2219  0b68  42                	LD	B,D		;BC = number of elements
  2220  0b69  4b                	LD	C,E
  2221  0b6a  d1                	POP	DE		;Restore type & operator
  2222  0b6b  e3                	EX	(SP),HL
  2223  0b6c  cd0000            	CALL	NXT
  2224  0b6f  dde1              	POP	IX		;Pointer to source
  2225  0b71  fe2e              	CP	'.'
  2226  0b73  ca030c            	JP	Z,ARRDOT	;Dot product
  2227  0b76  b7                	OR	A
  2228  0b77  ed42              	SBC	HL,BC		;Same number of elements?
  2229  0b79  c2ec01            	JP	NZ,MISMAT	;'Type mismatch'
  2230  0b7c  e1                	POP	HL		;Pointer to destination
  2231  0b7d  cb7a              	BIT	7,D
  2232  0b7f  201d              	JR	NZ,ITEMA3
  2233                          ;
  2234                          ; Process numeric array item:
  2235                          ;
  2236  0b81  c5                ITEMA2:	PUSH	BC
  2237  0b82  e5                	PUSH	HL
  2238  0b83  7a                	LD	A,D
  2239  0b84  cda302            	CALL	LOADN
  2240  0b87  dde3              	EX	(SP),IX
  2241  0b89  d5                	PUSH	DE
  2242  0b8a  cd0000            	CALL	MODIFY
  2243  0b8d  d1                	POP	DE
  2244  0b8e  dde3              	EX	(SP),IX
  2245  0b90  e1                	POP	HL
  2246  0b91  4a                	LD	C,D
  2247  0b92  0600              	LD	B,0
  2248  0b94  dd09              	ADD	IX,BC
  2249  0b96  09                	ADD	HL,BC
  2250  0b97  c1                	POP	BC
  2251  0b98  0b                	DEC	BC
  2252  0b99  78                	LD	A,B
  2253  0b9a  b1                	OR	C
  2254  0b9b  20e4              	JR	NZ,ITEMA2
  2255  0b9d  c9                	RET
  2256                          ;
  2257                          ; Process string array item (just copy descriptors):
  2258                          ;
  2259  0b9e  eb                ITEMA3:	EX	DE,HL		;DE = destination
  2260  0b9f  60                	LD	H,B
  2261  0ba0  69                	LD	L,C
  2262  0ba1  29                	ADD	HL,HL
  2263  0ba2  29                	ADD	HL,HL
  2264  0ba3  44                	LD	B,H
  2265  0ba4  4d                	LD	C,L
  2266  0ba5  dde5              	PUSH	IX
  2267  0ba7  e1                	POP	HL		;HL = source
  2268  0ba8  edb0              	LDIR
  2269  0baa  c9                	RET
  2270                          ;
  2271                          ; Process numeric non-array item:
  2272                          ;
  2273  0bab  d1                ITEMA4:	POP	DE		;Restore original operator
  2274  0bac  fde1              	POP	IY		;Restore original text pointer
  2275  0bae  cb7a              	BIT	7,D
  2276  0bb0  2028              	JR	NZ,ITEMA5
  2277  0bb2  d5                	PUSH	DE
  2278  0bb3  cd8901            	CALL	EXPR45		;; should be EXP345
  2279  0bb6  79                	LD	A,C		;Exponent
  2280  0bb7  d1                	POP	DE		;Type / operator
  2281  0bb8  c1                	POP	BC		;Count
  2282  0bb9  dde1              	POP	IX
  2283  0bbb  e5                ITEMA7:	PUSH	HL
  2284  0bbc  c5                	PUSH	BC
  2285  0bbd  d5                	PUSH	DE
  2286  0bbe  d9                	EXX
  2287  0bbf  e5                	PUSH	HL
  2288  0bc0  d9                	EXX
  2289  0bc1  f5                	PUSH	AF
  2290  0bc2  4f                	LD	C,A
  2291  0bc3  cd0000            	CALL	MODIFY
  2292  0bc6  f1                	POP	AF
  2293  0bc7  d9                	EXX
  2294  0bc8  e1                	POP	HL
  2295  0bc9  d9                	EXX
  2296  0bca  d1                	POP	DE
  2297  0bcb  4a                	LD	C,D
  2298  0bcc  0600              	LD	B,0
  2299  0bce  dd09              	ADD	IX,BC
  2300  0bd0  c1                	POP	BC
  2301  0bd1  0b                	DEC	BC
  2302  0bd2  ed62              	SBC	HL,HL
  2303  0bd4  ed42              	SBC	HL,BC
  2304  0bd6  e1                	POP	HL
  2305  0bd7  20e2              	JR	NZ,ITEMA7	;Copy into every element!
  2306  0bd9  c9                	RET
  2307                          ;
  2308                          ; Process string non-array item:
  2309                          ;
  2310  0bda  cdba01            ITEMA5:	CALL	EXPRS
  2311  0bdd  7b                	LD	A,E
  2312  0bde  b7                	OR	A
  2313  0bdf  280b              	JR	Z,ITEMA0
  2314  0be1  210000            	LD	HL,ACCS
  2315  0be4  110000            	LD	DE,BUFFER
  2316  0be7  4f                	LD	C,A
  2317  0be8  0600              	LD	B,0
  2318  0bea  edb0              	LDIR
  2319  0bec  c1                ITEMA0:	POP	BC
  2320  0bed  dde1              	POP	IX
  2321  0bef  d9                	EXX
  2322  0bf0  6f                	LD	L,A
  2323  0bf1  d9                	EXX
  2324  0bf2  110400            	LD	DE,4
  2325  0bf5  210000            	LD	HL,BUFFER
  2326  0bf8  cd0000            ITEMA6:	CALL	STORE4
  2327  0bfb  dd19              	ADD	IX,DE
  2328  0bfd  0b                	DEC	BC
  2329  0bfe  78                	LD	A,B
  2330  0bff  b1                	OR	C
  2331  0c00  20f6              	JR	NZ,ITEMA6	;Copy into every element!
  2332  0c02  c9                	RET
  2333                          ;
  2334                          ; Array dot-product:
  2335                          ;
  2336  0c03  fd23              ARRDOT:	INC	IY		;Bump past dot
  2337  0c05  7a                	LD	A,D		;Type
  2338  0c06  b7                	OR	A
  2339  0c07  faec01            	JP	M,MISMAT	;'Type mismatch'
  2340  0c0a  eb                	EX	DE,HL
  2341  0c0b  e1                	POP	HL
  2342                          ;
  2343                          ; A = type
  2344                          ; DE = no. of elements in destination array (outer loop counter)
  2345                          ; IX = pointer to first source array data
  2346                          ; HL = pointer to destination data
  2347                          ; IY = text pointer
  2348                          ;
  2349  0c0c  d5                	PUSH	DE
  2350  0c0d  e5                	PUSH	HL
  2351  0c0e  dde5              	PUSH	IX
  2352  0c10  f5                	PUSH	AF
  2353  0c11  cd3a03            	CALL	GETARR
  2354  0c14  cd2103            	CALL	ARRLEN
  2355  0c17  f1                	POP	AF
  2356  0c18  eb                	EX	DE,HL
  2357  0c19  dd6e00            	LD	L,(IX)
  2358  0c1c  dd6601            	LD	H,(IX+1)	;Indirect pointer
  2359  0c1f  6e                	LD	L,(HL)		;No. of dimensions
  2360  0c20  2d                	DEC	L
  2361  0c21  eb                	EX	DE,HL
  2362  0c22  dde1              	POP	IX
  2363  0c24  c1                	POP	BC
  2364  0c25  d1                	POP	DE
  2365                          ;
  2366  0c26  fde5              	PUSH	IY		;Save text pointer
  2367  0c28  c5                	PUSH	BC		;Save destination pointer
  2368  0c29  e5                	PUSH	HL
  2369  0c2a  fde1              	POP	IY
  2370                          ;
  2371                          ; Get row counts:
  2372                          ;
  2373  0c2c  210100            	LD	HL,1
  2374  0c2f  2806              	JR	Z,ARR1D
  2375  0c31  fd66ff            	LD	H,(IY-1)
  2376  0c34  fd6efe            	LD	L,(IY-2)
  2377  0c37  d5                ARR1D:	PUSH	DE
  2378  0c38  eb                	EX	DE,HL
  2379  0c39  cd0000            	CALL	X14OR5
  2380  0c3c  eb                	EX	DE,HL
  2381  0c3d  d1                	POP	DE
  2382  0c3e  dd46ff            	LD	B,(IX-1)
  2383  0c41  dd4efe            	LD	C,(IX-2)
  2384                          ;
  2385                          ; A = type, Z-flag set if first array is one-dimensional
  2386                          ; BC = no. of rows of first source array (inner loop counter)
  2387                          ; DE = no. of elements in destination array (outer loop counter)
  2388                          ; HL = no. of rows of second source array * size of each element
  2389                          ; IX = pointer to first source array
  2390                          ; IY = pointer to second source array
  2391                          ; (SP) = pointer to destination data
  2392                          ;
  2393                          ; Dot-product outer loop:
  2394                          ;
  2395  0c44  c5                OUTER:	PUSH	BC		;1
  2396  0c45  d5                	PUSH	DE		;2
  2397  0c46  e5                	PUSH	HL		;3
  2398  0c47  dde5              	PUSH	IX		;4
  2399  0c49  fde5              	PUSH	IY		;5
  2400  0c4b  50                	LD	D,B
  2401  0c4c  59                	LD	E,C
  2402  0c4d  f5                	PUSH	AF
  2403  0c4e  cd7809            	CALL	ZERO		;Zero accumulator
  2404  0c51  f1                	POP	AF
  2405  0c52  d5                INNER:	PUSH	DE		;6
  2406  0c53  c5                	PUSH	BC		;Save accumulator
  2407  0c54  e5                	PUSH	HL
  2408  0c55  d9                	EXX
  2409  0c56  e5                	PUSH	HL
  2410  0c57  d9                	EXX
  2411                          ;
  2412  0c58  cda302            	CALL	LOADN		;Load from (IX)
  2413  0c5b  dde5              	PUSH	IX
  2414  0c5d  fde3              	EX	(SP),IY
  2415  0c5f  dde1              	POP	IX
  2416                          ;
  2417  0c61  cd6403            	CALL	DLOADN		;Load from (IY)
  2418  0c64  dde5              	PUSH	IX
  2419  0c66  fde3              	EX	(SP),IY
  2420  0c68  dde1              	POP	IX
  2421                          ;
  2422  0c6a  f5                	PUSH	AF
  2423  0c6b  3e0a              	LD	A,10
  2424  0c6d  cd0000            	CALL	FPP		;Multiply
  2425  0c70  da0000            	JP	C,ERROR
  2426  0c73  f1                	POP	AF
  2427                          ;
  2428  0c74  d9                	EXX			;Restore accumulator
  2429  0c75  eb                	EX	DE,HL
  2430  0c76  e1                	POP	HL
  2431  0c77  d9                	EXX
  2432  0c78  eb                	EX	DE,HL
  2433  0c79  e1                	POP	HL
  2434  0c7a  08                	EX	AF,AF'
  2435  0c7b  79                	LD	A,C
  2436  0c7c  c1                	POP	BC
  2437  0c7d  47                	LD	B,A
  2438  0c7e  08                	EX	AF,AF'
  2439                          ;
  2440  0c7f  f5                	PUSH	AF
  2441  0c80  3e0b              	LD	A,11
  2442  0c82  cd0000            	CALL	FPP		;Accumulate
  2443  0c85  da0000            	JP	C,ERROR
  2444  0c88  f1                	POP	AF
  2445                          ;
  2446                          ; Bump pointers:
  2447                          ;
  2448  0c89  d1                	POP	DE		;5
  2449                          ;
  2450  0c8a  d9                	EXX
  2451  0c8b  4f                	LD	C,A
  2452  0c8c  0600              	LD	B,0
  2453  0c8e  dd09              	ADD	IX,BC
  2454  0c90  d1                	POP	DE
  2455  0c91  c1                	POP	BC
  2456  0c92  e3                	EX	(SP),HL
  2457  0c93  eb                	EX	DE,HL
  2458  0c94  fd19              	ADD	IY,DE
  2459  0c96  eb                	EX	DE,HL
  2460  0c97  e3                	EX	(SP),HL
  2461  0c98  c5                	PUSH	BC
  2462  0c99  d5                	PUSH	DE
  2463  0c9a  d9                	EXX
  2464                          ;
  2465                          ; Count inner loops:
  2466                          ;
  2467  0c9b  1b                	DEC	DE		;Inner loop counter
  2468  0c9c  1c                	INC	E
  2469  0c9d  1d                	DEC	E
  2470  0c9e  20b2              	JR	NZ,INNER
  2471  0ca0  14                	INC	D
  2472  0ca1  15                	DEC	D
  2473  0ca2  20ae              	JR	NZ,INNER
  2474                          ;
  2475  0ca4  fde1              	POP	IY		;4
  2476  0ca6  dde1              	POP	IX		;3
  2477                          ;
  2478                          ; Swap pointers:
  2479                          ;
  2480  0ca8  d9                	EXX
  2481  0ca9  08                	EX	AF,AF'
  2482  0caa  f1                	POP	AF
  2483  0cab  c1                	POP	BC
  2484  0cac  d1                	POP	DE
  2485  0cad  dde3              	EX	(SP),IX
  2486  0caf  d5                	PUSH	DE
  2487  0cb0  c5                	PUSH	BC
  2488  0cb1  f5                	PUSH	AF
  2489  0cb2  08                	EX	AF,AF'
  2490  0cb3  d9                	EXX
  2491                          ;
  2492                          ; Save to destination array and bump pointer:
  2493                          ;
  2494  0cb4  f5                	PUSH	AF
  2495  0cb5  d5                	PUSH	DE
  2496  0cb6  cd0000            	CALL	STOREN
  2497  0cb9  d1                	POP	DE
  2498  0cba  f1                	POP	AF
  2499  0cbb  4f                	LD	C,A
  2500  0cbc  0600              	LD	B,0
  2501  0cbe  dd09              	ADD	IX,BC
  2502                          ;
  2503                          ; Swap pointers:
  2504                          ;
  2505  0cc0  d9                	EXX
  2506  0cc1  08                	EX	AF,AF'
  2507  0cc2  f1                	POP	AF
  2508  0cc3  c1                	POP	BC
  2509  0cc4  d1                	POP	DE
  2510  0cc5  dde3              	EX	(SP),IX
  2511  0cc7  d5                	PUSH	DE
  2512  0cc8  c5                	PUSH	BC
  2513  0cc9  f5                	PUSH	AF
  2514  0cca  08                	EX	AF,AF'
  2515  0ccb  d9                	EXX
  2516                          ;
  2517  0ccc  e1                	POP	HL		;2
  2518  0ccd  d1                	POP	DE		;1 Outer loop counter
  2519  0cce  c1                	POP	BC		;0
  2520  0ccf  1b                	DEC	DE		;Count outer loops
  2521                          ;
  2522                          ; Adjust IX & IY
  2523                          ;
  2524  0cd0  c5                	PUSH	BC
  2525  0cd1  d5                	PUSH	DE
  2526  0cd2  e5                	PUSH	HL
  2527  0cd3  4f                	LD	C,A
  2528  0cd4  0600              	LD	B,0
  2529  0cd6  fd09              	ADD	IY,BC
  2530  0cd8  f5                	PUSH	AF
  2531  0cd9  e5                	PUSH	HL
  2532  0cda  cd0000            	CALL	X14OR5
  2533  0cdd  c1                	POP	BC
  2534  0cde  cd100d            	CALL	MOD16
  2535  0ce1  f1                	POP	AF
  2536  0ce2  b7                	OR	A
  2537  0ce3  010000            	LD	BC,0
  2538  0ce6  ed42              	SBC	HL,BC
  2539  0ce8  e1                	POP	HL
  2540  0ce9  d1                	POP	DE
  2541  0cea  c1                	POP	BC
  2542  0ceb  2015              	JR	NZ,MODNZ
  2543  0ced  d5                	PUSH	DE
  2544  0cee  e5                	PUSH	HL
  2545  0cef  eb                	EX	DE,HL
  2546  0cf0  fde5              	PUSH	IY
  2547  0cf2  e1                	POP	HL
  2548  0cf3  b7                	OR	A
  2549  0cf4  ed52              	SBC	HL,DE
  2550  0cf6  e5                	PUSH	HL
  2551  0cf7  fde1              	POP	IY
  2552  0cf9  50                	LD	D,B
  2553  0cfa  59                	LD	E,C
  2554  0cfb  cd0000            	CALL	X14OR5
  2555  0cfe  dd19              	ADD	IX,DE
  2556  0d00  e1                	POP	HL
  2557  0d01  d1                	POP	DE
  2558                          MODNZ:
  2559                          ;
  2560                          ; Count outer loops:
  2561                          ;
  2562  0d02  1c                	INC	E
  2563  0d03  1d                	DEC	E
  2564  0d04  c2440c            	JP	NZ,OUTER
  2565  0d07  14                	INC	D
  2566  0d08  15                	DEC	D
  2567  0d09  c2440c            	JP	NZ,OUTER
  2568                          ;
  2569                          ; Exit:
  2570                          ;
  2571  0d0c  e1                	POP	HL
  2572  0d0d  fde1              	POP	IY
  2573  0d0f  c9                	RET
  2574                          ;
  2575                          ; HL = DE MOD BC
  2576                          ;
  2577  0d10  af                MOD16:	XOR	A
  2578  0d11  67                	LD	H,A
  2579  0d12  6f                	LD	L,A
  2580  0d13  3e11              	LD	A,17
  2581  0d15  ed42              MOD160:	SBC	HL,BC
  2582  0d17  3001              	JR	NC,MOD161
  2583  0d19  09                	ADD	HL,BC
  2584  0d1a  3f                MOD161:	CCF
  2585  0d1b  cb13              	RL	E
  2586  0d1d  cb12              	RL	D
  2587  0d1f  3d                	DEC	A
  2588  0d20  c8                	RET	Z
  2589  0d21  ed6a              	ADC	HL,HL
  2590  0d23  18f0              	JR	MOD160
  2591                          ;
  2592                          	; END
  2593                          
