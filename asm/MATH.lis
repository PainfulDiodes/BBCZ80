asm/MATH.asm:
     1                          	; TITLE '(C) COPYRIGHT R.T.RUSSELL 1986-2025'
     2                          	INCLUDE "constants.inc"
asm/constants.inc:
     1                          ; BBC BASIC Z80 - Shared Constants
     2                          ; Extracted from source modules to avoid duplicate definitions
     3                          
     4                          ; ASCII control characters
     5                          LF      EQU     0AH
     6                          CR      EQU     0DH
     7                          ; Note: ESC conflicts with label in AMOS.Z80, not included
     8                          BEL     EQU     7
     9                          BS      EQU     8
    10                          HT      EQU     9
    11                          VT      EQU     0BH
    12                          ; Note: DEL conflicts with label in MAIN.Z80, not included
    13                          
    14                          ; CP/M system addresses
    15                          ; Note: BDOS conflicts with label in DIST.Z80, not included
    16                          FCB     EQU     5CH
    17                          DSKBUF  EQU     80H
    18                          FCBSIZ  EQU     128+36+2
    19                          
    20                          ; Token values
    21                          TAND    EQU     80H
    22                          TOR     EQU     84H
    23                          TBY     EQU     0FH
    24                          TERROR  EQU     85H
    25                          TLINE   EQU     86H
    26                          TOFF    EQU     87H
    27                          TSTEP   EQU     88H
    28                          TSPC    EQU     89H
    29                          TTAB    EQU     8AH
    30                          TELSE   EQU     8BH
    31                          TTHEN   EQU     8CH
    32                          TLINO   EQU     8DH
    33                          TTO     EQU     0B8H
    34                          TCASE   EQU     0C8H
    35                          TWHILE  EQU     0C7H
    36                          TWHEN   EQU     0C9H
    37                          TOF     EQU     0CAH
    38                          TENDCASE EQU    0CBH
    39                          TOTHERWISE EQU  0CCH
    40                          TENDIF  EQU     0CDH
    41                          TENDWHILE EQU   0CEH
    42                          TCALL   EQU     0D6H
    43                          TDATA   EQU     0DCH
    44                          TDEF    EQU     0DDH
    45                          TDIM    EQU     0DEH
    46                          TEND    EQU     0E0H
    47                          TFOR    EQU     0E3H
    48                          TGOSUB  EQU     0E4H
    49                          TGOTO   EQU     0E5H
    50                          TIF     EQU     0E7H
    51                          TLOCAL  EQU     0EAH
    52                          TMODE   EQU     0EBH
    53                          TNEXT   EQU     0EDH
    54                          TON     EQU     0EEH
    55                          TPROC   EQU     0F2H
    56                          TREM    EQU     0F4H
    57                          TREPEAT EQU     0F5H
    58                          TREPORT EQU     0F6H
    59                          TRESTORE EQU    0F7H
    60                          TRETURN EQU     0F8H
    61                          TSTOP   EQU     0FAH
    62                          TTRACE  EQU     0FCH
    63                          TUNTIL  EQU     0FDH
    64                          TWIDTH  EQU     0FEH
    65                          TEXIT   EQU     10H
    66                          
    67                          ; Error codes
    68                          BADOP   EQU     1
    69                          DIVBY0  EQU     18
    70                          ; Note: TOOBIG conflicts with label in MAIN.Z80, not included
    71                          NGROOT  EQU     21
    72                          LOGRNG  EQU     22
    73                          ACLOST  EQU     23
    74                          EXPRNG  EQU     24
    75                          
asm/MATH.asm:
     3                          ;
     4                          ;Z80 FLOATING POINT PACKAGE
     5                          ;(C) COPYRIGHT  R.T.RUSSELL  1986-2024
     6                          ;VERSION 0.0, 26-10-1986
     7                          ;VERSION 0.1, 14-12-1988 (BUG FIX)
     8                          ;VERSION 5.0, 16-06-2024 (SHIFTS ADDED)
     9                          ;VERSION 5.1, 16-03-2025 (Shifts moved to new codes)
    10                          ;
    11                          ;BINARY FLOATING POINT REPRESENTATION:
    12                          ;   32 BIT SIGN-MAGNITUDE NORMALIZED MANTISSA
    13                          ;    8 BIT EXCESS-128 SIGNED EXPONENT
    14                          ;   SIGN BIT REPLACES MANTISSA MSB (IMPLIED "1")
    15                          ;   MANTISSA=0 & EXPONENT=0 IMPLIES VALUE IS ZERO.
    16                          ;
    17                          ;BINARY INTEGER REPRESENTATION:
    18                          ;   32 BIT 2'S-COMPLEMENT SIGNED INTEGER
    19                          ;    "EXPONENT" BYTE = 0 (WHEN PRESENT)
    20                          ;
    21                          ;NORMAL REGISTER ALLOCATION: MANTISSA - HLH'L'
    22                          ;                            EXPONENT - C
    23                          ;ALTERNATE REGISTER ALLOCATION: MANTISSA - DED'E'
    24                          ;                               EXPONENT - B
    25                          ;
    26                          ;Error codes:
    27                          ;
    28                          ; BADOP EQU	1		;Bad operation code
    29                          ; DIVBY0 EQU	18		;Division by zero
    30                          TOOBIG	EQU	20		;Too big
    31                          ; NGROOT EQU	21		;Negative root
    32                          ; LOGRNG EQU	22		;Log range
    33                          ; ACLOST EQU	23		;Accuracy lost
    34                          ; EXPRNG EQU	24		;Exp range
    35                          ;
    36                          	PUBLIC FPP
    37                          	EXTERN STORE5
    38                          	EXTERN DLOAD5
    39                          ;
    40                          ;Call entry and despatch code:
    41                          ;
    42  0000  fde5              FPP:	PUSH	IY		;Save IY
    43  0002  fd210000          	LD	IY,0
    44  0006  fd39              	ADD	IY,SP		;Save SP in IY
    45  0008  cd1700            	CALL	OP		;Perform operation
    46  000b  bf                	CP	A		;Good return (Z, NC)
    47  000c  fde1              EXIT:	POP	IY		;Restore IY
    48  000e  c9                	RET			;Return to caller
    49                          ;
    50                          ;Error exit:
    51                          ;
    52  000f  3e01              BAD:	LD	A,BADOP		;"Bad operation code"
    53  0011  fdf9              ERROR:	LD	SP,IY		;Restore SP from IY
    54  0013  b7                	OR	A		;Set NZ
    55  0014  37                	SCF			;Set C
    56  0015  18f5              	JR	EXIT
    57                          ;
    58                          ;Perform operation or function:
    59                          ;
    60  0017  fe30              OP:	CP	(RTABLE-DTABLE)/2
    61  0019  30f4              	JR	NC,BAD
    62  001b  fe10              	CP	(FTABLE-DTABLE)/2
    63  001d  3007              	JR	NC,DISPAT
    64  001f  08                	EX	AF,AF'
    65  0020  78                	LD	A,B
    66  0021  b1                	OR	C		;Both integer?
    67  0022  c49009            	CALL	NZ,FLOATA	;No, so float both
    68  0025  08                	EX	AF,AF'
    69  0026  e5                DISPAT:	PUSH	HL
    70  0027  213700            	LD	HL,DTABLE
    71  002a  c5                	PUSH	BC
    72  002b  87                	ADD	A,A		;A = op-code * 2
    73  002c  4f                	LD	C,A
    74  002d  0600              	LD	B,0		;BC = op-code * 2
    75  002f  09                	ADD	HL,BC
    76  0030  7e                	LD	A,(HL)		;Get low byte
    77  0031  23                	INC	HL
    78  0032  66                	LD	H,(HL)		;Get high byte
    79  0033  6f                	LD	L,A
    80  0034  c1                	POP	BC
    81  0035  e3                	EX	(SP),HL
    82  0036  c9                	RET			;Off to routine
    83                          ;
    84                          ;Despatch table:
    85                          ;
    86  0037  ba00              DTABLE:	DEFW	IAND		;0  AND (INTEGER)
    87  0039  0701              	DEFW	IBDIV		;1  DIV
    88  003b  cc00              	DEFW	IEOR		;2  EOR
    89  003d  f000              	DEFW	IMOD		;3  MOD
    90  003f  de00              	DEFW	IOR		;4  OR
    91  0041  0503              	DEFW	ILE		;5  <=
    92  0043  1203              	DEFW	INE		;6  <>
    93  0045  fa02              	DEFW	IGE		;7  >=
    94  0047  e302              	DEFW	ILT		;8  <
    95  0049  1d03              	DEFW	IEQ		;9  =
    96  004b  d101              	DEFW	IMUL		;10 *
    97  004d  2a01              	DEFW	IADD		;11 +
    98  004f  ee02              	DEFW	IGT		;12 >
    99  0051  1401              	DEFW	ISUB		;13 -
   100  0053  4c02              	DEFW	IPOW		;14 ^
   101  0055  8901              	DEFW	IDIV		;15 /
   102                          ;
   103  0057  6903              FTABLE:	DEFW	ABS		;16 ABS
   104  0059  c506              	DEFW	ACS		;17 ACS
   105  005b  2106              	DEFW	ASN		;18 ASN
   106  005d  4606              	DEFW	ATN		;19 ATN
   107  005f  5f04              	DEFW	COS		;20 COS
   108  0061  9303              	DEFW	DEG		;21 DEG
   109  0063  0405              	DEFW	EXP		;22 EXP
   110  0065  d903              	DEFW	INT		;23 INT
   111  0067  8f05              	DEFW	LN		;24 LN
   112  0069  0f06              	DEFW	LOG		;25 LOG
   113  006b  7403              	DEFW	CPL		;26 NOT
   114  006d  9b03              	DEFW	RAD		;27 RAD
   115  006f  b103              	DEFW	SGN		;28 SGN
   116  0071  6a04              	DEFW	SIN		;29 SIN
   117  0073  ef03              	DEFW	SQR		;30 SQR
   118  0075  4204              	DEFW	TAN		;31 TAN
   119                          ;
   120  0077  0c0a              	DEFW	ZERO		;32 ZERO
   121  0079  e304              	DEFW	FONE		;33 FONE
   122  007b  2103              	DEFW	TRUE		;34 TRUE
   123  007d  8703              	DEFW	PI		;35 PI
   124                          ;
   125  007f  c103              	DEFW	VAL		;36 VAL
   126  0081  cd06              	DEFW	STR		;37 STR$
   127                          ;
   128  0083  e208              	DEFW	SFIX		;38 FIX
   129  0085  9d09              	DEFW	SFLOAT		;39 FLOAT
   130                          ;
   131  0087  e209              	DEFW	FTEST		;40 TEST
   132  0089  f309              	DEFW	FCOMP		;41 COMPARE
   133                          ;
   134  008b  0f00              	DEFW	BAD		;42 Reserved for Z88
   135  008d  0f00              	DEFW	BAD		;43 Reserved for Z88
   136                          ;
   137  008f  2c03              	DEFW	ISHL		;44 <<
   138  0091  2c03              	DEFW	ISHX		;45 <<<
   139  0093  3803              	DEFW	ISAR		;46 >>
   140  0095  4903              	DEFW	ISHR		;47 >>>
   141                          ;
   142  0097  b700              RTABLE:	DEFW	FAND		;AND (FLOATING-POINT)
   143  0099  0401              	DEFW	FBDIV		;DIV
   144  009b  c900              	DEFW	FEOR		;EOR
   145  009d  ed00              	DEFW	FMOD		;MOD
   146  009f  db00              	DEFW	FOR		;OR
   147  00a1  0003              	DEFW	FLE		;<=
   148  00a3  0d03              	DEFW	FNE		;<>
   149  00a5  f502              	DEFW	FGE		;>=
   150  00a7  de02              	DEFW	FLT		;<
   151  00a9  1803              	DEFW	FEQ		;=
   152  00ab  fc01              	DEFW	FMUL		;*
   153  00ad  3401              	DEFW	FADD		;+
   154  00af  e902              	DEFW	FGT		;>
   155  00b1  1e01              	DEFW	FSUB		;-
   156  00b3  b402              	DEFW	FPOW		;^
   157  00b5  8c01              	DEFW	FDIV		;/
   158                          ;
   159                          ;ARITHMETIC AND LOGICAL OPERATORS:
   160                          ;All take two arguments, in HLH'L'C & DED'E'B.
   161                          ;Output in HLH'L'C
   162                          ;All registers except IX, IY destroyed.
   163                          ; (N.B. FPOW destroys IX).
   164                          ;
   165                          ;FAND - Floating-point AND.
   166                          ;IAND - Integer AND.
   167                          ;
   168  00b7  cdd908            FAND:	CALL	FIX2
   169  00ba  7c                IAND:	LD	A,H
   170  00bb  a2                	AND	D
   171  00bc  67                	LD	H,A
   172  00bd  7d                	LD	A,L
   173  00be  a3                	AND	E
   174  00bf  6f                	LD	L,A
   175  00c0  d9                	EXX
   176  00c1  7c                	LD	A,H
   177  00c2  a2                	AND	D
   178  00c3  67                	LD	H,A
   179  00c4  7d                	LD	A,L
   180  00c5  a3                	AND	E
   181  00c6  6f                	LD	L,A
   182  00c7  d9                	EXX
   183  00c8  c9                	RET
   184                          ;
   185                          ;FEOR - Floating-point exclusive-OR.
   186                          ;IEOR - Integer exclusive-OR.
   187                          ;
   188  00c9  cdd908            FEOR:	CALL	FIX2
   189  00cc  7c                IEOR:	LD	A,H
   190  00cd  aa                	XOR	D
   191  00ce  67                	LD	H,A
   192  00cf  7d                	LD	A,L
   193  00d0  ab                	XOR	E
   194  00d1  6f                	LD	L,A
   195  00d2  d9                	EXX
   196  00d3  7c                	LD	A,H
   197  00d4  aa                	XOR	D
   198  00d5  67                	LD	H,A
   199  00d6  7d                	LD	A,L
   200  00d7  ab                	XOR	E
   201  00d8  6f                	LD	L,A
   202  00d9  d9                	EXX
   203  00da  c9                	RET
   204                          ;
   205                          ;FOR - Floating-point OR.
   206                          ;IOR - Integer OR.
   207                          ;
   208  00db  cdd908            FOR:	CALL	FIX2
   209  00de  7c                IOR:	LD	A,H
   210  00df  b2                	OR	D
   211  00e0  67                	LD	H,A
   212  00e1  7d                	LD	A,L
   213  00e2  b3                	OR	E
   214  00e3  6f                	LD	L,A
   215  00e4  d9                	EXX
   216  00e5  7c                	LD	A,H
   217  00e6  b2                	OR	D
   218  00e7  67                	LD	H,A
   219  00e8  7d                	LD	A,L
   220  00e9  b3                	OR	E
   221  00ea  6f                	LD	L,A
   222  00eb  d9                	EXX
   223  00ec  c9                	RET
   224                          ;
   225                          ;FMOD - Floating-point remainder.
   226                          ;IMOD - Integer remainder.
   227                          ;
   228  00ed  cdd908            FMOD:	CALL	FIX2
   229  00f0  7c                IMOD:	LD	A,H
   230  00f1  aa                	XOR	D		;DIV RESULT SIGN
   231  00f2  cb7c              	BIT	7,H
   232  00f4  cde00b            	CALL	ABS2		;MAKE BOTH POSITIVE
   233  00f7  3edf              	LD	A,-33
   234  00f9  cd1c0b            	CALL	DIVA		;DIVIDE
   235  00fc  d9                	EXX
   236  00fd  0e00              	LD	C,0		;INTEGER MARKER
   237  00ff  08                	EX	AF,AF'
   238  0100  c8                	RET	Z
   239  0101  c3f108            	JP	NEGATE
   240                          ;
   241                          ;BDIV - Integer division.
   242                          ;
   243  0104  cdd908            FBDIV:	CALL	FIX2
   244  0107  cdf000            IBDIV:	CALL	IMOD
   245  010a  b7                	OR	A
   246  010b  cdc709            	CALL	SWAP
   247  010e  0e00              	LD	C,0
   248  0110  f0                	RET	P
   249  0111  c3f108            	JP	NEGATE
   250                          ;
   251                          ;ISUB - Integer subtraction.
   252                          ;FSUB - Floating point subtraction with rounding.
   253                          ;
   254  0114  cd4f0a            ISUB:	CALL	SUB
   255  0117  e0                	RET	PO
   256  0118  cd490a            	CALL	ADD
   257  011b  cd9409            	CALL	FLOAT2
   258  011e  7a                FSUB:	LD	A,D
   259  011f  ee80              	XOR	80H		;CHANGE SIGN THEN ADD
   260  0121  57                	LD	D,A
   261  0122  1810              	JR	FADD
   262                          ;
   263                          ;Reverse subtract.
   264                          ;
   265  0124  7c                RSUB:	LD	A,H
   266  0125  ee80              	XOR	80H
   267  0127  67                	LD	H,A
   268  0128  180a              	JR	FADD
   269                          ;
   270                          ;IADD - Integer addition.
   271                          ;FADD - Floating point addition with rounding.
   272                          ;
   273  012a  cd490a            IADD:	CALL	ADD
   274  012d  e0                	RET	PO
   275  012e  cd4f0a            	CALL	SUB
   276  0131  cd9409            	CALL	FLOAT2
   277  0134  05                FADD:	DEC	B
   278  0135  04                	INC	B
   279  0136  c8                	RET	Z		;ARG 2 ZERO
   280  0137  0d                	DEC	C
   281  0138  0c                	INC	C
   282  0139  cac709            	JP	Z,SWAP		;ARG 1 ZERO
   283  013c  d9                	EXX
   284  013d  010000            	LD	BC,0		;INITIALISE
   285  0140  d9                	EXX
   286  0141  7c                	LD	A,H
   287  0142  aa                	XOR	D		;XOR SIGNS
   288  0143  f5                	PUSH	AF
   289  0144  78                	LD	A,B
   290  0145  b9                	CP	C		;COMPARE EXPONENTS
   291  0146  dcc709            	CALL	C,SWAP		;MAKE DED'E'B LARGEST
   292  0149  78                	LD	A,B
   293  014a  cbfc              	SET	7,H		;IMPLIED 1
   294  014c  c4c908            	CALL	NZ,FIX		;ALIGN
   295  014f  f1                	POP	AF
   296  0150  7a                	LD	A,D		;SIGN OF LARGER
   297  0151  cbfa              	SET	7,D		;IMPLIED 1
   298  0153  fa6001            	JP	M,FADD3		;SIGNS DIFFERENT
   299  0156  cd490a            	CALL	ADD		;HLH'L'=HLH'L'+DED'E'
   300  0159  dccf09            	CALL	C,DIV2		;NORMALISE
   301  015c  cbfc              	SET	7,H
   302  015e  180a              	JR	FADD4
   303                          ;
   304  0160  cd4f0a            FADD3:	CALL	SUB		;HLH'L'=HLH'L'-DED'E'
   305  0163  dc0509            	CALL	C,NEG		;NEGATE HLH'L'B'C'
   306  0166  cd7109            	CALL	FLO48
   307  0169  2f                	CPL			;CHANGE RESULT SIGN
   308  016a  d9                FADD4:	EXX
   309  016b  eb                	EX	DE,HL
   310  016c  210080            	LD	HL,8000H
   311  016f  b7                	OR	A		;CLEAR CARRY
   312  0170  ed42              	SBC	HL,BC
   313  0172  eb                	EX	DE,HL
   314  0173  d9                	EXX
   315  0174  ccc109            	CALL	Z,ODD		;ROUND UNBIASSED
   316  0177  dcb309            	CALL	C,ADD1		;ROUND UP
   317  017a  dcdb09            	CALL	C,INCC
   318  017d  cbbc              	RES	7,H
   319  017f  0d                	DEC	C
   320  0180  0c                	INC	C
   321  0181  ca0c0a            	JP	Z,ZERO
   322  0184  b7                	OR	A		;RESULT SIGNQ
   323  0185  f0                	RET	P		;POSITIVE
   324  0186  cbfc              	SET	7,H		;NEGATIVE
   325  0188  c9                	RET
   326                          ;
   327                          ;IDIV - Integer division.
   328                          ;FDIV - Floating point division with rounding.
   329                          ;
   330  0189  cd9409            IDIV:	CALL	FLOAT2
   331  018c  05                FDIV:	DEC	B		;TEST FOR ZERO
   332  018d  04                	INC	B
   333  018e  3e12              	LD	A,DIVBY0
   334  0190  ca1100            	JP	Z,ERROR		;"Division by zero"
   335  0193  0d                	DEC	C		;TEST FOR ZERO
   336  0194  0c                	INC	C
   337  0195  c8                	RET	Z
   338  0196  7c                	LD	A,H
   339  0197  aa                	XOR	D		;CALC. RESULT SIGN
   340  0198  08                	EX	AF,AF'		;SAVE SIGN
   341  0199  cbfa              	SET	7,D		;REPLACE IMPLIED 1's
   342  019b  cbfc              	SET	7,H
   343  019d  c5                	PUSH	BC		;SAVE EXPONENTS
   344  019e  42                	LD	B,D		;LOAD REGISTERS
   345  019f  4b                	LD	C,E
   346  01a0  110000            	LD	DE,0
   347  01a3  d9                	EXX
   348  01a4  42                	LD	B,D
   349  01a5  4b                	LD	C,E
   350  01a6  110000            	LD	DE,0
   351  01a9  3ee0              	LD	A,-32		;LOOP COUNTER
   352  01ab  cd1c0b            	CALL	DIVA		;DIVIDE
   353  01ae  d9                	EXX
   354  01af  cb7a              	BIT	7,D
   355  01b1  d9                	EXX
   356  01b2  cc370b            	CALL	Z,DIVB		;NORMALISE & INC A
   357  01b5  eb                	EX	DE,HL
   358  01b6  d9                	EXX
   359  01b7  cb38              	SRL	B		;DIVISOR/2
   360  01b9  cb19              	RR	C
   361  01bb  b7                	OR	A		;CLEAR CARRY
   362  01bc  ed42              	SBC	HL,BC		;REMAINDER-DIVISOR/2
   363  01be  3f                	CCF
   364  01bf  eb                	EX	DE,HL		;RESULT IN HLH'L'
   365  01c0  ccc109            	CALL	Z,ODD		;ROUND UNBIASSED
   366  01c3  dcb309            	CALL	C,ADD1		;ROUND UP
   367  01c6  c1                	POP	BC		;RESTORE EXPONENTS
   368  01c7  dcdb09            	CALL	C,INCC
   369  01ca  1f                	RRA			;LSB OF A TO CARRY
   370  01cb  79                	LD	A,C		;COMPUTE NEW EXPONENT
   371  01cc  98                	SBC	A,B
   372  01cd  3f                	CCF
   373  01ce  c33502            	JP	CHKOVF
   374                          ;
   375                          ;IMUL - Integer multiplication.
   376                          ;
   377  01d1  7c                IMUL:	LD	A,H
   378  01d2  aa                	XOR	D
   379  01d3  cde00b            	CALL	ABS2		;MAKE BOTH POSITIVE
   380  01d6  3edf              	LD	A,-33
   381  01d8  cd4a0b            	CALL	MULA		;MULTIPLY
   382  01db  d9                	EXX
   383  01dc  0ebf              	LD	C,191		;PRESET EXPONENT
   384  01de  cdec09            	CALL	TEST		;TEST RANGE
   385  01e1  200d              	JR	NZ,IMUL1	;TOO BIG
   386  01e3  cb7a              	BIT	7,D
   387  01e5  2009              	JR	NZ,IMUL1
   388  01e7  cdc709            	CALL	SWAP
   389  01ea  4a                	LD	C,D		;INTEGER MARKER
   390  01eb  08                	EX	AF,AF'
   391  01ec  f0                	RET	P
   392  01ed  c3f108            	JP	NEGATE
   393                          ;
   394  01f0  0d                IMUL1:	DEC	C
   395  01f1  cdb30b            	CALL	SLA8
   396  01f4  f2f001            	JP	P,IMUL1		;NORMALISE
   397  01f7  08                	EX	AF,AF'
   398  01f8  f8                	RET	M
   399  01f9  cbbc              	RES	7,H		;POSITIVE
   400  01fb  c9                	RET
   401                          ;
   402                          ;FMUL - Floating point multiplication with rounding.
   403                          ;
   404  01fc  05                FMUL:	DEC	B		;TEST FOR ZERO
   405  01fd  04                	INC	B
   406  01fe  ca0c0a            	JP	Z,ZERO
   407  0201  0d                	DEC	C		;TEST FOR ZERO
   408  0202  0c                	INC	C
   409  0203  c8                	RET	Z
   410  0204  7c                	LD	A,H
   411  0205  aa                	XOR	D		;CALC. RESULT SIGN
   412  0206  08                	EX	AF,AF'
   413  0207  cbfa              	SET	7,D		;REPLACE IMPLIED 1's
   414  0209  cbfc              	SET	7,H
   415  020b  c5                	PUSH	BC		;SAVE EXPONENTS
   416  020c  44                	LD	B,H		;LOAD REGISTERS
   417  020d  4d                	LD	C,L
   418  020e  210000            	LD	HL,0
   419  0211  d9                	EXX
   420  0212  44                	LD	B,H
   421  0213  4d                	LD	C,L
   422  0214  210000            	LD	HL,0
   423  0217  3ee0              	LD	A,-32		;LOOP COUNTER
   424  0219  cd4a0b            	CALL	MULA		;MULTIPLY
   425  021c  dc5e0b            	CALL	C,MULB		;NORMALISE & INC A
   426  021f  d9                	EXX
   427  0220  e5                	PUSH	HL
   428  0221  210080            	LD	HL,8000H
   429  0224  b7                	OR	A		;CLEAR CARRY
   430  0225  ed52              	SBC	HL,DE
   431  0227  e1                	POP	HL
   432  0228  ccc109            	CALL	Z,ODD		;ROUND UNBIASSED
   433  022b  dcb309            	CALL	C,ADD1		;ROUND UP
   434  022e  c1                	POP	BC		;RESTORE EXPONENTS
   435  022f  dcdb09            	CALL	C,INCC
   436  0232  1f                	RRA			;LSB OF A TO CARRY
   437  0233  79                	LD	A,C		;COMPUTE NEW EXPONENT
   438  0234  88                	ADC	A,B
   439  0235  3805              CHKOVF:	JR	C,CHKO1
   440  0237  f20c0a            	JP	P,ZERO		;UNDERFLOW
   441  023a  1803              	JR	CHKO2
   442  023c  fadd09            CHKO1:	JP	M,OFLOW		;OVERFLOW
   443  023f  c680              CHKO2:	ADD	A,80H
   444  0241  4f                	LD	C,A
   445  0242  ca0c0a            	JP	Z,ZERO
   446  0245  08                	EX	AF,AF'		;RESTORE SIGN BIT
   447  0246  cbbc              	RES	7,H
   448  0248  f0                	RET	P
   449  0249  cbfc              	SET	7,H
   450  024b  c9                	RET
   451                          ;
   452                          ;IPOW - Integer involution.
   453                          ;
   454  024c  cdc709            IPOW:	CALL	SWAP
   455  024f  cb7c              	BIT	7,H
   456  0251  f5                	PUSH	AF		;SAVE SIGN
   457  0252  c4f108            	CALL	NZ,NEGATE
   458  0255  48                IPOW0:	LD	C,B
   459  0256  0620              	LD	B,32		;LOOP COUNTER
   460  0258  cd660a            IPOW1:	CALL	X2
   461  025b  3808              	JR	C,IPOW2
   462  025d  10f9              	DJNZ	IPOW1
   463  025f  f1                	POP	AF
   464  0260  d9                	EXX
   465  0261  2c                	INC	L		;RESULT=1
   466  0262  d9                	EXX
   467  0263  4c                	LD	C,H
   468  0264  c9                	RET
   469                          ;
   470  0265  f1                IPOW2:	POP	AF
   471  0266  c5                	PUSH	BC
   472  0267  eb                	EX	DE,HL
   473  0268  e5                	PUSH	HL
   474  0269  d9                	EXX
   475  026a  eb                	EX	DE,HL
   476  026b  e5                	PUSH	HL
   477  026c  d9                	EXX
   478  026d  dd210000          	LD	IX,0
   479  0271  dd39              	ADD	IX,SP
   480  0273  2834              	JR	Z,IPOW4
   481  0275  c5                	PUSH	BC
   482  0276  d9                	EXX
   483  0277  d5                	PUSH	DE
   484  0278  d9                	EXX
   485  0279  d5                	PUSH	DE
   486  027a  cd9d09            	CALL	SFLOAT
   487  027d  cd7b05            	CALL	RECIP
   488  0280  cd0000            	CALL	STORE5
   489  0283  181d              	JR	IPOW5
   490                          ;
   491  0285  c5                IPOW3:	PUSH	BC
   492  0286  d9                	EXX
   493  0287  cb23              	SLA	E
   494  0289  cb12              	RL	D
   495  028b  d5                	PUSH	DE
   496  028c  d9                	EXX
   497  028d  cb13              	RL	E
   498  028f  cb12              	RL	D
   499  0291  d5                	PUSH	DE
   500  0292  3e0a              	LD	A,0AH
   501  0294  f5                	PUSH	AF
   502  0295  cd780a            	CALL	COPY
   503  0298  cd1700            	CALL	OP		;SQUARE
   504  029b  f1                	POP	AF
   505  029c  cd0000            	CALL	DLOAD5
   506  029f  dc1700            	CALL	C,OP		;MULTIPLY BY X
   507  02a2  d1                IPOW5:	POP	DE
   508  02a3  d9                	EXX
   509  02a4  d1                	POP	DE
   510  02a5  d9                	EXX
   511  02a6  79                	LD	A,C
   512  02a7  c1                	POP	BC
   513  02a8  4f                	LD	C,A
   514  02a9  10da              IPOW4:	DJNZ	IPOW3
   515  02ab  f1                	POP	AF
   516  02ac  f1                	POP	AF
   517  02ad  f1                	POP	AF
   518  02ae  c9                	RET
   519                          ;
   520  02af  f1                FPOW0:	POP	AF
   521  02b0  f1                	POP	AF
   522  02b1  f1                	POP	AF
   523  02b2  18a1              	JR	IPOW0
   524                          ;
   525                          ;FPOW - Floating-point involution.
   526                          ;
   527  02b4  cb7a              FPOW:	BIT	7,D
   528  02b6  f5                	PUSH	AF
   529  02b7  cdc709            	CALL	SWAP
   530  02ba  cd860a            	CALL	PUSH5
   531  02bd  0d                	DEC	C
   532  02be  0c                	INC	C
   533  02bf  28ee              	JR	Z,FPOW0
   534  02c1  3e9e              	LD	A,158
   535  02c3  b9                	CP	C
   536  02c4  3808              	JR	C,FPOW1
   537  02c6  3c                	INC	A
   538  02c7  cdc908            	CALL	FIX
   539  02ca  08                	EX	AF,AF'
   540  02cb  f2af02            	JP	P,FPOW0
   541  02ce  cdc709            FPOW1:	CALL	SWAP
   542  02d1  cd9205            	CALL	LN0
   543  02d4  cd8f0a            	CALL	POP5
   544  02d7  f1                	POP	AF
   545  02d8  cdfc01            	CALL	FMUL
   546  02db  c30705            	JP	EXP0
   547                          ;
   548                          ;Integer and floating-point compare.
   549                          ;Result is TRUE (-1) or FALSE (0).
   550                          ;
   551  02de  cd160a            FLT:	CALL	FCP
   552  02e1  1803              	JR	ILT1
   553  02e3  cd090a            ILT:	CALL	ICP
   554  02e6  d0                ILT1:	RET	NC
   555  02e7  1838              	JR	TRUE
   556                          ;
   557  02e9  cd160a            FGT:	CALL	FCP
   558  02ec  1803              	JR	IGT1
   559  02ee  cd090a            IGT:	CALL	ICP
   560  02f1  c8                IGT1:	RET	Z
   561  02f2  d8                	RET	C
   562  02f3  182c              	JR	TRUE
   563                          ;
   564  02f5  cd160a            FGE:	CALL	FCP
   565  02f8  1803              	JR	IGE1
   566  02fa  cd090a            IGE:	CALL	ICP
   567  02fd  d8                IGE1:	RET	C
   568  02fe  1821              	JR	TRUE
   569                          ;
   570  0300  cd160a            FLE:	CALL	FCP
   571  0303  1803              	JR	ILE1
   572  0305  cd090a            ILE:	CALL	ICP
   573  0308  2817              ILE1:	JR	Z,TRUE
   574  030a  d0                	RET	NC
   575  030b  1814              	JR	TRUE
   576                          ;
   577  030d  cd160a            FNE:	CALL	FCP
   578  0310  1803              	JR	INE1
   579  0312  cd090a            INE:	CALL	ICP
   580  0315  c8                INE1:	RET	Z
   581  0316  1809              	JR	TRUE
   582                          ;
   583  0318  cd160a            FEQ:	CALL	FCP
   584  031b  1803              	JR	IEQ1
   585  031d  cd090a            IEQ:	CALL	ICP
   586  0320  c0                IEQ1:	RET	NZ
   587  0321  21ffff            TRUE:	LD	HL,-1
   588  0324  d9                	EXX
   589  0325  21ffff            	LD	HL,-1
   590  0328  d9                	EXX
   591  0329  af                	XOR	A
   592  032a  4f                	LD	C,A
   593  032b  c9                	RET
   594                          ;
   595                          ;Integer shifts:
   596                          ;
   597                          ISHX:
   598  032c  cd5a03            ISHL:	CALL	SHIFTS
   599  032f  c8                	RET	Z
   600  0330  d9                ISHL1:	EXX
   601  0331  29                	ADD	HL,HL
   602  0332  d9                	EXX
   603  0333  ed6a              	ADC	HL,HL
   604  0335  10f9              	DJNZ	ISHL1
   605  0337  c9                	RET
   606                          ;
   607  0338  cd5a03            ISAR:	CALL	SHIFTS
   608  033b  c8                	RET	Z
   609  033c  cb2c              ISAR1:	SRA	H
   610  033e  cb1d              	RR	L
   611  0340  d9                	EXX
   612  0341  cb1c              	RR	H
   613  0343  cb1d              	RR	L
   614  0345  d9                	EXX
   615  0346  10f4              	DJNZ	ISAR1
   616  0348  c9                	RET
   617                          ;
   618  0349  cd5a03            ISHR:	CALL	SHIFTS
   619  034c  c8                	RET	Z
   620  034d  cb3c              ISHR1:	SRL	H
   621  034f  cb1d              	RR	L
   622  0351  d9                	EXX
   623  0352  cb1c              	RR	H
   624  0354  cb1d              	RR	L
   625  0356  d9                	EXX
   626  0357  10f4              	DJNZ	ISHR1
   627  0359  c9                	RET
   628                          ;
   629  035a  cdd908            SHIFTS:	CALL	FIX2
   630  035d  7a                	LD	A,D
   631  035e  b3                	OR	E
   632  035f  d9                	EXX
   633  0360  b2                	OR	D
   634  0361  7b                	LD	A,E
   635  0362  d9                	EXX
   636  0363  0620              	LD	B,32
   637  0365  c0                	RET	NZ
   638  0366  47                	LD	B,A
   639  0367  b7                	OR	A
   640  0368  c9                	RET
   641                          ;
   642                          ;FUNCTIONS:
   643                          ;
   644                          ;Result returned in HLH'L'C (floating point)
   645                          ;Result returned in HLH'L' (C=0) (integer)
   646                          ;All registers except IY destroyed.
   647                          ;
   648                          ;ABS - Absolute value
   649                          ;Result is numeric, variable type.
   650                          ;
   651  0369  cb7c              ABS:	BIT	7,H
   652  036b  c8                	RET	Z		;POSITIVE/ZERO
   653  036c  0d                	DEC	C
   654  036d  0c                	INC	C
   655  036e  caf108            	JP	Z,NEGATE	;INTEGER
   656  0371  cbbc              	RES	7,H
   657  0373  c9                	RET
   658                          ;
   659                          ;NOT - Complement integer.
   660                          ;Result is integer numeric.
   661                          ;
   662  0374  cde208            CPL:	CALL	SFIX
   663  0377  7c                	LD	A,H
   664  0378  2f                	CPL
   665  0379  67                	LD	H,A
   666  037a  7d                	LD	A,L
   667  037b  2f                	CPL
   668  037c  6f                	LD	L,A
   669  037d  d9                	EXX
   670  037e  7c                	LD	A,H
   671  037f  2f                	CPL
   672  0380  67                	LD	H,A
   673  0381  7d                	LD	A,L
   674  0382  2f                	CPL
   675  0383  6f                	LD	L,A
   676  0384  d9                	EXX
   677  0385  af                	XOR	A		;NUMERIC MARKER
   678  0386  c9                	RET
   679                          ;
   680                          ;PI - Return PI (3.141592654)
   681                          ;Result is floating-point numeric.
   682                          ;
   683  0387  210f49            PI:	LD	HL,490FH
   684  038a  d9                	EXX
   685  038b  21a2da            	LD	HL,0DAA2H
   686  038e  d9                	EXX
   687  038f  0e81              	LD	C,81H
   688  0391  af                	XOR	A		;NUMERIC MARKER
   689  0392  c9                	RET
   690                          ;
   691                          ;DEG - Convert radians to degrees
   692                          ;Result is floating-point numeric.
   693                          ;
   694  0393  cda303            DEG:	CALL	FPI180
   695  0396  cdfc01            	CALL	FMUL
   696  0399  af                	XOR	A
   697  039a  c9                	RET
   698                          ;
   699                          ;RAD - Convert degrees to radians
   700                          ;Result is floating-point numeric.
   701                          ;
   702  039b  cda303            RAD:	CALL	FPI180
   703  039e  cd8c01            	CALL	FDIV
   704  03a1  af                	XOR	A
   705  03a2  c9                	RET
   706                          ;
   707                          ;180/PI
   708                          ;
   709  03a3  cd9d09            FPI180:	CALL	SFLOAT
   710  03a6  112e65            	LD	DE,652EH
   711  03a9  d9                	EXX
   712  03aa  11d3e0            	LD	DE,0E0D3H
   713  03ad  d9                	EXX
   714  03ae  0685              	LD	B,85H
   715  03b0  c9                	RET
   716                          ;
   717                          ;SGN - Return -1, 0 or +1
   718                          ;Result is integer numeric.
   719                          ;
   720  03b1  cdec09            SGN:	CALL	TEST
   721  03b4  b1                	OR	C
   722  03b5  c8                	RET	Z		;ZERO
   723  03b6  cb7c              	BIT	7,H
   724  03b8  c22103            	JP	NZ,TRUE		;-1
   725  03bb  cd0c0a            	CALL	ZERO
   726  03be  c3b309            	JP	ADD1		;1
   727                          ;
   728                          ;VAL - Return numeric value of string.
   729                          ;Input: ASCII string at IX
   730                          ;Result is variable type numeric.
   731                          ;
   732  03c1  cdce0b            VAL:	CALL	SIGNQ
   733  03c4  f5                	PUSH	AF
   734  03c5  cd1f08            	CALL	CON
   735  03c8  f1                	POP	AF
   736  03c9  fe2d              	CP	'-'
   737  03cb  3e00              	LD	A,0		;NUMERIC MARKER
   738  03cd  c0                	RET	NZ
   739  03ce  0d                	DEC	C
   740  03cf  0c                	INC	C
   741  03d0  caf108            	JP	Z,NEGATE	;ZERO/INTEGER
   742  03d3  7c                	LD	A,H
   743  03d4  ee80              	XOR	80H		;CHANGE SIGN (FP)
   744  03d6  67                	LD	H,A
   745  03d7  af                	XOR	A
   746  03d8  c9                	RET
   747                          ;
   748                          ;INT - Floor function
   749                          ;Result is integer numeric.
   750                          ;
   751  03d9  0d                INT:	DEC	C
   752  03da  0c                	INC	C
   753  03db  c8                	RET	Z		;ZERO/INTEGER
   754  03dc  3e9f              	LD	A,159
   755  03de  44                	LD	B,H		;B7=SIGN BIT
   756  03df  cdc908            	CALL	FIX
   757  03e2  08                	EX	AF,AF'
   758  03e3  a0                	AND	B
   759  03e4  fcb309            	CALL	M,ADD1		;NEGATIVE NON-INTEGER
   760  03e7  78                	LD	A,B
   761  03e8  b7                	OR	A
   762  03e9  fcf108            	CALL	M,NEGATE
   763  03ec  af                	XOR	A
   764  03ed  4f                	LD	C,A
   765  03ee  c9                	RET
   766                          ;
   767                          ;SQR - square root
   768                          ;Result is floating-point numeric.
   769                          ;
   770  03ef  cd9d09            SQR:	CALL	SFLOAT
   771  03f2  cb7c              SQR0:	BIT	7,H
   772  03f4  3e15              	LD	A,NGROOT
   773  03f6  c21100            	JP	NZ,ERROR	;"-ve root"
   774  03f9  0d                	DEC	C
   775  03fa  0c                	INC	C
   776  03fb  c8                	RET	Z		;ZERO
   777  03fc  cbfc              	SET	7,H		;IMPLIED 1
   778  03fe  cb41              	BIT	0,C
   779  0400  cccf09            	CALL	Z,DIV2		;MAKE EXPONENT ODD
   780  0403  79                	LD	A,C
   781  0404  d680              	SUB	80H
   782  0406  cb2f              	SRA	A		;HALVE EXPONENT
   783  0408  c680              	ADD	A,80H
   784  040a  4f                	LD	C,A
   785  040b  c5                	PUSH	BC		;SAVE EXPONENT
   786  040c  eb                	EX	DE,HL
   787  040d  210000            	LD	HL,0
   788  0410  44                	LD	B,H
   789  0411  4d                	LD	C,L
   790  0412  d9                	EXX
   791  0413  eb                	EX	DE,HL
   792  0414  210000            	LD	HL,0
   793  0417  44                	LD	B,H
   794  0418  4d                	LD	C,L
   795  0419  3ee1              	LD	A,-31
   796  041b  cd7d0b            	CALL	SQRA		;ROOT
   797  041e  d9                	EXX
   798  041f  cb78              	BIT	7,B
   799  0421  d9                	EXX
   800  0422  cc7d0b            	CALL	Z,SQRA		;NORMALISE & INC A
   801  0425  cd9c0b            	CALL	SQRB
   802  0428  b7                	OR	A		;CLEAR CARRY
   803  0429  cd370b            	CALL	DIVB
   804  042c  cb1b              	RR	E		;LSB TO CARRY
   805  042e  60                	LD	H,B
   806  042f  69                	LD	L,C
   807  0430  d9                	EXX
   808  0431  60                	LD	H,B
   809  0432  69                	LD	L,C
   810  0433  dcb309            	CALL	C,ADD1		;ROUND UP
   811  0436  c1                	POP	BC		;RESTORE EXPONENT
   812  0437  dcdb09            	CALL	C,INCC
   813  043a  1f                	RRA
   814  043b  9f                	SBC	A,A
   815  043c  81                	ADD	A,C
   816  043d  4f                	LD	C,A
   817  043e  cbbc              	RES	7,H		;POSITIVE
   818  0440  af                	XOR	A
   819  0441  c9                	RET
   820                          ;
   821                          ;TAN - Tangent function
   822                          ;Result is floating-point numeric.
   823                          ;
   824  0442  cd9d09            TAN:	CALL	SFLOAT
   825  0445  cd860a            	CALL	PUSH5
   826  0448  cd6204            	CALL	COS0
   827  044b  cd8f0a            	CALL	POP5
   828  044e  cd860a            	CALL	PUSH5
   829  0451  cdc709            	CALL	SWAP
   830  0454  cd6d04            	CALL	SIN0
   831  0457  cd8f0a            	CALL	POP5
   832  045a  cd8c01            	CALL	FDIV
   833  045d  af                	XOR	A		;NUMERIC MARKER
   834  045e  c9                	RET
   835                          ;
   836                          ;COS - Cosine function
   837                          ;Result is floating-point numeric.
   838                          ;
   839  045f  cd9d09            COS:	CALL	SFLOAT
   840  0462  cd1209            COS0:	CALL	SCALE
   841  0465  1c                	INC	E
   842  0466  1c                	INC	E
   843  0467  7b                	LD	A,E
   844  0468  180e              	JR	SIN1
   845                          ;
   846                          ;SIN - Sine function
   847                          ;Result is floating-point numeric.
   848                          ;
   849  046a  cd9d09            SIN:	CALL	SFLOAT
   850  046d  e5                SIN0:	PUSH	HL		;H7=SIGN
   851  046e  cd1209            	CALL	SCALE
   852  0471  f1                	POP	AF
   853  0472  07                	RLCA
   854  0473  07                	RLCA
   855  0474  07                	RLCA
   856  0475  e604              	AND	4
   857  0477  ab                	XOR	E
   858  0478  f5                SIN1:	PUSH	AF		;OCTANT
   859  0479  cbbc              	RES	7,H
   860  047b  1f                	RRA
   861  047c  cdf904            	CALL	PIBY4
   862  047f  dc2401            	CALL	C,RSUB		;X=(PI/4)-X
   863  0482  f1                	POP	AF
   864  0483  f5                	PUSH	AF
   865  0484  e603              	AND	3
   866  0486  e2b704            	JP	PO,SIN2		;USE COSINE APPROX.
   867  0489  cd860a            	CALL	PUSH5		;SAVE X
   868  048c  cd800a            	CALL	SQUARE		;PUSH X*X
   869  048f  cdb90a            	CALL	POLY
   870  0492  b7a8              	DEFW	0A8B7H		;a(8)
   871  0494  1136              	DEFW	3611H
   872  0496  6d                	DEFB	6DH
   873  0497  26de              	DEFW	0DE26H		;a(6)
   874  0499  05d0              	DEFW	0D005H
   875  049b  73                	DEFB	73H
   876  049c  c080              	DEFW	80C0H		;a(4)
   877  049e  8808              	DEFW	888H
   878  04a0  79                	DEFB	79H
   879  04a1  9daa              	DEFW	0AA9DH		;a(2)
   880  04a3  aaaa              	DEFW	0AAAAH
   881  04a5  7d                	DEFB	7DH
   882  04a6  0000              	DEFW	0		;a(0)
   883  04a8  0000              	DEFW	0
   884  04aa  80                	DEFB	80H
   885  04ab  cd8f0a            	CALL	POP5
   886  04ae  cd8f0a            	CALL	POP5
   887  04b1  cdfc01            	CALL	FMUL
   888  04b4  c3d904            	JP	SIN3
   889                          ;
   890  04b7  cd800a            SIN2:	CALL	SQUARE		;PUSH X*X
   891  04ba  cdb90a            	CALL	POLY
   892  04bd  71d5              	DEFW	0D571H		;b(8)
   893  04bf  784c              	DEFW	4C78H
   894  04c1  70                	DEFB	70H
   895  04c2  af94              	DEFW	94AFH		;b(6)
   896  04c4  03b6              	DEFW	0B603H
   897  04c6  76                	DEFB	76H
   898  04c7  c89c              	DEFW	9CC8H		;b(4)
   899  04c9  aa2a              	DEFW	2AAAH
   900  04cb  7b                	DEFB	7BH
   901  04cc  ddff              	DEFW	0FFDDH		;b(2)
   902  04ce  ffff              	DEFW	0FFFFH
   903  04d0  7e                	DEFB	7EH
   904  04d1  0000              	DEFW	0		;b(0)
   905  04d3  0000              	DEFW	0
   906  04d5  80                	DEFB	80H
   907  04d6  cd8f0a            	CALL	POP5
   908  04d9  f1                SIN3:	POP	AF
   909  04da  e604              	AND	4
   910  04dc  c8                	RET	Z
   911  04dd  0d                	DEC	C
   912  04de  0c                	INC	C
   913  04df  c8                	RET	Z		;ZERO
   914  04e0  cbfc              	SET	7,H		;MAKE NEGATIVE
   915  04e2  c9                	RET
   916                          ;
   917                          ;Floating-point one:
   918                          ;
   919  04e3  210000            FONE:	LD	HL,0
   920  04e6  d9                	EXX
   921  04e7  210000            	LD	HL,0
   922  04ea  d9                	EXX
   923  04eb  0e80              	LD	C,80H
   924  04ed  c9                	RET
   925                          ;
   926  04ee  110000            DONE:	LD	DE,0
   927  04f1  d9                	EXX
   928  04f2  110000            	LD	DE,0
   929  04f5  d9                	EXX
   930  04f6  0680              	LD	B,80H
   931  04f8  c9                	RET
   932                          ;
   933  04f9  110f49            PIBY4:	LD	DE,490FH
   934  04fc  d9                	EXX
   935  04fd  11a2da            	LD	DE,0DAA2H
   936  0500  d9                	EXX
   937  0501  067f              	LD	B,7FH
   938  0503  c9                	RET
   939                          ;
   940                          ;EXP - Exponential function
   941                          ;Result is floating-point numeric.
   942                          ;
   943  0504  cd9d09            EXP:	CALL	SFLOAT
   944  0507  cd8405            EXP0:	CALL	LN2		;LN(2)
   945  050a  d9                	EXX
   946  050b  1d                	DEC	E
   947  050c  01cfd1            	LD	BC,0D1CFH	;0.6931471805599453
   948  050f  d9                	EXX
   949  0510  e5                	PUSH	HL		;H7=SIGN
   950  0511  cd2209            	CALL	MOD48		;"MODULUS"
   951  0514  f1                	POP	AF
   952  0515  cb7b              	BIT	7,E
   953  0517  2809              	JR	Z,EXP1
   954  0519  17                	RLA
   955  051a  da0c0a            	JP	C,ZERO
   956  051d  3e18              	LD	A,EXPRNG
   957  051f  c31100            	JP	ERROR		;"Exp range"
   958                          ;
   959  0522  e680              EXP1:	AND	80H
   960  0524  b3                	OR	E
   961  0525  f5                	PUSH	AF		;INTEGER PART
   962  0526  cbbc              	RES	7,H
   963  0528  cd860a            	CALL	PUSH5		;PUSH X*LN(2)
   964  052b  cdb90a            	CALL	POLY
   965  052e  7240              	DEFW	4072H		;a(7)
   966  0530  2e94              	DEFW	942EH
   967  0532  73                	DEFB	73H
   968  0533  656f              	DEFW	6F65H		;a(6)
   969  0535  4f2e              	DEFW	2E4FH
   970  0537  76                	DEFB	76H
   971  0538  376d              	DEFW	6D37H		;a(5)
   972  053a  0288              	DEFW	8802H
   973  053c  79                	DEFB	79H
   974  053d  12e5              	DEFW	0E512H		;a(4)
   975  053f  a02a              	DEFW	2AA0H
   976  0541  7b                	DEFB	7BH
   977  0542  144f              	DEFW	4F14H		;a(3)
   978  0544  aaaa              	DEFW	0AAAAH
   979  0546  7d                	DEFB	7DH
   980  0547  56fd              	DEFW	0FD56H		;a(2)
   981  0549  ff7f              	DEFW	7FFFH
   982  054b  7e                	DEFB	7EH
   983  054c  feff              	DEFW	0FFFEH		;a(1)
   984  054e  ffff              	DEFW	0FFFFH
   985  0550  7f                	DEFB	7FH
   986  0551  0000              	DEFW	0		;a(0)
   987  0553  0000              	DEFW	0
   988  0555  80                	DEFB	80H
   989  0556  cd8f0a            	CALL	POP5
   990  0559  f1                	POP	AF
   991  055a  f5                	PUSH	AF
   992  055b  f47b05            	CALL	P,RECIP		;X=1/X
   993  055e  f1                	POP	AF
   994  055f  f26605            	JP	P,EXP4
   995  0562  e67f              	AND	7FH
   996  0564  ed44              	NEG
   997  0566  c680              EXP4:	ADD	A,80H
   998  0568  81                	ADD	A,C
   999  0569  3805              	JR	C,EXP2
  1000  056b  f20c0a            	JP	P,ZERO		;UNDERFLOW
  1001  056e  1803              	JR	EXP3
  1002  0570  fadd09            EXP2:	JP	M,OFLOW		;OVERFLOW
  1003  0573  c680              EXP3:	ADD	A,80H
  1004  0575  ca0c0a            	JP	Z,ZERO
  1005  0578  4f                	LD	C,A
  1006  0579  af                	XOR	A		;NUMERIC MARKER
  1007  057a  c9                	RET
  1008                          ;
  1009  057b  cdee04            RECIP:	CALL	DONE
  1010  057e  cdc709            RDIV:	CALL	SWAP
  1011  0581  c38c01            	JP	FDIV		;RECIPROCAL
  1012                          ;
  1013  0584  117231            LN2:	LD	DE,3172H	;LN(2)
  1014  0587  d9                	EXX
  1015  0588  11f817            	LD	DE,17F8H
  1016  058b  d9                	EXX
  1017  058c  067f              	LD	B,7FH
  1018  058e  c9                	RET
  1019                          ;
  1020                          ;LN - Natural log.
  1021                          ;Result is floating-point numeric.
  1022                          ;
  1023  058f  cd9d09            LN:	CALL	SFLOAT
  1024  0592  3e16              LN0:	LD	A,LOGRNG
  1025  0594  cb7c              	BIT	7,H
  1026  0596  c21100            	JP	NZ,ERROR	;"Log range"
  1027  0599  0c                	INC	C
  1028  059a  0d                	DEC	C
  1029  059b  ca1100            	JP	Z,ERROR
  1030  059e  110435            	LD	DE,3504H	;SQR(2)
  1031  05a1  d9                	EXX
  1032  05a2  1133f3            	LD	DE,0F333H	;1.41421356237
  1033  05a5  d9                	EXX
  1034  05a6  cd1e0a            	CALL	ICP0		;MANTISSA>SQR(2)?
  1035  05a9  79                	LD	A,C		;EXPONENT
  1036  05aa  0e80              	LD	C,80H		;1 <= X < 2
  1037  05ac  3802              	JR	C,LN4
  1038  05ae  0d                	DEC	C
  1039  05af  3c                	INC	A
  1040  05b0  f5                LN4:	PUSH	AF		;SAVE EXPONENT
  1041  05b1  cd9b0a            	CALL	RATIO		;X=(X-1)/(X+1)
  1042  05b4  cd860a            	CALL	PUSH5
  1043  05b7  cd800a            	CALL	SQUARE		;PUSH X*X
  1044  05ba  cdb90a            	CALL	POLY
  1045  05bd  48cc              	DEFW	0CC48H		;a(9)
  1046  05bf  fb74              	DEFW	74FBH
  1047  05c1  7d                	DEFB	7DH
  1048  05c2  afae              	DEFW	0AEAFH		;a(7)
  1049  05c4  ff11              	DEFW	11FFH
  1050  05c6  7e                	DEFB	7EH
  1051  05c7  8cd9              	DEFW	0D98CH		;a(5)
  1052  05c9  cd4c              	DEFW	4CCDH
  1053  05cb  7e                	DEFB	7EH
  1054  05cc  e3a9              	DEFW	0A9E3H		;a(3)
  1055  05ce  aa2a              	DEFW	2AAAH
  1056  05d0  7f                	DEFB	7FH
  1057  05d1  0000              	DEFW	0		;a(1)
  1058  05d3  0000              	DEFW	0
  1059  05d5  81                	DEFB	81H
  1060  05d6  cd8f0a            	CALL	POP5
  1061  05d9  cd8f0a            	CALL	POP5
  1062  05dc  cdfc01            	CALL	FMUL
  1063  05df  f1                	POP	AF		;EXPONENT
  1064  05e0  cd860a            	CALL	PUSH5
  1065  05e3  08                	EX	AF,AF'
  1066  05e4  cd0c0a            	CALL	ZERO
  1067  05e7  08                	EX	AF,AF'
  1068  05e8  d680              	SUB	80H
  1069  05ea  281b              	JR	Z,LN3
  1070  05ec  3002              	JR	NC,LN1
  1071  05ee  2f                	CPL
  1072  05ef  3c                	INC	A
  1073  05f0  67                LN1:	LD	H,A
  1074  05f1  0e87              	LD	C,87H
  1075  05f3  f5                	PUSH	AF
  1076  05f4  cd8309            	CALL	FLOAT
  1077  05f7  cbbc              	RES	7,H
  1078  05f9  cd8405            	CALL	LN2
  1079  05fc  cdfc01            	CALL	FMUL
  1080  05ff  f1                	POP	AF
  1081  0600  3005              	JR	NC,LN3
  1082  0602  fa0706            	JP	M,LN3
  1083  0605  cbfc              	SET	7,H
  1084  0607  cd8f0a            LN3:	CALL	POP5
  1085  060a  cd3401            	CALL	FADD
  1086  060d  af                	XOR	A
  1087  060e  c9                	RET
  1088                          ;
  1089                          ;LOG - base-10 logarithm.
  1090                          ;Result is floating-point numeric.
  1091                          ;
  1092  060f  cd8f05            LOG:	CALL	LN
  1093  0612  115b5e            	LD	DE,5E5BH	;LOG(e)
  1094  0615  d9                	EXX
  1095  0616  11a9d8            	LD	DE,0D8A9H
  1096  0619  d9                	EXX
  1097  061a  067e              	LD	B,7EH
  1098  061c  cdfc01            	CALL	FMUL
  1099  061f  af                	XOR	A
  1100  0620  c9                	RET
  1101                          ;
  1102                          ;ASN - Arc-sine
  1103                          ;Result is floating-point numeric.
  1104                          ;
  1105  0621  cd9d09            ASN:	CALL	SFLOAT
  1106  0624  cd860a            	CALL	PUSH5
  1107  0627  cd780a            	CALL	COPY
  1108  062a  cdfc01            	CALL	FMUL
  1109  062d  cdee04            	CALL	DONE
  1110  0630  cd2401            	CALL	RSUB
  1111  0633  cdf203            	CALL	SQR0
  1112  0636  cd8f0a            	CALL	POP5
  1113  0639  0c                	INC	C
  1114  063a  0d                	DEC	C
  1115  063b  3e02              	LD	A,2
  1116  063d  d5                	PUSH	DE
  1117  063e  2870              	JR	Z,ACS1
  1118  0640  d1                	POP	DE
  1119  0641  cd7e05            	CALL	RDIV
  1120  0644  1803              	JR	ATN0
  1121                          ;
  1122                          ;ATN - arc-tangent
  1123                          ;Result is floating-point numeric.
  1124                          ;
  1125  0646  cd9d09            ATN:	CALL	SFLOAT
  1126  0649  e5                ATN0:	PUSH	HL		;SAVE SIGN
  1127  064a  cbbc              	RES	7,H
  1128  064c  111354            	LD	DE,5413H	;TAN(PI/8)=SQR(2)-1
  1129  064f  d9                	EXX
  1130  0650  11d0cc            	LD	DE,0CCD0H
  1131  0653  d9                	EXX
  1132  0654  067e              	LD	B,7EH
  1133  0656  cd1b0a            	CALL	FCP0		;COMPARE
  1134  0659  0600              	LD	B,0
  1135  065b  381c              	JR	C,ATN2
  1136  065d  11821a            	LD	DE,1A82H	;TAN(3*PI/8)=SQR(2)+1
  1137  0660  d9                	EXX
  1138  0661  119a79            	LD	DE,799AH
  1139  0664  d9                	EXX
  1140  0665  0681              	LD	B,81H
  1141  0667  cd1b0a            	CALL	FCP0		;COMPARE
  1142  066a  3808              	JR	C,ATN1
  1143  066c  cd7b05            	CALL	RECIP		;X=1/X
  1144  066f  0602              	LD	B,2
  1145  0671  c37906            	JP	ATN2
  1146  0674  cd9b0a            ATN1:	CALL	RATIO		;X=(X-1)/(X+1)
  1147  0677  0601              	LD	B,1
  1148  0679  c5                ATN2:	PUSH	BC		;SAVE FLAG
  1149  067a  cd860a            	CALL	PUSH5
  1150  067d  cd800a            	CALL	SQUARE		;PUSH X*X
  1151  0680  cdb90a            	CALL	POLY
  1152  0683  35f3              	DEFW	0F335H		;a(13)
  1153  0685  d837              	DEFW	37D8H
  1154  0687  7b                	DEFB	7BH
  1155  0688  916b              	DEFW	6B91H		;a(11)
  1156  068a  b9aa              	DEFW	0AAB9H
  1157  068c  7c                	DEFB	7CH
  1158  068d  de41              	DEFW	41DEH		;a(9)
  1159  068f  9761              	DEFW	6197H
  1160  0691  7c                	DEFB	7CH
  1161  0692  7b9d              	DEFW	9D7BH		;a(7)
  1162  0694  3792              	DEFW	9237H
  1163  0696  7d                	DEFB	7DH
  1164  0697  5a2a              	DEFW	2A5AH		;a(5)
  1165  0699  cc4c              	DEFW	4CCCH
  1166  069b  7d                	DEFB	7DH
  1167  069c  5ca9              	DEFW	0A95CH		;a(3)
  1168  069e  aaaa              	DEFW	0AAAAH
  1169  06a0  7e                	DEFB	7EH
  1170  06a1  0000              	DEFW	0		;a(1)
  1171  06a3  0000              	DEFW	0
  1172  06a5  80                	DEFB	80H
  1173  06a6  cd8f0a            	CALL	POP5
  1174  06a9  cd8f0a            	CALL	POP5
  1175  06ac  cdfc01            	CALL	FMUL
  1176  06af  f1                	POP	AF
  1177  06b0  cdf904            ACS1:	CALL	PIBY4		;PI/4
  1178  06b3  1f                	RRA
  1179  06b4  f5                	PUSH	AF
  1180  06b5  dc3401            	CALL	C,FADD
  1181  06b8  f1                	POP	AF
  1182  06b9  04                	INC	B
  1183  06ba  1f                	RRA
  1184  06bb  dc2401            	CALL	C,RSUB
  1185  06be  f1                	POP	AF
  1186  06bf  b7                	OR	A
  1187  06c0  f0                	RET	P
  1188  06c1  cbfc              	SET	7,H		;MAKE NEGATIVE
  1189  06c3  af                	XOR	A
  1190  06c4  c9                	RET
  1191                          ;
  1192                          ;ACS - Arc cosine=PI/2-ASN.
  1193                          ;Result is floating point numeric.
  1194                          ;
  1195  06c5  cd2106            ACS:	CALL	ASN
  1196  06c8  3e02              	LD	A,2
  1197  06ca  f5                	PUSH	AF
  1198  06cb  18e3              	JR	ACS1
  1199                          ;
  1200                          ;Function STR - convert numeric value to ASCII string.
  1201                          ;   Inputs: HLH'L'C = integer or floating-point number
  1202                          ;           DE = address at which to store string
  1203                          ;           IX = address of @% format control
  1204                          ;  Outputs: String stored, with NUL terminator
  1205                          ;
  1206                          ;First normalise for decimal output:
  1207                          ;
  1208  06cd  cd9d09            STR:	CALL	SFLOAT
  1209  06d0  0600              	LD	B,0		;DEFAULT PT. POSITION
  1210  06d2  cb7c              	BIT	7,H		;NEGATIVE?
  1211  06d4  2806              	JR	Z,STR10
  1212  06d6  cbbc              	RES	7,H
  1213  06d8  3e2d              	LD	A,'-'
  1214  06da  12                	LD	(DE),A		;STORE SIGN
  1215  06db  13                	INC	DE
  1216  06dc  af                STR10:	XOR	A		;CLEAR A
  1217  06dd  b9                	CP	C
  1218  06de  2847              	JR	Z,STR2		;ZERO
  1219  06e0  d5                	PUSH	DE		;SAVE TEXT POINTER
  1220  06e1  78                	LD	A,B
  1221  06e2  f5                STR11:	PUSH	AF		;SAVE DECIMAL COUNTER
  1222  06e3  79                	LD	A,C		;BINARY EXPONENT
  1223  06e4  fea1              	CP	161
  1224  06e6  301a              	JR	NC,STR14
  1225  06e8  fe9b              	CP	155
  1226  06ea  3025              	JR	NC,STR15
  1227  06ec  2f                	CPL
  1228  06ed  fee1              	CP	225
  1229  06ef  3802              	JR	C,STR13
  1230  06f1  3ef8              	LD	A,-8
  1231  06f3  c61c              STR13:	ADD	A,28
  1232  06f5  cde00a            	CALL	POWR10
  1233  06f8  f5                	PUSH	AF
  1234  06f9  cdfc01            	CALL	FMUL
  1235  06fc  f1                	POP	AF
  1236  06fd  47                	LD	B,A
  1237  06fe  f1                	POP	AF
  1238  06ff  90                	SUB	B
  1239  0700  18e0              	JR	STR11
  1240  0702  d620              STR14:	SUB	32
  1241  0704  cde00a            	CALL	POWR10
  1242  0707  f5                	PUSH	AF
  1243  0708  cd8c01            	CALL	FDIV
  1244  070b  f1                	POP	AF
  1245  070c  47                	LD	B,A
  1246  070d  f1                	POP	AF
  1247  070e  80                	ADD	A,B
  1248  070f  18d1              	JR	STR11
  1249  0711  3e09              STR15:	LD	A,9
  1250  0713  cde00a            	CALL	POWR10		;10^9
  1251  0716  cd1b0a            	CALL	FCP0
  1252  0719  79                	LD	A,C
  1253  071a  c1                	POP	BC
  1254  071b  4f                	LD	C,A
  1255  071c  cbfc              	SET	7,H		;IMPLIED 1
  1256  071e  dc3d0a            	CALL	C,X10B		;X10, DEC B
  1257  0721  d1                	POP	DE		;RESTORE TEXT POINTER
  1258  0722  cbb9              	RES	7,C
  1259  0724  3e00              	LD	A,0
  1260  0726  17                	RLA			;PUT CARRY IN LSB
  1261                          ;
  1262                          ;At this point decimal normalisation has been done,
  1263                          ;now convert to decimal digits:
  1264                          ;      AHLH'L' = number in normalised integer form
  1265                          ;            B = decimal place adjustment
  1266                          ;            C = binary place adjustment (29-33)
  1267                          ;
  1268  0727  0c                STR2:	INC	C
  1269  0728  08                	EX	AF,AF'		;SAVE A
  1270  0729  78                	LD	A,B
  1271  072a  ddcb024e          	BIT	1,(IX+2)
  1272  072e  2008              	JR	NZ,STR20
  1273  0730  af                	XOR	A
  1274  0731  ddbe01            	CP	(IX+1)
  1275  0734  280a              	JR	Z,STR21
  1276  0736  3ef6              	LD	A,-10
  1277  0738  dd8601            STR20:	ADD	A,(IX+1)	;SIG. FIG. COUNT
  1278  073b  b7                	OR	A		;CLEAR CARRY
  1279  073c  fa4007            	JP	M,STR21
  1280  073f  af                	XOR	A
  1281  0740  f5                STR21:	PUSH	AF
  1282  0741  08                	EX	AF,AF'		;RESTORE A
  1283  0742  cd660a            STR22:	CALL	X2		;RL AHLH'L'
  1284  0745  8f                	ADC	A,A
  1285  0746  fe0a              	CP	10
  1286  0748  3805              	JR	C,STR23
  1287  074a  d60a              	SUB	10
  1288  074c  d9                	EXX
  1289  074d  2c                	INC	L		;SET RESULT BIT
  1290  074e  d9                	EXX
  1291  074f  0d                STR23:	DEC	C
  1292  0750  20f0              	JR	NZ,STR22	;32 TIMES
  1293  0752  4f                	LD	C,A		;REMAINDER
  1294  0753  7c                	LD	A,H
  1295  0754  e63f              	AND	3FH		;CLEAR OUT JUNK
  1296  0756  67                	LD	H,A
  1297  0757  f1                	POP	AF
  1298  0758  f26507            	JP	P,STR24
  1299  075b  3c                	INC	A
  1300  075c  201c              	JR	NZ,STR26
  1301  075e  3e04              	LD	A,4
  1302  0760  b9                	CP	C		;ROUND UP?
  1303  0761  3e00              	LD	A,0
  1304  0763  1815              	JR	STR26
  1305  0765  f5                STR24:	PUSH	AF
  1306  0766  79                	LD	A,C
  1307  0767  ce30              	ADC	A,'0'		;ADD CARRY
  1308  0769  fe30              	CP	'0'
  1309  076b  2805              	JR	Z,STR25		;SUPPRESS ZERO
  1310  076d  fe3a              	CP	'9'+1
  1311  076f  3f                	CCF
  1312  0770  3008              	JR	NC,STR26
  1313  0772  e3                STR25:	EX	(SP),HL
  1314  0773  cb75              	BIT	6,L		;ZERO FLAG
  1315  0775  e3                	EX	(SP),HL
  1316  0776  2005              	JR	NZ,STR27
  1317  0778  3e30              	LD	A,'0'
  1318  077a  3c                STR26:	INC	A		;SET +VE
  1319  077b  3d                	DEC	A
  1320  077c  f5                	PUSH	AF		;PUT ON STACK + CARRY
  1321  077d  04                STR27:	INC	B
  1322  077e  cdec09            	CALL	TEST		;IS HLH'L' ZERO?
  1323  0781  0e20              	LD	C,32
  1324  0783  3e00              	LD	A,0
  1325  0785  20bb              	JR	NZ,STR22
  1326  0787  f1                	POP	AF
  1327  0788  f5                	PUSH	AF
  1328  0789  3e00              	LD	A,0
  1329  078b  38b5              	JR	C,STR22
  1330                          ;
  1331                          ;At this point, the decimal character string is stored
  1332                          ; on the stack. Trailing zeroes are suppressed and may
  1333                          ; need to be replaced.
  1334                          ;B register holds decimal point position.
  1335                          ;Now format number and store as ASCII string:
  1336                          ;
  1337  078d  eb                STR3:	EX	DE,HL		;STRING POINTER
  1338  078e  0eff              	LD	C,-1		;FLAG "E"
  1339  0790  1601              	LD	D,1
  1340  0792  dd5e01            	LD	E,(IX+1)	;f2
  1341  0795  ddcb0246          	BIT	0,(IX+2)
  1342  0799  2032              	JR	NZ,STR34	;E MODE
  1343  079b  ddcb024e          	BIT	1,(IX+2)
  1344  079f  2811              	JR	Z,STR31
  1345  07a1  78                	LD	A,B		;F MODE
  1346  07a2  b7                	OR	A
  1347  07a3  2804              	JR	Z,STR30
  1348  07a5  faa907            	JP	M,STR30
  1349  07a8  50                	LD	D,B
  1350  07a9  7a                STR30:	LD	A,D
  1351  07aa  dd8601            	ADD	A,(IX+1)
  1352  07ad  5f                	LD	E,A
  1353  07ae  fe0b              	CP	11
  1354  07b0  3817              	JR	C,STR32
  1355  07b2  78                STR31:	LD	A,B		;G MODE
  1356  07b3  110101            	LD	DE,101H
  1357  07b6  b7                	OR	A
  1358  07b7  facd07            	JP	M,STR34
  1359  07ba  280d              	JR	Z,STR32
  1360  07bc  dd7e01            	LD	A,(IX+1)
  1361  07bf  b7                	OR	A
  1362  07c0  2002              	JR	NZ,STR3A
  1363  07c2  3e0a              	LD	A,10
  1364  07c4  b8                STR3A:	CP	B
  1365  07c5  3806              	JR	C,STR34
  1366  07c7  50                	LD	D,B
  1367  07c8  58                	LD	E,B
  1368  07c9  78                STR32:	LD	A,B
  1369  07ca  c681              	ADD	A,129
  1370  07cc  4f                	LD	C,A
  1371  07cd  cbfa              STR34:	SET	7,D
  1372  07cf  1d                	DEC	E
  1373  07d0  7a                STR35:	LD	A,D
  1374  07d1  b9                	CP	C
  1375  07d2  300c              	JR	NC,STR33
  1376  07d4  f1                STR36:	POP	AF
  1377  07d5  2803              	JR	Z,STR37
  1378  07d7  f2e207            	JP	P,STR38
  1379  07da  f5                STR37:	PUSH	AF
  1380  07db  1c                	INC	E
  1381  07dc  1d                	DEC	E
  1382  07dd  faf107            	JP	M,STR4
  1383  07e0  3e30              STR33:	LD	A,'0'
  1384  07e2  15                STR38:	DEC	D
  1385  07e3  e2e907            	JP	PO,STR39
  1386  07e6  362e              	LD	(HL),'.'
  1387  07e8  23                	INC	HL
  1388  07e9  77                STR39:	LD	(HL),A
  1389  07ea  23                	INC	HL
  1390  07eb  1d                	DEC	E
  1391  07ec  f2d007            	JP	P,STR35
  1392  07ef  18e3              	JR	STR36
  1393                          ;
  1394  07f1  f1                STR4:	POP	AF
  1395  07f2  0c                STR40:	INC	C
  1396  07f3  4d                	LD	C,L
  1397  07f4  2027              	JR	NZ,STR44
  1398  07f6  3645              	LD	(HL),'E'	;EXPONENT
  1399  07f8  23                	INC	HL
  1400  07f9  78                	LD	A,B
  1401  07fa  3d                	DEC	A
  1402  07fb  f20308            	JP	P,STR41
  1403  07fe  362d              	LD	(HL),'-'
  1404  0800  23                	INC	HL
  1405  0801  ed44              	NEG
  1406  0803  3630              STR41:	LD	(HL),'0'
  1407  0805  2815              	JR	Z,STR47
  1408  0807  fe0a              	CP	10
  1409  0809  47                	LD	B,A
  1410  080a  3e3a              	LD	A,':'
  1411  080c  3803              	JR	C,STR42
  1412  080e  23                	INC	HL
  1413  080f  3630              	LD	(HL),'0'
  1414  0811  34                STR42:	INC	(HL)
  1415  0812  be                	CP	(HL)
  1416  0813  2005              	JR	NZ,STR43
  1417  0815  3630              	LD	(HL),'0'
  1418  0817  2b                	DEC	HL
  1419  0818  34                	INC	(HL)
  1420  0819  23                	INC	HL
  1421  081a  10f5              STR43:	DJNZ	STR42
  1422  081c  23                STR47:	INC	HL
  1423  081d  eb                STR44:	EX	DE,HL
  1424  081e  c9                	RET
  1425                          ;
  1426                          ;Support subroutines:
  1427                          ;
  1428                          ;CON - Get unsigned numeric constant from ASCII string.
  1429                          ;   Inputs: ASCII string at (IX).
  1430                          ;  Outputs: Variable-type result in HLH'L'C
  1431                          ;           IX updated (points to delimiter)
  1432                          ;           A7 = 0 (numeric marker)
  1433                          ;
  1434  081f  cd0c0a            CON:	CALL	ZERO		;INITIALISE TO ZERO
  1435  0822  0e00              	LD	C,0		;TRUNCATION COUNTER
  1436  0824  cda408            	CALL	NUMBER		;GET INTEGER PART
  1437  0827  fe2e              	CP	'.'
  1438  0829  0600              	LD	B,0		;DECL. PLACE COUNTER
  1439  082b  cca208            	CALL	Z,NUMBIX	;GET FRACTION PART
  1440  082e  fe45              	CP	'E'
  1441  0830  3e00              	LD	A,0		;INITIALISE EXPONENT
  1442  0832  cc7308            	CALL	Z,GETEXP	;GET EXPONENT
  1443  0835  cb7c              	BIT	7,H
  1444  0837  2008              	JR	NZ,CON0		;INTEGER OVERFLOW
  1445  0839  b7                	OR	A
  1446  083a  2005              	JR	NZ,CON0		;EXPONENT NON-ZERO
  1447  083c  b8                	CP	B
  1448  083d  2002              	JR	NZ,CON0		;DECIMAL POINT
  1449  083f  b9                	CP	C
  1450  0840  c8                	RET	Z		;INTEGER
  1451  0841  90                CON0:	SUB	B
  1452  0842  81                	ADD	A,C
  1453  0843  0e9f              	LD	C,159
  1454  0845  cd8309            	CALL	FLOAT
  1455  0848  cbbc              	RES	7,H		;DITCH IMPLIED 1
  1456  084a  b7                	OR	A
  1457  084b  c8                	RET	Z		;DONE
  1458  084c  fa5708            	JP	M,CON2		;NEGATIVE EXPONENT
  1459  084f  cde00a            	CALL	POWR10
  1460  0852  cdfc01            	CALL	FMUL		;SCALE
  1461  0855  af                	XOR	A
  1462  0856  c9                	RET
  1463  0857  feda              CON2:	CP	-38
  1464  0859  380a              	JR	C,CON3		;CAN'T SCALE IN ONE GO
  1465  085b  ed44              	NEG
  1466  085d  cde00a            	CALL	POWR10
  1467  0860  cd8c01            	CALL	FDIV		;SCALE
  1468  0863  af                	XOR	A
  1469  0864  c9                	RET
  1470  0865  f5                CON3:	PUSH	AF
  1471  0866  3e26              	LD	A,38
  1472  0868  cde00a            	CALL	POWR10
  1473  086b  cd8c01            	CALL	FDIV
  1474  086e  f1                	POP	AF
  1475  086f  c626              	ADD	A,38
  1476  0871  18e4              	JR	CON2
  1477                          ;
  1478                          ;GETEXP - Get decimal exponent from string
  1479                          ;     Inputs: ASCII string at (IX)
  1480                          ;             (IX points at 'E')
  1481                          ;             A = initial value
  1482                          ;    Outputs: A = new exponent
  1483                          ;             IX updated.
  1484                          ;   Destroys: A,A',IX,F,F'
  1485                          ;
  1486  0873  c5                GETEXP:	PUSH	BC		;SAVE REGISTERS
  1487  0874  47                	LD	B,A		;INITIAL VALUE
  1488  0875  0e02              	LD	C,2		;2 DIGITS MAX
  1489  0877  dd23              	INC	IX		;BUMP PAST 'E'
  1490  0879  cdce0b            	CALL	SIGNQ
  1491  087c  08                	EX	AF,AF'		;SAVE EXPONENT SIGN
  1492  087d  cdc40b            GETEX1:	CALL	DIGITQ
  1493  0880  3817              	JR	C,GETEX2
  1494  0882  78                	LD	A,B		;B=B*10
  1495  0883  87                	ADD	A,A
  1496  0884  87                	ADD	A,A
  1497  0885  80                	ADD	A,B
  1498  0886  87                	ADD	A,A
  1499  0887  47                	LD	B,A
  1500  0888  dd7e00            	LD	A,(IX)		;GET BACK DIGIT
  1501  088b  dd23              	INC	IX
  1502  088d  e60f              	AND	0FH		;MASK UNWANTED BITS
  1503  088f  80                	ADD	A,B		;ADD IN DIGIT
  1504  0890  47                	LD	B,A
  1505  0891  0d                	DEC	C
  1506  0892  f27d08            	JP	P,GETEX1
  1507  0895  0664              	LD	B,100		;FORCE OVERFLOW
  1508  0897  18e4              	JR	GETEX1
  1509  0899  08                GETEX2:	EX	AF,AF'		;RESTORE SIGN
  1510  089a  fe2d              	CP	'-'
  1511  089c  78                	LD	A,B
  1512  089d  c1                	POP	BC		;RESTORE
  1513  089e  c0                	RET	NZ
  1514  089f  ed44              	NEG			;NEGATE EXPONENT
  1515  08a1  c9                	RET
  1516                          ;
  1517                          ;NUMBER: Get unsigned integer from string.
  1518                          ;    Inputs: string at (IX)
  1519                          ;            C = truncated digit count
  1520                          ;                (initially zero)
  1521                          ;            B = total digit count
  1522                          ;            HLH'L' = initial value
  1523                          ;   Outputs: HLH'L' = number (binary integer)
  1524                          ;            A = delimiter.
  1525                          ;            B, C & IX updated
  1526                          ;  Destroys: A,B,C,D,E,H,L,B',C',D',E',H',L',IX,F
  1527                          ;
  1528  08a2  dd23              NUMBIX:	INC	IX
  1529  08a4  cdc40b            NUMBER:	CALL	DIGITQ
  1530  08a7  d8                	RET	C
  1531  08a8  04                	INC	B		;INCREMENT DIGIT COUNT
  1532  08a9  dd23              	INC	IX
  1533  08ab  cd570a            	CALL	X10		;*10 & COPY OLD VALUE
  1534  08ae  3813              	JR	C,NUMB1		;OVERFLOW
  1535  08b0  0d                	DEC	C		;SEE IF TRUNCATED
  1536  08b1  0c                	INC	C
  1537  08b2  200f              	JR	NZ,NUMB1	;IMPORTANT!
  1538  08b4  e60f              	AND	0FH
  1539  08b6  d9                	EXX
  1540  08b7  0600              	LD	B,0
  1541  08b9  4f                	LD	C,A
  1542  08ba  09                	ADD	HL,BC		;ADD IN DIGIT
  1543  08bb  d9                	EXX
  1544  08bc  30e6              	JR	NC,NUMBER
  1545  08be  23                	INC	HL		;CARRY
  1546  08bf  7c                	LD	A,H
  1547  08c0  b5                	OR	L
  1548  08c1  20e1              	JR	NZ,NUMBER
  1549  08c3  0c                NUMB1:	INC	C		;TRUNCATION COUNTER
  1550  08c4  cdca09            	CALL	SWAP1		;RESTORE PREVIOUS VALUE
  1551  08c7  18db              	JR	NUMBER
  1552                          ;
  1553                          ;FIX - Fix number to specified exponent value.
  1554                          ;    Inputs: HLH'L'C = +ve non-zero number (floated)
  1555                          ;            A = desired exponent (A>C)
  1556                          ;   Outputs: HLH'L'C = fixed number (unsigned)
  1557                          ;            fraction shifted into B'C'
  1558                          ;            A'F' positive if integer input
  1559                          ;  Destroys: C,H,L,A',B',C',H',L',F,F'
  1560                          ;
  1561  08c9  08                FIX:	EX	AF,AF'
  1562  08ca  af                	XOR	A
  1563  08cb  08                	EX	AF,AF'
  1564  08cc  cbfc              	SET	7,H		;IMPLIED 1
  1565  08ce  cdcf09            FIX1:	CALL	DIV2
  1566  08d1  b9                	CP	C
  1567  08d2  c8                	RET	Z
  1568  08d3  d2ce08            	JP	NC,FIX1
  1569  08d6  c3dd09            	JP	OFLOW
  1570                          ;
  1571                          ;SFIX - Convert to integer if necessary.
  1572                          ;    Input: Variable-type number in HLH'L'C
  1573                          ;   Output: Integer in HLH'L', C=0
  1574                          ; Destroys: A,C,H,L,A',B',C',H',L',F,F'
  1575                          ;
  1576                          ;NEGATE - Negate HLH'L'
  1577                          ;    Destroys: H,L,H',L',F
  1578                          ;
  1579  08d9  cdc709            FIX2:	CALL	SWAP
  1580  08dc  cde208            	CALL	SFIX
  1581  08df  cdc709            	CALL	SWAP
  1582  08e2  0d                SFIX:	DEC	C
  1583  08e3  0c                	INC	C
  1584  08e4  c8                	RET	Z		;INTEGER/ZERO
  1585  08e5  cb7c              	BIT	7,H		;SIGN
  1586  08e7  f5                	PUSH	AF
  1587  08e8  3e9f              	LD	A,159
  1588  08ea  cdc908            	CALL	FIX
  1589  08ed  f1                	POP	AF
  1590  08ee  0e00              	LD	C,0
  1591  08f0  c8                	RET	Z
  1592  08f1  b7                NEGATE:	OR	A		;CLEAR CARRY
  1593  08f2  d9                	EXX
  1594  08f3  d5                NEG0:	PUSH	DE
  1595  08f4  eb                	EX	DE,HL
  1596  08f5  210000            	LD	HL,0
  1597  08f8  ed52              	SBC	HL,DE
  1598  08fa  d1                	POP	DE
  1599  08fb  d9                	EXX
  1600  08fc  d5                	PUSH	DE
  1601  08fd  eb                	EX	DE,HL
  1602  08fe  210000            	LD	HL,0
  1603  0901  ed52              	SBC	HL,DE
  1604  0903  d1                	POP	DE
  1605  0904  c9                	RET
  1606                          ;
  1607                          ;NEG - Negate HLH'L'B'C'
  1608                          ;    Also complements A (used in FADD)
  1609                          ;    Destroys: A,H,L,B',C',H',L',F
  1610                          ;
  1611  0905  d9                NEG:	EXX
  1612  0906  2f                	CPL
  1613  0907  e5                	PUSH	HL
  1614  0908  b7                	OR	A		;CLEAR CARRY
  1615  0909  ed62              	SBC	HL,HL
  1616  090b  ed42              	SBC	HL,BC
  1617  090d  44                	LD	B,H
  1618  090e  4d                	LD	C,L
  1619  090f  e1                	POP	HL
  1620  0910  18e1              	JR	NEG0
  1621                          ;
  1622                          ;SCALE - Trig scaling.
  1623                          ;MOD48 - 48-bit floating-point "modulus" (remainder).
  1624                          ;   Inputs: HLH'L'C unsigned floating-point dividend
  1625                          ;           DED'E'B'C'B unsigned 48-bit FP divisor
  1626                          ;  Outputs: HLH'L'C floating point remainder (H7=1)
  1627                          ;           E = quotient (bit 7 is sticky)
  1628                          ; Destroys: A,B,C,D,E,H,L,B',C',D',E',H',L',IX,F
  1629                          ;FLO48 - Float unsigned number (48 bits)
  1630                          ;    Input/output in HLH'L'B'C'C
  1631                          ;   Destroys: C,H,L,B',C',H',L',F
  1632                          ;
  1633  0912  3e96              SCALE:	LD	A,150
  1634  0914  b9                	CP	C
  1635  0915  3e17              	LD	A,ACLOST
  1636  0917  da1100            	JP	C,ERROR		;"Accuracy lost"
  1637  091a  cdf904            	CALL	PIBY4
  1638  091d  d9                	EXX
  1639  091e  016921            	LD	BC,2169H	;3.141592653589793238
  1640  0921  d9                	EXX
  1641  0922  cbfa              MOD48:	SET	7,D		;IMPLIED 1
  1642  0924  cbfc              	SET	7,H
  1643  0926  79                	LD	A,C
  1644  0927  0e00              	LD	C,0		;INIT QUOTIENT
  1645  0929  dd210000          	LD	IX,0
  1646  092d  dde5              	PUSH	IX		;PUT ZERO ON STACK
  1647  092f  b8                	CP	B
  1648  0930  383a              	JR	C,MOD485	;DIVIDEND<DIVISOR
  1649  0932  d9                MOD481:	EXX			;CARRY=0 HERE
  1650  0933  e3                	EX	(SP),HL
  1651  0934  ed42              	SBC	HL,BC
  1652  0936  e3                	EX	(SP),HL
  1653  0937  ed52              	SBC	HL,DE
  1654  0939  d9                	EXX
  1655  093a  ed52              	SBC	HL,DE
  1656  093c  3009              	JR	NC,MOD482	;DIVIDEND>=DIVISOR
  1657  093e  d9                	EXX
  1658  093f  e3                	EX	(SP),HL
  1659  0940  09                	ADD	HL,BC
  1660  0941  e3                	EX	(SP),HL
  1661  0942  ed5a              	ADC	HL,DE
  1662  0944  d9                	EXX
  1663  0945  ed5a              	ADC	HL,DE
  1664  0947  3f                MOD482:	CCF
  1665  0948  cb11              	RL	C		;QUOTIENT
  1666  094a  3002              	JR	NC,MOD483
  1667  094c  cbf9              	SET	7,C		;STICKY BIT
  1668  094e  3d                MOD483:	DEC	A
  1669  094f  b8                	CP	B
  1670  0950  3819              	JR	C,MOD484	;DIVIDEND<DIVISOR
  1671  0952  e3                	EX	(SP),HL
  1672  0953  29                	ADD	HL,HL		;DIVIDEND * 2
  1673  0954  e3                	EX	(SP),HL
  1674  0955  d9                	EXX
  1675  0956  ed6a              	ADC	HL,HL
  1676  0958  d9                	EXX
  1677  0959  ed6a              	ADC	HL,HL
  1678  095b  30d5              	JR	NC,MOD481	;AGAIN
  1679  095d  b7                	OR	A
  1680  095e  d9                	EXX
  1681  095f  e3                	EX	(SP),HL
  1682  0960  ed42              	SBC	HL,BC		;OVERFLOW, SO SUBTRACT
  1683  0962  e3                	EX	(SP),HL
  1684  0963  ed52              	SBC	HL,DE
  1685  0965  d9                	EXX
  1686  0966  ed52              	SBC	HL,DE
  1687  0968  b7                	OR	A
  1688  0969  18dc              	JR	MOD482
  1689                          ;
  1690  096b  3c                MOD484:	INC	A
  1691  096c  59                MOD485:	LD	E,C		;QUOTIENT
  1692  096d  4f                	LD	C,A		;REMAINDER EXPONENT
  1693  096e  d9                	EXX
  1694  096f  c1                	POP	BC
  1695  0970  d9                	EXX
  1696  0971  cb7c              FLO48:	BIT	7,H
  1697  0973  c0                	RET	NZ
  1698  0974  d9                	EXX
  1699  0975  cb21              	SLA	C
  1700  0977  cb10              	RL	B
  1701  0979  ed6a              	ADC	HL,HL
  1702  097b  d9                	EXX
  1703  097c  ed6a              	ADC	HL,HL
  1704  097e  0d                	DEC	C
  1705  097f  c27109            	JP	NZ,FLO48
  1706  0982  c9                	RET
  1707                          ;
  1708                          ;Float unsigned number
  1709                          ;    Input/output in HLH'L'C
  1710                          ;   Destroys: C,H,L,H',L',F
  1711                          ;
  1712  0983  cb7c              FLOAT:	BIT	7,H
  1713  0985  c0                	RET	NZ
  1714  0986  d9                	EXX			;SAME AS "X2"
  1715  0987  29                	ADD	HL,HL		;TIME-CRITICAL
  1716  0988  d9                	EXX			;REGION
  1717  0989  ed6a              	ADC	HL,HL		;(BENCHMARKS)
  1718  098b  0d                	DEC	C
  1719  098c  c28309            	JP	NZ,FLOAT
  1720  098f  c9                	RET
  1721                          ;
  1722                          ;SFLOAT - Convert to floating-point if necessary.
  1723                          ;    Input: Variable-type number in HLH'L'C
  1724                          ;    Output: Floating-point in HLH'L'C
  1725                          ;    Destroys: A,C,H,L,H',L',F
  1726                          ;
  1727  0990  08                FLOATA:	EX	AF,AF'
  1728  0991  c630              	ADD	A,(RTABLE-DTABLE)/2
  1729  0993  08                	EX	AF,AF'
  1730  0994  cdc709            FLOAT2:	CALL	SWAP
  1731  0997  cd9d09            	CALL	SFLOAT
  1732  099a  cdc709            	CALL	SWAP
  1733  099d  0d                SFLOAT:	DEC	C
  1734  099e  0c                	INC	C
  1735  099f  c0                	RET	NZ		;ALREADY FLOATING-POINT
  1736  09a0  cdec09            	CALL	TEST
  1737  09a3  c8                	RET	Z		;ZERO
  1738  09a4  7c                	LD	A,H
  1739  09a5  b7                	OR	A
  1740  09a6  fcf108            	CALL	M,NEGATE
  1741  09a9  0e9f              	LD	C,159
  1742  09ab  cd8309            	CALL	FLOAT
  1743  09ae  b7                	OR	A
  1744  09af  f8                	RET	M		;NEGATIVE
  1745  09b0  cbbc              	RES	7,H
  1746  09b2  c9                	RET
  1747                          ;
  1748                          ;ROUND UP
  1749                          ;Return with carry set if 32-bit overflow
  1750                          ;   Destroys: H,L,B',C',H',L',F
  1751                          ;
  1752  09b3  d9                ADD1:	EXX
  1753  09b4  010100            	LD	BC,1
  1754  09b7  09                	ADD	HL,BC
  1755  09b8  d9                	EXX
  1756  09b9  d0                	RET	NC
  1757  09ba  c5                	PUSH	BC
  1758  09bb  010100            	LD	BC,1
  1759  09be  09                	ADD	HL,BC
  1760  09bf  c1                	POP	BC
  1761  09c0  c9                	RET
  1762                          ;
  1763                          ;ODD - Add one if even, leave alone if odd.
  1764                          ; (Used to perform unbiassed rounding, i.e.
  1765                          ;  number is rounded up half the time)
  1766                          ;    Destroys: L',F (carry cleared)
  1767                          ;
  1768  09c1  b7                ODD:	OR	A		;CLEAR CARRY
  1769  09c2  d9                	EXX
  1770  09c3  cbc5              	SET	0,L		;MAKE ODD
  1771  09c5  d9                	EXX
  1772  09c6  c9                	RET
  1773                          ;
  1774                          ;SWAP - Swap arguments.
  1775                          ;    Exchanges DE,HL D'E',H'L' and B,C
  1776                          ;    Destroys: A,B,C,D,E,H,L,D',E',H',L'
  1777                          ;SWAP1 - Swap DEHL with D'E'H'L'
  1778                          ;    Destroys: D,E,H,L,D',E',H',L'
  1779                          ;
  1780  09c7  79                SWAP:	LD	A,C
  1781  09c8  48                	LD	C,B
  1782  09c9  47                	LD	B,A
  1783  09ca  eb                SWAP1:	EX	DE,HL
  1784  09cb  d9                	EXX
  1785  09cc  eb                	EX	DE,HL
  1786  09cd  d9                	EXX
  1787  09ce  c9                	RET
  1788                          ;
  1789                          ;DIV2 - destroys C,H,L,A',B',C',H',L',F,F'
  1790                          ;INCC - destroys C,F
  1791                          ;OFLOW
  1792                          ;
  1793  09cf  cd6d0a            DIV2:	CALL	D2
  1794  09d2  d9                	EXX
  1795  09d3  cb18              	RR	B
  1796  09d5  cb19              	RR	C
  1797  09d7  08                	EX	AF,AF'
  1798  09d8  b0                	OR	B
  1799  09d9  08                	EX	AF,AF'
  1800  09da  d9                	EXX
  1801  09db  0c                INCC:	INC	C
  1802  09dc  c0                	RET	NZ
  1803  09dd  3e14              OFLOW:	LD	A,TOOBIG
  1804  09df  c31100            	JP	ERROR		;"Too big"
  1805                          ;
  1806                          ;FTEST - Test for zero & sign
  1807                          ;    Output: A=0 if zero, A=&40 if +ve, A=&C0 if -ve
  1808                          ;
  1809  09e2  cdec09            FTEST:	CALL	TEST
  1810  09e5  c8                	RET	Z
  1811  09e6  7c                	LD	A,H
  1812  09e7  e680              	AND	10000000B
  1813  09e9  f640              	OR	01000000B
  1814  09eb  c9                	RET
  1815                          ;
  1816                          ;TEST - Test HLH'L' for zero.
  1817                          ;    Output: Z-flag set & A=0 if HLH'L'=0
  1818                          ;    Destroys: A,F
  1819                          ;
  1820  09ec  7c                TEST:	LD	A,H
  1821  09ed  b5                	OR	L
  1822  09ee  d9                	EXX
  1823  09ef  b4                	OR	H
  1824  09f0  b5                	OR	L
  1825  09f1  d9                	EXX
  1826  09f2  c9                	RET
  1827                          ;
  1828                          ;FCOMP - Compare two numbers
  1829                          ;    Output: A=0 if equal, A=&40 if L>R, A=&C0 if L<R
  1830                          ;
  1831  09f3  78                FCOMP:	LD	A,B
  1832  09f4  b1                	OR	C		;Both integer?
  1833  09f5  200a              	JR	NZ,FCOMP1
  1834  09f7  cd090a            	CALL	ICP
  1835  09fa  3e00              FCOMP0:	LD	A,0
  1836  09fc  c8                	RET	Z		;Equal
  1837  09fd  3e80              	LD	A,80H
  1838  09ff  1f                	RRA
  1839  0a00  c9                	RET
  1840                          ;
  1841  0a01  cd9409            FCOMP1:	CALL	FLOAT2		;Float both
  1842  0a04  cd160a            	CALL	FCP
  1843  0a07  18f1              	JR	FCOMP0
  1844                          ;
  1845                          ;Integer and floating point compare.
  1846                          ;Sets carry & zero flags according to HLH'L'C-DED'E'B
  1847                          ;Result pre-set to FALSE
  1848                          ;ICP1, FCP1 destroy A,F
  1849                          ;
  1850                          ;ZERO - Return zero.
  1851                          ; Destroys: A,C,H,L,H',L'
  1852                          ;
  1853  0a09  cd350a            ICP:	CALL	ICP1
  1854  0a0c  3e00              ZERO:	LD	A,0
  1855  0a0e  d9                	EXX
  1856  0a0f  67                	LD	H,A
  1857  0a10  6f                	LD	L,A
  1858  0a11  d9                	EXX
  1859  0a12  67                	LD	H,A
  1860  0a13  6f                	LD	L,A
  1861  0a14  4f                	LD	C,A
  1862  0a15  c9                	RET
  1863                          ;
  1864  0a16  cd280a            FCP:	CALL	FCP1
  1865  0a19  18f1              	JR	ZERO		;PRESET FALSE
  1866                          ;
  1867  0a1b  79                FCP0:	LD	A,C
  1868  0a1c  b8                	CP	B		;COMPARE EXPONENTS
  1869  0a1d  c0                	RET	NZ
  1870  0a1e  ed52              ICP0:	SBC	HL,DE		;COMP MANTISSA MSB
  1871  0a20  19                	ADD	HL,DE
  1872  0a21  c0                	RET	NZ
  1873  0a22  d9                	EXX
  1874  0a23  ed52              	SBC	HL,DE		;COMP MANTISSA LSB
  1875  0a25  19                	ADD	HL,DE
  1876  0a26  d9                	EXX
  1877  0a27  c9                	RET
  1878                          ;
  1879  0a28  7c                FCP1:	LD	A,H
  1880  0a29  aa                	XOR	D
  1881  0a2a  7c                	LD	A,H
  1882  0a2b  17                	RLA
  1883  0a2c  f8                	RET	M
  1884  0a2d  30ec              	JR	NC,FCP0
  1885  0a2f  cd1b0a            	CALL	FCP0
  1886  0a32  c8                	RET	Z		;** V0.1 BUG FIX
  1887  0a33  3f                	CCF
  1888  0a34  c9                	RET
  1889                          ;
  1890  0a35  7c                ICP1:	LD	A,H
  1891  0a36  aa                	XOR	D
  1892  0a37  f21e0a            	JP	P,ICP0
  1893  0a3a  7c                	LD	A,H
  1894  0a3b  17                	RLA
  1895  0a3c  c9                	RET
  1896                          ;
  1897                          ;ADD - Integer add.
  1898                          ;Carry, sign & zero flags valid on exit
  1899                          ;    Destroys: H,L,H',L',F
  1900                          ;
  1901  0a3d  05                X10B:	DEC	B
  1902  0a3e  0c                	INC	C
  1903  0a3f  cd790a            X5:	CALL	COPY0
  1904  0a42  cd6c0a            	CALL	D2C
  1905  0a45  cd6c0a            	CALL	D2C
  1906  0a48  08                	EX	AF,AF'		;SAVE CARRY
  1907  0a49  d9                ADD:	EXX
  1908  0a4a  19                	ADD	HL,DE
  1909  0a4b  d9                	EXX
  1910  0a4c  ed5a              	ADC	HL,DE
  1911  0a4e  c9                	RET
  1912                          ;
  1913                          ;SUB - Integer subtract.
  1914                          ;Carry, sign & zero flags valid on exit
  1915                          ;    Destroys: H,L,H',L',F
  1916                          ;
  1917  0a4f  d9                SUB:	EXX
  1918  0a50  b7                	OR	A
  1919  0a51  ed52              	SBC	HL,DE
  1920  0a53  d9                	EXX
  1921  0a54  ed52              	SBC	HL,DE
  1922  0a56  c9                	RET
  1923                          ;
  1924                          ;X10 - unsigned integer * 10
  1925                          ;   Inputs: HLH'L' initial value
  1926                          ;  Outputs: DED'E' = initial HLH'L'
  1927                          ;           Carry bit set if overflow
  1928                          ;           If carry not set HLH'L'=result
  1929                          ; Destroys: D,E,H,L,D',E',H',L',F
  1930                          ;X2 - Multiply HLH'L' by 2 as 32-bit integer.
  1931                          ;    Carry set if MSB=1 before shift.
  1932                          ;    Sign set if MSB=1 after shift.
  1933                          ;    Destroys: H,L,H',L',F
  1934                          ;
  1935  0a57  cd790a            X10:	CALL	COPY0		;DED'E'=HLH'L'
  1936  0a5a  cd660a            	CALL	X2
  1937  0a5d  d8                	RET	C		;TOO BIG
  1938  0a5e  cd660a            	CALL	X2
  1939  0a61  d8                	RET	C
  1940  0a62  cd490a            	CALL	ADD
  1941  0a65  d8                	RET	C
  1942  0a66  d9                X2:	EXX
  1943  0a67  29                	ADD	HL,HL
  1944  0a68  d9                	EXX
  1945  0a69  ed6a              	ADC	HL,HL
  1946  0a6b  c9                	RET
  1947                          ;
  1948                          ;D2 - Divide HLH'L' by 2 as 32-bit integer.
  1949                          ;    Carry set if LSB=1 before shift.
  1950                          ;    Destroys: H,L,H',L',F
  1951                          ;
  1952  0a6c  0c                D2C:	INC	C
  1953  0a6d  cb3c              D2:	SRL	H
  1954  0a6f  cb1d              	RR	L
  1955  0a71  d9                	EXX
  1956  0a72  cb1c              	RR	H
  1957  0a74  cb1d              	RR	L
  1958  0a76  d9                	EXX
  1959  0a77  c9                	RET
  1960                          ;
  1961                          ;COPY - COPY HLH'L'C INTO DED'E'B
  1962                          ;  Destroys: B,C,D,E,H,L,D',E',H',L'
  1963                          ;
  1964  0a78  41                COPY:	LD	B,C
  1965  0a79  54                COPY0:	LD	D,H
  1966  0a7a  5d                	LD	E,L
  1967  0a7b  d9                	EXX
  1968  0a7c  54                	LD	D,H
  1969  0a7d  5d                	LD	E,L
  1970  0a7e  d9                	EXX
  1971  0a7f  c9                	RET
  1972                          ;
  1973                          ;SQUARE - PUSH X*X
  1974                          ;PUSH5 - PUSH HLH'L'C ONTO STACK.
  1975                          ;  Destroys: SP,IX
  1976                          ;
  1977  0a80  cd780a            SQUARE:	CALL	COPY
  1978  0a83  cdfc01            	CALL	FMUL
  1979  0a86  dde1              PUSH5:	POP	IX		;RETURN ADDRESS
  1980  0a88  c5                	PUSH	BC
  1981  0a89  e5                	PUSH	HL
  1982  0a8a  d9                	EXX
  1983  0a8b  e5                	PUSH	HL
  1984  0a8c  d9                	EXX
  1985  0a8d  dde9              	JP	(IX)		;"RETURN"
  1986                          ;
  1987                          ;POP5 - POP DED'E'B OFF STACK.
  1988                          ;  Destroys: A,B,D,E,D',E',SP,IX
  1989                          ;
  1990  0a8f  dde1              POP5:	POP	IX		;RETURN ADDRESS
  1991  0a91  d9                	EXX
  1992  0a92  d1                	POP	DE
  1993  0a93  d9                	EXX
  1994  0a94  d1                	POP	DE
  1995  0a95  79                	LD	A,C
  1996  0a96  c1                	POP	BC
  1997  0a97  41                	LD	B,C
  1998  0a98  4f                	LD	C,A
  1999  0a99  dde9              	JP	(IX)		;"RETURN"
  2000                          ;
  2001                          ;RATIO - Calculate (X-1)/(X+1)
  2002                          ;    Inputs: X in HLH'L'C
  2003                          ;   Outputs: (X-1)/(X+1) in HLH'L'C
  2004                          ;  Destroys: Everything except IY,SP,I
  2005                          ;
  2006  0a9b  cd860a            RATIO:	CALL	PUSH5		;SAVE X
  2007  0a9e  cdee04            	CALL	DONE
  2008  0aa1  cd3401            	CALL	FADD
  2009  0aa4  cd8f0a            	CALL	POP5		;RESTORE X
  2010  0aa7  cd860a            	CALL	PUSH5		;SAVE X+1
  2011  0aaa  cdc709            	CALL	SWAP
  2012  0aad  cdee04            	CALL	DONE
  2013  0ab0  cd1e01            	CALL	FSUB
  2014  0ab3  cd8f0a            	CALL	POP5		;RESTORE X+1
  2015  0ab6  c38c01            	JP	FDIV
  2016                          ;
  2017                          ;POLY - Evaluate a polynomial.
  2018                          ;    Inputs: X in HLH'L'C and also stored at (SP+2)
  2019                          ;            Polynomial coefficients follow call.
  2020                          ;   Outputs: Result in HLH'L'C
  2021                          ;  Destroys: Everything except IY,SP,I
  2022                          ;Routine terminates on finding a coefficient >=1.
  2023                          ;Note: The last coefficient is EXECUTED on return
  2024                          ;      so must contain only innocuous bytes!
  2025                          ;
  2026  0ab9  dd210200          POLY:	LD	IX,2
  2027  0abd  dd39              	ADD	IX,SP
  2028  0abf  dde3              	EX	(SP),IX
  2029  0ac1  cd0000            	CALL	DLOAD5		;FIRST COEFFICIENT
  2030  0ac4  cdfc01            POLY1:	CALL	FMUL
  2031  0ac7  110500            	LD	DE,5
  2032  0aca  dd19              	ADD	IX,DE
  2033  0acc  cd0000            	CALL	DLOAD5		;NEXT COEFFICIENT
  2034  0acf  dde3              	EX	(SP),IX
  2035  0ad1  04                	INC	B
  2036  0ad2  05                	DEC	B		;TEST
  2037  0ad3  fa3401            	JP	M,FADD
  2038  0ad6  cd3401            	CALL	FADD
  2039  0ad9  cd0000            	CALL	DLOAD5		;X
  2040  0adc  dde3              	EX	(SP),IX
  2041  0ade  18e4              	JR	POLY1
  2042                          ;
  2043                          ;POWR10 - Calculate power of ten.
  2044                          ;    Inputs: A=power of 10 required (A<128)
  2045                          ;            A=binary exponent to be exceeded (A>=128)
  2046                          ;   Outputs: DED'E'B = result
  2047                          ;            A = actual power of ten returned
  2048                          ;  Destroys: A,B,D,E,A',D',E',F,F'
  2049                          ;
  2050  0ae0  3c                POWR10:	INC	A
  2051  0ae1  08                	EX	AF,AF'
  2052  0ae2  e5                	PUSH	HL
  2053  0ae3  d9                	EXX
  2054  0ae4  e5                	PUSH	HL
  2055  0ae5  d9                	EXX
  2056  0ae6  cdee04            	CALL	DONE
  2057  0ae9  cdc709            	CALL	SWAP
  2058  0aec  af                	XOR	A
  2059  0aed  08                POWR11:	EX	AF,AF'
  2060  0aee  3d                	DEC	A
  2061  0aef  2820              	JR	Z,POWR14	;EXIT TYPE 1
  2062  0af1  f2f80a            	JP	P,POWR13
  2063  0af4  b9                	CP	C
  2064  0af5  381a              	JR	C,POWR14	;EXIT TYPE 2
  2065  0af7  3c                	INC	A
  2066  0af8  08                POWR13:	EX	AF,AF'
  2067  0af9  3c                	INC	A
  2068  0afa  cbfc              	SET	7,H
  2069  0afc  cd3f0a            	CALL	X5
  2070  0aff  3005              	JR	NC,POWR12
  2071  0b01  08                	EX	AF,AF'
  2072  0b02  cd6c0a            	CALL	D2C
  2073  0b05  08                	EX	AF,AF'
  2074  0b06  08                POWR12:	EX	AF,AF'
  2075  0b07  dcb309            	CALL	C,ADD1		;ROUND UP
  2076  0b0a  0c                	INC	C
  2077  0b0b  faed0a            	JP	M,POWR11
  2078  0b0e  c3dd09            	JP	OFLOW
  2079  0b11  cdc709            POWR14:	CALL	SWAP
  2080  0b14  cbba              	RES	7,D
  2081  0b16  d9                	EXX
  2082  0b17  e1                	POP	HL
  2083  0b18  d9                	EXX
  2084  0b19  e1                	POP	HL
  2085  0b1a  08                	EX	AF,AF'
  2086  0b1b  c9                	RET
  2087                          ;
  2088                          ;DIVA, DIVB - DIVISION PRIMITIVE.
  2089                          ;    Function: D'E'DE = H'L'HLD'E'DE / B'C'BC
  2090                          ;              Remainder in H'L'HL
  2091                          ;    Inputs: A = loop counter (normally -32)
  2092                          ;    Destroys: A,D,E,H,L,D',E',H',L',F
  2093                          ;
  2094  0b1c  b7                DIVA:	OR	A		;CLEAR CARRY
  2095  0b1d  ed42              DIV0:	SBC	HL,BC		;DIVIDEND-DIVISOR
  2096  0b1f  d9                	EXX
  2097  0b20  ed42              	SBC	HL,BC
  2098  0b22  d9                	EXX
  2099  0b23  3005              	JR	NC,DIV1
  2100  0b25  09                	ADD	HL,BC		;DIVIDEND+DIVISOR
  2101  0b26  d9                	EXX
  2102  0b27  ed4a              	ADC	HL,BC
  2103  0b29  d9                	EXX
  2104  0b2a  3f                DIV1:	CCF
  2105  0b2b  cb13              DIVC:	RL	E		;SHIFT RESULT INTO DE
  2106  0b2d  cb12              	RL	D
  2107  0b2f  d9                	EXX
  2108  0b30  cb13              	RL	E
  2109  0b32  cb12              	RL	D
  2110  0b34  d9                	EXX
  2111  0b35  3c                	INC	A
  2112  0b36  f0                	RET	P
  2113  0b37  ed6a              DIVB:	ADC	HL,HL		;DIVIDEND*2
  2114  0b39  d9                	EXX
  2115  0b3a  ed6a              	ADC	HL,HL
  2116  0b3c  d9                	EXX
  2117  0b3d  30de              	JR	NC,DIV0
  2118  0b3f  b7                	OR	A
  2119  0b40  ed42              	SBC	HL,BC		;DIVIDEND-DIVISOR
  2120  0b42  d9                	EXX
  2121  0b43  ed42              	SBC	HL,BC
  2122  0b45  d9                	EXX
  2123  0b46  37                	SCF
  2124  0b47  c32b0b            	JP	DIVC
  2125                          ;
  2126                          ;MULA, MULB - MULTIPLICATION PRIMITIVE.
  2127                          ;    Function: H'L'HLD'E'DE = B'C'BC * D'E'DE
  2128                          ;    Inputs: A = loop counter (usually -32)
  2129                          ;            H'L'HL = 0
  2130                          ;    Destroys: D,E,H,L,D',E',H',L',A,F
  2131                          ;
  2132  0b4a  b7                MULA:	OR	A		;CLEAR CARRY
  2133  0b4b  d9                MUL0:	EXX
  2134  0b4c  cb1a              	RR	D		;MULTIPLIER/2
  2135  0b4e  cb1b              	RR	E
  2136  0b50  d9                	EXX
  2137  0b51  cb1a              	RR	D
  2138  0b53  cb1b              	RR	E
  2139  0b55  3005              	JR	NC,MUL1
  2140  0b57  09                	ADD	HL,BC		;ADD IN MULTIPLICAND
  2141  0b58  d9                	EXX
  2142  0b59  ed4a              	ADC	HL,BC
  2143  0b5b  d9                	EXX
  2144  0b5c  3c                MUL1:	INC	A
  2145  0b5d  f0                	RET	P
  2146  0b5e  d9                MULB:	EXX
  2147  0b5f  cb1c              	RR	H		;PRODUCT/2
  2148  0b61  cb1d              	RR	L
  2149  0b63  d9                	EXX
  2150  0b64  cb1c              	RR	H
  2151  0b66  cb1d              	RR	L
  2152  0b68  c34b0b            	JP	MUL0
  2153                          ;
  2154                          ;SQRA, SQRB - SQUARE ROOT PRIMITIVES
  2155                          ;    Function: B'C'BC = SQR (D'E'DE)
  2156                          ;    Inputs: A = loop counter (normally -31)
  2157                          ;            B'C'BCH'L'HL initialised to 0
  2158                          ;  Destroys: A,B,C,D,E,H,L,B',C',D',E',H',L',F
  2159                          ;
  2160  0b6b  ed42              SQR1:	SBC	HL,BC
  2161  0b6d  d9                	EXX
  2162  0b6e  ed42              	SBC	HL,BC
  2163  0b70  d9                	EXX
  2164  0b71  0c                	INC	C
  2165  0b72  3007              	JR	NC,SQR2
  2166  0b74  0d                	DEC	C
  2167  0b75  09                	ADD	HL,BC
  2168  0b76  d9                	EXX
  2169  0b77  ed4a              	ADC	HL,BC
  2170  0b79  d9                	EXX
  2171  0b7a  0d                	DEC	C
  2172  0b7b  3c                SQR2:	INC	A
  2173  0b7c  f0                	RET	P
  2174  0b7d  cb21              SQRA:	SLA	C
  2175  0b7f  cb10              	RL	B
  2176  0b81  0c                	INC	C
  2177  0b82  d9                	EXX
  2178  0b83  cb11              	RL	C
  2179  0b85  cb10              	RL	B
  2180  0b87  cdb30b            	CALL	SLA8
  2181  0b8a  cdb30b            	CALL	SLA8
  2182  0b8d  d9                	EXX
  2183  0b8e  d26b0b            	JP	NC,SQR1
  2184  0b91  b7                SQR3:	OR	A
  2185  0b92  ed42              	SBC	HL,BC
  2186  0b94  d9                	EXX
  2187  0b95  ed42              	SBC	HL,BC
  2188  0b97  d9                	EXX
  2189  0b98  0c                	INC	C
  2190  0b99  c37b0b            	JP	SQR2
  2191                          ;
  2192  0b9c  29                SQRB:	ADD	HL,HL
  2193  0b9d  d9                	EXX
  2194  0b9e  ed6a              	ADC	HL,HL
  2195  0ba0  d9                	EXX
  2196  0ba1  38ee              	JR	C,SQR3
  2197  0ba3  3c                	INC	A
  2198  0ba4  0c                	INC	C
  2199  0ba5  ed42              	SBC	HL,BC
  2200  0ba7  d9                	EXX
  2201  0ba8  ed42              	SBC	HL,BC
  2202  0baa  d9                	EXX
  2203  0bab  d0                	RET	NC
  2204  0bac  09                	ADD	HL,BC
  2205  0bad  d9                	EXX
  2206  0bae  ed4a              	ADC	HL,BC
  2207  0bb0  d9                	EXX
  2208  0bb1  0d                	DEC	C
  2209  0bb2  c9                	RET
  2210                          ;
  2211  0bb3  d9                SLA8:	EXX
  2212  0bb4  cb23              	SLA	E
  2213  0bb6  cb12              	RL	D
  2214  0bb8  d9                	EXX
  2215  0bb9  cb13              	RL	E
  2216  0bbb  cb12              	RL	D
  2217  0bbd  d9                	EXX
  2218  0bbe  ed6a              	ADC	HL,HL
  2219  0bc0  d9                	EXX
  2220  0bc1  ed6a              	ADC	HL,HL
  2221  0bc3  c9                	RET
  2222                          ;
  2223  0bc4  dd7e00            DIGITQ:	LD	A,(IX)
  2224  0bc7  fe3a              	CP	'9'+1
  2225  0bc9  3f                	CCF
  2226  0bca  d8                	RET	C
  2227  0bcb  fe30              	CP	'0'
  2228  0bcd  c9                	RET
  2229                          ;
  2230  0bce  dd7e00            SIGNQ:	LD	A,(IX)
  2231  0bd1  dd23              	INC	IX
  2232  0bd3  fe20              	CP	' '
  2233  0bd5  28f7              	JR	Z,SIGNQ
  2234  0bd7  fe2b              	CP	'+'
  2235  0bd9  c8                	RET	Z
  2236  0bda  fe2d              	CP	'-'
  2237  0bdc  c8                	RET	Z
  2238  0bdd  dd2b              	DEC	IX
  2239  0bdf  c9                	RET
  2240                          ;
  2241  0be0  08                ABS2:	EX	AF,AF'
  2242  0be1  cb7c              	BIT	7,H
  2243  0be3  c4f108            	CALL	NZ,NEGATE	;MAKE ARGUMENTS +VE
  2244  0be6  cdc709            	CALL	SWAP
  2245  0be9  cb7c              	BIT	7,H
  2246  0beb  c4f108            	CALL	NZ,NEGATE
  2247  0bee  44                	LD	B,H
  2248  0bef  4d                	LD	C,L
  2249  0bf0  210000            	LD	HL,0
  2250  0bf3  d9                	EXX
  2251  0bf4  44                	LD	B,H
  2252  0bf5  4d                	LD	C,L
  2253  0bf6  210000            	LD	HL,0
  2254  0bf9  c9                	RET
  2255                          ;
  2256                          	; END
  2257                          
