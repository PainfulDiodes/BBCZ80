asm/EXEC.asm:
     1                          		; TITLE BBC BASIC (C) R.T.RUSSELL 1981-2025
     2                          	INCLUDE "constants.inc"
asm/constants.inc:
     1                          ; BBC BASIC Z80 - Shared Constants
     2                          ; Extracted from source modules to avoid duplicate definitions
     3                          
     4                          ; ASCII control characters
     5                          LF      EQU     0AH
     6                          CR      EQU     0DH
     7                          ; Note: ESC conflicts with label in AMOS.Z80, not included
     8                          BEL     EQU     7
     9                          BS      EQU     8
    10                          HT      EQU     9
    11                          VT      EQU     0BH
    12                          ; Note: DEL conflicts with label in MAIN.Z80, not included
    13                          
    14                          ; CP/M system addresses
    15                          ; Note: BDOS conflicts with label in DIST.Z80, not included
    16                          FCB     EQU     5CH
    17                          DSKBUF  EQU     80H
    18                          FCBSIZ  EQU     128+36+2
    19                          
    20                          ; Token values
    21                          TAND    EQU     80H
    22                          TOR     EQU     84H
    23                          TBY     EQU     0FH
    24                          TERROR  EQU     85H
    25                          TLINE   EQU     86H
    26                          TOFF    EQU     87H
    27                          TSTEP   EQU     88H
    28                          TSPC    EQU     89H
    29                          TTAB    EQU     8AH
    30                          TELSE   EQU     8BH
    31                          TTHEN   EQU     8CH
    32                          TLINO   EQU     8DH
    33                          TTO     EQU     0B8H
    34                          TCASE   EQU     0C8H
    35                          TWHILE  EQU     0C7H
    36                          TWHEN   EQU     0C9H
    37                          TOF     EQU     0CAH
    38                          TENDCASE EQU    0CBH
    39                          TOTHERWISE EQU  0CCH
    40                          TENDIF  EQU     0CDH
    41                          TENDWHILE EQU   0CEH
    42                          TCALL   EQU     0D6H
    43                          TDATA   EQU     0DCH
    44                          TDEF    EQU     0DDH
    45                          TDIM    EQU     0DEH
    46                          TEND    EQU     0E0H
    47                          TFOR    EQU     0E3H
    48                          TGOSUB  EQU     0E4H
    49                          TGOTO   EQU     0E5H
    50                          TIF     EQU     0E7H
    51                          TLOCAL  EQU     0EAH
    52                          TMODE   EQU     0EBH
    53                          TNEXT   EQU     0EDH
    54                          TON     EQU     0EEH
    55                          TPROC   EQU     0F2H
    56                          TREM    EQU     0F4H
    57                          TREPEAT EQU     0F5H
    58                          TREPORT EQU     0F6H
    59                          TRESTORE EQU    0F7H
    60                          TRETURN EQU     0F8H
    61                          TSTOP   EQU     0FAH
    62                          TTRACE  EQU     0FCH
    63                          TUNTIL  EQU     0FDH
    64                          TWIDTH  EQU     0FEH
    65                          TEXIT   EQU     10H
    66                          
    67                          ; Error codes
    68                          BADOP   EQU     1
    69                          DIVBY0  EQU     18
    70                          ; Note: TOOBIG conflicts with label in MAIN.Z80, not included
    71                          NGROOT  EQU     21
    72                          LOGRNG  EQU     22
    73                          ACLOST  EQU     23
    74                          EXPRNG  EQU     24
    75                          
asm/EXEC.asm:
     3                          ;
     4                          ;BBC BASIC INTERPRETER - Z80 VERSION
     5                          ;STATEMENT EXECUTION MODULE - "EXEC"
     6                          ;(C) COPYRIGHT R.T.RUSSELL 1981-2025
     7                          ;
     8                          ;THE NAME BBC BASIC IS USED WITH THE PERMISSION
     9                          ;OF THE BRITISH BROADCASTING CORPORATION AND IS
    10                          ;NOT TRANSFERRABLE TO A FORKED OR DERIVED WORK.
    11                          ;
    12                          ;VERSION 2.1, 22-01-1984
    13                          ;VERSION 3.1, 11-06-1987
    14                          ;VERSION 5.0, 12-07-2024
    15                          ;VERSION 5.1, 28-12-2024
    16                          ;VERSION 5.2, 11-01-2025
    17                          ;VERSION 5.3, 31-01-2025
    18                          ;
    19                          	PUBLIC XEQ
    20                          	PUBLIC RUN0
    21                          	PUBLIC CHAIN0
    22                          	PUBLIC CHECK
    23                          	PUBLIC MUL16
    24                          	PUBLIC X14OR5
    25                          	PUBLIC TERMQ
    26                          	PUBLIC STOREN
    27                          	PUBLIC STORE4
    28                          	PUBLIC STORE5
    29                          	PUBLIC STACCS
    30                          	PUBLIC SPACES
    31                          	PUBLIC FN
    32                          	PUBLIC USR
    33                          	PUBLIC ESCAPE
    34                          	PUBLIC SYNTAX
    35                          	PUBLIC CHANEL
    36                          	PUBLIC CHNL
    37                          	PUBLIC VAR
    38                          	PUBLIC TABIT
    39                          	PUBLIC MODIFY
    40                          	PUBLIC MODIFS
    41                          ;
    42                          	EXTERN ASSEM
    43                          	EXTERN ERROR
    44                          	EXTERN REPORT
    45                          	EXTERN WARM
    46                          	EXTERN CLOOP
    47                          	EXTERN SAYLN
    48                          	EXTERN LOAD0
    49                          	EXTERN CRLF
    50                          	EXTERN PBCDL
    51                          	EXTERN TELL
    52                          	EXTERN FINDL
    53                          	EXTERN SETLIN
    54                          	EXTERN CLEAR
    55                          	EXTERN GETVAR
    56                          	EXTERN PUTVAR
    57                          	EXTERN GETDEF
    58                          	EXTERN LOCATE
    59                          	EXTERN CREATE
    60                          	EXTERN OUTCHR
    61                          	EXTERN EXTERR
    62                          	EXTERN BYE
    63                          	EXTERN NXT
    64                          	EXTERN NLIST
    65                          	EXTERN CSRON
    66                          	EXTERN CSROFF
    67                          ;
    68                          	EXTERN OSWRCH
    69                          	EXTERN OSLINE
    70                          	EXTERN OSSHUT
    71                          	EXTERN OSBPUT
    72                          	EXTERN OSBGET
    73                          	EXTERN CLRSCN
    74                          	EXTERN PUTCSR
    75                          	EXTERN PUTIME
    76                          	EXTERN PUTIMS
    77                          	EXTERN PUTPTR
    78                          	EXTERN OSCALL
    79                          	EXTERN OSCLI
    80                          	EXTERN TRAP
    81                          ;
    82                          	EXTERN SOUND
    83                          	EXTERN CLG
    84                          	EXTERN DRAW
    85                          	EXTERN ENVEL
    86                          	EXTERN GCOL
    87                          	EXTERN MODE
    88                          	EXTERN MOVE
    89                          	EXTERN PLOT
    90                          	EXTERN COLOUR
    91                          	EXTERN CIRCLE
    92                          	EXTERN ELLIPS
    93                          	EXTERN FILL
    94                          	EXTERN MOUSE
    95                          	EXTERN ORIGIN
    96                          	EXTERN RECTAN
    97                          	EXTERN LINE
    98                          	EXTERN WAIT
    99                          	EXTERN TINT
   100                          	EXTERN SYS
   101                          ;
   102                          	EXTERN STR
   103                          	EXTERN HEXSTR
   104                          	EXTERN EXPR
   105                          	EXTERN EXPRN
   106                          	EXTERN EXPRI
   107                          	EXTERN EXPRS
   108                          	EXTERN ITEMI
   109                          	EXTERN CONS
   110                          	EXTERN LOADS
   111                          	EXTERN VAL0
   112                          	EXTERN SFIX
   113                          	EXTERN TEST
   114                          	EXTERN LOAD4
   115                          	EXTERN LOADN
   116                          	EXTERN DLOAD5
   117                          	EXTERN FPP
   118                          	EXTERN COMMA
   119                          	EXTERN BRAKET
   120                          	EXTERN PUSHS
   121                          	EXTERN POPS
   122                          	EXTERN ZERO
   123                          	EXTERN SCP
   124                          	EXTERN LETARR
   125                          ;
   126                          	EXTERN ACCS
   127                          	EXTERN PAGE
   128                          	EXTERN LOMEM
   129                          	EXTERN HIMEM
   130                          	EXTERN FREE
   131                          	EXTERN BUFFER
   132                          	EXTERN ERRTRP
   133                          	EXTERN ONERSP
   134                          	EXTERN CURLIN
   135                          	EXTERN COUNT
   136                          	EXTERN WIDTH
   137                          	EXTERN STAVAR
   138                          	EXTERN DATPTR
   139                          	EXTERN RANDOM
   140                          	EXTERN TRACEN
   141                          	EXTERN LISTON
   142                          	EXTERN PC
   143                          	EXTERN OC
   144                          ;
   145                          ; LF EQU	0AH
   146                          ; CR EQU	0DH
   147                          ; TAND EQU	80H
   148                          ; TOR EQU	84H
   149                          ; TERROR EQU	85H
   150                          ; TLINE EQU	86H
   151                          ; TOFF EQU	87H
   152                          ; TSTEP EQU	88H
   153                          ; TSPC EQU	89H
   154                          ; TTAB EQU	8AH
   155                          ; TELSE EQU	8BH
   156                          ; TTHEN EQU	8CH
   157                          ; TLINO EQU	8DH
   158                          ; TTO EQU	0B8H
   159                          TCMD	EQU	0C0H
   160                          ; TWHILE EQU	0C7H
   161                          ; TWHEN EQU	0C9H
   162                          ; TOF EQU	0CAH
   163                          ; TENDCASE EQU	0CBH
   164                          ; TOTHERWISE EQU	0CCH
   165                          ; TENDIF EQU	0CDH
   166                          ; TENDWHILE EQU	0CEH
   167                          ; TCALL EQU	0D6H
   168                          ; TDATA EQU	0DCH
   169                          ; TDEF EQU	0DDH
   170                          ; TFOR EQU	0E3H
   171                          ; TGOSUB EQU	0E4H
   172                          ; TGOTO EQU	0E5H
   173                          ; TLOCAL EQU	0EAH
   174                          ; TNEXT EQU	0EDH
   175                          ; TON EQU	0EEH
   176                          ; TPROC EQU	0F2H
   177                          ; TREM EQU	0F4H
   178                          ; TREPEAT EQU	0F5H
   179                          ; TRETURN EQU	0F8H
   180                          ; TSTOP EQU	0FAH
   181                          ; TUNTIL EQU	0FDH
   182                          ; TEXIT EQU	10H
   183                          ;
   184  0000  cf0c              CMDTAB:	DEFW	LEFTSL
   185  0002  e30c              	DEFW	MIDSL
   186  0004  d90c              	DEFW	RITESL
   187  0006  3a02              	DEFW	SYNTAX	;STR$
   188  0008  3a02              	DEFW	SYNTAX	;STRING$
   189  000a  3a02              	DEFW	SYNTAX	;EOF
   190  000c  3a02              	DEFW	SYNTAX	;SUM
   191  000e  800a              	DEFW	WHILE
   192  0010  b109              	DEFW	CASE
   193  0012  3a02              	DEFW	SYNTAX	;WHEN
   194  0014  3a02              	DEFW	SYNTAX	;OF
   195  0016  f400              	DEFW	XEQ	;ENDCASE
   196  0018  3a02              	DEFW	SYNTAX	;OTHERWISE
   197  001a  f400              	DEFW	XEQ	;ENDIF
   198  001c  9d0a              	DEFW	ENDWHI	;ENDWHILE
   199  001e  5b0b              	DEFW	PTR
   200  0020  6f0b              	DEFW	PAGEV
   201  0022  7d0b              	DEFW	TIMEV
   202  0024  9c0b              	DEFW	LOMEMV
   203  0026  ae0b              	DEFW	HIMEMV
   204  0028  0000              	DEFW	SOUND
   205  002a  2d0c              	DEFW	BPUT
   206  002c  640c              	DEFW	CALL
   207  002e  a700              	DEFW	CHAIN
   208  0030  f00a              	DEFW	CLR
   209  0032  250c              	DEFW	CLOSE
   210  0034  0000              	DEFW	CLG
   211  0036  cf0a              	DEFW	CLS
   212  0038  8c01              	DEFW	REM		;DATA
   213  003a  8c01              	DEFW	REM		;DEF
   214  003c  9802              	DEFW	DIM
   215  003e  0000              	DEFW	DRAW
   216  0040  2e01              	DEFW	END
   217  0042  d707              	DEFW	ENDPRO
   218  0044  0000              	DEFW	ENVEL
   219  0046  6e05              	DEFW	FOR
   220  0048  2505              	DEFW	GOSUB
   221  004a  0e05              	DEFW	GOTO
   222  004c  0000              	DEFW	GCOL
   223  004e  2309              	DEFW	IF
   224  0050  3c08              	DEFW	INPUT
   225  0052  fc01              	DEFW	LET
   226  0054  6d07              	DEFW	LOCAL
   227  0056  0000              	DEFW	MODE
   228  0058  0000              	DEFW	MOVE
   229  005a  bb05              	DEFW	NEXT
   230  005c  9404              	DEFW	ON
   231  005e  f60b              	DEFW	VDU
   232  0060  0000              	DEFW	PLOT
   233  0062  a003              	DEFW	PRINT
   234  0064  4106              	DEFW	PROC
   235  0066  da08              	DEFW	READ
   236  0068  8c01              	DEFW	REM
   237  006a  3f05              	DEFW	REPEAT
   238  006c  eb0a              	DEFW	REPOR
   239  006e  090b              	DEFW	RESTOR
   240  0070  3005              	DEFW	RETURN
   241  0072  a200              	DEFW	RUN
   242  0074  d80a              	DEFW	STOP
   243  0076  0000              	DEFW	COLOUR
   244  0078  dd0b              	DEFW	TRACE
   245  007a  4705              	DEFW	UNTIL
   246  007c  d30b              	DEFW	WIDTHV
   247  007e  6301              	DEFW	CLI		;OSCLI
   248  0080  8c01              	DEFW	REM		;NUL
   249  0082  0000              	DEFW	CIRCLE
   250  0084  0000              	DEFW	ELLIPS
   251  0086  0000              	DEFW	FILL
   252  0088  0000              	DEFW	MOUSE
   253  008a  0000              	DEFW	ORIGIN
   254  008c  0000              	DEFW	BYE		;QUIT
   255  008e  0000              	DEFW	RECTAN
   256  0090  b901              	DEFW	SWAP
   257  0092  0000              	DEFW	SYS
   258  0094  0000              	DEFW	TINT
   259  0096  0000              	DEFW	WAIT
   260  0098  3a02              	DEFW	SYNTAX		;INSTALL
   261  009a  8c01              	DEFW	REM		;CR
   262  009c  f50d              	DEFW	PUT		;Token changed
   263  009e  3a02              	DEFW	SYNTAX		;BY
   264  00a0  7b0d              	DEFW	EXIT
   265                          ;
   266                          TLAST	EQU	TCMD-128+($-CMDTAB)/2
   267                          ;
   268  00a2  cd9111            RUN:	CALL	TERMQ
   269  00a5  280d              	JR	Z,RUN0
   270  00a7  cd0000            CHAIN:	CALL	EXPRS
   271  00aa  3e0d              	LD	A,CR
   272  00ac  12                	LD	(DE),A
   273  00ad  ed7b0000          CHAIN0:	LD	SP,(HIMEM)
   274  00b1  cd0000            	CALL	LOAD0
   275  00b4  ed7b0000          RUN0:	LD	SP,(HIMEM)	;PREPARE FOR RUN
   276  00b8  dd210000          	LD	IX,RANDOM
   277  00bc  ed5f              RAND:	LD	A,R		;RANDOMISE (CARE!)
   278  00be  28fc              	JR	Z,RAND
   279  00c0  07                	RLCA
   280  00c1  07                	RLCA
   281  00c2  dd7703            	LD	(IX+3),A
   282  00c5  9f                	SBC	A,A
   283  00c6  dd7704            	LD	(IX+4),A
   284  00c9  cd0000            	CALL	CLEAR
   285  00cc  210000            	LD	HL,0
   286  00cf  220000            	LD	(ERRTRP),HL
   287  00d2  2a0000            	LD	HL,(PAGE)
   288  00d5  cd5412            	CALL	DSRCH		;LOOK FOR "DATA"
   289  00d8  220000            	LD	(DATPTR),HL	;SET DATA POINTER
   290  00db  fd2a0000          	LD	IY,(PAGE)
   291  00df  cd3601            XEQ0:	CALL	NEWLIN
   292  00e2  fd7e00            	LD	A,(IY)
   293  00e5  fe8b              	CP	TELSE
   294  00e7  ca8a09            	JP	Z,MELSE		;ELSE
   295  00ea  fec9              	CP	TWHEN
   296  00ec  ca9d09            	JP	Z,WHEN		;WHEN
   297  00ef  fecc              	CP	TOTHERWISE
   298  00f1  ca9d09            	JP	Z,WHEN
   299  00f4  fd220000          XEQ:	LD	(CURLIN),IY	;ERROR POINTER
   300  00f8  cd0000            	CALL	TRAP		;CHECK KEYBOARD
   301  00fb  cd0000            XEQ1:	CALL	NXT
   302  00fe  fd23              	INC	IY
   303  0100  fe3a              	CP	':'		;SEPARATOR
   304  0102  28f7              	JR	Z,XEQ1
   305  0104  fe0d              	CP	CR
   306  0106  28d7              	JR	Z,XEQ0		;NEW PROGRAM LINE
   307  0108  fe91              	CP	TLAST
   308  010a  eaee01            	JP	PE,LET0		;IMPLIED LET
   309  010d  d6c0              	SUB	TCMD
   310  010f  fa7101            	JP	M,EXTRAS
   311  0112  87                	ADD	A,A
   312  0113  4f                	LD	C,A
   313  0114  0600              	LD	B,0
   314  0116  210000            	LD	HL,CMDTAB
   315  0119  09                	ADD	HL,BC
   316  011a  7e                	LD	A,(HL)		;TABLE ENTRY
   317  011b  23                	INC	HL
   318  011c  66                	LD	H,(HL)
   319  011d  6f                	LD	L,A
   320  011e  cd0000            	CALL	NXT
   321  0121  e9                	JP	(HL)		;EXECUTE STATEMENT
   322                          ;
   323                          ;END
   324                          ;
   325  0122  fde5              ENDIM:	PUSH	IY
   326  0124  e1                	POP	HL
   327  0125  ed4b0000          	LD	BC,(PAGE)
   328  0129  ed42              	SBC	HL,BC		;IMMEDIATE MODE ?
   329  012b  da0000            	JP	C,CLOOP
   330  012e  1e00              END:	LD	E,0
   331  0130  cd0000            	CALL	OSSHUT		;CLOSE ALL FILES
   332  0133  c30000            	JP	WARM		;"Ready"
   333                          ;
   334  0136  fd7e00            NEWLIN:	LD	A,(IY+0)	;A=LINE LENGTH
   335  0139  010300            	LD	BC,3
   336  013c  fd09              	ADD	IY,BC
   337  013e  b7                	OR	A
   338  013f  28e1              	JR	Z,ENDIM		;LENGTH=0, EXIT
   339  0141  2a0000            	LD	HL,(TRACEN)
   340  0144  7c                	LD	A,H
   341  0145  b5                	OR	L
   342  0146  c8                	RET	Z
   343  0147  fd56ff            	LD	D,(IY-1)	;DE = LINE NUMBER
   344  014a  fd5efe            	LD	E,(IY-2)
   345  014d  ed52              	SBC	HL,DE
   346  014f  d8                	RET	C
   347  0150  eb                	EX	DE,HL
   348  0151  3e5b              	LD	A,'['		;TRACE
   349  0153  cd0000            	CALL	OUTCHR
   350  0156  cd0000            	CALL	PBCDL
   351  0159  3e5d              	LD	A,']'
   352  015b  cd0000            	CALL	OUTCHR
   353  015e  3e20              	LD	A,' '
   354  0160  c30000            	JP	OUTCHR
   355                          ;
   356                          ;ROUTINES FOR EACH STATEMENT:
   357                          ;
   358                          ;OSCLI
   359                          ;
   360  0163  cd0000            CLI:	CALL	EXPRS
   361  0166  3e0d              	LD	A,CR
   362  0168  12                	LD	(DE),A
   363  0169  210000            	LD	HL,ACCS
   364  016c  cd0000            	CALL	OSCLI
   365  016f  1883              	JR	XEQ
   366                          ;
   367  0171  fecb              EXTRAS:	CP	TELSE-TCMD
   368  0173  2817              	JR	Z,REM		;ELSE
   369  0175  fec5              	CP	TERROR-TCMD
   370  0177  2821              	JR	Z,THROW		;ERROR
   371  0179  fec6              	CP	TLINE-TCMD
   372  017b  ca0000            	JP	Z,LINE		;LINE
   373  017e  fec7              	CP	TOFF-TCMD
   374  0180  ca0000            	JP	Z,CSROFF	;OFF
   375  0183  c33a02            	JP	SYNTAX
   376                          ;
   377                          ;REM, *
   378                          ;
   379  0186  fde5              EXT:	PUSH	IY
   380  0188  e1                	POP	HL
   381  0189  cd0000            	CALL	OSCLI
   382  018c  fde5              REM:	PUSH	IY
   383  018e  e1                	POP	HL
   384  018f  3e0d              	LD	A,CR
   385  0191  47                	LD	B,A
   386  0192  edb1              	CPIR			;FIND LINE END
   387  0194  e5                	PUSH	HL
   388  0195  fde1              	POP	IY
   389  0197  c3df00            	JP	XEQ0
   390                          ;
   391                          ;ERROR num,string$
   392                          ;
   393  019a  cd0000            THROW:	CALL	EXPRI
   394  019d  d9                	EXX
   395  019e  e5                	PUSH	HL
   396  019f  d9                	EXX
   397  01a0  cd0000            	CALL	COMMA
   398  01a3  cd0000            	CALL	EXPRS
   399  01a6  e1                	POP	HL
   400  01a7  af                	XOR	A
   401  01a8  12                	LD	(DE),A
   402  01a9  7d                	LD	A,L
   403  01aa  210000            	LD	HL,ACCS
   404  01ad  110000            	LD	DE,BUFFER
   405  01b0  d5                	PUSH	DE
   406  01b1  010001            	LD	BC,256
   407  01b4  edb0              	LDIR
   408  01b6  c30000            	JP	EXTERR
   409                          ;
   410                          ; SWAP
   411                          ;
   412  01b9  cd0000            SWAP:	CALL	GETVAR
   413  01bc  200b              	JR	NZ,SWAPNZ
   414  01be  f5                	PUSH	AF
   415  01bf  e5                	PUSH	HL
   416  01c0  cd0000            	CALL	COMMA
   417  01c3  cd0000            	CALL	NXT
   418  01c6  cd0000            	CALL	GETVAR
   419  01c9  206c              SWAPNZ:	JR	NZ,NOSUCH
   420  01cb  d1                	POP	DE
   421  01cc  c1                	POP	BC
   422  01cd  b8                	CP	B
   423  01ce  2073              	JR	NZ,MISMAT
   424  01d0  e60f              	AND	00001111B
   425  01d2  286f              	JR	Z,MISMAT
   426  01d4  78                	LD	A,B
   427  01d5  e6c0              	AND	11000000B
   428  01d7  280a              	JR	Z,SWAP1
   429  01d9  0602              	LD	B,2
   430  01db  f2e301            	JP	P,SWAP1
   431  01de  eae301            	JP	PE,SWAP1
   432  01e1  0604              	LD	B,4
   433  01e3  4e                SWAP1:	LD	C,(HL)
   434  01e4  1a                	LD	A,(DE)
   435  01e5  77                	LD	(HL),A
   436  01e6  79                	LD	A,C
   437  01e7  12                	LD	(DE),A
   438  01e8  13                	INC	DE
   439  01e9  23                	INC	HL
   440  01ea  10f7              	DJNZ	SWAP1
   441  01ec  1827              	JR	XEQGO4
   442                          ;
   443                          ;[LET] var = expr
   444                          ;
   445  01ee  fe2a              LET0:	CP	'*'
   446  01f0  2894              	JR	Z,EXT
   447  01f2  fe3d              	CP	'='
   448  01f4  2870              	JR	Z,FNEND
   449  01f6  fe5b              	CP	'['
   450  01f8  2851              	JR	Z,ASM
   451  01fa  fd2b              	DEC	IY
   452  01fc  cd070e            LET:	CALL	ASSIGN
   453  01ff  caf400            	JP	Z,XEQ
   454  0202  3836              	JR	C,SYNTAX	;"Syntax error"
   455  0204  f20000            	JP	P,LETARR	;Numeric array
   456  0207  ea0000            	JP	PE,LETARR	;String array
   457  020a  d5                	PUSH	DE
   458  020b  e5                	PUSH	HL
   459  020c  cd0000            	CALL	EXPRS
   460  020f  dde1              	POP	IX
   461  0211  e1                	POP	HL
   462  0212  cd6f0e            	CALL	MODIFS
   463  0215  c3f400            XEQGO4:	JP	XEQ
   464                          ;
   465                          ; GETSTR - Get string variable
   466                          ;   Inputs: IY = text pointer
   467                          ;  Outputs: B = type
   468                          ;           Z-flag set if comma
   469                          ;
   470  0218  cd0000            GETSTR:	CALL	GETVAR
   471  021b  201a              	JR	NZ,NOSUCH
   472  021d  47                	LD	B,A
   473  021e  e6c0              	AND	11000000B
   474  0220  f24302            	JP	P,MISMAT
   475  0223  ea4002            	JP	PE,BADUSE
   476  0226  cb40              	BIT	0,B
   477  0228  2819              	JR	Z,MISMAT
   478  022a  cd0000            	CALL	NXT
   479  022d  fe2c              	CP	','
   480  022f  c9                	RET
   481                          ;
   482  0230  cd0000            VAR:	CALL	GETVAR
   483  0233  c8                	RET	Z
   484  0234  d20000            	JP	NC,PUTVAR
   485  0237  3e1a              NOSUCH:	LD	A,26		;'No such variable'
   486  0239  21                	DEFB	21H
   487  023a  3e10              SYNTAX:	LD	A,16		;"Syntax error"
   488  023c  21                	DEFB	21H
   489  023d  3e11              ESCAPE:	LD	A,17		;"Escape"
   490  023f  21                	DEFB	21H
   491  0240  3e0e              BADUSE:	LD	A,14		;'Bad use of array'
   492  0242  21                	DEFB	21H
   493  0243  3e06              MISMAT:	LD	A,6		;'Type mismatch'
   494  0245  c30000            ERROR0:	JP	ERROR
   495                          ;
   496  0248  cd3601            ASM0:	CALL	NEWLIN
   497  024b  fd220000          ASM:	LD	(CURLIN),IY
   498  024f  cd0000            	CALL	TRAP
   499  0252  cd0000            	CALL	ASSEM
   500  0255  38e3              	JR	C,SYNTAX
   501  0257  fe0d              	CP	CR
   502  0259  28ed              	JR	Z,ASM0
   503  025b  210000            	LD	HL,LISTON
   504  025e  7e                	LD	A,(HL)
   505  025f  e60f              	AND	0FH
   506  0261  f630              	OR	30H
   507  0263  77                	LD	(HL),A
   508  0264  18af              	JR	XEQGO4
   509                          ;
   510                          ;=
   511                          ;
   512  0266  cd0000            FNEND:	CALL	EXPR		;FUNCTION RESULT
   513  0269  08                	EX	AF,AF'
   514  026a  87                	ADD	A,A
   515  026b  7b                	LD	A,E
   516  026c  3801              	JR	C,FNEND1
   517  026e  79                	LD	A,C
   518  026f  08                FNEND1:	EX	AF,AF'
   519  0270  e5                	PUSH	HL
   520  0271  d9                	EXX
   521  0272  c1                	POP	BC
   522  0273  eb                	EX	DE,HL		;SAVE RESULT IN A'B'C'D'E'
   523  0274  d9                	EXX
   524  0275  c1                FNEND2:	POP	BC
   525  0276  214106            	LD	HL,FNCHK
   526  0279  af                	XOR	A
   527  027a  ed42              	SBC	HL,BC
   528  027c  280a              	JR	Z,FNEND3
   529  027e  c5                	PUSH	BC
   530  027f  cd8c10            	CALL	RESLOC
   531  0282  20f1              	JR	NZ,FNEND2
   532  0284  3e07              	LD	A,7
   533  0286  18bd              	JR	ERROR0		;"No FN"
   534                          ;
   535  0288  fde1              FNEND3:	POP	IY
   536  028a  fd220000          	LD	(CURLIN),IY	;IN CASE OF ERROR
   537  028e  d9                	EXX
   538  028f  eb                	EX	DE,HL
   539  0290  c5                	PUSH	BC
   540  0291  d9                	EXX
   541  0292  e1                	POP	HL
   542  0293  08                	EX	AF,AF'
   543  0294  5f                	LD	E,A
   544  0295  4f                	LD	C,A
   545  0296  1f                	RRA
   546  0297  c9                	RET
   547                          ;
   548                          ;DIM var(dim1[,dim2[,...]])[,var(...]
   549                          ;DIM var expr[,var expr...]
   550                          ;
   551  0298  fde5              DIM:	PUSH	IY
   552  029a  fe21              	CP	'!'
   553  029c  ca6903            	JP	Z,DIM4
   554  029f  cd0000            	CALL	LOCATE		;VARIABLE
   555  02a2  da5303            	JP	C,BADDIM
   556  02a5  c40000            	CALL	NZ,CREATE
   557  02a8  fd7e00            	LD	A,(IY)
   558  02ab  fe28              	CP	'('
   559  02ad  c26903            	JP	NZ,DIM4
   560  02b0  e5                	PUSH	HL
   561  02b1  dde1              	POP	IX
   562  02b3  7e                	LD	A,(HL)
   563  02b4  e6fe              	AND	0FEH
   564  02b6  23                	INC	HL
   565  02b7  b6                	OR	(HL)
   566  02b8  c26903            	JP	NZ,DIM4
   567  02bb  c1                	POP	BC		;LEVEL STACK
   568  02bc  7a                	LD	A,D
   569  02bd  2a0000            	LD	HL,(FREE)
   570  02c0  e5                	PUSH	HL
   571  02c1  dde3              	EX	(SP),IX
   572  02c3  e5                	PUSH	HL
   573  02c4  f5                	PUSH	AF		;SAVE TYPE
   574  02c5  110100            	LD	DE,1
   575  02c8  42                	LD	B,D		;DIMENSION COUNTER
   576  02c9  fd23              DIM1:	INC	IY
   577  02cb  c5                	PUSH	BC
   578  02cc  d5                	PUSH	DE
   579  02cd  dde5              	PUSH	IX
   580  02cf  cd0000            	CALL	EXPRI		;DIMENSION SIZE
   581  02d2  cb7c              	BIT	7,H
   582  02d4  207d              	JR	NZ,BADDIM
   583  02d6  d9                	EXX
   584  02d7  23                	INC	HL
   585  02d8  dde1              	POP	IX
   586  02da  dd23              	INC	IX
   587  02dc  dd7500            	LD	(IX),L		;SAVE SIZE
   588  02df  dd23              	INC	IX
   589  02e1  dd7400            	LD	(IX),H
   590  02e4  c1                	POP	BC
   591  02e5  cd1813            	CALL	MUL16		;HL=HL*BC
   592  02e8  386c              	JR	C,NOROOM	;TOO LARGE
   593  02ea  eb                	EX	DE,HL		;DE=PRODUCT
   594  02eb  c1                	POP	BC
   595  02ec  04                	INC	B		;DIMENSION COUNTER
   596  02ed  fd7e00            	LD	A,(IY)
   597  02f0  fe2c              	CP	','		;ANOTHER
   598  02f2  28d5              	JR	Z,DIM1
   599  02f4  dd23              	INC	IX
   600  02f6  cd0000            	CALL	BRAKET		;CLOSING BRACKET
   601  02f9  f1                	POP	AF		;RESTORE TYPE
   602  02fa  cd0813            	CALL	X14OR5		;DE=DE*n
   603  02fd  3857              	JR	C,NOROOM
   604  02ff  e1                	POP	HL
   605  0300  70                	LD	(HL),B		;NO. OF DIMENSIONS
   606  0301  dde3              	EX	(SP),IX
   607  0303  e1                	POP	HL
   608  0304  e680              	AND	80H
   609  0306  ddb600            	OR	(IX)		;FLAGS
   610                          ;
   611                          ;  A = flags: bit 7 = string, bit 0 = LOCAL
   612                          ; DE = amount to allocate
   613                          ; HL = where to allocate (if not LOCAL)
   614                          ; (HL - FREE is size of 'descriptor')
   615                          ; IX = where to store pointer
   616                          ;
   617  0309  e5                DIM3:	PUSH	HL
   618  030a  24                	INC	H		;Safety margin
   619  030b  19                	ADD	HL,DE
   620  030c  3848              	JR	C,NOROOM
   621  030e  ed72              	SBC	HL,SP
   622  0310  3044              	JR	NC,NOROOM
   623  0312  e1                	POP	HL
   624  0313  e5                	PUSH	HL
   625  0314  ed4b0000          	LD	BC,(FREE)
   626  0318  b7                	OR	A
   627  0319  ed42              	SBC	HL,BC
   628  031b  44                	LD	B,H
   629  031c  4d                	LD	C,L
   630  031d  e1                	POP	HL
   631  031e  ed42              	SBC	HL,BC
   632  0320  cb47              	BIT	0,A
   633  0322  2812              	JR	Z,ARRCHK	;NOT LOCAL
   634  0324  210000            	LD	HL,0
   635  0327  ed52              	SBC	HL,DE
   636  0329  b7                	OR	A
   637  032a  ed42              	SBC	HL,BC
   638  032c  39                	ADD	HL,SP
   639  032d  2807              	JR	Z,ARRCHK	;RESERVE NOTHING
   640  032f  f9                	LD	SP,HL
   641  0330  d5                	PUSH	DE
   642  0331  c5                	PUSH	BC
   643  0332  f5                	PUSH	AF
   644  0333  cd3603            	CALL	ARRCHK
   645  0336  dd7500            ARRCHK:	LD	(IX+0),L	;SAVE POINTER
   646  0339  dd7401            	LD	(IX+1),H
   647  033c  78                	LD	A,B
   648  033d  b1                	OR	C
   649  033e  2809              	JR	Z,DIM2
   650  0340  d5                	PUSH	DE
   651  0341  eb                	EX	DE,HL
   652  0342  2a0000            	LD	HL,(FREE)
   653  0345  edb0              	LDIR			;COPY DESCRIPTOR
   654  0347  eb                	EX	DE,HL
   655  0348  d1                	POP	DE
   656  0349  7a                DIM2:	LD	A,D
   657  034a  b3                	OR	E
   658  034b  280e              	JR	Z,DIM5
   659  034d  3600              	LD	(HL),0		;INITIALISE ARRAY
   660  034f  23                	INC	HL
   661  0350  1b                	DEC	DE
   662  0351  18f6              	JR	DIM2
   663                          ;
   664  0353  3e0a              BADDIM:	LD	A,10		;"Bad DIM"
   665  0355  21                	DEFB	21H
   666  0356  3e0b              NOROOM:	LD	A,11		;"DIM space"
   667  0358  c30000            ERROR1:	JP	ERROR
   668                          ;
   669  035b  ed72              DIM5:	SBC	HL,SP
   670  035d  3004              	JR	NC,DIM7		;LOCAL
   671  035f  39                	ADD	HL,SP
   672  0360  220000            	LD	(FREE),HL
   673  0363  cd0000            DIM7:	CALL	NLIST		;ANOTHER VARIABLE?
   674  0366  c39802            	JP	DIM
   675                          ;
   676  0369  fde1              DIM4:	POP	IY
   677  036b  cd3002            	CALL	VAR
   678  036e  b7                	OR	A
   679  036f  28e2              	JR	Z,BADDIM
   680  0371  fa5303            	JP	M,BADDIM
   681  0374  cb77              	BIT	6,A
   682  0376  20db              	JR	NZ,BADDIM
   683  0378  47                	LD	B,A		;TYPE
   684  0379  cd0000            	CALL	NXT
   685  037c  feea              	CP	TLOCAL
   686  037e  3e00              	LD	A,0		;PRESET TO NOT LOCAL
   687  0380  2003              	JR	NZ,DIM8
   688  0382  fd23              	INC	IY
   689  0384  3c                	INC	A		;FLAG LOCAL
   690  0385  f5                DIM8:	PUSH	AF
   691  0386  78                	LD	A,B		;TYPE
   692  0387  d9                	EXX
   693  0388  210000            	LD	HL,0
   694  038b  4c                	LD	C,H
   695  038c  cd470e            	CALL	STOREN		;RESERVED AREA
   696  038f  dde5              	PUSH	IX
   697  0391  cd0000            	CALL	EXPRI
   698  0394  dde1              	POP	IX
   699  0396  d9                	EXX
   700  0397  23                	INC	HL
   701  0398  eb                	EX	DE,HL
   702  0399  2a0000            	LD	HL,(FREE)
   703  039c  f1                	POP	AF		;LOCAL FLAG
   704  039d  c30903            	JP	DIM3
   705                          ;
   706                          ;PRINT list...
   707                          ;PRINT #channel,list...
   708                          ;
   709  03a0  fe23              PRINT:	CP	'#'
   710  03a2  2064              	JR	NZ,PRINT0
   711  03a4  cd3613            	CALL	CHNL		;CHANNEL NO. = E
   712  03a7  cd0000            PRNTN1:	CALL	NLIST
   713  03aa  d5                	PUSH	DE
   714  03ab  cd0000            	CALL	EXPR		;ITEM TO PRINT
   715  03ae  08                	EX	AF,AF'
   716  03af  facf03            	JP	M,PRNTN2	;STRING
   717  03b2  d1                	POP	DE
   718  03b3  c5                	PUSH	BC
   719  03b4  d9                	EXX
   720  03b5  7d                	LD	A,L
   721  03b6  d9                	EXX
   722  03b7  cd0000            	CALL	OSBPUT
   723  03ba  d9                	EXX
   724  03bb  7c                	LD	A,H
   725  03bc  d9                	EXX
   726  03bd  cd0000            	CALL	OSBPUT
   727  03c0  7d                	LD	A,L
   728  03c1  cd0000            	CALL	OSBPUT
   729  03c4  7c                	LD	A,H
   730  03c5  cd0000            	CALL	OSBPUT
   731  03c8  c1                	POP	BC
   732  03c9  79                	LD	A,C
   733  03ca  cd0000            	CALL	OSBPUT
   734  03cd  18d8              	JR	PRNTN1
   735  03cf  4b                PRNTN2:	LD	C,E
   736  03d0  d1                	POP	DE
   737  03d1  210000            	LD	HL,ACCS
   738  03d4  0c                	INC	C
   739  03d5  0d                PRNTN3:	DEC	C
   740  03d6  2809              	JR	Z,PRNTN4
   741  03d8  7e                	LD	A,(HL)
   742  03d9  23                	INC	HL
   743  03da  c5                	PUSH	BC
   744  03db  cd0000            	CALL	OSBPUT
   745  03de  c1                	POP	BC
   746  03df  18f4              	JR	PRNTN3
   747  03e1  3e0d              PRNTN4:	LD	A,CR
   748  03e3  cd0000            	CALL	OSBPUT
   749  03e6  18bf              	JR	PRNTN1
   750                          ;
   751  03e8  0602              PRINT6:	LD	B,2
   752  03ea  1822              	JR	PRINTC
   753  03ec  010001            PRINT8:	LD	BC,100H
   754  03ef  181d              	JR	PRINTC
   755  03f1  210000            PRINT9:	LD	HL,STAVAR
   756  03f4  af                	XOR	A
   757  03f5  be                	CP	(HL)
   758  03f6  2810              	JR	Z,PRINT0
   759  03f8  3a0000            	LD	A,(COUNT)
   760  03fb  b7                	OR	A
   761  03fc  280a              	JR	Z,PRINT0
   762  03fe  96                PRINTA:	SUB	(HL)
   763  03ff  2807              	JR	Z,PRINT0
   764  0401  30fb              	JR	NC,PRINTA
   765  0403  ed44              	NEG
   766  0405  cdfe11            	CALL	SPACES
   767  0408  3a0000            PRINT0:	LD	A,(STAVAR)
   768  040b  4f                	LD	C,A		;PRINTS
   769  040c  0600              	LD	B,0		;PRINTF
   770  040e  cd9111            PRINTC:	CALL	TERMQ
   771  0411  2838              	JR	Z,PRINT4
   772  0413  cb80              	RES	0,B
   773  0415  fd23              	INC	IY
   774  0417  fe7e              	CP	'~'
   775  0419  28cd              	JR	Z,PRINT6
   776  041b  fe3b              	CP	';'
   777  041d  28cd              	JR	Z,PRINT8
   778  041f  fe2c              	CP	','
   779  0421  28ce              	JR	Z,PRINT9
   780  0423  cdb711            	CALL	FORMAT		;SPC, TAB, '
   781  0426  28e6              	JR	Z,PRINTC
   782  0428  fd2b              	DEC	IY
   783  042a  c5                	PUSH	BC
   784  042b  cd0000            	CALL	EXPR		;VARIABLE TYPE
   785  042e  08                	EX	AF,AF'
   786  042f  fa4504            	JP	M,PRINT3	;STRING
   787  0432  d1                	POP	DE
   788  0433  d5                	PUSH	DE
   789  0434  cb4a              	BIT	1,D
   790  0436  f5                	PUSH	AF
   791  0437  cc0000            	CALL	Z,STR		;DECIMAL
   792  043a  f1                	POP	AF
   793  043b  c40000            	CALL	NZ,HEXSTR	;HEX
   794  043e  c1                	POP	BC
   795  043f  c5                	PUSH	BC
   796  0440  79                	LD	A,C
   797  0441  93                	SUB	E
   798  0442  d4fe11            	CALL	NC,SPACES		;RIGHT JUSTIFY
   799  0445  c1                PRINT3:	POP	BC
   800  0446  cd0c12            	CALL	PTEXT		;PRINT
   801  0449  18c3              	JR	PRINTC
   802  044b  cb40              PRINT4:	BIT	0,B
   803  044d  cc0000            	CALL	Z,CRLF
   804  0450  183f              	JR	XEQGO3
   805                          ;
   806  0452  fd23              ONERR:	INC	IY		;SKIP "ERROR"
   807  0454  cd0000            	CALL	NXT
   808  0457  210000            	LD	HL,0		;FLAG NOT LOCAL
   809  045a  feea              	CP	TLOCAL
   810  045c  201d              	JR	NZ,ONERR1
   811  045e  fd23              	INC	IY		;SKIP "LOCAL"
   812  0460  2a0000            	LD	HL,(ERRTRP)
   813  0463  e5                	PUSH	HL
   814  0464  2a0000            	LD	HL,(ONERSP)
   815  0467  e5                	PUSH	HL
   816  0468  210004            	LD	HL,400H		;TYPE = 4, 'EXPONENT' = 0
   817  046b  e5                	PUSH	HL
   818  046c  210000            	LD	HL,ERRTRP
   819  046f  e5                	PUSH	HL
   820  0470  218511            	LD	HL,LOCCHK
   821  0473  e5                	PUSH	HL
   822  0474  210000            	LD	HL,0
   823  0477  39                	ADD	HL,SP
   824  0478  cd0000            	CALL	NXT
   825  047b  220000            ONERR1:	LD	(ONERSP),HL
   826  047e  fd220000          	LD	(ERRTRP),IY
   827  0482  fe87              	CP	TOFF
   828  0484  c28c01            	JP	NZ,REM
   829  0487  fd23              	INC	IY		;SKIP "OFF"
   830  0489  ed62              	SBC	HL,HL
   831  048b  220000            	LD	(ONERSP),HL
   832  048e  220000            	LD	(ERRTRP),HL
   833  0491  c3f400            XEQGO3:	JP	XEQ
   834                          ;
   835                          ;ON expr GOTO line[,line...] [ELSE statement]
   836                          ;ON expr GOTO line[,line...] [ELSE line]
   837                          ;ON expr GOSUB line[,line...] [ELSE statement]
   838                          ;ON expr GOSUB line[,line...] [ELSE line]
   839                          ;ON expr PROCone [,PROCtwo..] [ELSE PROCotherwise]
   840                          ;ON ERROR [LOCAL] statement [:statement...]
   841                          ;ON ERROR [LOCAL] OFF
   842                          ;
   843  0494  cd9111            ON:	CALL	TERMQ
   844  0497  ca0000            	JP	Z,CSRON
   845  049a  fe85              	CP	TERROR
   846  049c  28b4              	JR	Z,ONERR		;"ON ERROR"
   847  049e  cd0000            	CALL	EXPRI
   848  04a1  fd7e00            	LD	A,(IY)
   849  04a4  fd23              	INC	IY
   850  04a6  1e2c              	LD	E,','		;SEPARATOR
   851  04a8  fee5              	CP	TGOTO
   852  04aa  280b              	JR	Z,ON1
   853  04ac  fee4              	CP	TGOSUB
   854  04ae  2807              	JR	Z,ON1
   855  04b0  1ef2              	LD	E,TPROC
   856  04b2  bb                	CP	E
   857  04b3  3e27              	LD	A,39
   858  04b5  204f              	JR	NZ,ERROR2	;"ON syntax"
   859  04b7  57                ON1:	LD	D,A
   860  04b8  d9                	EXX
   861  04b9  e5                	PUSH	HL
   862  04ba  d9                	EXX
   863  04bb  c1                	POP	BC		;ON INDEX
   864  04bc  78                	LD	A,B
   865  04bd  b4                	OR	H
   866  04be  b5                	OR	L
   867  04bf  2032              	JR	NZ,ON4		;OUT OF RANGE
   868  04c1  b1                	OR	C
   869  04c2  282f              	JR	Z,ON4
   870  04c4  0d                	DEC	C
   871  04c5  2811              	JR	Z,ON3		;INDEX=1
   872  04c7  cd9111            ON2:	CALL	TERMQ
   873  04ca  2827              	JR	Z,ON4		;OUT OF RANGE
   874  04cc  fd23              	INC	IY		;SKIP DELIMITER
   875  04ce  fe22              	CP	'"'
   876  04d0  281a              	JR	Z,ON5
   877  04d2  bb                	CP	E
   878  04d3  20f2              	JR	NZ,ON2
   879  04d5  0d                	DEC	C
   880  04d6  20ef              	JR	NZ,ON2
   881  04d8  7b                ON3:	LD	A,E
   882  04d9  fef2              	CP	TPROC
   883  04db  282c              	JR	Z,ONPROC
   884  04dd  d5                	PUSH	DE
   885  04de  cd0000            	CALL	ITEMI		;LINE NUMBER
   886  04e1  d1                	POP	DE
   887  04e2  7a                	LD	A,D
   888  04e3  fee5              	CP	TGOTO
   889  04e5  2830              	JR	Z,GOTO2
   890  04e7  cd9d11            	CALL	SPAN		;SKIP REST OF LIST
   891  04ea  183c              	JR	GOSUB1
   892                          ;
   893  04ec  cdf412            ON5:	CALL	QUOTE
   894  04ef  fd23              	INC	IY
   895  04f1  18d4              	JR	ON2
   896                          ;
   897  04f3  fd7e00            ON4:	LD	A,(IY)
   898  04f6  fd23              	INC	IY
   899  04f8  fe8b              	CP	TELSE
   900  04fa  ca3c09            	JP	Z,IF1		;ELSE CLAUSE
   901  04fd  fe0d              	CP	CR
   902  04ff  20f2              	JR	NZ,ON4
   903  0501  3e28              	LD	A,40		;'ON range'
   904  0503  21                	DEFB	21H
   905  0504  3e22              FORVAR:	LD	A,34		;'FOR variable'
   906  0506  c30000            ERROR2:	JP	ERROR
   907                          ;
   908  0509  3eee              ONPROC:	LD	A,TON
   909  050b  c34106            	JP	PROC
   910                          ;
   911                          ;GOTO line
   912                          ;
   913  050e  cd0000            GOTO:	CALL	ITEMI		;LINE NUMBER
   914  0511  cd9111            GOTO1:	CALL	TERMQ
   915  0514  c23a02            	JP	NZ,SYNTAX
   916  0517  d9                GOTO2:	EXX
   917  0518  cd0000            	CALL	FINDL
   918  051b  e5                	PUSH	HL
   919  051c  fde1              	POP	IY
   920  051e  cadf00            	JP	Z,XEQ0
   921  0521  3e29              	LD	A,41
   922  0523  18e1              	JR	ERROR2		;"No such line"
   923                          ;
   924                          ;GOSUB line
   925                          ;
   926  0525  cd0000            GOSUB:	CALL	ITEMI		;LINE NUMBER
   927  0528  fde5              GOSUB1:	PUSH	IY		;TEXT POINTER
   928  052a  cde10e            	CALL	CHECK		;CHECK ROOM
   929  052d  cd1105            	CALL	GOTO1		;SAVE MARKER
   930                          GOSCHK	EQU	$
   931                          ;
   932                          ;RETURN
   933                          ;
   934  0530  d1                RETURN:	POP	DE		;MARKER
   935  0531  213005            	LD	HL,GOSCHK
   936  0534  b7                	OR	A
   937  0535  ed52              	SBC	HL,DE
   938  0537  fde1              	POP	IY
   939  0539  2830              	JR	Z,XEQGO2
   940  053b  3e26              	LD	A,38
   941  053d  18c7              	JR	ERROR2		;"No GOSUB"
   942                          ;
   943                          ;REPEAT
   944                          ;
   945  053f  fde5              REPEAT:	PUSH	IY
   946  0541  cde10e            	CALL	CHECK
   947  0544  cdf400            	CALL	XEQ
   948                          REPCHK	EQU	$
   949                          ;
   950                          ;UNTIL expr
   951                          ;
   952  0547  c1                UNTIL:	POP	BC
   953  0548  c5                	PUSH	BC
   954  0549  214705            	LD	HL,REPCHK
   955  054c  b7                	OR	A
   956  054d  ed42              	SBC	HL,BC
   957  054f  280b              	JR	Z,UNTIL1
   958  0551  3e03              	LD	A,3
   959  0553  cd8c10            	CALL	RESLOC
   960  0556  20ef              	JR	NZ,UNTIL
   961  0558  3e2b              	LD	A,43
   962  055a  18aa              	JR	ERROR2		;"Not in a REPEAT loop"
   963                          ;
   964  055c  cd0000            UNTIL1:	CALL	EXPRI
   965  055f  cd0000            	CALL	TEST
   966  0562  c1                	POP	BC
   967  0563  d1                	POP	DE
   968  0564  2005              	JR	NZ,XEQGO2		;TRUE
   969  0566  d5                	PUSH	DE
   970  0567  c5                	PUSH	BC
   971  0568  d5                	PUSH	DE
   972  0569  fde1              	POP	IY
   973  056b  c3f400            XEQGO2:	JP	XEQ
   974                          ;
   975                          ;FOR var = expr TO expr [STEP expr]
   976                          ;
   977  056e  cd070e            FOR:	CALL	ASSIGN
   978  0571  2091              	JR	NZ,FORVAR	;"FOR variable"
   979  0573  f5                	PUSH	AF		;SAVE TYPE
   980  0574  fd7e00            	LD	A,(IY)
   981  0577  feb8              	CP	TTO
   982  0579  3e24              	LD	A,36
   983  057b  2089              	JR	NZ,ERROR2	;"No TO"
   984  057d  fd23              	INC	IY
   985  057f  dde5              	PUSH	IX
   986  0581  cd0000            	CALL	EXPRN		;LIMIT
   987  0584  dde1              	POP	IX
   988  0586  f1                	POP	AF
   989  0587  47                	LD	B,A		;TYPE
   990  0588  c5                	PUSH	BC		;SAVE ON STACK
   991  0589  e5                	PUSH	HL
   992  058a  210000            	LD	HL,0
   993  058d  4c                	LD	C,H
   994  058e  d9                	EXX
   995  058f  e5                	PUSH	HL
   996  0590  210100            	LD	HL,1		;PRESET STEP
   997  0593  d9                	EXX
   998  0594  fd7e00            	LD	A,(IY)
   999  0597  fe88              	CP	TSTEP
  1000  0599  2009              	JR	NZ,FOR1
  1001  059b  fd23              	INC	IY
  1002  059d  dde5              	PUSH	IX
  1003  059f  cd0000            	CALL	EXPRN		;STEP
  1004  05a2  dde1              	POP	IX
  1005  05a4  0608              FOR1:	LD	B,8		;FPP '>'
  1006  05a6  cb7c              	BIT	7,H
  1007  05a8  2002              	JR	NZ,FOR2		;STEP SIGN
  1008  05aa  060c              	LD	B,12		;FPP '<'
  1009  05ac  c5                FOR2:	PUSH	BC
  1010  05ad  e5                	PUSH	HL
  1011  05ae  d9                	EXX
  1012  05af  e5                	PUSH	HL
  1013  05b0  d9                	EXX
  1014  05b1  fde5              	PUSH	IY		;SAVE TEXT POINTER
  1015  05b3  dde5              	PUSH	IX		;LOOP VARIABLE
  1016  05b5  cde10e            	CALL	CHECK
  1017  05b8  cdf400            	CALL	XEQ
  1018                          FORCHK	EQU	$
  1019                          ;
  1020                          ;NEXT [var[,var...]]
  1021                          ;
  1022  05bb  c1                NEXT:	POP	BC		;MARKER
  1023  05bc  21bb05            	LD	HL,FORCHK
  1024  05bf  b7                	OR	A
  1025  05c0  ed42              	SBC	HL,BC
  1026  05c2  280c              	JR	Z,NEXT2
  1027  05c4  c5                	PUSH	BC
  1028  05c5  3e03              	LD	A,3
  1029  05c7  cd8c10            	CALL	RESLOC
  1030  05ca  20ef              	JR	NZ,NEXT
  1031  05cc  3e20              	LD	A,32
  1032  05ce  186a              	JR	ERROR3		;"Not in a FOR loop"
  1033                          ;
  1034  05d0  cd9111            NEXT2:	CALL	TERMQ
  1035  05d3  e1                	POP	HL
  1036  05d4  e5                	PUSH	HL
  1037  05d5  c5                	PUSH	BC
  1038  05d6  e5                	PUSH	HL
  1039  05d7  c40000            	CALL	NZ,GETVAR	;VARIABLE
  1040  05da  d1                	POP	DE
  1041  05db  eb                	EX	DE,HL
  1042  05dc  b7                	OR	A
  1043  05dd  ed52              NEXT0:	SBC	HL,DE
  1044  05df  2047              	JR	NZ,NEXT1
  1045  05e1  d5                	PUSH	DE
  1046  05e2  dd210800          	LD	IX,6+2
  1047  05e6  dd39              	ADD	IX,SP
  1048  05e8  cd0000            	CALL	DLOAD5		;STEP
  1049  05eb  dd7e0b            	LD	A,(IX+11)	;TYPE
  1050  05ee  dde1              	POP	IX
  1051  05f0  cd0000            	CALL	LOADN		;LOOP VARIABLE
  1052  05f3  f5                	PUSH	AF
  1053  05f4  3e0b              	LD	A,0BH
  1054  05f6  cd0000            	CALL	FPP		;ADD STEP
  1055  05f9  383f              	JR	C,ERROR3
  1056  05fb  f1                	POP	AF		;RESTORE TYPE
  1057  05fc  cd470e            	CALL	STOREN		;UPDATE VARIABLE
  1058  05ff  dd210c00          	LD	IX,12
  1059  0603  dd39              	ADD	IX,SP
  1060  0605  cd0000            	CALL	DLOAD5		;LIMIT
  1061  0608  dd7eff            	LD	A,(IX-1)
  1062  060b  cd0000            	CALL	FPP		;TEST AGAINST LIMIT
  1063  060e  382a              	JR	C,ERROR3
  1064  0610  24                	INC	H
  1065  0611  200a              	JR	NZ,LOOP		;KEEP LOOPING
  1066  0613  211200            	LD	HL,18
  1067  0616  39                	ADD	HL,SP
  1068  0617  f9                	LD	SP,HL
  1069  0618  cd0000            	CALL	NLIST
  1070  061b  189e              	JR	NEXT
  1071                          ;
  1072  061d  c1                LOOP:	POP	BC
  1073  061e  d1                	POP	DE
  1074  061f  fde1              	POP	IY
  1075  0621  fde5              	PUSH	IY
  1076  0623  d5                	PUSH	DE
  1077  0624  c5                	PUSH	BC
  1078  0625  c3f400            	JP	XEQ
  1079                          ;
  1080  0628  211200            NEXT1:	LD	HL,18
  1081  062b  39                	ADD	HL,SP
  1082  062c  f9                	LD	SP,HL		;"POP" THE STACK
  1083  062d  c1                	POP	BC
  1084  062e  21bb05            	LD	HL,FORCHK
  1085  0631  ed42              	SBC	HL,BC
  1086  0633  e1                	POP	HL		;VARIABLE POINTER
  1087  0634  e5                	PUSH	HL
  1088  0635  c5                	PUSH	BC
  1089  0636  28a5              	JR	Z,NEXT0
  1090  0638  3e21              	LD	A,33
  1091  063a  c30000            ERROR3:	JP	ERROR		;"Can't match FOR"
  1092                          ;
  1093                          ;FNname
  1094                          ;N.B. ENTERED WITH A <> TON
  1095                          ;
  1096  063d  f5                FN:	PUSH	AF		;MAKE SPACE ON STACK
  1097  063e  cd4506            	CALL	PROC1
  1098                          FNCHK	EQU	$
  1099                          ;
  1100                          ;PROCname
  1101                          ;N.B. ENTERED WITH A = ON PROC FLAG
  1102                          ;
  1103  0641  f5                PROC:	PUSH	AF		;MAKE SPACE ON STACK
  1104  0642  cd4506            	CALL	PROC1
  1105                          PROCHK	EQU	$
  1106  0645  cde10e            PROC1:	CALL	CHECK
  1107  0648  fd2b              	DEC	IY
  1108  064a  fde5              	PUSH	IY
  1109  064c  cd0000            	CALL	GETDEF
  1110  064f  c1                	POP	BC
  1111  0650  2839              	JR	Z,PROC4
  1112  0652  3e1e              	LD	A,30
  1113  0654  38e4              	JR	C,ERROR3	;"Bad call"
  1114  0656  c5                	PUSH	BC
  1115  0657  2a0000            	LD	HL,(PAGE)
  1116  065a  3edd              PROC2:	LD	A,TDEF
  1117  065c  cd5612            	CALL	SEARCH		;LOOK FOR "DEF"
  1118  065f  3821              	JR	C,PROC3
  1119  0661  e5                	PUSH	HL
  1120  0662  fde1              	POP	IY
  1121  0664  fd23              	INC	IY		;SKIP DEF
  1122  0666  cd0000            	CALL	NXT
  1123  0669  cd0000            	CALL	GETDEF
  1124  066c  fde5              	PUSH	IY
  1125  066e  d1                	POP	DE
  1126  066f  3809              	JR	C,PROC6
  1127  0671  c40000            	CALL	NZ,CREATE
  1128  0674  fde5              	PUSH	IY
  1129  0676  d1                	POP	DE
  1130  0677  73                	LD	(HL),E
  1131  0678  23                	INC	HL
  1132  0679  72                	LD	(HL),D		;SAVE ADDRESS
  1133  067a  eb                PROC6:	EX	DE,HL
  1134  067b  3e0d              	LD	A,CR
  1135  067d  47                	LD	B,A
  1136  067e  edb1              	CPIR			;SKIP TO END OF LINE
  1137  0680  18d8              	JR	PROC2
  1138  0682  fde1              PROC3:	POP	IY		;RESTORE TEXT POINTER
  1139  0684  cd0000            	CALL	GETDEF
  1140  0687  3e1d              	LD	A,29
  1141  0689  20af              	JR	NZ,ERROR3	;"No such FN/PROC"
  1142  068b  5e                PROC4:	LD	E,(HL)
  1143  068c  23                	INC	HL
  1144  068d  56                	LD	D,(HL)		;GET ADDRESS
  1145  068e  210200            	LD	HL,2
  1146  0691  39                	ADD	HL,SP
  1147  0692  cd0000            	CALL	NXT		;ALLOW SPACE BEFORE (
  1148  0695  d5                	PUSH	DE		;EXCHANGE DE,IY
  1149  0696  fde3              	EX	(SP),IY
  1150  0698  d1                	POP	DE
  1151  0699  fe28              	CP	'('		;ARGUMENTS?
  1152  069b  c23f07            	JP	NZ,PROC5
  1153  069e  cd0000            	CALL	NXT		;ALLOW SPACE BEFORE (
  1154  06a1  fe28              	CP	'('
  1155  06a3  c23a02            	JP	NZ,SYNTAX	;"Syntax error"
  1156  06a6  fde5              	PUSH	IY
  1157  06a8  c1                	POP	BC		;SAVE IY IN BC
  1158  06a9  d9                	EXX
  1159  06aa  08                	EX	AF,AF'
  1160  06ab  af                	XOR	A		;INITIALISE RETURN COUNT
  1161  06ac  08                	EX	AF,AF'
  1162  06ad  cd1911            	CALL	SAVLOC		;SAVE DUMMY VARIABLES
  1163  06b0  08                	EX	AF,AF'
  1164  06b1  b7                	OR	A
  1165  06b2  2816              	JR	Z,RETCHK	;NO RETURNS
  1166  06b4  e5                	PUSH	HL
  1167  06b5  ed44              	NEG
  1168  06b7  6f                	LD	L,A
  1169  06b8  ed44              	NEG
  1170  06ba  26ff              	LD	H,-1		;HL = -RETURNS
  1171  06bc  29                	ADD	HL,HL
  1172  06bd  29                	ADD	HL,HL
  1173  06be  29                	ADD	HL,HL		;-RETURNS * 8
  1174  06bf  e3                	EX	(SP),HL
  1175  06c0  dde1              	POP	IX
  1176  06c2  dd39              	ADD	IX,SP
  1177  06c4  ddf9              	LD	SP,IX
  1178  06c6  f5                	PUSH	AF		;PUSH RETURN COUNT
  1179  06c7  cdca06            	CALL	RETCHK		;PUSH MARKER
  1180  06ca  08                RETCHK:	EX	AF,AF'
  1181  06cb  cd0000            	CALL	BRAKET		;CLOSING BRACKET
  1182  06ce  d9                	EXX
  1183  06cf  c5                	PUSH	BC
  1184  06d0  fde1              	POP	IY		;RESTORE IY
  1185  06d2  e5                	PUSH	HL
  1186  06d3  cd280f            	CALL	ARGUE		;TRANSFER ARGUMENTS
  1187  06d6  e1                	POP	HL
  1188                          ;
  1189                          ; If any of the dummy arguments is the same as a passed-by-reference
  1190                          ; variable, then it must not be restored on exit (it would overwrite
  1191                          ; the wanted returned values), therefore search the saved values on
  1192                          ; the stack and if a match is found set bit 4 of the type.  On exit
  1193                          ; from the FN/PROC this will prevent the dummies from being restored.
  1194                          ;
  1195  06d7  e3                	EX	(SP),HL
  1196  06d8  b7                	OR	A
  1197  06d9  01ca06            	LD	BC,RETCHK
  1198  06dc  ed42              	SBC	HL,BC
  1199  06de  09                	ADD	HL,BC
  1200  06df  e3                	EX	(SP),HL
  1201  06e0  205d              	JR	NZ,PROC5	;No RETURNs
  1202                          ;
  1203  06e2  d5                	PUSH	DE
  1204  06e3  e5                	PUSH	HL
  1205  06e4  210700            	LD	HL,7		;Skip two PUSHes and RETCHK
  1206  06e7  39                	ADD	HL,SP
  1207  06e8  7e                	LD	A,(HL)		;RETURN count
  1208  06e9  23                	INC	HL
  1209  06ea  e5                	PUSH	HL
  1210  06eb  dde1              	POP	IX		;Address RETURNs table
  1211  06ed  5f                PROC0:	LD	E,A
  1212  06ee  1600              	LD	D,0
  1213  06f0  eb                	EX	DE,HL
  1214  06f1  29                	ADD	HL,HL
  1215  06f2  29                	ADD	HL,HL
  1216  06f3  29                	ADD	HL,HL
  1217  06f4  19                	ADD	HL,DE		;HL addresses SAVLOC stack
  1218  06f5  23                	INC	HL
  1219  06f6  23                	INC	HL		;Bump past LOCCHK
  1220  06f7  5e                PROC7:	LD	E,(HL)
  1221  06f8  23                	INC	HL
  1222  06f9  56                	LD	D,(HL)		;DE = SAVLOC VARPTR
  1223  06fa  23                	INC	HL
  1224  06fb  4e                	LD	C,(HL)		;Length (if string)
  1225  06fc  23                	INC	HL
  1226  06fd  46                	LD	B,(HL)		;Variable type
  1227                          ;
  1228                          ; Scan RETURNs table for VARPTR match
  1229                          ;
  1230  06fe  c5                	PUSH	BC		;Save type
  1231  06ff  e5                	PUSH	HL
  1232  0700  dde5              	PUSH	IX
  1233  0702  47                	LD	B,A		;B = RETURN count
  1234  0703  dd6e04            PROC8:	LD	L,(IX+4)
  1235  0706  dd6605            	LD	H,(IX+5)	;HL = RETURNed VARPTR
  1236  0709  b7                	OR	A
  1237  070a  ed52              	SBC	HL,DE
  1238  070c  2809              	JR	Z,PROC9
  1239  070e  eb                	EX	DE,HL
  1240  070f  110800            	LD	DE,8
  1241  0712  dd19              	ADD	IX,DE
  1242  0714  eb                	EX	DE,HL
  1243  0715  10ec              	DJNZ	PROC8
  1244  0717  dde1              PROC9:	POP	IX
  1245  0719  e1                	POP	HL
  1246  071a  c1                	POP	BC		;Restore type
  1247                          ;
  1248                          ; If match, set bit 4 of type:
  1249                          ;
  1250  071b  2002              	JR	NZ,PROCA
  1251  071d  cbe6              	SET	4,(HL)		;Flag don't restore
  1252                          ;
  1253                          ; Increment past stacked data:
  1254                          ;
  1255  071f  110300            PROCA:	LD	DE,3
  1256  0722  cb70              	BIT	6,B
  1257  0724  2008              	JR	NZ,PROCB	;Whole array
  1258  0726  1e05              	LD	E,5
  1259  0728  cb78              	BIT	7,B
  1260  072a  2802              	JR	Z,PROCB		;Numeric
  1261  072c  59                	LD	E,C
  1262  072d  13                	INC	DE
  1263  072e  19                PROCB:	ADD	HL,DE
  1264  072f  4e                	LD	C,(HL)
  1265  0730  23                	INC	HL
  1266  0731  46                	LD	B,(HL)
  1267  0732  23                	INC	HL		; BC = marker ?
  1268  0733  eb                	EX	DE,HL
  1269  0734  218511            	LD	HL,LOCCHK
  1270  0737  b7                	OR	A
  1271  0738  ed42              	SBC	HL,BC
  1272  073a  eb                	EX	DE,HL
  1273  073b  28ba              	JR	Z,PROC7		;Another
  1274  073d  e1                	POP	HL
  1275  073e  d1                	POP	DE
  1276                          ;
  1277  073f  73                PROC5:	LD	(HL),E		;SAVE "RETURN ADDRESS"
  1278  0740  23                	INC	HL
  1279  0741  7e                	LD	A,(HL)
  1280  0742  72                	LD	(HL),D
  1281  0743  feee              	CP	TON		;WAS IT "ON PROC" ?
  1282  0745  200c              	JR	NZ,XEQGO
  1283  0747  d5                	PUSH	DE
  1284  0748  fde3              	EX	(SP),IY
  1285  074a  cd9d11            	CALL	SPAN		;SKIP REST OF ON LIST
  1286  074d  fde3              	EX	(SP),IY
  1287  074f  d1                	POP	DE
  1288  0750  72                	LD	(HL),D
  1289  0751  2b                	DEC	HL
  1290  0752  73                	LD	(HL),E
  1291  0753  c3f400            XEQGO:	JP	XEQ
  1292                          ;
  1293  0756  fd23              LOCERR:	INC	IY
  1294  0758  18f9              	JR	XEQGO
  1295                          ;
  1296                          ;LOCAL DATA
  1297                          ;
  1298  075a  fd23              LOCDAT:	INC	IY
  1299  075c  2a0000            	LD	HL,(DATPTR)
  1300  075f  e5                	PUSH	HL
  1301  0760  3e40              	LD	A,40H
  1302  0762  f5                	PUSH	AF
  1303  0763  210000            	LD	HL,DATPTR
  1304  0766  e5                	PUSH	HL
  1305  0767  218511            	LD	HL,LOCCHK
  1306  076a  e5                	PUSH	HL
  1307  076b  18e6              	JR	XEQGO
  1308                          ;
  1309                          ;LOCAL var[,var...]
  1310                          ;
  1311  076d  fe85              LOCAL:	CP	TERROR
  1312  076f  28e5              	JR	Z,LOCERR
  1313  0771  fedc              	CP	TDATA
  1314  0773  28e5              	JR	Z,LOCDAT
  1315  0775  c1                	POP	BC
  1316  0776  c5                	PUSH	BC
  1317  0777  214106            	LD	HL,FNCHK
  1318  077a  b7                	OR	A
  1319  077b  ed42              	SBC	HL,BC
  1320  077d  2823              	JR	Z,LOCAL1
  1321  077f  214506            	LD	HL,PROCHK
  1322  0782  b7                	OR	A
  1323  0783  ed42              	SBC	HL,BC
  1324  0785  281b              	JR	Z,LOCAL1
  1325  0787  218511            	LD	HL,LOCCHK
  1326  078a  b7                	OR	A
  1327  078b  ed42              	SBC	HL,BC
  1328  078d  2813              	JR	Z,LOCAL1
  1329  078f  213603            	LD	HL,ARRCHK
  1330  0792  b7                	OR	A
  1331  0793  ed42              	SBC	HL,BC
  1332  0795  280b              	JR	Z,LOCAL1
  1333  0797  21ca06            	LD	HL,RETCHK
  1334  079a  b7                	OR	A
  1335  079b  ed42              	SBC	HL,BC
  1336  079d  3e0c              	LD	A,12
  1337  079f  c20000            	JP	NZ,ERROR	;"Not LOCAL"
  1338  07a2  fde5              LOCAL1:	PUSH	IY
  1339  07a4  c1                	POP	BC
  1340  07a5  d9                	EXX
  1341  07a6  fd2b              	DEC	IY
  1342  07a8  cd1911            	CALL	SAVLOC
  1343  07ab  d9                	EXX
  1344  07ac  c5                	PUSH	BC
  1345  07ad  fde1              	POP	IY
  1346  07af  cd0000            LOCAL2:	CALL	GETVAR
  1347  07b2  c23a02            	JP	NZ,SYNTAX
  1348  07b5  cb77              	BIT	6,A		;ARRAY?
  1349  07b7  2014              	JR	NZ,LOCAL4
  1350  07b9  b7                	OR	A		;TYPE
  1351  07ba  08                	EX	AF,AF'
  1352  07bb  cd0000            	CALL	ZERO
  1353  07be  08                	EX	AF,AF'
  1354  07bf  f5                	PUSH	AF
  1355  07c0  f4470e            	CALL	P,STOREN	;ZERO
  1356  07c3  f1                	POP	AF
  1357  07c4  59                	LD	E,C
  1358  07c5  fc9c0e            	CALL	M,STORES
  1359  07c8  cd0000            LOCAL3:	CALL	NLIST
  1360  07cb  18e2              	JR	LOCAL2
  1361                          ;
  1362  07cd  dd360001          LOCAL4:	LD	(IX+0),1	;FLAG LOCAL ARRAY
  1363  07d1  dd360100          	LD	(IX+1),0
  1364  07d5  18f1              	JR	LOCAL3
  1365                          ;
  1366                          ;ENDPROC
  1367                          ;
  1368  07d7  c1                ENDPRO:	POP	BC
  1369  07d8  214506            	LD	HL,PROCHK	;PROC MARKER
  1370  07db  af                	XOR	A
  1371  07dc  ed42              	SBC	HL,BC
  1372  07de  280b              	JR	Z,ENDPR1
  1373  07e0  c5                	PUSH	BC		;PUT BACK
  1374  07e1  cd8c10            	CALL	RESLOC
  1375  07e4  20f1              	JR	NZ,ENDPRO
  1376  07e6  3e0d              	LD	A,13
  1377  07e8  c30000            	JP	ERROR		;"No PROC"
  1378                          ;
  1379  07eb  fde1              ENDPR1:	POP	IY
  1380  07ed  c3f400            XEQGO6:	JP	XEQ
  1381                          ;
  1382                          ;INPUT #channel,var,var...
  1383                          ;
  1384  07f0  cd3613            INPUTN:	CALL	CHNL		;E = CHANNEL NUMBER
  1385  07f3  cd0000            INPN1:	CALL	NLIST
  1386  07f6  d5                	PUSH	DE
  1387  07f7  cd3002            	CALL	VAR
  1388  07fa  d1                	POP	DE
  1389  07fb  f5                	PUSH	AF		;SAVE TYPE
  1390  07fc  e5                	PUSH	HL		;VARPTR
  1391  07fd  b7                	OR	A
  1392  07fe  fa2308            	JP	M,INPN2		;STRING
  1393  0801  cd0000            	CALL	OSBGET
  1394  0804  d9                	EXX
  1395  0805  6f                	LD	L,A
  1396  0806  d9                	EXX
  1397  0807  cd0000            	CALL	OSBGET
  1398  080a  d9                	EXX
  1399  080b  67                	LD	H,A
  1400  080c  d9                	EXX
  1401  080d  cd0000            	CALL	OSBGET
  1402  0810  6f                	LD	L,A
  1403  0811  cd0000            	CALL	OSBGET
  1404  0814  67                	LD	H,A
  1405  0815  cd0000            	CALL	OSBGET
  1406  0818  4f                	LD	C,A
  1407  0819  dde1              	POP	IX
  1408  081b  f1                	POP	AF		;RESTORE TYPE
  1409  081c  d5                	PUSH	DE		;SAVE CHANNEL
  1410  081d  cd470e            	CALL	STOREN
  1411  0820  d1                	POP	DE
  1412  0821  18d0              	JR	INPN1
  1413  0823  210000            INPN2:	LD	HL,ACCS
  1414  0826  cd0000            INPN3:	CALL	OSBGET
  1415  0829  fe0d              	CP	CR
  1416  082b  2804              	JR	Z,INPN4
  1417  082d  77                	LD	(HL),A
  1418  082e  2c                	INC	L
  1419  082f  20f5              	JR	NZ,INPN3
  1420  0831  dde1              INPN4:	POP	IX
  1421  0833  f1                	POP	AF
  1422  0834  d5                	PUSH	DE
  1423  0835  eb                	EX	DE,HL
  1424  0836  cd990e            	CALL	STACCS
  1425  0839  d1                	POP	DE
  1426  083a  18b7              	JR	INPN1
  1427                          ;
  1428                          ;INPUT ['][SPC(x)][TAB(x[,y])]["prompt",]var[,var...]
  1429                          ;INPUT LINE [SPC(x)][TAB(x[,y])]["prompt",]var[,var...]
  1430                          ;
  1431  083c  fe23              INPUT:	CP	'#'
  1432  083e  28b0              	JR	Z,INPUTN
  1433  0840  0e00              	LD	C,0		;FLAG PROMPT
  1434  0842  fe86              	CP	TLINE
  1435  0844  2004              	JR	NZ,INPUT0
  1436  0846  fd23              	INC	IY		;SKIP "LINE"
  1437  0848  0e80              	LD	C,80H
  1438  084a  210000            INPUT0:	LD	HL,BUFFER
  1439  084d  360d              	LD	(HL),CR		;INITIALISE EMPTY
  1440  084f  cd9111            INPUT1:	CALL	TERMQ
  1441  0852  2899              	JR	Z,XEQGO6	;DONE
  1442  0854  fd23              	INC	IY
  1443  0856  fe2c              	CP	','
  1444  0858  2851              	JR	Z,INPUT3	;SKIP COMMA
  1445  085a  fe3b              	CP	';'
  1446  085c  284d              	JR	Z,INPUT3
  1447  085e  e5                	PUSH	HL		;SAVE BUFFER POINTER
  1448  085f  fe22              	CP	'"'
  1449  0861  200a              	JR	NZ,INPUT6
  1450  0863  c5                	PUSH	BC
  1451  0864  cd0000            	CALL	CONS
  1452  0867  c1                	POP	BC
  1453  0868  cd0c12            	CALL	PTEXT		;PRINT PROMPT
  1454  086b  1805              	JR	INPUT9
  1455  086d  cdb711            INPUT6:	CALL	FORMAT		;SPC, TAB, '
  1456  0870  2005              	JR	NZ,INPUT2
  1457  0872  e1                INPUT9:	POP	HL
  1458  0873  cbc1              	SET	0,C		;FLAG NO PROMPT
  1459  0875  18d3              	JR	INPUT0
  1460  0877  fd2b              INPUT2:	DEC	IY
  1461  0879  c5                	PUSH	BC
  1462  087a  cd3002            	CALL	VAR
  1463  087d  c1                	POP	BC
  1464  087e  e1                	POP	HL
  1465  087f  f5                	PUSH	AF		;SAVE TYPE
  1466  0880  7e                	LD	A,(HL)
  1467  0881  23                	INC	HL
  1468  0882  fe0d              	CP	CR		;BUFFER EMPTY?
  1469  0884  ccaf08            	CALL	Z,REFILL
  1470  0887  cb79              	BIT	7,C
  1471  0889  f5                	PUSH	AF
  1472  088a  c42a12            	CALL	NZ,LINES
  1473  088d  f1                	POP	AF
  1474  088e  cc1912            	CALL	Z,FETCHS
  1475  0891  f1                	POP	AF		;RESTORE TYPE
  1476  0892  c5                	PUSH	BC
  1477  0893  e5                	PUSH	HL
  1478  0894  b7                	OR	A
  1479  0895  faa608            	JP	M,INPUT4	;STRING
  1480  0898  f5                	PUSH	AF
  1481  0899  dde5              	PUSH	IX
  1482  089b  cd0000            	CALL	VAL0
  1483  089e  dde1              	POP	IX
  1484  08a0  f1                	POP	AF
  1485  08a1  cd470e            	CALL	STOREN
  1486  08a4  1803              	JR	INPUT5
  1487  08a6  cd990e            INPUT4:	CALL	STACCS
  1488  08a9  e1                INPUT5:	POP	HL
  1489  08aa  c1                	POP	BC
  1490  08ab  cb81              INPUT3:	RES	0,C
  1491  08ad  18a0              	JR	INPUT1
  1492                          ;
  1493  08af  cb41              REFILL:	BIT	0,C
  1494  08b1  200a              	JR	NZ,REFIL0	;NO PROMPT
  1495  08b3  3e3f              	LD	A,'?'
  1496  08b5  cd0000            	CALL	OUTCHR		;PROMPT
  1497  08b8  3e20              	LD	A,' '
  1498  08ba  cd0000            	CALL	OUTCHR
  1499  08bd  210000            REFIL0:	LD	HL,BUFFER
  1500  08c0  c5                	PUSH	BC
  1501  08c1  e5                	PUSH	HL
  1502  08c2  dde5              	PUSH	IX
  1503  08c4  cd0000            	CALL	OSLINE
  1504  08c7  dde1              	POP	IX
  1505  08c9  e1                	POP	HL
  1506  08ca  c1                	POP	BC
  1507  08cb  47                	LD	B,A		;POS AT ENTRY
  1508  08cc  af                	XOR	A
  1509  08cd  320000            	LD	(COUNT),A
  1510  08d0  b8                	CP	B
  1511  08d1  c8                	RET	Z
  1512  08d2  7e                REFIL1:	LD	A,(HL)
  1513  08d3  fe0d              	CP	CR
  1514  08d5  c8                	RET	Z
  1515  08d6  23                	INC	HL
  1516  08d7  10f9              	DJNZ	REFIL1
  1517  08d9  c9                	RET
  1518                          ;
  1519                          ;READ var[,var...]
  1520                          ;
  1521  08da  fe23              READ:	CP	'#'
  1522  08dc  caf007            	JP	Z,INPUTN
  1523  08df  2a0000            	LD	HL,(DATPTR)
  1524  08e2  7e                READ0:	LD	A,(HL)
  1525  08e3  fe3a              	CP	':'
  1526  08e5  ccd208            	CALL	Z,REFIL1
  1527  08e8  23                	INC	HL		;SKIP COMMA OR "DATA"
  1528  08e9  fe0d              	CP	CR		;END OF DATA STMT?
  1529  08eb  cc1a09            	CALL	Z,GETDAT
  1530  08ee  e5                	PUSH	HL
  1531  08ef  cd3002            	CALL	VAR
  1532  08f2  e1                	POP	HL
  1533  08f3  b7                	OR	A
  1534  08f4  fa0a09            	JP	M,READ1		;STRING
  1535  08f7  e5                	PUSH	HL
  1536  08f8  fde3              	EX	(SP),IY
  1537  08fa  f5                	PUSH	AF		;SAVE TYPE
  1538  08fb  dde5              	PUSH	IX
  1539  08fd  cd0000            	CALL	EXPRN
  1540  0900  dde1              	POP	IX
  1541  0902  f1                	POP	AF
  1542  0903  cd470e            	CALL	STOREN
  1543  0906  fde3              	EX	(SP),IY
  1544  0908  1807              	JR	READ2
  1545  090a  cd1912            READ1:	CALL	FETCHS
  1546  090d  e5                	PUSH	HL
  1547  090e  cd990e            	CALL	STACCS
  1548  0911  e1                READ2:	POP	HL
  1549  0912  220000            	LD	(DATPTR),HL
  1550  0915  cd0000            	CALL	NLIST
  1551  0918  18c8              	JR	READ0
  1552                          ;
  1553  091a  cd5412            GETDAT:	CALL	DSRCH
  1554  091d  23                	INC	HL
  1555  091e  d0                	RET	NC
  1556  091f  3e2a              	LD	A,42
  1557  0921  1864              	JR	ERROR4		;"Out of DATA"
  1558                          ;
  1559                          ;IF expr statement
  1560                          ;IF expr THEN statement [ELSE statement]
  1561                          ;IF expr THEN line [ELSE line]
  1562                          ;IF expr THEN
  1563                          ;
  1564  0923  cd0000            IF:	CALL	EXPRI
  1565  0926  cd0000            	CALL	TEST
  1566  0929  282a              	JR	Z,IFNOT		;FALSE
  1567  092b  fd7e00            	LD	A,(IY)
  1568  092e  fe8c              	CP	TTHEN
  1569  0930  c2f400            	JP	NZ,XEQ
  1570  0933  fd23              IF0:	INC	IY		;SKIP "THEN"
  1571  0935  fd7e00            	LD	A,(IY)
  1572  0938  fe3b              	CP	';'
  1573  093a  28f7              	JR	Z,IF0
  1574  093c  cd0000            IF1:	CALL	NXT
  1575  093f  fe8d              	CP	TLINO
  1576  0941  c2f400            	JP	NZ,XEQ		;STATEMENT FOLLOWS
  1577  0944  c30e05            	JP	GOTO		;LINE NO. FOLLOWS
  1578                          ;
  1579  0947  fd7e00            IFELSE:	LD	A,(IY)
  1580  094a  fd23              	INC	IY
  1581  094c  fe3b              	CP	';'
  1582  094e  200a              	JR	NZ,IFNEXT
  1583  0950  181e              	JR	IFTHEN
  1584                          ;
  1585  0952  cdf412            IF2:	CALL	QUOTE		;SKIP STRING
  1586  0955  fd7e00            IFNOT:	LD	A,(IY)
  1587  0958  fd23              	INC	IY
  1588  095a  fe22              IFNEXT:	CP	'"'
  1589  095c  28f4              	JR	Z,IF2		;QUOTED STRING
  1590  095e  fef4              	CP	TREM
  1591  0960  ca8c01            	JP	Z,REM		;REM
  1592  0963  fe0d              	CP	CR
  1593  0965  cadf00            	JP	Z,XEQ0		;END OF LINE
  1594  0968  fe8b              	CP	TELSE
  1595  096a  28d0              	JR	Z,IF1		;ELSE CLAUSE
  1596  096c  fe8c              	CP	TTHEN
  1597  096e  20e5              	JR	NZ,IFNOT	;TRY FOR END AGAIN
  1598  0970  fd7e00            IFTHEN:	LD	A,(IY)
  1599  0973  fe0d              	CP	CR
  1600  0975  20d0              	JR	NZ,IFELSE
  1601  0977  018b00            	LD	BC,TELSE
  1602  097a  118ccd            	LD	DE,TENDIF*256+TTHEN
  1603  097d  fd23              	INC	IY
  1604  097f  cd6c12            	CALL	NSCAN
  1605  0982  cafb00            	JP	Z,XEQ1
  1606  0985  3e31              NENDIF:	LD	A,49
  1607  0987  c30000            ERROR4:	JP	ERROR		;"Missing ENDIF"
  1608                          ;
  1609                          ; ELSE (multi-line)
  1610                          ;
  1611  098a  01fdff            MELSE:	LD	BC,-3
  1612  098d  fd09              	ADD	IY,BC
  1613  098f  01cd00            	LD	BC,TENDIF
  1614  0992  118ccd            	LD	DE,TENDIF*256+TTHEN
  1615  0995  cd6c12            	CALL	NSCAN
  1616  0998  20eb              	JR	NZ,NENDIF
  1617  099a  c3f400            XEQGO7:	JP	XEQ
  1618                          ;
  1619                          ; WHEN and OTHERWISE:
  1620                          ;
  1621  099d  01fdff            WHEN:	LD	BC,-3
  1622  09a0  fd09              	ADD	IY,BC
  1623  09a2  01cb00            	LD	BC,TENDCASE
  1624  09a5  11cacb            	LD	DE,TENDCASE*256+TOF
  1625  09a8  cd6c12            	CALL	NSCAN
  1626  09ab  28ed              	JR	Z,XEQGO7
  1627  09ad  3e2f              	LD	A,47
  1628  09af  18d6              	JR	ERROR4		;"Missing ENDCASE"
  1629                          ;
  1630                          ; CASE
  1631                          ;
  1632  09b1  cd0000            CASE:	CALL	EXPR		;String or numeric
  1633  09b4  08                	EX	AF,AF'
  1634  09b5  0600              	LD	B,0		;Flag numeric
  1635  09b7  f2c009            	JP	P,CASE6		;numeric
  1636  09ba  cd0000            	CALL	PUSHS		;put string on stack
  1637  09bd  c1                	POP	BC		;C = length
  1638  09be  0601              	LD	B,1		;Flag string
  1639  09c0  fd7e00            CASE6:	LD	A,(IY)
  1640  09c3  fd23              	INC	IY
  1641  09c5  feca              	CP	TOF
  1642  09c7  3e25              	LD	A,37
  1643  09c9  20bc              	JR	NZ,ERROR4	;"Missing OF"
  1644  09cb  fd7e00            	LD	A,(IY)
  1645  09ce  fd23              	INC	IY		;Address line-length byte
  1646  09d0  fe0d              	CP	CR
  1647  09d2  3e30              	LD	A,48
  1648  09d4  20b1              	JR	NZ,ERROR4	;"OF not last"
  1649  09d6  af                CASE1:	XOR	A		;Level
  1650  09d7  d9                CASE0:	EXX
  1651  09d8  e5                	PUSH	HL		;Push to stack
  1652  09d9  d9                	EXX
  1653  09da  e5                	PUSH	HL
  1654  09db  c5                	PUSH	BC
  1655  09dc  6f                	LD	L,A		;Level
  1656  09dd  01c9cc            	LD	BC,TOTHERWISE*256+TWHEN
  1657  09e0  11cacb             	LD	DE,TENDCASE*256+TOF
  1658  09e3  cd6e12            	CALL	NSCAN1
  1659  09e6  c1                	POP	BC		;Restore from stack
  1660  09e7  e1                	POP	HL
  1661  09e8  d9                	EXX
  1662  09e9  e1                	POP	HL
  1663  09ea  d9                	EXX
  1664  09eb  3e2f              	LD	A,47
  1665  09ed  c20000            	JP	NZ,ERROR	;Missing ENDCASE
  1666  09f0  fd7eff            	LD	A,(IY-1)
  1667  09f3  fecb              	CP	TENDCASE
  1668  09f5  2856              	JR	Z,CASE9
  1669  09f7  fecc              	CP	TOTHERWISE
  1670  09f9  2852              	JR	Z,CASE9
  1671  09fb  cb40              CASE4:	BIT	0,B		;Numeric or string?
  1672  09fd  2069              	JR	NZ,CASE3
  1673  09ff  c5                	PUSH	BC		;Type/exponent/length
  1674  0a00  e5                	PUSH	HL		;MS 32 bits
  1675  0a01  d9                	EXX
  1676  0a02  e5                	PUSH	HL		;LS 32 bits
  1677  0a03  d9                	EXX
  1678  0a04  cd0000            	CALL	EXPRN
  1679  0a07  dd210000          	LD	IX,0
  1680  0a0b  dd39              	ADD	IX,SP		;Address stack
  1681  0a0d  d9                	EXX
  1682  0a0e  dd5e00            	LD	E,(IX+0)	;Get LS 32-bits
  1683  0a11  dd5601            	LD	D,(IX+1)
  1684  0a14  d9                	EXX
  1685  0a15  dd5e02            	LD	E,(IX+2)
  1686  0a18  dd5603            	LD	D,(IX+3)	;Get MS 32-bits
  1687  0a1b  dd4604            	LD	B,(IX+4)	;Get exponent
  1688  0a1e  3e09              	LD	A,9
  1689  0a20  cd0000            	CALL	FPP		;In case integer vs float
  1690  0a23  7d                	LD	A,L
  1691  0a24  b7                	OR	A		;NZ if equal
  1692  0a25  d9                	EXX
  1693  0a26  e1                	POP	HL
  1694  0a27  d9                	EXX
  1695  0a28  e1                	POP	HL
  1696  0a29  c1                	POP	BC
  1697  0a2a  202c              	JR	NZ,CASE5	;Match found
  1698  0a2c  fd7e00            CASE2:	LD	A,(IY)
  1699  0a2f  fd23              	INC	IY
  1700  0a31  fe2c              	CP	','
  1701  0a33  28c6              	JR	Z,CASE4		;Not found, try another
  1702  0a35  d9                	EXX
  1703  0a36  fde5              	PUSH	IY
  1704  0a38  e3                	EX	(SP),HL
  1705  0a39  3e0d              	LD	A,CR
  1706  0a3b  47                	LD	B,A
  1707  0a3c  edb1              	CPIR			;Find CR
  1708  0a3e  e3                	EX	(SP),HL
  1709  0a3f  fde1              	POP	IY
  1710  0a41  d9                	EXX
  1711  0a42  fd7efe            	LD	A,(IY-2)	;Last token in previous line
  1712  0a45  feca              	CP	TOF		;CASE statement in WHEN line
  1713  0a47  208d              	JR	NZ,CASE1
  1714  0a49  3e01              	LD	A,1
  1715  0a4b  188a              	JR	CASE0
  1716                          ;
  1717                          ;Finished, level stack if string:
  1718                          ;
  1719  0a4d  cb40              CASE9:	BIT	0,B
  1720  0a4f  2849              	JR	Z,XEQGO5
  1721  0a51  2600              	LD	H,0
  1722  0a53  69                	LD	L,C
  1723  0a54  39                	ADD	HL,SP
  1724  0a55  f9                	LD	SP,HL
  1725  0a56  1842              	JR	XEQGO5
  1726                          ;
  1727                          ;Matched, so skip any more expressions:
  1728                          ;
  1729  0a58  cd0000            CASE5:	CALL	NXT
  1730  0a5b  fe2c              	CP	','
  1731  0a5d  20ee              	JR	NZ,CASE9	;End of list
  1732  0a5f  fd23              	INC	IY
  1733  0a61  c5                	PUSH	BC		;Save type and string length
  1734  0a62  cd0000            	CALL	EXPR		;Evaluate but discard
  1735  0a65  c1                	POP	BC
  1736  0a66  18f0              	JR	CASE5
  1737                          ;
  1738                          ;String compare:
  1739                          ;
  1740  0a68  c5                CASE3:	PUSH	BC
  1741  0a69  cd0000            	CALL	EXPRS
  1742  0a6c  c1                	POP	BC
  1743  0a6d  210000            	LD	HL,0
  1744  0a70  39                	ADD	HL,SP
  1745  0a71  43                	LD	B,E
  1746  0a72  110000            	LD	DE,ACCS
  1747  0a75  c5                	PUSH	BC
  1748  0a76  cd0000            	CALL	SCP		;String compare
  1749  0a79  c1                	POP	BC
  1750  0a7a  0601              	LD	B,1
  1751  0a7c  20ae              	JR	NZ,CASE2
  1752  0a7e  18d8              	JR	CASE5
  1753                          ;
  1754                          ; WHILE
  1755                          ;
  1756  0a80  fde5              WHILE:	PUSH	IY		;Save current position
  1757  0a82  cde10e            	CALL	CHECK
  1758  0a85  cd880a            	CALL	WHICHK		;Push marker
  1759  0a88  cd0000            WHICHK:	CALL	EXPRI
  1760  0a8b  cd0000            	CALL	TEST
  1761  0a8e  200a              	JR	NZ,XEQGO5
  1762  0a90  c1                	POP	BC		;Pop marker
  1763  0a91  c1                	POP	BC		;Level stack
  1764  0a92  01c7ce            	LD	BC,TWHILE+TENDWHILE*256
  1765  0a95  1601              	LD	D,1
  1766  0a97  cdab12            	CALL	WSRCH
  1767  0a9a  c3f400            XEQGO5:	JP	XEQ
  1768                          ;
  1769                          ; ENDWHILE
  1770                          ;
  1771  0a9d  c1                ENDWHI:	POP	BC		;Marker
  1772  0a9e  d1                	POP	DE		;Saved text pointer
  1773  0a9f  d5                	PUSH	DE
  1774  0aa0  c5                	PUSH	BC
  1775  0aa1  b7                	OR	A
  1776  0aa2  21880a            	LD	HL,WHICHK
  1777  0aa5  ed42              	SBC	HL,BC
  1778  0aa7  280b              	JR	Z,ENDWH1
  1779  0aa9  3e03              	LD	A,3
  1780  0aab  cd8c10            	CALL	RESLOC
  1781  0aae  20ed              	JR	NZ,ENDWHI
  1782  0ab0  3e2e              	LD	A,46
  1783  0ab2  1852              	JR	ERROR5		;"Not in a WHILE loop"
  1784                          ;
  1785  0ab4  fde5              ENDWH1:	PUSH	IY
  1786  0ab6  fd210000          	LD	IY,0
  1787  0aba  fd19              	ADD	IY,DE
  1788  0abc  cd0000            	CALL	EXPRI
  1789  0abf  cd0000            	CALL	TEST
  1790  0ac2  d1                	POP	DE		;Text pointer
  1791  0ac3  20d5              	JR	NZ,XEQGO5
  1792  0ac5  c1                	POP	BC		;Junk marker
  1793  0ac6  c1                	POP	BC		;Junk pointer
  1794  0ac7  fd210000          	LD	IY,0
  1795  0acb  fd19              	ADD	IY,DE
  1796  0acd  18cb              	JR	XEQGO5
  1797                          ;
  1798                          ;CLS
  1799                          ;
  1800  0acf  cd0000            CLS:	CALL	CLRSCN
  1801  0ad2  af                	XOR	A
  1802  0ad3  320000            	LD	(COUNT),A
  1803  0ad6  18c2              	JR	XEQGO5
  1804                          ;
  1805                          ;STOP
  1806                          ;
  1807  0ad8  cd0000            STOP:	CALL	TELL
  1808  0adb  0d                	DEFB	CR
  1809  0adc  0a                	DEFB	LF
  1810  0add  fa                	DEFB	TSTOP
  1811  0ade  00                	DEFB	0
  1812  0adf  cd0000            	CALL	SETLIN		;FIND CURRENT LINE
  1813  0ae2  cd0000            	CALL	SAYLN
  1814  0ae5  cd0000            	CALL	CRLF
  1815  0ae8  c30000            	JP	CLOOP
  1816                          ;
  1817                          ;REPORT
  1818                          ;
  1819  0aeb  cd0000            REPOR:	CALL	REPORT
  1820  0aee  18aa              	JR	XEQGO5
  1821                          ;
  1822                          ;CLEAR
  1823                          ;
  1824  0af0  cd0000            CLR:	CALL	CLEAR
  1825  0af3  2a0000            	LD	HL,(PAGE)
  1826  0af6  183b              	JR	RESTR1
  1827                          ;
  1828                          ;RESTORE DATA / ERROR / LOCAL
  1829                          ;
  1830  0af8  fd23              RESDEL:	INC	IY		;Skip DATA / ERROR / LOCAL
  1831  0afa  79                	LD	A,C		;Save error code
  1832  0afb  08                	EX	AF,AF'
  1833  0afc  78                	LD	A,B		;1=DATA, 2=ERROR, 0=LOCAL
  1834  0afd  cd8c10            	CALL	RESLOC
  1835  0b00  2098              	JR	NZ,XEQGO5
  1836  0b02  08                	EX	AF,AF'		;Get error code
  1837  0b03  21                	DEFB	21H
  1838  0b04  3e29              NOLINE:	LD	A,41		;'No such line'
  1839  0b06  c30000            ERROR5:	JP	ERROR
  1840                          ;
  1841                          ;RESTORE [line | +n | DATA | ERROR | LOCAL]
  1842                          ;
  1843  0b09  fe85              RESTOR:	CP	TERROR
  1844  0b0b  013502            	LD	BC,200H + 53	;'ON ERROR not LOCAL'
  1845  0b0e  28e8              	JR	Z,RESDEL
  1846  0b10  fedc              	CP	TDATA
  1847  0b12  013601            	LD	BC,100H + 54	;'DATA not LOCAL'
  1848  0b15  28e1              	JR	Z,RESDEL
  1849  0b17  feea              	CP	TLOCAL
  1850  0b19  010c00            	LD	BC,12		;'Not in a FN or PROC'
  1851  0b1c  28da              	JR	Z,RESDEL
  1852  0b1e  fe2b              	CP	'+'
  1853  0b20  281a              	JR	Z,RESREL
  1854  0b22  2a0000            	LD	HL,(PAGE)
  1855  0b25  cd9111            	CALL	TERMQ
  1856  0b28  2809              	JR	Z,RESTR1
  1857  0b2a  cd0000            	CALL	ITEMI
  1858  0b2d  d9                	EXX
  1859  0b2e  cd0000            	CALL	FINDL		;SEARCH FOR LINE
  1860  0b31  20d1              	JR	NZ,NOLINE
  1861  0b33  cd5412            RESTR1:	CALL	DSRCH
  1862  0b36  220000            	LD	(DATPTR),HL
  1863  0b39  c3f400            	JP	XEQ
  1864                          ;
  1865  0b3c  cd0000            RESREL:	CALL	EXPRI
  1866  0b3f  d9                	EXX
  1867  0b40  eb                	EX	DE,HL
  1868  0b41  fde5              	PUSH	IY
  1869  0b43  e1                	POP	HL
  1870  0b44  3e0d              	LD	A,CR
  1871  0b46  47                	LD	B,A
  1872  0b47  edb1              	CPIR			;FIND LINE END
  1873  0b49  1d                	DEC	E
  1874  0b4a  28e7              	JR	Z,RESTR1
  1875  0b4c  fa330b            	JP	M,RESTR1
  1876  0b4f  af                	XOR	A
  1877  0b50  47                	LD	B,A
  1878  0b51  4e                RESTR2:	LD	C,(HL)
  1879  0b52  b9                	CP	C
  1880  0b53  28af              	JR	Z,NOLINE
  1881  0b55  09                	ADD	HL,BC
  1882  0b56  1d                	DEC	E
  1883  0b57  20f8              	JR	NZ,RESTR2
  1884  0b59  18d8              	JR	RESTR1
  1885                          ;
  1886                          ;PTR#channel=expr
  1887                          ;PAGE=expr
  1888                          ;TIME=expr
  1889                          ;LOMEM=expr
  1890                          ;HIMEM=expr
  1891                          ;
  1892  0b5b  cd2c13            PTR:	CALL	CHANEL
  1893  0b5e  cdaa11            	CALL	EQUALS
  1894  0b61  7b                	LD	A,E
  1895  0b62  f5                	PUSH	AF
  1896  0b63  cd0000            	CALL	EXPRI
  1897  0b66  e5                	PUSH	HL
  1898  0b67  d9                	EXX
  1899  0b68  d1                	POP	DE
  1900  0b69  f1                	POP	AF
  1901  0b6a  cd0000            	CALL	PUTPTR
  1902  0b6d  1861              	JR	XEQGO1
  1903                          ;
  1904  0b6f  cdaa11            PAGEV:	CALL	EQUALS
  1905  0b72  cd0000            	CALL	EXPRI
  1906  0b75  d9                	EXX
  1907  0b76  2e00              	LD	L,0
  1908  0b78  220000            	LD	(PAGE),HL
  1909  0b7b  1853              	JR	XEQGO1
  1910                          ;
  1911  0b7d  fe24              TIMEV:	CP	'$'
  1912  0b7f  280e              	JR	Z,TIMEVS
  1913  0b81  cdaa11            	CALL	EQUALS
  1914  0b84  cd0000            	CALL	EXPRI
  1915  0b87  e5                	PUSH	HL
  1916  0b88  d9                	EXX
  1917  0b89  d1                	POP	DE
  1918  0b8a  cd0000            	CALL	PUTIME
  1919  0b8d  1841              	JR	XEQGO1
  1920                          ;
  1921  0b8f  fd23              TIMEVS:	INC	IY		;SKIP '$'
  1922  0b91  cdaa11            	CALL	EQUALS
  1923  0b94  cd0000            	CALL	EXPRS
  1924  0b97  cd0000            	CALL	PUTIMS
  1925  0b9a  1834              	JR	XEQGO1
  1926                          ;
  1927  0b9c  cdaa11            LOMEMV:	CALL	EQUALS
  1928  0b9f  cd0000            	CALL	EXPRI
  1929  0ba2  cd0000            	CALL	CLEAR
  1930  0ba5  d9                	EXX
  1931  0ba6  220000            	LD	(LOMEM),HL
  1932  0ba9  220000            	LD	(FREE),HL
  1933  0bac  1822              	JR	XEQGO1
  1934                          ;
  1935  0bae  cdaa11            HIMEMV:	CALL	EQUALS
  1936  0bb1  cd0000            	CALL	EXPRI
  1937  0bb4  d9                	EXX
  1938  0bb5  ed5b0000          	LD	DE,(FREE)
  1939  0bb9  14                	INC	D
  1940  0bba  af                	XOR	A
  1941  0bbb  ed52              	SBC	HL,DE
  1942  0bbd  19                	ADD	HL,DE
  1943  0bbe  da0000            	JP	C,ERROR		;"No room"
  1944  0bc1  ed5b0000          	LD	DE,(HIMEM)
  1945  0bc5  220000            	LD	(HIMEM),HL
  1946  0bc8  eb                	EX	DE,HL
  1947  0bc9  ed72              	SBC	HL,SP
  1948  0bcb  c2f400            	JP	NZ,XEQ
  1949  0bce  eb                	EX	DE,HL
  1950  0bcf  f9                	LD	SP,HL		;LOAD STACK POINTER
  1951  0bd0  c3f400            XEQGO1:	JP	XEQ
  1952                          ;
  1953                          ;WIDTH expr
  1954                          ;
  1955  0bd3  cd0000            WIDTHV:	CALL	EXPRI
  1956  0bd6  d9                	EXX
  1957  0bd7  7d                	LD	A,L
  1958  0bd8  320000            	LD	(WIDTH),A
  1959  0bdb  18f3              	JR	XEQGO1
  1960                          ;
  1961                          ;TRACE ON
  1962                          ;TRACE OFF
  1963                          ;TRACE line
  1964                          ;
  1965  0bdd  fd23              TRACE:	INC	IY
  1966  0bdf  210000            	LD	HL,0
  1967  0be2  feee              	CP	TON
  1968  0be4  280a              	JR	Z,TRACE0
  1969  0be6  fe87              	CP	TOFF
  1970  0be8  2807              	JR	Z,TRACE1
  1971  0bea  fd2b              	DEC	IY
  1972  0bec  cd0000            	CALL	EXPRI
  1973  0bef  d9                	EXX
  1974  0bf0  2b                TRACE0:	DEC	HL
  1975  0bf1  220000            TRACE1:	LD	(TRACEN),HL
  1976  0bf4  18da              	JR	XEQGO1
  1977                          ;
  1978                          ;VDU expr,expr;....[|]
  1979                          ;
  1980  0bf6  cd0000            VDU:	CALL	EXPRI
  1981  0bf9  d9                	EXX
  1982  0bfa  7d                	LD	A,L
  1983  0bfb  0601              	LD	B,1
  1984  0bfd  cd0000            VDU1:	CALL	OSWRCH
  1985  0c00  10fb              	DJNZ	VDU1
  1986  0c02  fd7e00            	LD	A,(IY)
  1987  0c05  fe7c              	CP	'|'
  1988  0c07  2815              	JR	Z,VDU4
  1989  0c09  fe2c              	CP	','
  1990  0c0b  2808              	JR	Z,VDU2
  1991  0c0d  fe3b              	CP	';'
  1992  0c0f  2006              	JR	NZ,VDU3
  1993  0c11  7c                	LD	A,H
  1994  0c12  cd0000            	CALL	OSWRCH
  1995  0c15  fd23              VDU2:	INC	IY
  1996  0c17  cd9111            VDU3:	CALL	TERMQ
  1997  0c1a  20da              	JR	NZ,VDU
  1998  0c1c  18b2              	JR	XEQGO1
  1999                          ;
  2000  0c1e  fd23              VDU4:	INC	IY
  2001  0c20  af                	XOR	A
  2002  0c21  0609              	LD	B,9
  2003  0c23  18d8              	JR	VDU1
  2004                          ;
  2005                          ;CLOSE channel number
  2006                          ;
  2007  0c25  cd2c13            CLOSE:	CALL	CHANEL
  2008  0c28  cd0000            	CALL	OSSHUT
  2009  0c2b  18a3              	JR	XEQGO1
  2010                          ;
  2011                          ;BPUT #channel,byte
  2012                          ;BPUT #channel,string[;]
  2013                          ;
  2014  0c2d  cd2c13            BPUT:	CALL	CHANEL		;CHANNEL NUMBER
  2015  0c30  d5                	PUSH	DE
  2016  0c31  cd0000            	CALL	COMMA
  2017  0c34  cd0000            	CALL	EXPR
  2018  0c37  08                	EX	AF,AF'
  2019  0c38  fa460c            	JP	M,BPUTS
  2020  0c3b  cd0000            	CALL	SFIX
  2021  0c3e  d9                	EXX
  2022  0c3f  7d                	LD	A,L
  2023  0c40  d1                	POP	DE
  2024  0c41  cd0000            BPUT1:	CALL	OSBPUT
  2025  0c44  188a              BPUTX:	JR	XEQGO1
  2026                          ;
  2027  0c46  7b                BPUTS:	LD	A,E
  2028  0c47  d1                	POP	DE
  2029  0c48  57                	LD	D,A
  2030  0c49  210000            	LD	HL,ACCS
  2031  0c4c  b7                	OR	A
  2032  0c4d  2808              	JR	Z,BPUTS0
  2033  0c4f  7e                BPUTS1:	LD	A,(HL)
  2034  0c50  23                	INC	HL
  2035  0c51  cd0000            	CALL	OSBPUT
  2036  0c54  15                	DEC	D
  2037  0c55  20f8              	JR	NZ,BPUTS1
  2038  0c57  cd0000            BPUTS0:	CALL	NXT
  2039  0c5a  fe3b              	CP	';'
  2040  0c5c  3e0a              	LD	A,LF
  2041  0c5e  20e1              	JR	NZ,BPUT1
  2042  0c60  fd23              	INC	IY
  2043  0c62  18e0              	JR	BPUTX
  2044                          ;
  2045                          ;CALL address[,var[,var...]]
  2046                          ;
  2047  0c64  cd0000            CALL:	CALL	EXPRI		;ADDRESS
  2048  0c67  d9                	EXX
  2049  0c68  e5                	PUSH	HL		;SAVE IT
  2050  0c69  0600              	LD	B,0		;PARAMETER COUNTER
  2051  0c6b  110000            	LD	DE,BUFFER	;VECTOR
  2052  0c6e  cd0000            CALL1:	CALL	NXT
  2053  0c71  fe2c              	CP	','
  2054  0c73  2017              	JR	NZ,CALL2
  2055  0c75  fd23              	INC	IY
  2056  0c77  04                	INC	B
  2057  0c78  cd0000            	CALL	NXT
  2058  0c7b  c5                	PUSH	BC
  2059  0c7c  d5                	PUSH	DE
  2060  0c7d  cd3002            	CALL	VAR
  2061  0c80  d1                	POP	DE
  2062  0c81  c1                	POP	BC
  2063  0c82  13                	INC	DE
  2064  0c83  12                	LD	(DE),A		;PARAMETER TYPE
  2065  0c84  13                	INC	DE
  2066  0c85  eb                	EX	DE,HL
  2067  0c86  73                	LD	(HL),E		;PARAMETER ADDRESS
  2068  0c87  23                	INC	HL
  2069  0c88  72                	LD	(HL),D
  2070  0c89  eb                	EX	DE,HL
  2071  0c8a  18e2              	JR	CALL1
  2072  0c8c  78                CALL2:	LD	A,B
  2073  0c8d  320000            	LD	(BUFFER),A	;PARAMETER COUNT
  2074  0c90  e1                	POP	HL		;RESTORE ADDRESS
  2075  0c91  cd9b0c            	CALL	USR1
  2076  0c94  c3f400            	JP	XEQ
  2077                          ;
  2078                          ;USR(address)
  2079                          ;
  2080  0c97  cd0000            USR:	CALL	ITEMI
  2081  0c9a  d9                	EXX
  2082  0c9b  e5                USR1:	PUSH	HL		;ADDRESS ON STACK
  2083  0c9c  fde3              	EX	(SP),IY
  2084  0c9e  24                	INC	H		;PAGE &FF?
  2085  0c9f  21ca0c            	LD	HL,USR2		;RETURN ADDRESS
  2086  0ca2  e5                	PUSH	HL
  2087  0ca3  dd210000          	LD	IX,STAVAR
  2088  0ca7  cc0000            	CALL	Z,OSCALL	;INTERCEPT PAGE &FF
  2089  0caa  dd4e18            	LD	C,(IX+24)
  2090  0cad  c5                	PUSH	BC
  2091  0cae  f1                	POP	AF		;LOAD FLAGS
  2092  0caf  dd7e04            	LD	A,(IX+4)	;LOAD Z80 REGISTERS
  2093  0cb2  dd4608            	LD	B,(IX+8)
  2094  0cb5  dd4e0c            	LD	C,(IX+12)
  2095  0cb8  dd5610            	LD	D,(IX+16)
  2096  0cbb  dd5e14            	LD	E,(IX+20)
  2097  0cbe  dd6620            	LD	H,(IX+32)
  2098  0cc1  dd6e30            	LD	L,(IX+48)
  2099  0cc4  dd210000          	LD	IX,BUFFER
  2100  0cc8  fde9              	JP	(IY)		;OFF TO USER ROUTINE
  2101  0cca  fde1              USR2:	POP	IY
  2102  0ccc  af                	XOR	A
  2103  0ccd  4f                	LD	C,A
  2104  0cce  c9                	RET
  2105                          ;
  2106                          ; LEFT$(A$[,N]) = string
  2107                          ; MID$(A$,N[,M]) = string
  2108                          ; RIGHT$(A$[,N]) = string
  2109                          ;
  2110  0ccf  cd1802            LEFTSL: CALL    GETSTR
  2111  0cd2  2100ff            	LD	HL,0FF00H	;Default all but last
  2112  0cd5  2048              	JR	NZ,MIDSL1
  2113  0cd7  1826              	JR	MIDSL0
  2114                          ;
  2115  0cd9  cd1802            RITESL: CALL	GETSTR
  2116  0cdc  21ffff            	LD	HL,0FFFFH	;Default last char only
  2117  0cdf  203e              	JR	NZ,MIDSL1
  2118  0ce1  181c              	JR	MIDSL0
  2119                          ;
  2120  0ce3  cd1802            MIDSL:	CALL	GETSTR
  2121  0ce6  3e05              	LD	A,5
  2122  0ce8  c20000            	JP	NZ,ERROR	;'Missing comma'
  2123  0ceb  fd23              	INC	IY
  2124  0ced  dde5              	PUSH	IX
  2125  0cef  cd0000            	CALL	EXPRI
  2126  0cf2  dde1              	POP	IX
  2127  0cf4  d9                	EXX
  2128  0cf5  cd0000            	CALL	NXT
  2129  0cf8  2d                	DEC	L
  2130  0cf9  26fe              	LD	H,254		;Default rest of string
  2131  0cfb  fe2c              	CP	','
  2132  0cfd  2020              	JR	NZ,MIDSL1
  2133  0cff  fd23              MIDSL0:	INC	IY
  2134  0d01  e5                	PUSH	HL
  2135  0d02  dde5              	PUSH	IX
  2136  0d04  cd0000            	CALL	EXPRI
  2137  0d07  dde1              	POP	IX
  2138  0d09  d9                	EXX
  2139  0d0a  7d                	LD	A,L
  2140  0d0b  e1                	POP	HL
  2141  0d0c  b7                	OR	A
  2142  0d0d  280d              	JR	Z,MIDSL2	;Zero length
  2143  0d0f  3d                	DEC	A
  2144  0d10  85                	ADD	A,L
  2145  0d11  67                	LD	H,A
  2146  0d12  300b              	JR	NC,MIDSL1
  2147  0d14  7d                	LD	A,L
  2148  0d15  3c                	INC	A
  2149  0d16  2807              	JR	Z,MIDSL1
  2150  0d18  26fe              	LD	H,254
  2151  0d1a  1803              	JR	MIDSL1
  2152                          ;
  2153  0d1c  210100            MIDSL2:	LD	HL,1
  2154  0d1f  cd0000            MIDSL1:	CALL	BRAKET
  2155  0d22  cdaa11            	CALL	EQUALS
  2156  0d25  e5                	PUSH	HL
  2157  0d26  dde5              	PUSH	IX
  2158  0d28  cd0000            	CALL	EXPRS
  2159  0d2b  dde1              	POP	IX
  2160  0d2d  e1                	POP	HL
  2161  0d2e  4b                	LD	C,E
  2162  0d2f  dd4600            	LD	B,(IX+0)
  2163  0d32  dd5e02            	LD	E,(IX+2)
  2164  0d35  dd5603            	LD	D,(IX+3)
  2165                          ;
  2166                          ; Source string at ACCS, length C
  2167                          ; Destination string at DE, length B
  2168                          ; L = first character to modify 0-254
  2169                          ; H =  last character to modify 0-254
  2170                          ; IF L=255 THEN modify rightmost H + 2 chars
  2171                          ; ELSE IF H=255 modify all but last character
  2172                          ; ELSE IF L > H do nothing
  2173                          ; IX = destination VARPTR
  2174                          ;
  2175  0d38  7d                	LD	A,L
  2176  0d39  3c                	INC	A
  2177  0d3a  200f              	JR	NZ,SUBSL1
  2178  0d3c  24                	INC	H
  2179  0d3d  24                	INC	H
  2180  0d3e  79                	LD	A,C
  2181  0d3f  bc                	CP	H
  2182  0d40  3001              	JR	NC,SUBSL0
  2183  0d42  67                	LD	H,A
  2184  0d43  78                SUBSL0:	LD	A,B
  2185  0d44  94                	SUB	H
  2186  0d45  3001              	JR	NC,SUBSL6
  2187  0d47  af                	XOR	A
  2188  0d48  6f                SUBSL6:	LD	L,A
  2189  0d49  1812              	JR	SUBSL5
  2190                          ;
  2191  0d4b  7c                SUBSL1:	LD	A,H
  2192  0d4c  3c                	INC	A
  2193  0d4d  2006              	JR	NZ,SUBSL2
  2194  0d4f  78                	LD	A,B
  2195  0d50  d602              	SUB	2
  2196  0d52  3824              	JR	C,SUBSL9
  2197  0d54  67                	LD	H,A
  2198  0d55  7d                SUBSL2:	LD	A,L
  2199  0d56  b8                	CP	B
  2200  0d57  301f              	JR	NC,SUBSL9
  2201  0d59  7c                	LD	A,H
  2202  0d5a  b8                	CP	B
  2203  0d5b  3803              	JR	C,SUBSL3
  2204  0d5d  78                SUBSL5:	LD	A,B
  2205  0d5e  3d                	DEC	A
  2206  0d5f  67                	LD	H,A
  2207  0d60  7c                SUBSL3:	LD	A,H
  2208  0d61  95                	SUB	L
  2209  0d62  3814              	JR	C,SUBSL9
  2210  0d64  3c                	INC	A
  2211  0d65  b9                	CP	C
  2212  0d66  3801              	JR	C,SUBSL4
  2213  0d68  79                	LD	A,C
  2214  0d69  0600              SUBSL4:	LD	B,0
  2215  0d6b  60                	LD	H,B
  2216  0d6c  4f                	LD	C,A
  2217  0d6d  b7                	OR	A
  2218  0d6e  2808              	JR	Z,SUBSL9
  2219  0d70  eb                	EX	DE,HL
  2220  0d71  19                	ADD	HL,DE
  2221  0d72  eb                	EX	DE,HL
  2222  0d73  210000            	LD	HL,ACCS
  2223  0d76  edb0              	LDIR
  2224  0d78  c3f400            SUBSL9:	JP	XEQ
  2225                          ;
  2226                          ; EXIT FOR [var]
  2227                          ; EXIT REPEAT
  2228                          ; EXIT WHILE
  2229                          ;
  2230  0d7b  fd23              EXIT:	INC	IY		;Skip FOR/REPEAT/WHILE
  2231  0d7d  fee3              	CP	TFOR
  2232  0d7f  200c              	JR	NZ,EXIT0
  2233  0d81  dd210000          	LD	IX,0		;For EXIT FOR <var>
  2234  0d85  cd9111            	CALL	TERMQ
  2235  0d88  c40000            	CALL	NZ,GETVAR
  2236  0d8b  3ee3              	LD	A,TFOR
  2237  0d8d  1601              EXIT0:	LD	D,1		;Level for WSRCH
  2238  0d8f  5f                	LD	E,A
  2239  0d90  7b                EXIT1:	LD	A,E
  2240  0d91  c1                	POP	BC		;Marker
  2241  0d92  21bb05            	LD	HL,FORCHK
  2242  0d95  b7                	OR	A
  2243  0d96  ed42              	SBC	HL,BC
  2244  0d98  2825              	JR	Z,EXIT4
  2245  0d9a  214705            	LD	HL,REPCHK
  2246  0d9d  b7                	OR	A
  2247  0d9e  ed42              	SBC	HL,BC
  2248  0da0  2838              	JR	Z,EXIT6
  2249  0da2  21880a            	LD	HL,WHICHK
  2250  0da5  b7                	OR	A
  2251  0da6  ed42              	SBC	HL,BC
  2252  0da8  283a              	JR	Z,EXIT7
  2253  0daa  c5                	PUSH	BC		;Put back marker
  2254  0dab  dde5              	PUSH	IX
  2255  0dad  c1                	POP	BC
  2256  0dae  d9                	EXX
  2257  0daf  3e03              	LD	A,3
  2258  0db1  cd8c10            	CALL	RESLOC
  2259  0db4  d9                	EXX
  2260  0db5  c5                	PUSH	BC
  2261  0db6  dde1              	POP	IX
  2262  0db8  20d6              	JR	NZ,EXIT1
  2263  0dba  3e2c              	LD	A,44
  2264  0dbc  c30000            	JP	ERROR		;'Bad EXIT'
  2265                          ;
  2266  0dbf  c1                EXIT4:	POP	BC		;VARPTR
  2267  0dc0  210e00            	LD	HL,14		;Skip text pointer, limit & step
  2268  0dc3  39                	ADD	HL,SP
  2269  0dc4  f9                	LD	SP,HL		;Pop FOR record
  2270  0dc5  fee3              	CP	TFOR
  2271  0dc7  20c7              	JR	NZ,EXIT1
  2272  0dc9  dde5              	PUSH	IX
  2273  0dcb  e1                	POP	HL
  2274  0dcc  7c                	LD	A,H
  2275  0dcd  b5                	OR	L
  2276  0dce  2802              	JR	Z,EXIT5
  2277  0dd0  ed42              	SBC	HL,BC
  2278  0dd2  01e3ed            EXIT5:	LD	BC,TFOR+TNEXT*256
  2279  0dd5  2815              	JR	Z,EXIT8
  2280  0dd7  14                	INC	D		;Count nested FOR loops
  2281  0dd8  18b6              	JR	EXIT1
  2282                          ;
  2283  0dda  c1                EXIT6:	POP	BC		;Text pointer
  2284  0ddb  fef5              	CP	TREPEAT
  2285  0ddd  20b1              	JR	NZ,EXIT1
  2286  0ddf  01f5fd            	LD	BC,TREPEAT+TUNTIL*256
  2287  0de2  1808              	JR	EXIT8
  2288                          ;
  2289  0de4  c1                EXIT7:	POP	BC		;Text pointer
  2290  0de5  fec7              	CP	TWHILE
  2291  0de7  20a7              	JR	NZ,EXIT1
  2292  0de9  01c7ce            	LD	BC,TWHILE+TENDWHILE*256
  2293  0dec  cdab12            EXIT8:	CALL	WSRCH
  2294  0def  cd9d11            	CALL	SPAN		;Skip UNTIL expression
  2295  0df2  c3f400            	JP	XEQ
  2296                          ;
  2297                          ;PUT port,data
  2298                          ;
  2299  0df5  cd0000            PUT:	CALL	EXPRI		;PORT ADDRESS
  2300  0df8  d9                	EXX
  2301  0df9  e5                	PUSH	HL
  2302  0dfa  cd0000            	CALL	COMMA
  2303  0dfd  cd0000            	CALL	EXPRI		;DATA
  2304  0e00  d9                	EXX
  2305  0e01  c1                	POP	BC
  2306  0e02  ed69              	OUT	(C),L		;OUTPUT TO PORT BC
  2307  0e04  c3f400            	JP	XEQ
  2308                          ;
  2309                          ;SUBROUTINES:
  2310                          ;
  2311                          ;ASSIGN - Assign a numeric value to a variable.
  2312                          ;Outputs: NC,  Z     - OK, numeric scalar
  2313                          ;         NC, NZ, PE - OK, string array  (D = type, E = operator)
  2314                          ; else if NC, NZ, P  - OK, numeric array (D = type, E = operator)
  2315                          ; else if NC, NZ     - OK, string scalar
  2316                          ;          C, NZ     - illegal / invalid
  2317                          ;
  2318  0e07  cd0000            ASSIGN:	CALL	GETVAR		;VARIABLE
  2319  0e0a  d8                	RET	C		;ILLEGAL VARIABLE
  2320  0e0b  c40000            	CALL	NZ,PUTVAR
  2321  0e0e  57                	LD	D,A		;Type
  2322  0e0f  cd0000            	CALL	NXT
  2323  0e12  fd23              	INC	IY
  2324  0e14  5f                	LD	E,A		;Operator (or =)
  2325  0e15  fe3d              	CP	'='
  2326  0e17  c4aa11            	CALL	NZ,EQUALS
  2327  0e1a  7a                	LD	A,D
  2328  0e1b  e6c0              	AND	11000000B
  2329  0e1d  c0                	RET	NZ		;String or array
  2330  0e1e  d5                	PUSH	DE
  2331  0e1f  e5                	PUSH	HL
  2332  0e20  cd0000            	CALL	EXPRN
  2333  0e23  dde1              	POP	IX
  2334  0e25  d1                	POP	DE
  2335                          ;
  2336                          ; Falls through to...
  2337                          ;
  2338                          ; MODIFY - Update numeric variable according to operator:
  2339                          ;   Inputs: D = type
  2340                          ;           E = operator
  2341                          ;           HLH'L'C = value
  2342                          ;           IX = destination VARPTR
  2343                          ; Destroys: Everything except IX,IY,SP
  2344                          ;
  2345  0e26  7b                MODIFY:	LD	A,E
  2346  0e27  fe3d              	CP	'='
  2347  0e29  281b              	JR	Z,STORE0	;Simple assignment
  2348  0e2b  d5                	PUSH	DE
  2349  0e2c  d9                	EXX
  2350  0e2d  eb                	EX	DE,HL
  2351  0e2e  d9                	EXX
  2352  0e2f  eb                	EX	DE,HL
  2353  0e30  41                	LD	B,C
  2354  0e31  e3                	EX	(SP),HL
  2355  0e32  7c                	LD	A,H
  2356  0e33  e3                	EX	(SP),HL
  2357  0e34  cd0000            	CALL	LOADN
  2358  0e37  e3                	EX	(SP),HL
  2359  0e38  7d                	LD	A,L
  2360  0e39  e3                	EX	(SP),HL
  2361  0e3a  e60f              	AND	15
  2362  0e3c  dde5              	PUSH	IX
  2363  0e3e  cd0000            	CALL	FPP
  2364  0e41  dde1              	POP	IX
  2365  0e43  d1                	POP	DE
  2366  0e44  3842              	JR	C,ERRORC
  2367  0e46  7a                STORE0:	LD	A,D		;Type
  2368  0e47  fe05              STOREN:	CP	5
  2369  0e49  2812              	JR	Z,STORE5
  2370  0e4b  f5                	PUSH	AF
  2371  0e4c  0c                	INC	C		;SPEED - & PRESERVE F'
  2372  0e4d  0d                	DEC	C		; WHEN CALLED BY FNEND0
  2373  0e4e  c40000            	CALL	NZ,SFIX		;CONVERT TO INTEGER
  2374  0e51  f1                	POP	AF
  2375  0e52  fe04              	CP	4
  2376  0e54  280a              	JR	Z,STORE4
  2377  0e56  bf                	CP	A		;SET ZERO
  2378  0e57  d9                STORE1:	EXX
  2379  0e58  dd7500            	LD	(IX+0),L
  2380  0e5b  d9                	EXX
  2381  0e5c  c9                	RET
  2382                          ;
  2383  0e5d  dd7104            STORE5:	LD	(IX+4),C
  2384  0e60  d9                STORE4:	EXX
  2385  0e61  dd7500            	LD	(IX+0),L
  2386  0e64  dd7401            	LD	(IX+1),H
  2387  0e67  d9                	EXX
  2388  0e68  dd7502            	LD	(IX+2),L
  2389  0e6b  dd7403            	LD	(IX+3),H
  2390  0e6e  c9                	RET
  2391                          ;
  2392                          ; MODIFS - Update string variable according to operator:
  2393                          ;   Inputs: H = type
  2394                          ;           L = operator (= or +)
  2395                          ;           E = string length (string in accumulator)
  2396                          ;           IX = destination VARPTR
  2397                          ; Destroys: Everything except SP, IY
  2398                          ;
  2399  0e6f  7d                MODIFS:	LD	A,L		;Operator
  2400  0e70  fe2b              	CP	'+'
  2401  0e72  7c                	LD	A,H		;Type
  2402  0e73  2024              	JR	NZ,STACCS
  2403  0e75  dde5              	PUSH	IX
  2404  0e77  fde3              	EX	(SP),IY
  2405  0e79  cd0000            	CALL	PUSHS
  2406  0e7c  fde5              	PUSH	IY
  2407  0e7e  dde1              	POP	IX
  2408  0e80  cd0000            	CALL	LOADS
  2409  0e83  c1                	POP	BC
  2410  0e84  7b                	LD	A,E
  2411  0e85  81                	ADD	C
  2412  0e86  3e13              	LD	A,19		;String too long
  2413  0e88  3861              ERRORC:	JR	C,ERROR6
  2414  0e8a  78                	LD	A,B		;Type
  2415  0e8b  0c                	INC	C
  2416  0e8c  0d                	DEC	C
  2417  0e8d  2808              	JR	Z,MODFS1	;Zero length
  2418  0e8f  210000            	LD	HL,0
  2419  0e92  44                	LD	B,H
  2420  0e93  39                	ADD	HL,SP
  2421  0e94  edb0              	LDIR
  2422  0e96  f9                	LD	SP,HL
  2423  0e97  fde1              MODFS1:	POP	IY
  2424                          ;
  2425                          ; Falls through to:
  2426                          ;
  2427  0e99  210000            STACCS:	LD	HL,ACCS
  2428  0e9c  1f                STORES:	RRA
  2429  0e9d  304f              	JR	NC,STORS3	;FIXED STRING
  2430  0e9f  e5                	PUSH	HL
  2431  0ea0  cd0000            	CALL	LOAD4
  2432  0ea3  7b                	LD	A,E		;LENGTH OF STRING
  2433  0ea4  d9                	EXX
  2434  0ea5  6f                	LD	L,A
  2435  0ea6  7c                	LD	A,H		;LENGTH ALLOCATED
  2436  0ea7  d9                	EXX
  2437  0ea8  bb                	CP	E
  2438  0ea9  3024              	JR	NC,STORS1	;ENOUGH ROOM
  2439  0eab  d9                	EXX
  2440  0eac  65                	LD	H,L
  2441  0ead  d9                	EXX
  2442  0eae  e5                	PUSH	HL
  2443  0eaf  0600              	LD	B,0
  2444  0eb1  4f                	LD	C,A
  2445  0eb2  09                	ADD	HL,BC
  2446  0eb3  ed4b0000          	LD	BC,(FREE)
  2447  0eb7  ed42              	SBC	HL,BC		;IS STRING LAST?
  2448  0eb9  e1                	POP	HL
  2449  0eba  2812              	JR	Z,STORS0
  2450  0ebc  60                	LD	H,B
  2451  0ebd  69                	LD	L,C		;DESTINATION
  2452                          ;
  2453  0ebe  b7                	OR	A		;V5 optimisation
  2454  0ebf  280d              	JR	Z,STORS0
  2455  0ec1  7b                	LD	A,E
  2456  0ec2  5f                STORS2:	LD	E,A
  2457  0ec3  1d                	DEC	E
  2458  0ec4  a3                	AND	E
  2459  0ec5  20fb              	JR	NZ,STORS2
  2460  0ec7  37                	SCF
  2461  0ec8  cb13              	RL	E
  2462  0eca  7b                	LD	A,E
  2463  0ecb  d9                	EXX
  2464  0ecc  67                	LD	H,A
  2465  0ecd  d9                	EXX
  2466                          ;
  2467  0ece  37                STORS0:	SCF
  2468  0ecf  cd600e            STORS1:	CALL	STORE4		;PRESERVES CARRY!
  2469  0ed2  0600              	LD	B,0
  2470  0ed4  4b                	LD	C,E
  2471  0ed5  eb                	EX	DE,HL
  2472  0ed6  e1                	POP	HL
  2473  0ed7  0d                	DEC	C
  2474  0ed8  0c                	INC	C
  2475  0ed9  c8                	RET	Z		;NULL STRING
  2476  0eda  edb0              	LDIR
  2477  0edc  d0                	RET	NC		;STRING REPLACED
  2478  0edd  ed530000          	LD	(FREE),DE
  2479  0ee1  e5                CHECK:	PUSH	HL
  2480  0ee2  2a0000            	LD	HL,(FREE)
  2481  0ee5  24                	INC	H
  2482  0ee6  ed72              	SBC	HL,SP
  2483  0ee8  e1                	POP	HL
  2484  0ee9  d8                	RET	C
  2485  0eea  af                	XOR	A
  2486  0eeb  c30000            ERROR6:	JP	ERROR		;"No room"
  2487                          ;
  2488  0eee  4b                STORS3:	LD	C,E
  2489  0eef  dde5              	PUSH	IX
  2490  0ef1  d1                	POP	DE
  2491  0ef2  af                	XOR	A
  2492  0ef3  47                	LD	B,A
  2493  0ef4  b9                	CP	C
  2494  0ef5  2802              	JR	Z,STORS5
  2495  0ef7  edb0              	LDIR
  2496  0ef9  3e0d              STORS5:	LD	A,CR
  2497  0efb  12                	LD	(DE),A
  2498  0efc  c9                	RET
  2499                          ;
  2500                          ; SAVRET - SAVE 'RETURNed' PARAMETER INFO
  2501                          ;
  2502  0efd  dd7500            SAVRET:	LD	(IX+0),L		;Formal VARPTR
  2503  0f00  dd7401            	LD	(IX+1),H
  2504  0f03  dd7702            	LD	(IX+2),A
  2505  0f06  fde3              	EX	(SP),IY
  2506  0f08  f5                	PUSH	AF
  2507  0f09  fde5              	PUSH	IY
  2508  0f0b  dde5              	PUSH	IX
  2509  0f0d  cd0000            	CALL	NXT
  2510  0f10  cd3002            	CALL	VAR
  2511  0f13  dde1              	POP	IX
  2512  0f15  dd7504            	LD	(IX+4),L		;Actual VARPTR
  2513  0f18  dd7405            	LD	(IX+5),H
  2514  0f1b  dd7706            	LD	(IX+6),A
  2515  0f1e  fde1              	POP	IY
  2516  0f20  f1                	POP	AF
  2517  0f21  010800            	LD	BC,8
  2518  0f24  dd09              	ADD	IX,BC
  2519  0f26  182d              	JR	ARGUE0
  2520                          ;
  2521                          ;ARGUE: TRANSFER FN OR PROC ARGUMENTS FROM THE
  2522                          ; CALLING STATEMENT TO THE DUMMY VARIABLES VIA
  2523                          ; THE STACK.  IT MUST BE DONE THIS WAY TO MAKE
  2524                          ; PROCFRED(A,B)    DEF PROCFRED(B,A)     WORK.
  2525                          ;   Inputs: DE addresses parameter list
  2526                          ;           IY addresses dummy variable list
  2527                          ;           IX addresses RETURNed parameter data block
  2528                          ;  Outputs: DE,IY updated
  2529                          ; Destroys: Everything
  2530                          ;
  2531  0f28  3eff              ARGUE:	LD	A,-1
  2532  0f2a  f5                	PUSH	AF		;PUT MARKER ON STACK
  2533  0f2b  fd23              ARGUE1:	INC	IY		;BUMP PAST ( OR ,
  2534  0f2d  13                	INC	DE
  2535  0f2e  d5                	PUSH	DE
  2536  0f2f  0600              	LD	B,0
  2537  0f31  cd0000            	CALL	NXT
  2538  0f34  fef8              	CP	TRETURN
  2539  0f36  2006              	JR	NZ,ARGUE9
  2540  0f38  fd23              	INC	IY		;SKIP 'RETURN'
  2541  0f3a  cd0000            	CALL	NXT
  2542  0f3d  04                	INC	B		;FLAG 'RETURN'
  2543  0f3e  c5                ARGUE9:	PUSH	BC
  2544  0f3f  dde5              	PUSH	IX
  2545  0f41  cd0000            	CALL	GETVAR		;FORMAL PARAMETER
  2546  0f44  3849              	JR	C,ARGERR
  2547  0f46  c40000            	CALL	NZ,PUTVAR
  2548  0f49  dde1              	POP	IX
  2549  0f4b  c1                	POP	BC
  2550  0f4c  d1                	POP	DE
  2551  0f4d  e5                	PUSH	HL		;VARPTR
  2552  0f4e  f5                	PUSH	AF
  2553  0f4f  d5                	PUSH	DE
  2554  0f50  05                	DEC	B
  2555  0f51  28aa              	JR	Z,SAVRET
  2556  0f53  fde3              	EX	(SP),IY
  2557  0f55  cb77              ARGUE0:	BIT	6,A		;ARRAY?
  2558  0f57  203b              	JR	NZ,ARGUE3
  2559  0f59  b7                	OR	A		;TYPE
  2560  0f5a  fa700f            	JP	M,ARGUE2	;STRING
  2561  0f5d  dde5              	PUSH	IX
  2562  0f5f  cd0000            	CALL	EXPRN		;ACTUAL PARAMETER
  2563  0f62  dde1              	POP	IX
  2564  0f64  fde3              	EX	(SP),IY
  2565  0f66  d1                	POP	DE
  2566  0f67  f1                	POP	AF
  2567  0f68  d9                	EXX
  2568  0f69  e5                	PUSH	HL
  2569  0f6a  d9                	EXX
  2570  0f6b  e5                	PUSH	HL
  2571  0f6c  47                	LD	B,A
  2572  0f6d  c5                	PUSH	BC
  2573  0f6e  1813              	JR	ARGUE4
  2574                          ;
  2575  0f70  dde5              ARGUE2:	PUSH	IX
  2576  0f72  cd0000            	CALL	EXPRS
  2577  0f75  d9                	EXX
  2578  0f76  c1                	POP	BC
  2579  0f77  fde3              	EX	(SP),IY
  2580  0f79  d1                	POP	DE
  2581  0f7a  d9                	EXX
  2582  0f7b  f1                	POP	AF
  2583  0f7c  cd0000            	CALL	PUSHS
  2584  0f7f  d9                	EXX
  2585  0f80  c5                	PUSH	BC
  2586  0f81  dde1              	POP	IX
  2587  0f83  cd0000            ARGUE4:	CALL	NXT
  2588  0f86  fe2c              	CP	','
  2589  0f88  2027              	JR	NZ,ARGUE5
  2590  0f8a  1a                	LD	A,(DE)
  2591  0f8b  fe2c              	CP	','
  2592  0f8d  289c              	JR	Z,ARGUE1	;ANOTHER
  2593  0f8f  3e1f              ARGERR:	LD	A,31
  2594  0f91  c30000            	JP	ERROR		;"Bad arguments"
  2595                          ;
  2596  0f94  dde5              ARGUE3:	PUSH	IX
  2597  0f96  cd0000            	CALL	NXT
  2598  0f99  cd0000            	CALL	GETVAR
  2599  0f9c  38f1              	JR	C,ARGERR
  2600  0f9e  dd4e00            	LD	C,(IX+0)
  2601  0fa1  dd4601            	LD	B,(IX+1)
  2602  0fa4  dde1              	POP	IX
  2603  0fa6  cd0000            	CALL	NXT
  2604  0fa9  fde3              	EX	(SP),IY
  2605  0fab  d1                	POP	DE
  2606  0fac  f1                	POP	AF
  2607  0fad  c5                	PUSH	BC		;STACK ARRAY POINTER
  2608  0fae  f5                	PUSH	AF		;STACK TYPE
  2609  0faf  18d2              	JR	ARGUE4
  2610                          ;
  2611  0fb1  cd0000            ARGUE5:	CALL	BRAKET
  2612  0fb4  1a                	LD	A,(DE)
  2613  0fb5  fe29              	CP	')'
  2614  0fb7  20d6              	JR	NZ,ARGERR
  2615  0fb9  13                	INC	DE
  2616  0fba  d9                UNSTAK:	EXX
  2617  0fbb  c1                ARGUE6:	POP	BC
  2618  0fbc  78                	LD	A,B
  2619  0fbd  3c                	INC	A
  2620  0fbe  d9                	EXX
  2621  0fbf  c8                	RET	Z		;MARKER POPPED
  2622  0fc0  d9                	EXX
  2623  0fc1  3d                	DEC	A
  2624  0fc2  cb77              	BIT	6,A		;ARRAY
  2625  0fc4  2019              	JR	NZ,ARGUE8
  2626  0fc6  b7                	OR	A
  2627  0fc7  fad50f            	JP	M,ARGUE7	;STRING
  2628  0fca  e1                	POP	HL
  2629  0fcb  d9                	EXX
  2630  0fcc  e1                	POP	HL
  2631  0fcd  d9                	EXX
  2632  0fce  dde1              	POP	IX
  2633  0fd0  cd470e            	CALL	STOREN		;WRITE TO DUMMY
  2634  0fd3  18e6              	JR	ARGUE6
  2635                          ;
  2636  0fd5  cd0000            ARGUE7:	CALL	POPS
  2637  0fd8  dde1              	POP	IX
  2638  0fda  cd990e            	CALL	STACCS
  2639  0fdd  18dc              	JR	ARGUE6
  2640                          ;
  2641  0fdf  c1                ARGUE8:	POP	BC		;ARRAY POINTER
  2642  0fe0  dde1              	POP	IX
  2643  0fe2  dd7100            	LD	(IX+0),C
  2644  0fe5  dd7001            	LD	(IX+1),B
  2645  0fe8  18d1              	JR	ARGUE6
  2646                          ;
  2647                          ;Restore RETURNed parameters, via the stack to ensure that
  2648                          ; PROCFRED(A,B)    DEF PROCFRED(RETURN B,RETURN A)  works.
  2649                          ;
  2650  0fea  3eff              RETXFR:	LD	A,-1
  2651  0fec  f5                	PUSH	AF		;PUT MARKER ON STACK
  2652  0fed  d9                RETXF1:	EXX
  2653  0fee  dd6e04            	LD	L,(IX+4)	;Actual parameter (destination)
  2654  0ff1  dd6605            	LD	H,(IX+5)
  2655  0ff4  e5                	PUSH	HL		;STACK VARPTR
  2656  0ff5  dd6e00            	LD	L,(IX+0)	;Formal parameter (source)
  2657  0ff8  dd6601            	LD	H,(IX+1)
  2658  0ffb  dd7e02            	LD	A,(IX+2)
  2659  0ffe  cb77              	BIT	6,A		;ARRAY?
  2660  1000  2019              	JR	NZ,RETXF3
  2661  1002  b7                	OR	A		;TYPE
  2662  1003  fa2110            	JP	M,RETXF2	;STRING
  2663  1006  e5                	PUSH	HL
  2664  1007  dde3              	EX	(SP),IX
  2665  1009  cd0000            	CALL	LOADN
  2666  100c  dde1              	POP	IX
  2667  100e  d9                	EXX			;STACK VALUE
  2668  100f  e5                	PUSH	HL
  2669  1010  d9                	EXX
  2670  1011  e5                	PUSH	HL
  2671  1012  dd4606            RETXF6:	LD	B,(IX+6)
  2672  1015  c5                	PUSH	BC		;TYPE & EXPONENT
  2673  1016  cde10e            RETXF5:	CALL	CHECK		;CHECK ROOM
  2674  1019  181e              	JR	RETXF4
  2675                          ;
  2676  101b  5e                RETXF3:	LD	E,(HL)
  2677  101c  23                	INC	HL
  2678  101d  56                	LD	D,(HL)
  2679  101e  d5                	PUSH	DE		;STACK ARRAY POINTER
  2680  101f  18f1              	JR	RETXF6
  2681                          ;
  2682  1021  e5                RETXF2:	PUSH	HL
  2683  1022  dde3              	EX	(SP),IX
  2684  1024  cd0000            	CALL	LOADS
  2685  1027  dde1              	POP	IX
  2686  1029  dd7e06            	LD	A,(IX+6)
  2687  102c  d9                	EXX
  2688  102d  dde5              	PUSH	IX
  2689  102f  e1                	POP	HL
  2690  1030  d9                	EXX
  2691  1031  cd0000            	CALL	PUSHS
  2692  1034  d9                	EXX
  2693  1035  e5                	PUSH	HL
  2694  1036  dde1              	POP	IX
  2695  1038  d9                	EXX
  2696  1039  110800            RETXF4:	LD	DE,8
  2697  103c  dd19              	ADD	IX,DE
  2698  103e  d9                	EXX
  2699  103f  10ac              	DJNZ	RETXF1
  2700  1041  c3ba0f            	JP	UNSTAK
  2701                          ;
  2702                          ;Restore 'RETURNed' parameters,
  2703                          ;
  2704  1044  c1                RESRET:	POP	BC		;B = 'RETURN' COUNT
  2705  1045  2600              	LD	H,0
  2706  1047  68                	LD	L,B
  2707  1048  29                	ADD	HL,HL
  2708  1049  29                	ADD	HL,HL
  2709  104a  29                	ADD	HL,HL		;RETURN COUNT * 8
  2710  104b  39                	ADD	HL,SP
  2711  104c  dd210000          	LD	IX,0
  2712  1050  dd39              	ADD	IX,SP		;ADDRESS PARAMETER LIST
  2713  1052  f5                	PUSH	AF
  2714  1053  d5                	PUSH	DE
  2715  1054  e5                	PUSH	HL
  2716  1055  d9                	EXX
  2717  1056  c5                	PUSH	BC
  2718  1057  d5                	PUSH	DE
  2719  1058  d9                	EXX
  2720  1059  78                	LD	A,B
  2721  105a  210000            	LD	HL,ACCS
  2722  105d  110000            	LD	DE,BUFFER
  2723  1060  01ff00            	LD	BC,255
  2724  1063  edb0              	LDIR
  2725  1065  47                	LD	B,A
  2726  1066  cdea0f            	CALL	RETXFR		;TRANSFER VIA STACK
  2727  1069  210000            	LD	HL,BUFFER
  2728  106c  110000            	LD	DE,ACCS
  2729  106f  01ff00            	LD	BC,255
  2730  1072  edb0              	LDIR
  2731  1074  d9                	EXX
  2732  1075  d1                	POP	DE
  2733  1076  c1                	POP	BC
  2734  1077  d9                	EXX
  2735  1078  e1                	POP	HL
  2736  1079  d1                	POP	DE
  2737  107a  f1                	POP	AF
  2738  107b  180a              	JR	RESAR1
  2739                          ;
  2740                          ; Restore LOCAL array or memory block:
  2741                          ;
  2742  107d  c1                RESARR:	POP	BC
  2743  107e  cb78              	BIT	7,B		;String array?
  2744  1080  e1                	POP	HL
  2745  1081  c1                	POP	BC
  2746  1082  09                	ADD	HL,BC
  2747  1083  39                	ADD	HL,SP
  2748  1084  c43e13            	CALL	NZ,FREESA	;Free string array
  2749  1087  f9                RESAR1:	LD	SP,HL
  2750  1088  dd23              	INC	IX		;Flag something restored
  2751  108a  1805              	JR	RESLO1
  2752                          ;
  2753                          ; RESLOC - Restore local variables/arrays or DATA/ERROR status from stack
  2754                          ;   Inputs: A = 0 if everything OK, bit0 set if DATPTR, bit1 set if ERRTRP
  2755                          ;  Outputs: Z if nothing was restored, NZ if something was restored
  2756                          ; Destroys: A,B,C,D,E,H,L,H',L',IX,SP,flags
  2757                          ;
  2758  108c  d1                RESLOC:	POP	DE		;Return address
  2759  108d  dd210000          	LD	IX,0		;To flag nothing was restored
  2760  1091  c1                RESLO1:	POP	BC		;Marker ?
  2761  1092  218511            	LD	HL,LOCCHK
  2762  1095  b7                	OR	A
  2763  1096  ed42              	SBC	HL,BC
  2764  1098  281a              	JR	Z,RESLO2	;Something to restore
  2765  109a  b7                	OR	A
  2766  109b  200f              	JR	NZ,RESLO8
  2767  109d  21ca06            	LD	HL,RETCHK
  2768  10a0  ed42              	SBC	HL,BC
  2769  10a2  28a0              	JR	Z,RESRET
  2770  10a4  213603            	LD	HL,ARRCHK
  2771  10a7  b7                	OR	A
  2772  10a8  ed42              	SBC	HL,BC
  2773  10aa  28d1              	JR	Z,RESARR
  2774  10ac  dde5              RESLO8:	PUSH	IX
  2775  10ae  e1                	POP	HL
  2776  10af  7c                	LD	A,H
  2777  10b0  b5                	OR	L
  2778  10b1  c5                RESLO0:	PUSH	BC		;Put back marker
  2779  10b2  eb                	EX	DE,HL
  2780  10b3  e9                	JP	(HL)		;Return
  2781                          ;
  2782  10b4  dde1              RESLO2:	POP	IX		;Variable pointer
  2783  10b6  b7                	OR	A
  2784  10b7  2820              	JR	Z,RESLO3	;Everything allowed
  2785  10b9  dde5              	PUSH	IX
  2786  10bb  c1                	POP	BC
  2787  10bc  cb47              	BIT	0,A
  2788  10be  2807              	JR	Z,RESLO6	;Bit 0 set, so
  2789  10c0  210000            	LD	HL,DATPTR	;test for DATPTR
  2790  10c3  ed42              	SBC	HL,BC
  2791  10c5  2812              	JR	Z,RESLO3
  2792  10c7  b7                RESLO6:	OR	A
  2793  10c8  cb4f              	BIT	1,A
  2794  10ca  2807              	JR	Z,RESLO7	;Bit 1 set, so
  2795  10cc  210000            	LD	HL,ERRTRP	;test for ERRPTR
  2796  10cf  ed42              	SBC	HL,BC
  2797  10d1  2806              	JR	Z,RESLO3
  2798  10d3  c5                RESLO7:	PUSH	BC		;Put back pointer
  2799  10d4  018511            	LD	BC,LOCCHK
  2800  10d7  18d8              	JR	RESLO0
  2801                          ;
  2802  10d9  c1                RESLO3:	POP	BC		;Type / exponent
  2803  10da  cb70              	BIT	6,B
  2804  10dc  2014              	JR	NZ,RESLO4	;Array?
  2805  10de  cb78              	BIT	7,B
  2806  10e0  2023              	JR	NZ,RESLO5	;String?
  2807  10e2  e1                	POP	HL
  2808  10e3  d9                	EXX
  2809  10e4  e1                	POP	HL
  2810  10e5  d9                	EXX
  2811  10e6  cb60              	BIT	4,B
  2812  10e8  20a7              	JR	NZ,RESLO1
  2813  10ea  f5                	PUSH	AF
  2814  10eb  78                	LD	A,B
  2815  10ec  cd470e            	CALL	STOREN		;Numeric
  2816  10ef  f1                	POP	AF
  2817  10f0  189f              	JR	RESLO1
  2818                          ;
  2819  10f2  e1                RESLO4:	POP	HL
  2820  10f3  cb60              	BIT	4,B
  2821  10f5  209a              	JR	NZ,RESLO1
  2822  10f7  dd7500            	LD	(IX+0),L	;Array
  2823  10fa  dd7401            	LD	(IX+1),H
  2824  10fd  1892              	JR	RESLO1
  2825                          ;
  2826  10ff  0600              RESLO9:	LD	B,0
  2827  1101  09                	ADD	HL,BC
  2828  1102  f9                	LD	SP,HL
  2829  1103  188c              RESLGO:	JR	RESLO1
  2830                          ;
  2831  1105  210000            RESLO5:	LD	HL,0
  2832  1108  39                	ADD	HL,SP
  2833  1109  cb60              	BIT	4,B
  2834  110b  20f2              	JR	NZ,RESLO9
  2835  110d  f5                	PUSH	AF
  2836  110e  d5                	PUSH	DE
  2837  110f  59                	LD	E,C
  2838  1110  78                	LD	A,B
  2839  1111  cd9c0e            	CALL	STORES		;String
  2840  1114  d1                	POP	DE
  2841  1115  f1                	POP	AF
  2842  1116  f9                	LD	SP,HL
  2843  1117  18ea              	JR	RESLGO
  2844                          ;
  2845                          ;SAVLOC: SUBROUTINE TO STACK LOCAL PARAMETERS
  2846                          ;  OF A FUNCTION OR PROCEDURE.
  2847                          ;THERE IS A LOT OF STACK MANIPULATION - CARE!!
  2848                          ;   Inputs: IY is parameters pointer
  2849                          ;  Outputs: IY updated
  2850                          ;           A' incremented for each RETURN
  2851                          ; Destroys: A',A,B,C,D,E,H,L,IX,IY,F,SP
  2852                          ;
  2853  1119  d1                SAVLOC:	POP	DE		;RETURN ADDRESS
  2854  111a  fd23              SAVLO1:	INC	IY		;BUMP PAST ( OR ,
  2855  111c  cd0000            	CALL	NXT
  2856  111f  fef8              	CP	TRETURN
  2857  1121  2008              	JR	NZ,SAVLO6
  2858  1123  08                	EX	AF,AF'
  2859  1124  3c                	INC	A		;RETURN counter
  2860  1125  08                	EX	AF,AF'
  2861  1126  fd23              	INC	IY		;Bump past RETURN
  2862  1128  cd0000            	CALL	NXT
  2863  112b  d5                SAVLO6:	PUSH	DE
  2864  112c  d9                	EXX
  2865  112d  c5                	PUSH	BC
  2866  112e  d5                	PUSH	DE
  2867  112f  e5                	PUSH	HL
  2868  1130  d9                	EXX
  2869  1131  cd3002            	CALL	VAR		;DUMMY VARIABLE
  2870  1134  d9                	EXX
  2871  1135  e1                	POP	HL
  2872  1136  d1                	POP	DE
  2873  1137  c1                	POP	BC
  2874  1138  d9                	EXX
  2875  1139  d1                	POP	DE
  2876  113a  cb77              	BIT	6,A		;ARRAY?
  2877  113c  2012              	JR	NZ,SAVLO3
  2878  113e  b7                	OR	A		;TYPE
  2879  113f  fa5a11            	JP	M,SAVLO2	;STRING
  2880  1142  d9                	EXX
  2881  1143  e5                	PUSH	HL		;SAVE H'L'
  2882  1144  d9                	EXX
  2883  1145  47                	LD	B,A		;TYPE
  2884  1146  cd0000            	CALL	LOADN
  2885  1149  d9                	EXX
  2886  114a  e3                	EX	(SP),HL
  2887  114b  d9                	EXX
  2888  114c  e5                	PUSH	HL
  2889  114d  c5                	PUSH	BC
  2890  114e  1830              	JR	SAVLO4
  2891                          ;
  2892  1150  dd4e00            SAVLO3:	LD	C,(IX+0)	;ARRAY POINTER
  2893  1153  dd4601            	LD	B,(IX+1)
  2894  1156  c5                	PUSH	BC		;SAVE TO STACK
  2895  1157  f5                	PUSH	AF		;SAVE TYPE
  2896  1158  1826              	JR	SAVLO4
  2897                          ;
  2898  115a  f5                SAVLO2:	PUSH	AF		;STRING TYPE
  2899  115b  d5                	PUSH	DE
  2900  115c  d9                	EXX
  2901  115d  e5                	PUSH	HL
  2902  115e  d9                	EXX
  2903  115f  cd0000            	CALL	LOADS
  2904  1162  d9                	EXX
  2905  1163  e1                	POP	HL
  2906  1164  d9                	EXX
  2907  1165  4b                	LD	C,E
  2908  1166  d1                	POP	DE
  2909  1167  cde10e            	CALL	CHECK
  2910  116a  f1                	POP	AF		;LEVEL STACK
  2911  116b  210000            	LD	HL,0
  2912  116e  45                	LD	B,L
  2913  116f  ed42              	SBC	HL,BC
  2914  1171  39                	ADD	HL,SP
  2915  1172  f9                	LD	SP,HL
  2916  1173  47                	LD	B,A		;TYPE
  2917  1174  c5                	PUSH	BC
  2918  1175  2809              	JR	Z,SAVLO4
  2919  1177  d5                	PUSH	DE
  2920  1178  110000            	LD	DE,ACCS
  2921  117b  eb                	EX	DE,HL
  2922  117c  45                	LD	B,L
  2923  117d  edb0              	LDIR			;SAVE STRING ON STACK
  2924  117f  d1                	POP	DE
  2925  1180  dde5              SAVLO4:	PUSH	IX		;VARPTR
  2926  1182  cd8511            	CALL	SAVLO5
  2927                          LOCCHK	EQU	$
  2928  1185  cde10e            SAVLO5:	CALL	CHECK
  2929  1188  cd0000            	CALL	NXT
  2930  118b  fe2c              	CP	','		;MORE?
  2931  118d  288b              	JR	Z,SAVLO1
  2932  118f  eb                	EX	DE,HL
  2933  1190  e9                	JP	(HL)		;"RETURN"
  2934                          ;
  2935  1191  cd0000            TERMQ:	CALL	NXT
  2936  1194  fe8b              	CP	TELSE
  2937  1196  d0                	RET	NC
  2938  1197  fe3a              	CP	':'		;ASSEMBLER SEPARATOR
  2939  1199  d0                	RET	NC
  2940  119a  fe0d              	CP	CR
  2941  119c  c9                	RET
  2942                          ;
  2943  119d  cd9111            SPAN:	CALL	TERMQ
  2944  11a0  c8                	RET	Z
  2945  11a1  fd23              	INC	IY
  2946  11a3  fe22              	CP	'"'
  2947  11a5  ccf412            	CALL	Z,QUOTE
  2948  11a8  18f3              	JR	SPAN
  2949                          ;
  2950  11aa  cd0000            EQUALS:	CALL	NXT
  2951  11ad  fd23              	INC	IY
  2952  11af  fe3d              	CP	'='
  2953  11b1  c8                	RET	Z
  2954  11b2  3e04              	LD	A,4
  2955  11b4  c30000            	JP	ERROR		;"Mistake"
  2956                          ;
  2957  11b7  fe8a              FORMAT:	CP	TTAB
  2958  11b9  280c              	JR	Z,DOTAB
  2959  11bb  fe89              	CP	TSPC
  2960  11bd  2838              	JR	Z,DOSPC
  2961  11bf  fe27              	CP	27H
  2962  11c1  c0                	RET	NZ
  2963  11c2  cd0000            	CALL	CRLF
  2964  11c5  af                	XOR	A
  2965  11c6  c9                	RET
  2966                          ;
  2967  11c7  c5                DOTAB:	PUSH	BC
  2968  11c8  cd0000            	CALL	EXPRI
  2969  11cb  d9                	EXX
  2970  11cc  c1                	POP	BC
  2971  11cd  fd7e00            	LD	A,(IY)
  2972  11d0  fe2c              	CP	','
  2973  11d2  2811              	JR	Z,DOTAB1
  2974  11d4  cd0000            	CALL	BRAKET
  2975  11d7  7d                	LD	A,L
  2976  11d8  210000            TABIT:	LD	HL,COUNT
  2977  11db  be                	CP	(HL)
  2978  11dc  c8                	RET	Z
  2979  11dd  f5                	PUSH	AF
  2980  11de  dc0000            	CALL	C,CRLF
  2981  11e1  f1                	POP	AF
  2982  11e2  96                	SUB	(HL)
  2983  11e3  1819              	JR	SPACES
  2984  11e5  fd23              DOTAB1:	INC	IY
  2985  11e7  c5                	PUSH	BC
  2986  11e8  e5                	PUSH	HL
  2987  11e9  cd0000            	CALL	EXPRI
  2988  11ec  d9                	EXX
  2989  11ed  d1                	POP	DE
  2990  11ee  c1                	POP	BC
  2991  11ef  cd0000            	CALL	BRAKET
  2992  11f2  cd0000            	CALL	PUTCSR
  2993  11f5  af                	XOR	A
  2994  11f6  c9                	RET
  2995                          ;
  2996  11f7  c5                DOSPC:	PUSH	BC
  2997  11f8  cd0000            	CALL	ITEMI
  2998  11fb  d9                	EXX
  2999  11fc  7d                	LD	A,L
  3000  11fd  c1                	POP	BC
  3001  11fe  b7                SPACES:	OR	A
  3002  11ff  c8                	RET	Z
  3003  1200  c5                	PUSH	BC
  3004  1201  47                	LD	B,A
  3005  1202  3e20              FILL1:	LD	A,' '
  3006  1204  cd0000            	CALL	OUTCHR
  3007  1207  10f9              	DJNZ	FILL1
  3008  1209  c1                	POP	BC
  3009  120a  af                	XOR	A
  3010  120b  c9                	RET
  3011                          ;
  3012  120c  210000            PTEXT:	LD	HL,ACCS
  3013  120f  1c                	INC	E
  3014  1210  1d                PTEXT1:	DEC	E
  3015  1211  c8                	RET	Z
  3016  1212  7e                	LD	A,(HL)
  3017  1213  23                	INC	HL
  3018  1214  cd0000            	CALL	OUTCHR
  3019  1217  18f7              	JR	PTEXT1
  3020                          ;
  3021  1219  f5                FETCHS:	PUSH	AF
  3022  121a  c5                	PUSH	BC
  3023  121b  e5                	PUSH	HL
  3024  121c  fde3              	EX	(SP),IY
  3025  121e  cd3612            	CALL	XTRACT
  3026  1221  cd0000            	CALL	NXT
  3027  1224  fde3              	EX	(SP),IY
  3028  1226  e1                	POP	HL
  3029  1227  c1                	POP	BC
  3030  1228  f1                	POP	AF
  3031  1229  c9                	RET
  3032                          ;
  3033  122a  110000            LINES:	LD	DE,ACCS
  3034  122d  7e                LINE1S:	LD	A,(HL)
  3035  122e  12                	LD	(DE),A
  3036  122f  fe0d              	CP	CR
  3037  1231  c8                	RET	Z
  3038  1232  23                	INC	HL
  3039  1233  1c                	INC	E
  3040  1234  18f7              	JR	LINE1S
  3041                          ;
  3042  1236  cd0000            XTRACT:	CALL	NXT
  3043  1239  fe22              	CP	'"'
  3044  123b  fd23              	INC	IY
  3045  123d  ca0000            	JP	Z,CONS
  3046  1240  fd2b              	DEC	IY
  3047  1242  110000            	LD	DE,ACCS
  3048  1245  fd7e00            XTRAC1:	LD	A,(IY)
  3049  1248  12                	LD	(DE),A
  3050  1249  fe2c              	CP	','
  3051  124b  c8                	RET	Z
  3052  124c  fe0d              	CP	CR
  3053  124e  c8                	RET	Z
  3054  124f  fd23              	INC	IY
  3055  1251  1c                	INC	E
  3056  1252  18f1              	JR	XTRAC1
  3057                          ;
  3058  1254  3edc              DSRCH:	LD	A,TDATA
  3059  1256  0600              SEARCH:	LD	B,0
  3060  1258  4e                SRCH1:	LD	C,(HL)
  3061  1259  0c                	INC	C
  3062  125a  0d                	DEC	C
  3063  125b  280c              	JR	Z,SRCH2		;FAIL
  3064  125d  23                	INC	HL
  3065  125e  23                	INC	HL
  3066  125f  23                	INC	HL
  3067  1260  be                	CP	(HL)
  3068  1261  c8                	RET	Z
  3069  1262  0d                	DEC	C
  3070  1263  0d                	DEC	C
  3071  1264  0d                	DEC	C
  3072  1265  09                	ADD	HL,BC
  3073  1266  c35812            	JP	SRCH1
  3074  1269  2b                SRCH2:	DEC	HL		;POINT TO CR
  3075  126a  37                	SCF
  3076  126b  c9                	RET
  3077                          ;
  3078                          ; NSCAN - scan for token at start of line, with nesting of inner structures
  3079                          ; Alternative entry at NSCAN1 with L = level (used by CASE)
  3080                          ;
  3081                          ;   Inputs: B = token to find (1, start of line)
  3082                          ;           C = token to find (2, start of line)
  3083                          ;           E = token to nest (end of line)
  3084                          ;           D = token to unnest (start of line)
  3085                          ;           IY = start search area (line length byte)
  3086                          ;  Outputs: NZ if not found
  3087                          ;           Z if found, IY points to byte after token
  3088                          ; Destroys: A,B,C,L,IY,F
  3089                          ;
  3090  126c  2e00              NSCAN:	LD	L,0		;nest level
  3091  126e  fd7e00            NSCAN1:	LD	A,(IY)		;get line length
  3092  1271  b7                	OR	A		;test zero = end of prog
  3093  1272  2834              	JR	Z,NSCAN6
  3094  1274  fd7e03            	LD	A,(IY+3)	;initial token
  3095  1277  b8                	CP	B		;test value reqd
  3096  1278  281d              	JR	Z,NSCAN3	;found (1)
  3097  127a  b9                	CP	C
  3098  127b  281a              	JR	Z,NSCAN3	;found (2)
  3099  127d  ba                NSCAN7:	CP	D		;unnest?
  3100  127e  2822              	JR	Z,NSCAN5
  3101  1280  c5                NSCAN2:	PUSH	BC
  3102  1281  0600              	LD	B,0
  3103  1283  fd4e00            	LD	C,(IY)
  3104  1286  fd09              	ADD	IY,BC		;go to next line
  3105  1288  fd7efe            	LD	A,(IY-2)
  3106  128b  bb                	CP	E		;nest?
  3107  128c  79                	LD	A,C
  3108  128d  c1                	POP	BC
  3109  128e  20de              	JR	NZ,NSCAN1	;continue
  3110  1290  fe05              	CP	5		;empty line ?
  3111  1292  38da              	JR	C,NSCAN1	;continue
  3112  1294  2c                	INC	L		;increment nest level
  3113  1295  18d7              	JR	NSCAN1		;continue
  3114                          ;
  3115  1297  2c                NSCAN3:	INC	L
  3116  1298  2d                	DEC	L
  3117  1299  20e2              	JR	NZ,NSCAN7
  3118  129b  010400            NSCAN4:	LD	BC,4
  3119  129e  fd09              	ADD	IY,BC
  3120  12a0  af                	XOR	A		;Z
  3121  12a1  c9                	RET
  3122                          ;
  3123  12a2  2d                NSCAN5:	DEC	L		;decrement nest level
  3124  12a3  f28012            	JP	P,NSCAN2
  3125  12a6  18f3              	JR	NSCAN4
  3126                          ;
  3127  12a8  f601              NSCAN6:	OR	1		;NZ
  3128  12aa  c9                	RET
  3129                          ;
  3130                          ; WSRCH - search for token, with nesting of inner structures
  3131                          ;
  3132                          ;   Inputs: B = token to find or unnest (anywhere)
  3133                          ;           C = token to nest (anywhere), ignore after EXIT
  3134                          ;           D = ordinal (1 = find first token, 2 = second)
  3135                          ;           IY = address to start looking
  3136                          ;  Outputs: IY points to byte after that found
  3137                          ;           if not found abort to END
  3138                          ; Destroys: A,D,IY,F
  3139                          ;
  3140  12ab  fd7e00            WSRCH:	LD	A,(IY)
  3141  12ae  fd23              	INC	IY
  3142  12b0  fe22              	CP	'"'
  3143  12b2  ccf412            	CALL	Z,QUOTE
  3144  12b5  fef4              	CP	TREM
  3145  12b7  2822              	JR	Z,WSRCHM
  3146  12b9  fe10              	CP	TEXIT
  3147  12bb  2830              	JR	Z,WSRCHE
  3148  12bd  b8                	CP	B
  3149  12be  2829              	JR	Z,WSRCHX
  3150  12c0  b9                	CP	C
  3151  12c1  2823              	JR	Z,WSRCHP
  3152  12c3  fe0d              	CP	CR
  3153  12c5  20e4              	JR	NZ,WSRCH
  3154  12c7  fd7e00            WSRCH1:	LD	A,(IY)			;Line length
  3155  12ca  fd23              	INC	IY
  3156  12cc  b7                	OR	A
  3157  12cd  ca2e01            	JP	Z,END
  3158  12d0  fd23              	INC	IY
  3159  12d2  fd23              	INC	IY			;Skip line number
  3160  12d4  fd7e00            	LD	A,(IY)
  3161  12d7  fedc              	CP	TDATA
  3162  12d9  20d0              	JR	NZ,WSRCH
  3163  12db  fd7e00            WSRCHM:	LD	A,(IY)
  3164  12de  fd23              	INC	IY
  3165  12e0  fe0d              	CP	CR
  3166  12e2  20f7              	JR	NZ,WSRCHM		;Skip to end of line
  3167  12e4  18e1              	JR	WSRCH1
  3168                          ;
  3169  12e6  14                WSRCHP:	INC	D
  3170  12e7  18c2              	JR	WSRCH
  3171                          ;
  3172  12e9  15                WSRCHX:	DEC	D
  3173  12ea  20bf              	JR	NZ,WSRCH
  3174  12ec  c9                	RET
  3175                          ;
  3176  12ed  cd0000            WSRCHE:	CALL	NXT
  3177  12f0  fd23              	INC	IY
  3178  12f2  18b7              	JR	WSRCH
  3179                          ;
  3180                          ; QUOTE - skip quoted string
  3181                          ;
  3182  12f4  fd7e00            QUOTE:	LD	A,(IY)
  3183  12f7  fd23              	INC	IY
  3184  12f9  fe0d              	CP	CR
  3185  12fb  ca0313            	JP	Z,MISQUO
  3186  12fe  fe22              	CP	'"'
  3187  1300  20f2              	JR	NZ,QUOTE
  3188  1302  c9                	RET
  3189                          ;
  3190  1303  3e09              MISQUO:	LD	A,9
  3191  1305  c30000            	JP	ERROR		;"Missing quote"
  3192                          ;
  3193                          ; X14OR5 - multiply by 1, 4 or 5
  3194                          ;   Inputs: DE = number to be multiplied
  3195                          ;           A = 1, 4 or 5 (else multiply by 4)
  3196                          ;  Outputs: DE = DE * A
  3197                          ;           Carry set if overflow
  3198                          ; Destroys: D,E,H,L,F
  3199                          ;
  3200  1308  62                X14OR5:	LD	H,D
  3201  1309  6b                	LD	L,E
  3202  130a  fe01              	CP	1
  3203  130c  c8                	RET	Z
  3204  130d  fe05              	CP	5
  3205  130f  29                	ADD	HL,HL
  3206  1310  d8                	RET	C
  3207  1311  29                	ADD	HL,HL
  3208  1312  d8                	RET	C
  3209  1313  eb                	EX	DE,HL
  3210  1314  c0                	RET	NZ
  3211  1315  19                	ADD	HL,DE
  3212  1316  eb                	EX	DE,HL
  3213  1317  c9                	RET
  3214                          ;
  3215                          ; MUL16 - 16-bit multiply
  3216                          ;   Inputs: HL = number to be multiplied
  3217                          ;           BC = multiplier
  3218                          ;  Outputs: HL = HL * BC
  3219                          ;           Carry set if overflow
  3220                          ; Destroys: A,D,E,H,L,F
  3221                          ;
  3222  1318  eb                MUL16:	EX	DE,HL
  3223  1319  210000            	LD	HL,0
  3224  131c  3e10              	LD	A,16
  3225  131e  29                MUL161:	ADD	HL,HL
  3226  131f  d8                	RET	C		;OVERFLOW
  3227  1320  cb23              	SLA	E
  3228  1322  cb12              	RL	D
  3229  1324  3002              	JR	NC,MUL162
  3230  1326  09                	ADD	HL,BC
  3231  1327  d8                	RET	C
  3232  1328  3d                MUL162:	DEC	A
  3233  1329  20f3              	JR	NZ,MUL161
  3234  132b  c9                	RET
  3235                          ;
  3236  132c  cd0000            CHANEL:	CALL	NXT
  3237  132f  fe23              	CP	'#'
  3238  1331  3e2d              	LD	A,45
  3239  1333  c20000            	JP	NZ,ERROR	;"Missing #"
  3240  1336  fd23              CHNL:	INC	IY		;SKIP '#'
  3241  1338  cd0000            	CALL	ITEMI
  3242  133b  d9                	EXX
  3243  133c  eb                	EX	DE,HL
  3244  133d  c9                	RET
  3245                          ;
  3246                          ; FREESA - Free members of a string array if adjacent to the top of heap
  3247                          ;   Inputs: BC = length of array (= 4 * number of elements)
  3248                          ;           HL addresses array first byte *above* array
  3249                          ;  Outputs: NZ if any array element freed, Z if none
  3250                          ; Destroys: nothing
  3251                          ;
  3252  133e  f5                FREESA:	PUSH	AF
  3253  133f  c5                FREES0:	PUSH	BC
  3254  1340  d5                	PUSH	DE
  3255  1341  e5                	PUSH	HL
  3256  1342  af                	XOR	A
  3257  1343  50                	LD	D,B
  3258  1344  59                	LD	E,C
  3259  1345  47                	LD	B,A
  3260  1346  d5                FREES1:	PUSH	DE
  3261  1347  2b                	DEC	HL
  3262  1348  56                	LD	D,(HL)
  3263  1349  2b                	DEC	HL
  3264  134a  5e                	LD	E,(HL)
  3265  134b  2b                	DEC	HL
  3266  134c  4e                	LD	C,(HL)
  3267  134d  2b                	DEC	HL
  3268  134e  e5                	PUSH	HL
  3269  134f  2a0000            	LD	HL,(FREE)
  3270  1352  eb                	EX	DE,HL
  3271  1353  09                	ADD	HL,BC
  3272  1354  ed52              	SBC	HL,DE
  3273  1356  2007              	JR	NZ,FREES2
  3274  1358  19                	ADD	HL,DE
  3275  1359  ed42              	SBC	HL,BC
  3276  135b  220000            	LD	(FREE),HL
  3277  135e  b4                	OR	H
  3278  135f  d1                FREES2:	POP	DE
  3279  1360  e1                	POP	HL
  3280  1361  0e04              	LD	C,4
  3281  1363  b7                	OR	A
  3282  1364  ed42              	SBC	HL,BC
  3283  1366  eb                	EX	DE,HL
  3284  1367  20dd              	JR	NZ,FREES1
  3285  1369  b7                	OR	A
  3286  136a  e1                	POP	HL
  3287  136b  d1                	POP	DE
  3288  136c  c1                	POP	BC
  3289  136d  b7                	OR	A
  3290  136e  20cf              	JR	NZ,FREES0
  3291  1370  f1                	POP	AF
  3292  1371  c9                	RET
  3293                          ;
  3294                          	; END
  3295                          
