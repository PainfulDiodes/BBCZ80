asm/AMOS.asm:
     1                          	; TITLE BBC BASIC (C) R.T.RUSSELL 1984-2024
     2                          	INCLUDE "constants.inc"
asm/constants.inc:
     1                          ; BBC BASIC Z80 - Shared Constants
     2                          ; Extracted from source modules to avoid duplicate definitions
     3                          
     4                          ; ASCII control characters
     5                          LF      EQU     0AH
     6                          CR      EQU     0DH
     7                          ; Note: ESC conflicts with label in AMOS.Z80, not included
     8                          BEL     EQU     7
     9                          BS      EQU     8
    10                          HT      EQU     9
    11                          VT      EQU     0BH
    12                          ; Note: DEL conflicts with label in MAIN.Z80, not included
    13                          
    14                          ; CP/M system addresses
    15                          ; Note: BDOS conflicts with label in DIST.Z80, not included
    16                          FCB     EQU     5CH
    17                          DSKBUF  EQU     80H
    18                          FCBSIZ  EQU     128+36+2
    19                          
    20                          ; Token values
    21                          TAND    EQU     80H
    22                          TOR     EQU     84H
    23                          TBY     EQU     0FH
    24                          TERROR  EQU     85H
    25                          TLINE   EQU     86H
    26                          TOFF    EQU     87H
    27                          TSTEP   EQU     88H
    28                          TSPC    EQU     89H
    29                          TTAB    EQU     8AH
    30                          TELSE   EQU     8BH
    31                          TTHEN   EQU     8CH
    32                          TLINO   EQU     8DH
    33                          TTO     EQU     0B8H
    34                          TCASE   EQU     0C8H
    35                          TWHILE  EQU     0C7H
    36                          TWHEN   EQU     0C9H
    37                          TOF     EQU     0CAH
    38                          TENDCASE EQU    0CBH
    39                          TOTHERWISE EQU  0CCH
    40                          TENDIF  EQU     0CDH
    41                          TENDWHILE EQU   0CEH
    42                          TCALL   EQU     0D6H
    43                          TDATA   EQU     0DCH
    44                          TDEF    EQU     0DDH
    45                          TDIM    EQU     0DEH
    46                          TEND    EQU     0E0H
    47                          TFOR    EQU     0E3H
    48                          TGOSUB  EQU     0E4H
    49                          TGOTO   EQU     0E5H
    50                          TIF     EQU     0E7H
    51                          TLOCAL  EQU     0EAH
    52                          TMODE   EQU     0EBH
    53                          TNEXT   EQU     0EDH
    54                          TON     EQU     0EEH
    55                          TPROC   EQU     0F2H
    56                          TREM    EQU     0F4H
    57                          TREPEAT EQU     0F5H
    58                          TREPORT EQU     0F6H
    59                          TRESTORE EQU    0F7H
    60                          TRETURN EQU     0F8H
    61                          TSTOP   EQU     0FAH
    62                          TTRACE  EQU     0FCH
    63                          TUNTIL  EQU     0FDH
    64                          TWIDTH  EQU     0FEH
    65                          TEXIT   EQU     10H
    66                          
    67                          ; Error codes
    68                          BADOP   EQU     1
    69                          DIVBY0  EQU     18
    70                          ; Note: TOOBIG conflicts with label in MAIN.Z80, not included
    71                          NGROOT  EQU     21
    72                          LOGRNG  EQU     22
    73                          ACLOST  EQU     23
    74                          EXPRNG  EQU     24
    75                          
asm/AMOS.asm:
     3                          ;
     4                          ;PATCH FOR BBC BASIC TO CP/M 2.2 & 3.0
     5                          ;* ACORN COMPUTERS Z80 TUBE VERSION  *
     6                          ;(C) COPYRIGHT R.T.RUSSELL, 08-05-1984
     7                          ;VERSION 5.0, 14-06-2024
     8                          ;
     9                          	PUBLIC OSINIT
    10                          	PUBLIC OSRDCH
    11                          	PUBLIC OSWRCH
    12                          	PUBLIC OSLINE
    13                          	PUBLIC OSSAVE
    14                          	PUBLIC OSLOAD
    15                          	PUBLIC OSOPEN
    16                          	PUBLIC OSSHUT
    17                          	PUBLIC OSBGET
    18                          	PUBLIC OSBPUT
    19                          	PUBLIC OSSTAT
    20                          	PUBLIC GETEXT
    21                          	PUBLIC GETPTR
    22                          	PUBLIC PUTPTR
    23                          	PUBLIC PROMPT
    24                          	PUBLIC RESET
    25                          	PUBLIC LTRAP
    26                          	PUBLIC OSCLI
    27                          	PUBLIC TRAP
    28                          	PUBLIC BYE
    29                          	PUBLIC SCRAP
    30                          ;
    31                          	EXTERN ESCAPE
    32                          	EXTERN EXTERR
    33                          	EXTERN CHECK
    34                          	EXTERN CRLF
    35                          ;
    36                          	EXTERN ACCS
    37                          	EXTERN FREE
    38                          	EXTERN CURLIN
    39                          	EXTERN USER
    40                          	EXTERN VERMSG
    41                          ;
    42                          ;OSSAVE - Save an area of memory to a file.
    43                          ;   Inputs: HL addresses filename (term CR)
    44                          ;           DE = start address of data to save
    45                          ;           BC = length of data to save (bytes)
    46                          ; Destroys: A,B,C,D,E,H,L,F
    47                          ;
    48  0000  cd5b04            STSAVE:	CALL	SAVLOD		;*SAVE
    49  0003  da2904            	JP	C,HUH		;"Bad command"
    50  0006  e5                	PUSH	HL
    51  0007  1804              	JR	OSS1
    52                          ;
    53  0009  c5                OSSAVE:	PUSH	BC		;SAVE
    54  000a  cdbd02            	CALL	SETUP0
    55  000d  eb                OSS1:	EX	DE,HL
    56  000e  cd5302            	CALL	CREATE
    57  0011  2014              	JR	NZ,SAVE
    58  0013  3ebe              	LD	A,190
    59  0015  cd0000            	CALL	EXTERR
    60  0018  4469726563746f72  	DEFM "Directory full"
              792066756c6c      
    61  0026  00                	DEFB	0
    62  0027  cd2502            SAVE:	CALL	WRITE
    63  002a  09                	ADD	HL,BC
    64  002b  e3                	EX	(SP),HL
    65  002c  ed42              	SBC	HL,BC
    66  002e  e3                	EX	(SP),HL
    67  002f  2802              	JR	Z,SAVE1
    68  0031  30f4              	JR	NC,SAVE
    69  0033  c1                SAVE1:	POP	BC
    70  0034  3e10              CLOSE:	LD	A,16
    71  0036  cdf901            	CALL	BDOS1
    72  0039  3c                	INC	A
    73  003a  c0                	RET	NZ
    74  003b  3ec8              	LD	A,200
    75  003d  cd0000            	CALL	EXTERR
    76  0040  436c6f7365206572  	DEFM "Close error"
              726f72            
    77  004b  00                	DEFB	0
    78                          ;
    79                          ;OSSHUT - Close disk file(s).
    80                          ;   Inputs: E = file channel
    81                          ;           If E=0 all files are closed
    82                          ; Destroys: A,B,C,D,E,H,L,F
    83                          ;
    84  004c  7b                OSSHUT:	LD	A,E
    85  004d  b7                	OR	A
    86  004e  200b              	JR	NZ,SHUTIT
    87  0050  1c                SHUT0:	INC	E
    88  0051  cb5b              	BIT	3,E
    89  0053  c0                	RET	NZ
    90  0054  d5                	PUSH	DE
    91  0055  cd6300            	CALL	SHUT1
    92  0058  d1                	POP	DE
    93  0059  18f5              	JR	SHUT0
    94                          ;
    95  005b  cdac02            SHUTIT:	CALL	FIND1
    96  005e  2007              	JR	NZ,SHUT2
    97  0060  c39702            	JP	CHANER
    98                          ;
    99  0063  cdac02            SHUT1:	CALL	FIND1
   100  0066  c8                	RET	Z
   101  0067  af                SHUT2:	XOR	A
   102  0068  77                	LD	(HL),A
   103  0069  2b                	DEC	HL
   104  006a  77                	LD	(HL),A
   105  006b  212500            	LD	HL,37
   106  006e  19                	ADD	HL,DE
   107  006f  cb7e              	BIT	7,(HL)
   108  0071  23                	INC	HL
   109  0072  c42502            	CALL	NZ,WRITE
   110  0075  21a600            	LD	HL,FCBSIZ
   111  0078  19                	ADD	HL,DE
   112  0079  ed4b0000          	LD	BC,(FREE)
   113  007d  ed42              	SBC	HL,BC
   114  007f  20b3              	JR	NZ,CLOSE
   115  0081  ed530000          	LD	(FREE),DE	;RELEASE SPACE
   116  0085  18ad              	JR	CLOSE
   117                          ;
   118                          ;TYPE - *TYPE command.
   119                          ;Types file to console output.
   120                          ;
   121  0087  37                TYPE:	SCF			;*TYPE
   122  0088  cdd700            	CALL	OSOPEN
   123  008b  b7                	OR	A
   124  008c  281e              	JR	Z,NOTFND
   125  008e  5f                	LD	E,A
   126  008f  cd5805            TYPE1:	CALL	TRAP		;IMPORTANT (ACORN)
   127  0092  cd4b01            	CALL	OSBGET
   128  0095  cdd005            	CALL	OSWRCH
   129  0098  30f5              	JR	NC,TYPE1
   130  009a  18b0              	JR	OSSHUT
   131                          ;
   132                          ;OSLOAD - Load an area of memory from a file.
   133                          ;   Inputs: HL addresses filename (term CR)
   134                          ;           DE = address at which to load
   135                          ;           BC = maximum allowed size (bytes)
   136                          ;  Outputs: Carry reset indicates no room for file.
   137                          ; Destroys: A,B,C,D,E,H,L,F
   138                          ;
   139  009c  cd5b04            STLOAD:	CALL	SAVLOD		;*LOAD
   140  009f  e5                	PUSH	HL
   141  00a0  1804              	JR	OSL1
   142                          ;
   143  00a2  c5                OSLOAD:	PUSH	BC		;LOAD
   144  00a3  cdbd02            	CALL	SETUP0
   145  00a6  eb                OSL1:	EX	DE,HL
   146  00a7  cd4902            	CALL	OPEN
   147  00aa  201d              	JR	NZ,LOAD0
   148  00ac  3ed6              NOTFND:	LD	A,214
   149  00ae  cd0000            	CALL	EXTERR
   150  00b1  46696c65206e6f74  	DEFM "File not found"
              20666f756e64      
   151  00bf  00                	DEFB	0
   152  00c0  cdf401            LOAD:	CALL	READ
   153  00c3  200a              	JR	NZ,LOAD1
   154  00c5  cd3e02            	CALL	INCSEC
   155  00c8  09                	ADD	HL,BC
   156  00c9  e3                LOAD0:	EX	(SP),HL
   157  00ca  ed42              	SBC	HL,BC
   158  00cc  e3                	EX	(SP),HL
   159  00cd  30f1              	JR	NC,LOAD
   160  00cf  c1                LOAD1:	POP	BC
   161  00d0  f5                	PUSH	AF
   162  00d1  cd3400            	CALL	CLOSE
   163  00d4  f1                	POP	AF
   164  00d5  3f                	CCF
   165  00d6  c9                RESET:	RET
   166                          ;
   167                          ;OSOPEN - Open a file for reading or writing.
   168                          ;   Inputs: HL addresses filename (term CR)
   169                          ;           Carry set for OPENIN, cleared for OPENOUT.
   170                          ;  Outputs: A = file channel (=0 if cannot open)
   171                          ; Destroys: A,B,C,D,E,H,L,F
   172                          ;
   173  00d7  f5                OSOPEN:	PUSH	AF		;SAVE CARRY
   174  00d8  cdbd02            	CALL	SETUP0
   175  00db  f1                	POP	AF
   176  00dc  d45302            	CALL	NC,CREATE
   177  00df  dc4902            	CALL	C,OPEN
   178  00e2  c8                	RET	Z		;ERROR
   179  00e3  0607              	LD	B,7		;MAX. NUMBER OF FILES
   180  00e5  211306            	LD	HL,TABLE+13
   181  00e8  7e                OPEN1:	LD	A,(HL)
   182  00e9  2b                	DEC	HL
   183  00ea  b6                	OR	(HL)
   184  00eb  281c              	JR	Z,OPEN2
   185  00ed  2b                	DEC	HL
   186  00ee  10f8              	DJNZ	OPEN1
   187  00f0  3ec0              	LD	A,192
   188  00f2  cd0000            	CALL	EXTERR
   189  00f5  546f6f206d616e79  	DEFM "Too many open files"
              206f70656e206669  
              6c6573            
   190  0108  00                	DEFB	0
   191                          ;
   192  0109  ed5b0000          OPEN2:	LD	DE,(FREE)	;FREE SPACE POINTER
   193  010d  73                	LD	(HL),E
   194  010e  23                	INC	HL
   195  010f  72                	LD	(HL),D
   196  0110  78                	LD	A,B		;CHANNEL (1-7)
   197  0111  21a600            	LD	HL,FCBSIZ
   198  0114  19                	ADD	HL,DE		;RESERVE SPACE
   199  0115  220000            	LD	(FREE),HL
   200  0118  215c00            	LD	HL,FCB
   201  011b  d5                	PUSH	DE
   202  011c  012400            	LD	BC,36
   203  011f  edb0              	LDIR			;COPY FCB
   204  0121  eb                	EX	DE,HL
   205  0122  23                	INC	HL
   206  0123  71                	LD	(HL),C		;CLEAR PTR
   207  0124  23                	INC	HL
   208  0125  d1                	POP	DE
   209  0126  47                	LD	B,A
   210  0127  cdd401            	CALL	RDF		;READ OR FILL
   211  012a  78                	LD	A,B
   212  012b  c30000            	JP	CHECK
   213                          ;
   214                          ;OSBPUT - Write a byte to a random disk file.
   215                          ;   Inputs: E = file channel
   216                          ;           A = byte to write
   217                          ; Destroys: A,B,C,F
   218                          ;
   219  012e  d5                OSBPUT:	PUSH	DE
   220  012f  e5                	PUSH	HL
   221  0130  47                	LD	B,A
   222  0131  cd8b02            	CALL	FIND
   223  0134  78                	LD	A,B
   224  0135  0600              	LD	B,0
   225  0137  2b                	DEC	HL
   226  0138  70                	LD	(HL),B		;CLEAR EOF
   227  0139  23                	INC	HL
   228  013a  4e                	LD	C,(HL)
   229  013b  cbb9              	RES	7,C
   230  013d  cbfe              	SET	7,(HL)
   231  013f  34                	INC	(HL)
   232  0140  23                	INC	HL
   233  0141  e5                	PUSH	HL
   234  0142  09                	ADD	HL,BC
   235  0143  77                	LD	(HL),A
   236  0144  e1                	POP	HL
   237  0145  ccd101            	CALL	Z,WRRDF		;WRITE THEN READ/FILL
   238  0148  e1                	POP	HL
   239  0149  d1                	POP	DE
   240  014a  c9                	RET
   241                          ;
   242                          ;OSBGET - Read a byte from a random disk file.
   243                          ;   Inputs: E = file channel
   244                          ;  Outputs: A = byte read
   245                          ;           Carry set if LAST BYTE of file
   246                          ; Destroys: A,B,C,F
   247                          ;
   248  014b  d5                OSBGET:	PUSH	DE
   249  014c  e5                	PUSH	HL
   250  014d  cd8b02            	CALL	FIND
   251  0150  4e                	LD	C,(HL)
   252  0151  cbb9              	RES	7,C
   253  0153  34                	INC	(HL)
   254  0154  23                	INC	HL
   255  0155  e5                	PUSH	HL
   256  0156  0600              	LD	B,0
   257  0158  09                	ADD	HL,BC
   258  0159  46                	LD	B,(HL)
   259  015a  e1                	POP	HL
   260  015b  ecec01            	CALL	PE,INCRDF	;INC SECTOR THEN READ
   261  015e  ccd101            	CALL	Z,WRRDF		;WRITE THEN READ/FILL
   262  0161  78                	LD	A,B
   263  0162  e1                	POP	HL
   264  0163  d1                	POP	DE
   265  0164  c9                	RET
   266                          ;
   267                          ;OSSTAT - Read file status.
   268                          ;   Inputs: E = file channel
   269                          ;  Outputs: Z flag set - EOF
   270                          ;           (If Z then A=0)
   271                          ;           DE = address of file block.
   272                          ; Destroys: A,D,E,H,L,F
   273                          ;
   274  0165  cd8b02            OSSTAT:	CALL	FIND
   275  0168  2b                	DEC	HL
   276  0169  7e                	LD	A,(HL)
   277  016a  3c                	INC	A
   278  016b  c9                	RET
   279                          ;
   280                          ;GETEXT - Find file size.
   281                          ;   Inputs: E = file channel
   282                          ;  Outputs: DEHL = file size (0-&800000)
   283                          ; Destroys: A,B,C,D,E,H,L,F
   284                          ;
   285  016c  cd8b02            GETEXT:	CALL	FIND
   286  016f  eb                	EX	DE,HL
   287  0170  115c00            	LD	DE,FCB
   288  0173  012400            	LD	BC,36
   289  0176  d5                	PUSH	DE
   290  0177  edb0              	LDIR			;COPY FCB
   291  0179  eb                	EX	DE,HL
   292  017a  e3                	EX	(SP),HL
   293  017b  eb                	EX	DE,HL
   294  017c  3e23              	LD	A,35
   295  017e  cdf901            	CALL	BDOS1		;COMPUTE SIZE
   296  0181  e1                	POP	HL
   297  0182  af                	XOR	A
   298  0183  1806              	JR	GETPT1
   299                          ;
   300                          ;GETPTR - Return file pointer.
   301                          ;   Inputs: E = file channel
   302                          ;  Outputs: DEHL = pointer (0-&7FFFFF)
   303                          ; Destroys: A,B,C,D,E,H,L,F
   304                          ;
   305  0185  cd8b02            GETPTR:	CALL	FIND
   306  0188  7e                	LD	A,(HL)
   307  0189  87                	ADD	A,A
   308  018a  2b                	DEC	HL
   309  018b  2b                GETPT1:	DEC	HL
   310  018c  56                	LD	D,(HL)
   311  018d  2b                	DEC	HL
   312  018e  5e                	LD	E,(HL)
   313  018f  2b                	DEC	HL
   314  0190  66                	LD	H,(HL)
   315  0191  6f                	LD	L,A
   316  0192  cb3a              	SRL	D
   317  0194  cb1b              	RR	E
   318  0196  cb1c              	RR	H
   319  0198  cb1d              	RR	L
   320  019a  c9                	RET
   321                          ;
   322                          ;PUTPTR - Update file pointer.
   323                          ;   Inputs: A = file channel
   324                          ;           DEHL = new pointer (0-&7FFFFF)
   325                          ; Destroys: A,B,C,D,E,H,L,F
   326                          ;
   327  019b  55                PUTPTR:	LD	D,L
   328  019c  29                	ADD	HL,HL
   329  019d  cb13              	RL	E
   330  019f  43                	LD	B,E
   331  01a0  4c                	LD	C,H
   332  01a1  5f                	LD	E,A		;CHANNEL
   333  01a2  d5                	PUSH	DE
   334  01a3  cd8b02            	CALL	FIND
   335  01a6  f1                	POP	AF
   336  01a7  e67f              	AND	7FH
   337  01a9  cb7e              	BIT	7,(HL)		;PENDING WRITE?
   338  01ab  2802              	JR	Z,PUTPT1
   339  01ad  f680              	OR	80H
   340  01af  77                PUTPT1:	LD	(HL),A
   341  01b0  d5                	PUSH	DE
   342  01b1  e5                	PUSH	HL
   343  01b2  2b                	DEC	HL
   344  01b3  2b                	DEC	HL
   345  01b4  2b                	DEC	HL
   346  01b5  56                	LD	D,(HL)
   347  01b6  2b                	DEC	HL
   348  01b7  5e                	LD	E,(HL)
   349  01b8  eb                	EX	DE,HL
   350  01b9  b7                	OR	A
   351  01ba  ed42              	SBC	HL,BC
   352  01bc  e1                	POP	HL
   353  01bd  d1                	POP	DE
   354  01be  c8                	RET	Z
   355  01bf  23                	INC	HL
   356  01c0  b7                	OR	A
   357  01c1  fc2502            	CALL	M,WRITE
   358  01c4  e5                	PUSH	HL
   359  01c5  2b                	DEC	HL
   360  01c6  2b                	DEC	HL
   361  01c7  2b                	DEC	HL
   362  01c8  3600              	LD	(HL),0
   363  01ca  2b                	DEC	HL
   364  01cb  70                	LD	(HL),B
   365  01cc  2b                	DEC	HL
   366  01cd  71                	LD	(HL),C		;NEW RECORD NO.
   367  01ce  e1                	POP	HL
   368  01cf  1803              	JR	RDF
   369                          ;
   370                          ;WRRDF - Write, read; if EOF fill with zeroes.
   371                          ;RDF - Read; if EOF fill with zeroes.
   372                          ;   Inputs: DE address FCB.
   373                          ;           HL addresses data buffer.
   374                          ;  Outputs: A=0, Z-flag set.
   375                          ;           Carry set if fill done (EOF)
   376                          ; Destroys: A,H,L,F
   377                          ;
   378  01d1  cd2502            WRRDF:	CALL	WRITE
   379  01d4  cdf401            RDF:	CALL	READ
   380  01d7  2b                	DEC	HL
   381  01d8  cbbe              	RES	7,(HL)
   382  01da  2b                	DEC	HL
   383  01db  77                	LD	(HL),A		;CLEAR EOF FLAG
   384  01dc  c8                	RET	Z
   385  01dd  36ff              	LD	(HL),-1		;SET EOF FLAG
   386  01df  23                	INC	HL
   387  01e0  23                	INC	HL
   388  01e1  c5                	PUSH	BC
   389  01e2  af                	XOR	A
   390  01e3  0680              	LD	B,128
   391  01e5  77                FILL:	LD	(HL),A
   392  01e6  23                	INC	HL
   393  01e7  10fc              	DJNZ	FILL
   394  01e9  c1                	POP	BC
   395  01ea  37                	SCF
   396  01eb  c9                	RET
   397                          ;
   398                          ;INCRDF - Increment record, read; if EOF fill.
   399                          ;   Inputs: DE addresses FCB.
   400                          ;           HL addresses data buffer.
   401                          ;  Outputs: A=1, Z-flag reset.
   402                          ;           Carry set if fill done (EOF)
   403                          ; Destroys: A,H,L,F
   404                          ;
   405  01ec  cd3e02            INCRDF:	CALL	INCSEC
   406  01ef  cdd401            	CALL	RDF
   407  01f2  3c                	INC	A
   408  01f3  c9                	RET
   409                          ;
   410                          ;READ - Read a record from a disk file.
   411                          ;   Inputs: DE addresses FCB.
   412                          ;           HL = address to store data.
   413                          ;  Outputs: A<>0 & Z-flag reset indicates EOF.
   414                          ;           Carry = 0
   415                          ; Destroys: A,F
   416                          ;
   417                          ;BDOS1 - CP/M BDOS call.
   418                          ;   Inputs: A = function number
   419                          ;          DE = parameter
   420                          ;  Outputs: AF = result (carry=0)
   421                          ; Destroys: A,F
   422                          ;
   423  01f4  cd8302            READ:	CALL	SETDMA
   424  01f7  3e21              	LD	A,33
   425  01f9  cd1002            BDOS1:	CALL	BDOS0
   426  01fc  2002              	JR	NZ,CPMERR
   427  01fe  b7                	OR	A
   428  01ff  c9                	RET
   429  0200  3eff              CPMERR:	LD	A,255
   430  0202  cd0000            	CALL	EXTERR
   431  0205  43502f4d20457272  	DEFM "CP/M Error"
              6f72              
   432  020f  00                	DEFB	0
   433                          ;
   434  0210  c5                BDOS0:	PUSH	BC
   435  0211  d5                	PUSH	DE
   436  0212  e5                	PUSH	HL
   437  0213  dde5              	PUSH	IX
   438  0215  fde5              	PUSH	IY
   439  0217  4f                	LD	C,A
   440  0218  cd0500            	CALL	BDOS
   441  021b  24                	INC	H
   442  021c  25                	DEC	H
   443  021d  fde1              	POP	IY
   444  021f  dde1              	POP	IX
   445  0221  e1                	POP	HL
   446  0222  d1                	POP	DE
   447  0223  c1                	POP	BC
   448  0224  c9                	RET
   449                          ;
   450                          ;WRITE - Write a record to a disk file.
   451                          ;   Inputs: DE addresses FCB.
   452                          ;           HL = address to get data.
   453                          ; Destroys: A,F
   454                          ;
   455  0225  cd8302            WRITE:	CALL	SETDMA
   456  0228  3e28              	LD	A,40
   457  022a  cdf901            	CALL	BDOS1
   458  022d  280f              	JR	Z,INCSEC
   459  022f  3ec6              	LD	A,198
   460  0231  cd0000            	CALL	EXTERR
   461  0234  4469736b2066756c  	DEFM "Disk full"
              6c                
   462  023d  00                	DEFB	0
   463                          ;
   464                          ;INCSEC - Increment random record number.
   465                          ;   Inputs: DE addresses FCB.
   466                          ; Destroys: F
   467                          ;
   468  023e  e5                INCSEC:	PUSH	HL
   469  023f  212100            	LD	HL,33
   470  0242  19                	ADD	HL,DE
   471  0243  34                INCS1:	INC	(HL)
   472  0244  23                	INC	HL
   473  0245  28fc              	JR	Z,INCS1
   474  0247  e1                	POP	HL
   475  0248  c9                	RET
   476                          ;
   477                          ;OPEN - Open a file for access.
   478                          ;   Inputs: FCB set up.
   479                          ;  Outputs: DE = FCB
   480                          ;           A=0 & Z-flag set indicates Not Found.
   481                          ;           Carry = 0
   482                          ; Destroys: A,D,E,F
   483                          ;
   484  0249  115c00            OPEN:	LD	DE,FCB
   485  024c  3e0f              	LD	A,15
   486  024e  cdf901            	CALL	BDOS1
   487  0251  3c                	INC	A
   488  0252  c9                	RET
   489                          ;
   490                          ;CREATE - Create a disk file for writing.
   491                          ;   Inputs: FCB set up.
   492                          ;  Outputs: DE = FCB
   493                          ;           A=0 & Z-flag set indicates directory full.
   494                          ;           Carry = 0
   495                          ; Destroys: A,D,E,F
   496                          ;
   497  0253  cd6502            CREATE:	CALL	CHKAMB
   498  0256  115c00            	LD	DE,FCB
   499  0259  3e13              	LD	A,19
   500  025b  cdf901            	CALL	BDOS1		;DELETE
   501  025e  3e16              	LD	A,22
   502  0260  cdf901            	CALL	BDOS1		;MAKE
   503  0263  3c                	INC	A
   504  0264  c9                	RET
   505                          ;
   506                          ;CHKAMB - Check for ambiguous filename.
   507                          ; Destroys: A,D,E,F
   508                          ;
   509  0265  c5                CHKAMB:	PUSH	BC
   510  0266  115c00            	LD	DE,FCB
   511  0269  060c              	LD	B,12
   512  026b  1a                CHKAM1:	LD	A,(DE)
   513  026c  fe3f              	CP	'?'
   514  026e  2805              	JR	Z,AMBIG		;AMBIGUOUS
   515  0270  13                	INC	DE
   516  0271  10f8              	DJNZ	CHKAM1
   517  0273  c1                	POP	BC
   518  0274  c9                	RET
   519  0275  3ecc              AMBIG:	LD	A,204
   520  0277  cd0000            	CALL	EXTERR
   521  027a  426164206e616d65  	DEFM "Bad name"
   522  0282  00                	DEFB	0
   523                          ;
   524                          ;SETDMA - Set "DMA" address.
   525                          ;   Inputs: HL = address
   526                          ; Destroys: A,F
   527                          ;
   528  0283  3e1a              SETDMA:	LD	A,26
   529  0285  eb                	EX	DE,HL
   530  0286  cd1002            	CALL	BDOS0
   531  0289  eb                	EX	DE,HL
   532  028a  c9                	RET
   533                          ;
   534                          ;FIND - Find file parameters from channel.
   535                          ;   Inputs: E = channel
   536                          ;  Outputs: DE addresses FCB
   537                          ;           HL addresses pointer byte (FCB+37)
   538                          ; Destroys: A,D,E,H,L,F
   539                          ;
   540  028b  1c                FIND:	INC	E
   541  028c  1d                	DEC	E
   542  028d  2808              	JR	Z,CHANER
   543  028f  cdac02            	CALL	FIND1
   544  0292  212500            	LD	HL,37
   545  0295  19                	ADD	HL,DE
   546  0296  c0                	RET	NZ
   547  0297  3ede              CHANER:	LD	A,222
   548  0299  cd0000            	CALL	EXTERR
   549  029c  496e76616c696420  	DEFM "Invalid channel"
              6368616e6e656c    
   550  02ab  00                	DEFB	0
   551                          ;
   552                          ;FIND1 - Look up file table.
   553                          ;   Inputs: E = channel
   554                          ;  Outputs: Z-flag set = file not opened
   555                          ;           If NZ, DE addresses FCB
   556                          ;                  HL points into table
   557                          ; Destroys: A,D,E,H,L,F
   558                          ;
   559  02ac  7b                FIND1:	LD	A,E
   560  02ad  e607              	AND	7
   561  02af  87                	ADD	A,A
   562  02b0  5f                	LD	E,A
   563  02b1  1600              	LD	D,0
   564  02b3  210406            	LD	HL,TABLE-2
   565  02b6  19                	ADD	HL,DE
   566  02b7  5e                	LD	E,(HL)
   567  02b8  23                	INC	HL
   568  02b9  56                	LD	D,(HL)
   569  02ba  7a                	LD	A,D
   570  02bb  b3                	OR	E
   571  02bc  c9                	RET
   572                          ;
   573                          ;SETUP - Set up File Control Block.
   574                          ;   Inputs: HL addresses filename
   575                          ;           Format  [A:]FILENAME[.EXT]
   576                          ;           Device defaults to current drive
   577                          ;           Extension defaults to .BBC
   578                          ;           A = fill character
   579                          ;  Outputs: HL updated
   580                          ;           A = terminator
   581                          ;           BC = 128
   582                          ; Destroys: A,B,C,H,L,F
   583                          ;
   584                          ;FCB FORMAT (36 BYTES TOTAL):
   585                          ; 0      0=SAME DISK, 1=DISK A, 2=DISK B (ETC.)
   586                          ; 1-8    FILENAME, PADDED WITH SPACES
   587                          ; 9-11   EXTENSION, PADDED WITH SPACES
   588                          ; 12     CURRENT EXTENT, SET TO ZERO
   589                          ; 32-35  CLEARED TO ZERO
   590                          ;
   591  02bd  3e20              SETUP0:	LD	A,' '
   592  02bf  d5                SETUP:	PUSH	DE
   593  02c0  e5                	PUSH	HL
   594  02c1  116500            	LD	DE,FCB+9
   595  02c4  216803            	LD	HL,BBC
   596  02c7  010300            	LD	BC,3
   597  02ca  edb0              	LDIR
   598  02cc  217c00            	LD	HL,FCB+32
   599  02cf  0604              	LD	B,4
   600  02d1  71                SETUP1:	LD	(HL),C
   601  02d2  23                	INC	HL
   602  02d3  10fc              	DJNZ	SETUP1
   603  02d5  e1                	POP	HL
   604  02d6  4f                	LD	C,A
   605  02d7  af                	XOR	A
   606  02d8  12                	LD	(DE),A
   607  02d9  d1                	POP	DE
   608  02da  cd6103            	CALL	SKIPSP
   609  02dd  fe22              	CP	'"'
   610  02df  2027              	JR	NZ,SETUP2
   611  02e1  23                	INC	HL
   612  02e2  cd6103            	CALL	SKIPSP
   613  02e5  cd0803            	CALL	SETUP2
   614  02e8  fe22              	CP	'"'
   615  02ea  23                	INC	HL
   616  02eb  2874              	JR	Z,SKIPSP
   617  02ed  3efd              BADSTR:	LD	A,253
   618  02ef  cd0000            	CALL	EXTERR
   619  02f2  4261642073747269  	DEFM "Bad string"
              6e67              
   620  02fc  00                	DEFB	0
   621                          ;
   622  02fd  7e                PARSE:	LD	A,(HL)
   623  02fe  23                	INC	HL
   624  02ff  fe60              	CP	'`'
   625  0301  d0                	RET	NC
   626  0302  fe3f              	CP	'?'
   627  0304  d8                	RET	C
   628  0305  ee40              	XOR	40H
   629  0307  c9                	RET
   630                          ;
   631  0308  d5                SETUP2:	PUSH	DE
   632  0309  23                	INC	HL
   633  030a  7e                	LD	A,(HL)
   634  030b  fe3a              	CP	':'
   635  030d  2b                	DEC	HL
   636  030e  78                	LD	A,B
   637  030f  2005              	JR	NZ,DEVICE
   638  0311  7e                	LD	A,(HL)		;DRIVE
   639  0312  e61f              	AND	31
   640  0314  23                	INC	HL
   641  0315  23                	INC	HL
   642  0316  115c00            DEVICE:	LD	DE,FCB
   643  0319  12                	LD	(DE),A
   644  031a  13                	INC	DE
   645  031b  0608              	LD	B,8
   646  031d  7e                COPYF:	LD	A,(HL)
   647  031e  fe2e              	CP	'.'
   648  0320  2822              	JR	Z,COPYF1
   649  0322  fe20              	CP	' '
   650  0324  281e              	JR	Z,COPYF1
   651  0326  fe0d              	CP	CR
   652  0328  281a              	JR	Z,COPYF1
   653  032a  fe3d              	CP	'='
   654  032c  2816              	JR	Z,COPYF1
   655  032e  fe22              	CP	'"'
   656  0330  2812              	JR	Z,COPYF1
   657  0332  0e3f              	LD	C,'?'
   658  0334  fe2a              	CP	'*'
   659  0336  280c              	JR	Z,COPYF1
   660  0338  0e20              	LD	C,' '
   661  033a  23                	INC	HL
   662  033b  fe7c              	CP	'|'
   663  033d  2006              	JR	NZ,COPYF2
   664  033f  cdfd02            	CALL	PARSE
   665  0342  1804              	JR	COPYF0
   666  0344  79                COPYF1:	LD	A,C
   667  0345  cde804            COPYF2:	CALL	UPPRC
   668  0348  12                COPYF0:	LD	(DE),A
   669  0349  13                	INC	DE
   670  034a  10d1              	DJNZ	COPYF
   671  034c  7e                COPYF3:	LD	A,(HL)
   672  034d  23                	INC	HL
   673  034e  fe2a              	CP	'*'
   674  0350  28fa              	JR	Z,COPYF3
   675  0352  fe2e              	CP	'.'
   676  0354  012003            	LD	BC,3*256+' '
   677  0357  116500            	LD	DE,FCB+9
   678  035a  28c1              	JR	Z,COPYF
   679  035c  2b                	DEC	HL
   680  035d  d1                	POP	DE
   681  035e  018000            	LD	BC,128
   682  0361  7e                SKIPSP:	LD	A,(HL)
   683  0362  fe20              	CP	' '
   684  0364  c0                	RET	NZ
   685  0365  23                	INC	HL
   686  0366  18f9              	JR	SKIPSP
   687                          ;
   688  0368  424243            BBC:	DEFM "BBC"
   689                          ;
   690                          ;HEX - Read a hex string and convert to binary.
   691                          ;   Inputs: HL = text pointer
   692                          ;  Outputs: HL = updated text pointer
   693                          ;           DE = value
   694                          ;            A = terminator (spaces skipped)
   695                          ; Destroys: A,D,E,H,L,F
   696                          ;
   697  036b  110000            HEX:	LD	DE,0		;INITIALISE
   698  036e  cd6103            	CALL	SKIPSP
   699  0371  7e                HEX1:	LD	A,(HL)
   700  0372  cde804            	CALL	UPPRC
   701  0375  fe30              	CP	'0'
   702  0377  38e8              	JR	C,SKIPSP
   703  0379  fe3a              	CP	'9'+1
   704  037b  380a              	JR	C,HEX2
   705  037d  fe41              	CP	'A'
   706  037f  38e0              	JR	C,SKIPSP
   707  0381  fe47              	CP	'F'+1
   708  0383  30dc              	JR	NC,SKIPSP
   709  0385  d607              	SUB	7
   710  0387  e60f              HEX2:	AND	0FH
   711  0389  eb                	EX	DE,HL
   712  038a  29                	ADD	HL,HL
   713  038b  29                	ADD	HL,HL
   714  038c  29                	ADD	HL,HL
   715  038d  29                	ADD	HL,HL
   716  038e  eb                	EX	DE,HL
   717  038f  b3                	OR	E
   718  0390  5f                	LD	E,A
   719  0391  23                	INC	HL
   720  0392  18dd              	JR	HEX1
   721                          ;
   722                          ;OSCLI - Process an "operating system" command
   723                          ;
   724  0394  cd6103            OSCLI:	CALL	SKIPSP
   725  0397  fe0d              	CP	CR
   726  0399  c8                	RET	Z
   727  039a  fe7c              	CP	'|'
   728  039c  c8                	RET	Z
   729  039d  fe2e              	CP	'.'
   730  039f  ca7904            	JP	Z,DOT		;*.
   731  03a2  eb                	EX	DE,HL
   732  03a3  21f804            	LD	HL,COMDS
   733  03a6  1a                OSCLI0:	LD	A,(DE)
   734  03a7  cde804            	CALL	UPPRC
   735  03aa  be                	CP	(HL)
   736  03ab  280b              	JR	Z,OSCLI2
   737  03ad  382e              	JR	C,UNK
   738  03af  cb7e              OSCLI1:	BIT	7,(HL)
   739  03b1  23                	INC	HL
   740  03b2  28fb              	JR	Z,OSCLI1
   741  03b4  23                	INC	HL
   742  03b5  23                	INC	HL
   743  03b6  18ee              	JR	OSCLI0
   744                          ;
   745  03b8  d5                OSCLI2:	PUSH	DE
   746  03b9  13                OSCLI3:	INC	DE
   747  03ba  23                	INC	HL
   748  03bb  1a                	LD	A,(DE)
   749  03bc  cde804            	CALL	UPPRC
   750  03bf  fe2e              	CP	'.'		;ABBREVIATED?
   751  03c1  280a              	JR	Z,OSCLI4
   752  03c3  ae                	XOR	(HL)
   753  03c4  28f3              	JR	Z,OSCLI3
   754  03c6  fe80              	CP	80H
   755  03c8  2803              	JR	Z,OSCLI4
   756  03ca  d1                	POP	DE
   757  03cb  18e2              	JR	OSCLI1
   758                          ;
   759  03cd  f1                OSCLI4:	POP	AF
   760  03ce  13                	INC	DE
   761  03cf  cb7e              OSCLI5:	BIT	7,(HL)
   762  03d1  23                	INC	HL
   763  03d2  28fb              	JR	Z,OSCLI5
   764  03d4  7e                	LD	A,(HL)
   765  03d5  23                	INC	HL
   766  03d6  66                	LD	H,(HL)
   767  03d7  6f                	LD	L,A
   768  03d8  e5                	PUSH	HL
   769  03d9  eb                	EX	DE,HL
   770  03da  c36103            	JP	SKIPSP
   771                          ;
   772  03dd  eb                UNK:	EX	DE,HL
   773  03de  c3f7ff            	JP	ASCLI
   774                          ;
   775                          ;
   776  03e1  c7                BYE:	RST	0		;*BYE, *QUIT
   777                          ;
   778  03e2  cdbd02            ERA:	CALL	SETUP0		;*ERA, *ERASE
   779  03e5  0e13              	LD	C,19
   780  03e7  1833              	JR	XEQ		;"DELETE"
   781                          ;
   782  03e9  0e0d              RES:	LD	C,13		;*RESET
   783  03eb  182f              	JR	XEQ		;"RESET"
   784                          ;
   785  03ed  cdbd02            DRV:	CALL	SETUP0		;*DRIVE
   786  03f0  3a5c00            	LD	A,(FCB)
   787  03f3  3d                	DEC	A
   788  03f4  fa2904            	JP	M,HUH
   789  03f7  5f                	LD	E,A
   790  03f8  0e0e              	LD	C,14
   791  03fa  1823              	JR	XEQ0
   792                          ;
   793  03fc  cdbd02            REN:	CALL	SETUP0		;*REN, *RENAME
   794  03ff  fe3d              	CP	'='
   795  0401  2026              	JR	NZ,HUH
   796  0403  23                	INC	HL
   797  0404  e5                	PUSH	HL
   798  0405  cd3a04            	CALL	EXISTS
   799  0408  215c00            	LD	HL,FCB
   800  040b  116c00            	LD	DE,FCB+16
   801  040e  010c00            	LD	BC,12
   802  0411  edb0              	LDIR
   803  0413  e1                	POP	HL
   804  0414  cdbd02            	CALL	SETUP0
   805  0417  cd6502            	CALL	CHKAMB
   806  041a  0e17              	LD	C,23
   807  041c  115c00            XEQ:	LD	DE,FCB
   808  041f  7e                XEQ0:	LD	A,(HL)
   809  0420  fe0d              	CP	CR
   810  0422  2005              	JR	NZ,HUH
   811  0424  79                BDC:	LD	A,C
   812  0425  cdf901            	CALL	BDOS1
   813  0428  f0                	RET	P
   814  0429  3efe              HUH:	LD	A,254
   815  042b  cd0000            	CALL	EXTERR
   816  042e  42616420636f6d6d  	DEFM "Bad command"
              616e64            
   817  0439  00                	DEFB	0
   818                          ;
   819  043a  218000            EXISTS:	LD	HL,DSKBUF
   820  043d  cd8302            	CALL	SETDMA
   821  0440  115c00            	LD	DE,FCB
   822  0443  3e11              	LD	A,17
   823  0445  cdf901            	CALL	BDOS1		;SEARCH
   824  0448  3c                	INC	A
   825  0449  c8                	RET	Z
   826  044a  3ec4              	LD	A,196
   827  044c  cd0000            	CALL	EXTERR
   828  044f  46696c6520657869  	DEFM "File exists"
              737473            
   829  045a  00                	DEFB	0
   830                          ;
   831  045b  cdbd02            SAVLOD:	CALL	SETUP0		;PART OF *SAVE, *LOAD
   832  045e  cd6b03            	CALL	HEX
   833  0461  fe2b              	CP	'+'
   834  0463  f5                	PUSH	AF
   835  0464  d5                	PUSH	DE
   836  0465  2001              	JR	NZ,SAVLO1
   837  0467  23                	INC	HL
   838  0468  cd6b03            SAVLO1:	CALL	HEX
   839  046b  fe0d              	CP	CR
   840  046d  20ba              	JR	NZ,HUH
   841  046f  eb                	EX	DE,HL
   842  0470  d1                	POP	DE
   843  0471  f1                	POP	AF
   844  0472  c8                	RET	Z
   845  0473  b7                	OR	A
   846  0474  ed52              	SBC	HL,DE
   847  0476  c0                	RET	NZ
   848  0477  18b0              	JR	HUH
   849                          ;
   850  0479  23                DOT:	INC	HL
   851  047a  3e3f              DIR:	LD	A,'?'		;*DIR
   852  047c  cdbf02            	CALL	SETUP
   853  047f  fe0d              	CP	CR
   854  0481  20a6              	JR	NZ,HUH
   855  0483  0e11              	LD	C,17
   856  0485  0604              DIR0:	LD	B,4
   857  0487  cd5805            DIR1:	CALL	LTRAP
   858  048a  115c00            	LD	DE,FCB
   859  048d  218000            	LD	HL,DSKBUF
   860  0490  cd8302            	CALL	SETDMA
   861  0493  79                	LD	A,C
   862  0494  cdf901            	CALL	BDOS1		;SEARCH DIRECTORY
   863  0497  fa0000            	JP	M,CRLF
   864  049a  0f                	RRCA
   865  049b  0f                	RRCA
   866  049c  0f                	RRCA
   867  049d  e660              	AND	60H
   868  049f  5f                	LD	E,A
   869  04a0  1600              	LD	D,0
   870  04a2  218100            	LD	HL,DSKBUF+1
   871  04a5  19                	ADD	HL,DE
   872  04a6  e5                	PUSH	HL
   873  04a7  110800            	LD	DE,8
   874  04aa  19                	ADD	HL,DE
   875  04ab  5e                	LD	E,(HL)
   876  04ac  23                	INC	HL
   877  04ad  cb7e              	BIT	7,(HL)		;SYSTEM FILE?
   878  04af  e1                	POP	HL
   879  04b0  0e12              	LD	C,18
   880  04b2  20d3              	JR	NZ,DIR1
   881  04b4  c5                	PUSH	BC
   882  04b5  78                	LD	A,B
   883  04b6  fe04              	CP	4
   884  04b8  3e20              	LD	A,' '
   885  04ba  ccdc04            	CALL	Z,DRIVE
   886  04bd  cdd005            	CALL	OSWRCH
   887  04c0  0608              	LD	B,8
   888  04c2  3e20              	LD	A,' '
   889  04c4  cb7b              	BIT	7,E		;READ ONLY?
   890  04c6  2802              	JR	Z,DIR3
   891  04c8  3e2a              	LD	A,'*'
   892  04ca  cd6505            DIR3:	CALL	CPTEXT
   893  04cd  0603              	LD	B,3
   894  04cf  3e20              	LD	A,' '
   895  04d1  cd6c05            	CALL	SPTEXT
   896  04d4  c1                	POP	BC
   897  04d5  10b0              	DJNZ	DIR1
   898  04d7  cd0000            	CALL	CRLF
   899  04da  18a9              	JR	DIR0
   900                          ;
   901  04dc  3a5c00            DRIVE:	LD	A,(FCB)
   902  04df  3d                	DEC	A
   903  04e0  0e19              	LD	C,25
   904  04e2  fc2404            	CALL	M,BDC
   905  04e5  c641              	ADD	A,'A'
   906  04e7  c9                	RET
   907                          ;
   908  04e8  e67f              UPPRC:	AND	7FH
   909  04ea  fe60              	CP	'`'
   910  04ec  d8                	RET	C
   911  04ed  e65f              	AND	5FH		;CONVERT TO UPPER CASE
   912  04ef  c9                	RET
   913                          ;
   914  04f0  0620              HELP:	LD	B,32		;*HELP
   915  04f2  210000            	LD	HL,VERMSG
   916  04f5  c36f05            	JP	PTEXT
   917                          ;
   918                          ;
   919  04f8  4259              COMDS:	DEFM "BY"
   920  04fa  c5                	DEFB	'E'+80H
   921  04fb  e103              	DEFW	BYE
   922  04fd  4350              	DEFM "CP"
   923  04ff  cd                	DEFB	'M'+80H
   924  0500  e103              	DEFW	BYE
   925  0502  4449              	DEFM "DI"
   926  0504  d2                	DEFB	'R'+80H
   927  0505  7a04              	DEFW	DIR
   928  0507  44524956          	DEFM "DRIV"
   929  050b  c5                	DEFB	'E'+80H
   930  050c  ed03              	DEFW	DRV
   931  050e  45524153          	DEFM "ERAS"
   932  0512  c5                	DEFB	'E'+80H
   933  0513  e203              	DEFW	ERA
   934  0515  4552              	DEFM "ER"
   935  0517  c1                	DEFB	'A'+80H
   936  0518  e203              	DEFW	ERA
   937  051a  48454c            	DEFM "HEL"
   938  051d  d0                	DEFB	'P'+80H
   939  051e  f004              	DEFW	HELP
   940  0520  4c4f41            	DEFM "LOA"
   941  0523  c4                	DEFB	'D'+80H
   942  0524  9c00              	DEFW	STLOAD
   943  0526  515549            	DEFM "QUI"
   944  0529  d4                	DEFB	'T'+80H
   945  052a  e103              	DEFW	BYE
   946  052c  52454e414d        	DEFM "RENAM"
   947  0531  c5                	DEFB	'E'+80H
   948  0532  fc03              	DEFW	REN
   949  0534  5245              	DEFM "RE"
   950  0536  ce                	DEFB	'N'+80H
   951  0537  fc03              	DEFW	REN
   952  0539  52455345          	DEFM "RESE"
   953  053d  d4                	DEFB	'T'+80H
   954  053e  e903              	DEFW	RES
   955  0540  534156            	DEFM "SAV"
   956  0543  c5                	DEFB	'E'+80H
   957  0544  0000              	DEFW	STSAVE
   958  0546  545950            	DEFM "TYP"
   959  0549  c5                	DEFB	'E'+80H
   960  054a  8700              	DEFW	TYPE
   961  054c  ff                	DEFB	0FFH
   962                          ;
   963                          ;PROCESS 6502's BRK INSTRUCTION
   964                          ;
   965  054d  2a82ff            BRK:	LD	HL,(BRKPTR)
   966  0550  e5                	PUSH	HL
   967  0551  e1                BRKTRP:	POP	HL
   968  0552  7e                	LD	A,(HL)
   969  0553  23                	INC	HL
   970  0554  e5                	PUSH	HL
   971  0555  c30000            	JP	EXTERR
   972                          ;
   973                          ;TRAP - Test for "ESC" and abort if so.
   974                          ;  Destroys: A,H,L,F
   975                          ;
   976                          TRAP:
   977  0558  3a80ff            LTRAP:	LD	A,(BRKFLG)
   978  055b  b7                	OR	A
   979  055c  f0                	RET	P
   980  055d  3e7e              ESC:	LD	A,126
   981  055f  cdf4ff            	CALL	ASBYTE
   982  0562  c30000            	JP	ESCAPE
   983                          ;
   984                          ;PTEXT - Print text
   985                          ;   Inputs: HL = address of text
   986                          ;            B = number of characters to print
   987                          ; Destroys: A,B,H,L,F
   988                          ;
   989  0565  f5                CPTEXT:	PUSH	AF
   990  0566  3e3a              	LD	A,':'
   991  0568  cdd005            	CALL	OSWRCH
   992  056b  f1                	POP	AF
   993  056c  cdd005            SPTEXT:	CALL	OSWRCH
   994  056f  7e                PTEXT:	LD	A,(HL)
   995  0570  e67f              	AND	7FH
   996  0572  23                	INC	HL
   997  0573  cdd005            	CALL	OSWRCH
   998  0576  10f7              	DJNZ	PTEXT
   999  0578  c9                	RET
  1000                          ;
  1001                          ;OSINIT - Initialise RAM mapping etc.
  1002                          ;If BASIC is entered by BBCBASIC FILENAME then file
  1003                          ;FILENAME.BBC is automatically CHAINed.
  1004                          ;   Outputs: DE = initial value of HIMEM (top of RAM)
  1005                          ;            HL = initial value of PAGE (user program)
  1006                          ;            Z-flag reset indicates AUTO-RUN.
  1007                          ;  Destroys: A,B,C,D,E,H,L,F
  1008                          ;
  1009  0579  3ec3              OSINIT:	LD	A,0C3H
  1010  057b  323800            	LD	(38H),A
  1011  057e  215105            	LD	HL,BRKTRP
  1012  0581  223900            	LD	(39H),HL
  1013  0584  214d05            	LD	HL,BRK
  1014  0587  22faff            	LD	(BRKVEC),HL
  1015  058a  3ee5              	LD	A,229
  1016  058c  210000            	LD	HL,0
  1017  058f  cdf4ff            	CALL	ASBYTE		;ESC interrupts program
  1018  0592  3ee6              	LD	A,230
  1019  0594  210000            	LD	HL,0
  1020  0597  cdf4ff            	CALL	ASBYTE		;ESC flushes buffers
  1021  059a  0e2d              	LD	C,45
  1022  059c  1efe              	LD	E,254
  1023  059e  cd0500            	CALL	BDOS		;TRAP ERRORS (CP/M 3)
  1024  05a1  af                	XOR	A
  1025  05a2  060e              	LD	B,INILEN
  1026  05a4  210606            	LD	HL,TABLE
  1027  05a7  77                CLRTAB:	LD	(HL),A		;CLEAR FILE TABLE
  1028  05a8  23                	INC	HL
  1029  05a9  10fc              	DJNZ	CLRTAB
  1030  05ab  110000            	LD	DE,ACCS
  1031  05ae  218000            	LD	HL,DSKBUF
  1032  05b1  4e                	LD	C,(HL)
  1033  05b2  23                	INC	HL
  1034  05b3  b9                	CP	C
  1035  05b4  2802              	JR	Z,NOBOOT
  1036  05b6  edb0              	LDIR			;COPY TO ACCS
  1037  05b8  eb                NOBOOT:	EX	DE,HL
  1038  05b9  360d              	LD	(HL),CR
  1039  05bb  ed5b0600          	LD	DE,(6)		;DE = HIMEM
  1040  05bf  5f                	LD	E,A		;PAGE BOUNDARY
  1041  05c0  210000            	LD	HL,USER
  1042  05c3  c9                	RET
  1043                          ;
  1044                          ;OSRDCH - Read a character from console input.
  1045                          ;  Outputs: A = character.
  1046                          ; Destroys: A,F
  1047                          ;
  1048  05c4  c5                OSRDCH:	PUSH	BC
  1049  05c5  d5                	PUSH	DE
  1050  05c6  e5                	PUSH	HL
  1051  05c7  cde0ff            	CALL	ASRDCH
  1052  05ca  e1                	POP	HL
  1053  05cb  d1                	POP	DE
  1054  05cc  c1                	POP	BC
  1055  05cd  c9                	RET
  1056                          ;
  1057                          ;OSWRCH - Write a character to console output.
  1058                          ;   Inputs: A = character.
  1059                          ; Destroys: Nothing
  1060                          ;
  1061  05ce  3e3e              PROMPT:	LD	A,'>'
  1062  05d0  f5                OSWRCH:	PUSH	AF
  1063  05d1  c5                	PUSH	BC
  1064  05d2  d5                	PUSH	DE
  1065  05d3  e5                	PUSH	HL
  1066  05d4  cdeeff            	CALL	ASWRCH
  1067  05d7  e1                	POP	HL
  1068  05d8  d1                	POP	DE
  1069  05d9  c1                	POP	BC
  1070  05da  f1                	POP	AF
  1071  05db  c9                	RET
  1072                          ;
  1073                          ;OSLINE - Read a complete line, terminated by
  1074                          ;carriage-return.
  1075                          ;   Inputs: HL addresses destination buffer.
  1076                          ;           (L=0)
  1077                          ;  Outputs: Buffer filled, terminated by CR.
  1078                          ;           A=0.
  1079                          ;  Destroys: A,B,C,D,E,H,L,IX,F
  1080                          ;
  1081  05dc  dd211406          OSLINE:	LD	IX,SCRAP
  1082  05e0  dd7500            	LD	(IX+0),L
  1083  05e3  dd7401            	LD	(IX+1),H
  1084  05e6  dd3602ff          	LD	(IX+2),255	;MAX. LINE LENGTH
  1085  05ea  dd360320          	LD	(IX+3),' '	;MIN. ASCII VALUE
  1086  05ee  dd3604ff          	LD	(IX+4),255	;MAX. ASCII VALUE
  1087  05f2  3eda              	LD	A,218
  1088  05f4  210000            	LD	HL,0
  1089  05f7  cdf4ff            	CALL	ASBYTE		;FLUSH VDU QUEUE
  1090  05fa  af                	XOR	A
  1091  05fb  211406            	LD	HL,SCRAP
  1092  05fe  cdf1ff            	CALL	ASWORD
  1093  0601  da5d05            	JP	C,ESC
  1094  0604  af                	XOR	A
  1095  0605  c9                	RET
  1096                          ;
  1097                          ; CR EQU	0DH
  1098                          ; FCBSIZ EQU	128+36+2
  1099                          ;
  1100                          BDOS	EQU	5
  1101                          ;
  1102                          BRKFLG	EQU	0FF80H
  1103                          BRKPTR	EQU	0FF82H
  1104                          ASRDCH	EQU	0FFE0H
  1105                          ASWRCH	EQU	0FFEEH
  1106                          ASWORD	EQU	0FFF1H
  1107                          ASBYTE	EQU	0FFF4H
  1108                          ASCLI	EQU	0FFF7H
  1109                          BRKVEC	EQU	0FFFAH
  1110                          ;
  1111                          ; FCB EQU	5CH
  1112                          ; DSKBUF EQU	80H
  1113                          ;
  1114  0606  0000000000000000  TABLE:	DEFS	14		;FILE BLOCK POINTERS
              000000000000      
  1115                          INILEN	EQU	$-TABLE
  1116  0614  0000000000000000  SCRAP:	DEFS	31
              0000000000000000  
              0000000000000000  
              00000000000000    
  1117  0633  00                	DEFB	0
  1118                          ;
  1119                          FIN: ; END
  1120                          
  1121                          
