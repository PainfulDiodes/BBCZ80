asm/CMOS.asm:
     1                          	; TITLE BBC BASIC (C) R.T.RUSSELL 1984-2024
     2                          	INCLUDE "constants.inc"
asm/constants.inc:
     1                          ; BBC BASIC Z80 - Shared Constants
     2                          ; Extracted from source modules to avoid duplicate definitions
     3                          
     4                          ; ASCII control characters
     5                          LF      EQU     0AH
     6                          CR      EQU     0DH
     7                          ; Note: ESC conflicts with label in AMOS.Z80, not included
     8                          BEL     EQU     7
     9                          BS      EQU     8
    10                          HT      EQU     9
    11                          VT      EQU     0BH
    12                          ; Note: DEL conflicts with label in MAIN.Z80, not included
    13                          
    14                          ; CP/M system addresses
    15                          ; Note: BDOS conflicts with label in DIST.Z80, not included
    16                          FCB     EQU     5CH
    17                          DSKBUF  EQU     80H
    18                          FCBSIZ  EQU     128+36+2
    19                          
    20                          ; Token values
    21                          TAND    EQU     80H
    22                          TOR     EQU     84H
    23                          TBY     EQU     0FH
    24                          TERROR  EQU     85H
    25                          TLINE   EQU     86H
    26                          TOFF    EQU     87H
    27                          TSTEP   EQU     88H
    28                          TSPC    EQU     89H
    29                          TTAB    EQU     8AH
    30                          TELSE   EQU     8BH
    31                          TTHEN   EQU     8CH
    32                          TLINO   EQU     8DH
    33                          TTO     EQU     0B8H
    34                          TCASE   EQU     0C8H
    35                          TWHILE  EQU     0C7H
    36                          TWHEN   EQU     0C9H
    37                          TOF     EQU     0CAH
    38                          TENDCASE EQU    0CBH
    39                          TOTHERWISE EQU  0CCH
    40                          TENDIF  EQU     0CDH
    41                          TENDWHILE EQU   0CEH
    42                          TCALL   EQU     0D6H
    43                          TDATA   EQU     0DCH
    44                          TDEF    EQU     0DDH
    45                          TDIM    EQU     0DEH
    46                          TEND    EQU     0E0H
    47                          TFOR    EQU     0E3H
    48                          TGOSUB  EQU     0E4H
    49                          TGOTO   EQU     0E5H
    50                          TIF     EQU     0E7H
    51                          TLOCAL  EQU     0EAH
    52                          TMODE   EQU     0EBH
    53                          TNEXT   EQU     0EDH
    54                          TON     EQU     0EEH
    55                          TPROC   EQU     0F2H
    56                          TREM    EQU     0F4H
    57                          TREPEAT EQU     0F5H
    58                          TREPORT EQU     0F6H
    59                          TRESTORE EQU    0F7H
    60                          TRETURN EQU     0F8H
    61                          TSTOP   EQU     0FAH
    62                          TTRACE  EQU     0FCH
    63                          TUNTIL  EQU     0FDH
    64                          TWIDTH  EQU     0FEH
    65                          TEXIT   EQU     10H
    66                          
    67                          ; Error codes
    68                          BADOP   EQU     1
    69                          DIVBY0  EQU     18
    70                          ; Note: TOOBIG conflicts with label in MAIN.Z80, not included
    71                          NGROOT  EQU     21
    72                          LOGRNG  EQU     22
    73                          ACLOST  EQU     23
    74                          EXPRNG  EQU     24
    75                          
asm/CMOS.asm:
     3                          ;
     4                          ;PATCH FOR BBC BASIC TO CP/M 2.2 & 3.0
     5                          ;*    PLAIN VANILLA CP/M VERSION     *
     6                          ;(C) COPYRIGHT R.T.RUSSELL, 25-12-1986
     7                          ;VERSION 5.0, 25-05-2024
     8                          ;
     9                          	PUBLIC OSINIT
    10                          	PUBLIC OSRDCH
    11                          	PUBLIC OSWRCH
    12                          	PUBLIC OSLINE
    13                          	PUBLIC OSSAVE
    14                          	PUBLIC OSLOAD
    15                          	PUBLIC OSOPEN
    16                          	PUBLIC OSSHUT
    17                          	PUBLIC OSBGET
    18                          	PUBLIC OSBPUT
    19                          	PUBLIC OSSTAT
    20                          	PUBLIC GETEXT
    21                          	PUBLIC GETPTR
    22                          	PUBLIC PUTPTR
    23                          	PUBLIC PROMPT
    24                          	PUBLIC RESET
    25                          	PUBLIC LTRAP
    26                          	PUBLIC OSCLI
    27                          	PUBLIC TRAP
    28                          	PUBLIC OSKEY
    29                          	PUBLIC OSCALL
    30                          ;
    31                          	EXTERN BYE
    32                          	EXTERN GETKEY
    33                          ;
    34                          	EXTERN ESCAPE
    35                          	EXTERN EXTERR
    36                          	EXTERN CHECK
    37                          	EXTERN CRLF
    38                          ;
    39                          	EXTERN ACCS
    40                          	EXTERN FREE
    41                          	EXTERN HIMEM
    42                          	EXTERN CURLIN
    43                          	EXTERN AUTONO
    44                          	EXTERN USER
    45                          	EXTERN VERMSG
    46                          ;
    47                          ;
    48                          ;OSSAVE - Save an area of memory to a file.
    49                          ;   Inputs: HL addresses filename (term CR)
    50                          ;           DE = start address of data to save
    51                          ;           BC = length of data to save (bytes)
    52                          ; Destroys: A,B,C,D,E,H,L,F
    53                          ;
    54  0000  cd6d04            STSAVE:	CALL	SAVLOD		;*SAVE
    55  0003  da3b04            	JP	C,HUH		;"Bad command"
    56  0006  e5                	PUSH	HL
    57  0007  1804              	JR	OSS1
    58                          ;
    59  0009  c5                OSSAVE:	PUSH	BC		;SAVE
    60  000a  cdd402            	CALL	SETUP0
    61  000d  eb                OSS1:	EX	DE,HL
    62  000e  cd6a02            	CALL	CREATE
    63  0011  2014              	JR	NZ,SAVE
    64  0013  3ebe              DIRFUL:	LD	A,190
    65  0015  cd0000            	CALL	EXTERR
    66  0018  4469726563746f72  	DEFM "Directory full"
              792066756c6c      
    67  0026  00                	DEFB	0
    68  0027  cd3c02            SAVE:	CALL	WRITE
    69  002a  09                	ADD	HL,BC
    70  002b  e3                	EX	(SP),HL
    71  002c  ed42              	SBC	HL,BC
    72  002e  e3                	EX	(SP),HL
    73  002f  2802              	JR	Z,SAVE1
    74  0031  30f4              	JR	NC,SAVE
    75  0033  c1                SAVE1:	POP	BC
    76  0034  3e10              CLOSE:	LD	A,16
    77  0036  cd1002            	CALL	BDOS1
    78  0039  3c                	INC	A
    79  003a  c0                	RET	NZ
    80  003b  3ec8              	LD	A,200
    81  003d  cd0000            	CALL	EXTERR
    82  0040  436c6f7365206572  	DEFM "Close error"
              726f72            
    83  004b  00                	DEFB	0
    84                          ;
    85                          ;OSSHUT - Close disk file(s).
    86                          ;   Inputs: E = file channel
    87                          ;           If E=0 all files are closed (except SPOOL)
    88                          ; Destroys: A,B,C,D,E,H,L,F
    89                          ;
    90  004c  7b                OSSHUT:	LD	A,E
    91  004d  b7                	OR	A
    92  004e  200b              	JR	NZ,SHUTIT
    93  0050  1c                SHUT0:	INC	E
    94  0051  cb5b              	BIT	3,E
    95  0053  c0                	RET	NZ
    96  0054  d5                	PUSH	DE
    97  0055  cd6c00            	CALL	SHUT1
    98  0058  d1                	POP	DE
    99  0059  18f5              	JR	SHUT0
   100                          ;
   101  005b  cdc302            SHUTIT:	CALL	FIND1
   102  005e  2010              	JR	NZ,SHUT2
   103  0060  c3ae02            	JP	CHANER
   104                          ;
   105  0063  216b08            SESHUT:	LD	HL,FLAGS
   106  0066  cb86              	RES	0,(HL)		;STOP EXEC
   107  0068  cb8e              	RES	1,(HL)		;STOP SPOOL
   108  006a  1e08              	LD	E,8		;SPOOL/EXEC CHANNEL
   109  006c  cdc302            SHUT1:	CALL	FIND1
   110  006f  c8                	RET	Z
   111  0070  af                SHUT2:	XOR	A
   112  0071  77                	LD	(HL),A
   113  0072  2b                	DEC	HL
   114  0073  77                	LD	(HL),A
   115  0074  212500            	LD	HL,37
   116  0077  19                	ADD	HL,DE
   117  0078  cb7e              	BIT	7,(HL)
   118  007a  23                	INC	HL
   119  007b  c43c02            	CALL	NZ,WRITE
   120  007e  21a600            	LD	HL,FCBSIZ
   121  0081  19                	ADD	HL,DE
   122  0082  ed4b0000          	LD	BC,(FREE)
   123  0086  ed42              	SBC	HL,BC
   124  0088  20aa              	JR	NZ,CLOSE
   125  008a  ed530000          	LD	(FREE),DE	;RELEASE SPACE
   126  008e  18a4              	JR	CLOSE
   127                          ;
   128                          ;TYPE - *TYPE command.
   129                          ;Types file to console output.
   130                          ;
   131  0090  37                TYPE:	SCF			;*TYPE
   132  0091  cdf600            	CALL	OSOPEN
   133  0094  b7                	OR	A
   134  0095  2828              	JR	Z,NOTFND
   135  0097  5f                	LD	E,A
   136  0098  3a6b08            TYPE1:	LD	A,(FLAGS)	;TEST
   137  009b  cb7f              	BIT	7,A		;FOR
   138  009d  200a              	JR	NZ,TYPESC	;ESCape
   139  009f  cd6201            	CALL	OSBGET
   140  00a2  cd9b06            	CALL	OSWRCH		;N.B. CALLS "TEST"
   141  00a5  30f1              	JR	NC,TYPE1
   142  00a7  18a3              	JR	OSSHUT
   143                          ;
   144  00a9  cd4c00            TYPESC:	CALL	OSSHUT		;CLOSE!
   145  00ac  c31b06            	JP	ABORT
   146                          ;
   147                          ;OSLOAD - Load an area of memory from a file.
   148                          ;   Inputs: HL addresses filename (term CR)
   149                          ;           DE = address at which to load
   150                          ;           BC = maximum allowed size (bytes)
   151                          ;  Outputs: Carry reset indicates no room for file.
   152                          ; Destroys: A,B,C,D,E,H,L,F
   153                          ;
   154  00af  cd6d04            STLOAD:	CALL	SAVLOD		;*LOAD
   155  00b2  e5                	PUSH	HL
   156  00b3  1804              	JR	OSL1
   157                          ;
   158  00b5  c5                OSLOAD:	PUSH	BC		;LOAD
   159  00b6  cdd402            	CALL	SETUP0
   160  00b9  eb                OSL1:	EX	DE,HL
   161  00ba  cd6002            	CALL	OPEN
   162  00bd  201d              	JR	NZ,LOAD0
   163  00bf  3ed6              NOTFND:	LD	A,214
   164  00c1  cd0000            	CALL	EXTERR
   165  00c4  46696c65206e6f74  	DEFM "File not found"
              20666f756e64      
   166  00d2  00                	DEFB	0
   167  00d3  cd0b02            LOAD:	CALL	READ
   168  00d6  200a              	JR	NZ,LOAD1
   169  00d8  cd5502            	CALL	INCSEC
   170  00db  09                	ADD	HL,BC
   171  00dc  e3                LOAD0:	EX	(SP),HL
   172  00dd  ed42              	SBC	HL,BC
   173  00df  e3                	EX	(SP),HL
   174  00e0  30f1              	JR	NC,LOAD
   175  00e2  c1                LOAD1:	POP	BC
   176  00e3  f5                	PUSH	AF
   177  00e4  cd3400            	CALL	CLOSE
   178  00e7  f1                	POP	AF
   179  00e8  3f                	CCF
   180  00e9  c9                OSCALL:	RET
   181                          ;
   182                          ;OSOPEN - Open a file for reading or writing.
   183                          ;   Inputs: HL addresses filename (term CR)
   184                          ;           Carry set for OPENIN, cleared for OPENOUT.
   185                          ;  Outputs: A = file channel (=0 if cannot open)
   186                          ;           DE = file FCB
   187                          ; Destroys: A,B,C,D,E,H,L,F
   188                          ;
   189  00ea  f5                OPENIT:	PUSH	AF		;SAVE CARRY
   190  00eb  cdd402            	CALL	SETUP0
   191  00ee  f1                	POP	AF
   192  00ef  d46a02            	CALL	NC,CREATE
   193  00f2  dc6002            	CALL	C,OPEN
   194  00f5  c9                	RET
   195                          ;
   196  00f6  cdea00            OSOPEN:	CALL	OPENIT
   197  00f9  c8                	RET	Z		;ERROR
   198  00fa  0607              	LD	B,7		;MAX. NUMBER OF FILES
   199  00fc  216a08            	LD	HL,TABLE+15
   200  00ff  7e                OPEN1:	LD	A,(HL)
   201  0100  2b                	DEC	HL
   202  0101  b6                	OR	(HL)
   203  0102  281c              	JR	Z,OPEN2		;FREE CHANNEL
   204  0104  2b                	DEC	HL
   205  0105  10f8              	DJNZ	OPEN1
   206  0107  3ec0              	LD	A,192
   207  0109  cd0000            	CALL	EXTERR
   208  010c  546f6f206d616e79  	DEFM "Too many open files"
              206f70656e206669  
              6c6573            
   209  011f  00                	DEFB	0
   210                          ;
   211  0120  ed5b0000          OPEN2:	LD	DE,(FREE)	;FREE SPACE POINTER
   212  0124  73                	LD	(HL),E
   213  0125  23                	INC	HL
   214  0126  72                	LD	(HL),D
   215  0127  78                	LD	A,B		;CHANNEL (1-7)
   216  0128  21a600            	LD	HL,FCBSIZ
   217  012b  19                	ADD	HL,DE		;RESERVE SPACE
   218  012c  220000            	LD	(FREE),HL
   219  012f  215c00            OPEN3:	LD	HL,FCB		;ENTRY FROM SPOOL/EXEC
   220  0132  d5                	PUSH	DE
   221  0133  012400            	LD	BC,36
   222  0136  edb0              	LDIR			;COPY FCB
   223  0138  eb                	EX	DE,HL
   224  0139  23                	INC	HL
   225  013a  71                	LD	(HL),C		;CLEAR PTR
   226  013b  23                	INC	HL
   227  013c  d1                	POP	DE
   228  013d  47                	LD	B,A
   229  013e  cdeb01            	CALL	RDF		;READ OR FILL
   230  0141  78                	LD	A,B
   231  0142  c30000            	JP	CHECK
   232                          ;
   233                          ;OSBPUT - Write a byte to a random disk file.
   234                          ;   Inputs: E = file channel
   235                          ;           A = byte to write
   236                          ; Destroys: A,B,C,F
   237                          ;
   238  0145  d5                OSBPUT:	PUSH	DE
   239  0146  e5                	PUSH	HL
   240  0147  47                	LD	B,A
   241  0148  cda202            	CALL	FIND
   242  014b  78                	LD	A,B
   243  014c  0600              	LD	B,0
   244  014e  2b                	DEC	HL
   245  014f  70                	LD	(HL),B		;CLEAR EOF
   246  0150  23                	INC	HL
   247  0151  4e                	LD	C,(HL)
   248  0152  cbb9              	RES	7,C
   249  0154  cbfe              	SET	7,(HL)
   250  0156  34                	INC	(HL)
   251  0157  23                	INC	HL
   252  0158  e5                	PUSH	HL
   253  0159  09                	ADD	HL,BC
   254  015a  77                	LD	(HL),A
   255  015b  e1                	POP	HL
   256  015c  cce801            	CALL	Z,WRRDF		;WRITE THEN READ/FILL
   257  015f  e1                	POP	HL
   258  0160  d1                	POP	DE
   259  0161  c9                	RET
   260                          ;
   261                          ;OSBGET - Read a byte from a random disk file.
   262                          ;   Inputs: E = file channel
   263                          ;  Outputs: A = byte read
   264                          ;           Carry set if LAST BYTE of file
   265                          ; Destroys: A,B,C,F
   266                          ;
   267  0162  d5                OSBGET:	PUSH	DE
   268  0163  e5                	PUSH	HL
   269  0164  cda202            	CALL	FIND
   270  0167  4e                	LD	C,(HL)
   271  0168  cbb9              	RES	7,C
   272  016a  34                	INC	(HL)
   273  016b  23                	INC	HL
   274  016c  e5                	PUSH	HL
   275  016d  0600              	LD	B,0
   276  016f  09                	ADD	HL,BC
   277  0170  46                	LD	B,(HL)
   278  0171  e1                	POP	HL
   279  0172  ec0302            	CALL	PE,INCRDF	;INC SECTOR THEN READ
   280  0175  cce801            	CALL	Z,WRRDF		;WRITE THEN READ/FILL
   281  0178  78                	LD	A,B
   282  0179  e1                	POP	HL
   283  017a  d1                	POP	DE
   284  017b  c9                	RET
   285                          ;
   286                          ;OSSTAT - Read file status.
   287                          ;   Inputs: E = file channel
   288                          ;  Outputs: Z flag set - EOF
   289                          ;           (If Z then A=0)
   290                          ;           DE = address of file block.
   291                          ; Destroys: A,D,E,H,L,F
   292                          ;
   293  017c  cda202            OSSTAT:	CALL	FIND
   294  017f  2b                	DEC	HL
   295  0180  7e                	LD	A,(HL)
   296  0181  3c                	INC	A
   297  0182  c9                	RET
   298                          ;
   299                          ;GETEXT - Find file size.
   300                          ;   Inputs: E = file channel
   301                          ;  Outputs: DEHL = file size (0-&800000)
   302                          ; Destroys: A,B,C,D,E,H,L,F
   303                          ;
   304  0183  cda202            GETEXT:	CALL	FIND
   305  0186  eb                	EX	DE,HL
   306  0187  115c00            	LD	DE,FCB
   307  018a  012400            	LD	BC,36
   308  018d  d5                	PUSH	DE
   309  018e  edb0              	LDIR			;COPY FCB
   310  0190  eb                	EX	DE,HL
   311  0191  e3                	EX	(SP),HL
   312  0192  eb                	EX	DE,HL
   313  0193  3e23              	LD	A,35
   314  0195  cd1002            	CALL	BDOS1		;COMPUTE SIZE
   315  0198  e1                	POP	HL
   316  0199  af                	XOR	A
   317  019a  1806              	JR	GETPT1
   318                          ;
   319                          ;GETPTR - Return file pointer.
   320                          ;   Inputs: E = file channel
   321                          ;  Outputs: DEHL = pointer (0-&7FFFFF)
   322                          ; Destroys: A,B,C,D,E,H,L,F
   323                          ;
   324  019c  cda202            GETPTR:	CALL	FIND
   325  019f  7e                	LD	A,(HL)
   326  01a0  87                	ADD	A,A
   327  01a1  2b                	DEC	HL
   328  01a2  2b                GETPT1:	DEC	HL
   329  01a3  56                	LD	D,(HL)
   330  01a4  2b                	DEC	HL
   331  01a5  5e                	LD	E,(HL)
   332  01a6  2b                	DEC	HL
   333  01a7  66                	LD	H,(HL)
   334  01a8  6f                	LD	L,A
   335  01a9  cb3a              	SRL	D
   336  01ab  cb1b              	RR	E
   337  01ad  cb1c              	RR	H
   338  01af  cb1d              	RR	L
   339  01b1  c9                	RET
   340                          ;
   341                          ;PUTPTR - Update file pointer.
   342                          ;   Inputs: A = file channel
   343                          ;           DEHL = new pointer (0-&7FFFFF)
   344                          ; Destroys: A,B,C,D,E,H,L,F
   345                          ;
   346  01b2  55                PUTPTR:	LD	D,L
   347  01b3  29                	ADD	HL,HL
   348  01b4  cb13              	RL	E
   349  01b6  43                	LD	B,E
   350  01b7  4c                	LD	C,H
   351  01b8  5f                	LD	E,A		;CHANNEL
   352  01b9  d5                	PUSH	DE
   353  01ba  cda202            	CALL	FIND
   354  01bd  f1                	POP	AF
   355  01be  e67f              	AND	7FH
   356  01c0  cb7e              	BIT	7,(HL)		;PENDING WRITE?
   357  01c2  2802              	JR	Z,PUTPT1
   358  01c4  f680              	OR	80H
   359  01c6  77                PUTPT1:	LD	(HL),A
   360  01c7  d5                	PUSH	DE
   361  01c8  e5                	PUSH	HL
   362  01c9  2b                	DEC	HL
   363  01ca  2b                	DEC	HL
   364  01cb  2b                	DEC	HL
   365  01cc  56                	LD	D,(HL)
   366  01cd  2b                	DEC	HL
   367  01ce  5e                	LD	E,(HL)
   368  01cf  eb                	EX	DE,HL
   369  01d0  b7                	OR	A
   370  01d1  ed42              	SBC	HL,BC
   371  01d3  e1                	POP	HL
   372  01d4  d1                	POP	DE
   373  01d5  c8                	RET	Z
   374  01d6  23                	INC	HL
   375  01d7  b7                	OR	A
   376  01d8  fc3c02            	CALL	M,WRITE
   377  01db  e5                	PUSH	HL
   378  01dc  2b                	DEC	HL
   379  01dd  2b                	DEC	HL
   380  01de  2b                	DEC	HL
   381  01df  3600              	LD	(HL),0
   382  01e1  2b                	DEC	HL
   383  01e2  70                	LD	(HL),B
   384  01e3  2b                	DEC	HL
   385  01e4  71                	LD	(HL),C		;NEW RECORD NO.
   386  01e5  e1                	POP	HL
   387  01e6  1803              	JR	RDF
   388                          ;
   389                          ;WRRDF - Write, read; if EOF fill with zeroes.
   390                          ;RDF - Read; if EOF fill with zeroes.
   391                          ;   Inputs: DE address FCB.
   392                          ;           HL addresses data buffer.
   393                          ;  Outputs: A=0, Z-flag set.
   394                          ;           Carry set if fill done (EOF)
   395                          ; Destroys: A,H,L,F
   396                          ;
   397  01e8  cd3c02            WRRDF:	CALL	WRITE
   398  01eb  cd0b02            RDF:	CALL	READ
   399  01ee  2b                	DEC	HL
   400  01ef  cbbe              	RES	7,(HL)
   401  01f1  2b                	DEC	HL
   402  01f2  77                	LD	(HL),A		;CLEAR EOF FLAG
   403  01f3  c8                	RET	Z
   404  01f4  36ff              	LD	(HL),-1		;SET EOF FLAG
   405  01f6  23                	INC	HL
   406  01f7  23                	INC	HL
   407  01f8  c5                	PUSH	BC
   408  01f9  af                	XOR	A
   409  01fa  0680              	LD	B,128
   410  01fc  77                FILL:	LD	(HL),A
   411  01fd  23                	INC	HL
   412  01fe  10fc              	DJNZ	FILL
   413  0200  c1                	POP	BC
   414  0201  37                	SCF
   415  0202  c9                	RET
   416                          ;
   417                          ;INCRDF - Increment record, read; if EOF fill.
   418                          ;   Inputs: DE addresses FCB.
   419                          ;           HL addresses data buffer.
   420                          ;  Outputs: A=1, Z-flag reset.
   421                          ;           Carry set if fill done (EOF)
   422                          ; Destroys: A,H,L,F
   423                          ;
   424  0203  cd5502            INCRDF:	CALL	INCSEC
   425  0206  cdeb01            	CALL	RDF
   426  0209  3c                	INC	A
   427  020a  c9                	RET
   428                          ;
   429                          ;READ - Read a record from a disk file.
   430                          ;   Inputs: DE addresses FCB.
   431                          ;           HL = address to store data.
   432                          ;  Outputs: A<>0 & Z-flag reset indicates EOF.
   433                          ;           Carry = 0
   434                          ; Destroys: A,F
   435                          ;
   436                          ;BDOS1 - CP/M BDOS call.
   437                          ;   Inputs: A = function number
   438                          ;          DE = parameter
   439                          ;  Outputs: AF = result (carry=0)
   440                          ; Destroys: A,F
   441                          ;
   442  020b  cd9a02            READ:	CALL	SETDMA
   443  020e  3e21              	LD	A,33
   444  0210  cd2702            BDOS1:	CALL	BDOS0
   445  0213  2002              	JR	NZ,CPMERR
   446  0215  b7                	OR	A
   447  0216  c9                	RET
   448  0217  3eff              CPMERR:	LD	A,255
   449  0219  cd0000            	CALL	EXTERR
   450  021c  43502f4d20457272  	DEFM "CP/M Error"
              6f72              
   451  0226  00                	DEFB	0
   452                          ;
   453  0227  c5                BDOS0:	PUSH	BC
   454  0228  d5                	PUSH	DE
   455  0229  e5                	PUSH	HL
   456  022a  dde5              	PUSH	IX
   457  022c  fde5              	PUSH	IY
   458  022e  4f                	LD	C,A
   459  022f  cd0500            	CALL	BDOS
   460  0232  24                	INC	H
   461  0233  25                	DEC	H
   462  0234  fde1              	POP	IY
   463  0236  dde1              	POP	IX
   464  0238  e1                	POP	HL
   465  0239  d1                	POP	DE
   466  023a  c1                	POP	BC
   467  023b  c9                	RET
   468                          ;
   469                          ;WRITE - Write a record to a disk file.
   470                          ;   Inputs: DE addresses FCB.
   471                          ;           HL = address to get data.
   472                          ; Destroys: A,F
   473                          ;
   474  023c  cd9a02            WRITE:	CALL	SETDMA
   475  023f  3e28              	LD	A,40
   476  0241  cd1002            	CALL	BDOS1
   477  0244  280f              	JR	Z,INCSEC
   478  0246  3ec6              	LD	A,198
   479  0248  cd0000            	CALL	EXTERR
   480  024b  4469736b2066756c  	DEFM "Disk full"
              6c                
   481  0254  00                	DEFB	0
   482                          ;
   483                          ;INCSEC - Increment random record number.
   484                          ;   Inputs: DE addresses FCB.
   485                          ; Destroys: F
   486                          ;
   487  0255  e5                INCSEC:	PUSH	HL
   488  0256  212100            	LD	HL,33
   489  0259  19                	ADD	HL,DE
   490  025a  34                INCS1:	INC	(HL)
   491  025b  23                	INC	HL
   492  025c  28fc              	JR	Z,INCS1
   493  025e  e1                	POP	HL
   494  025f  c9                	RET
   495                          ;
   496                          ;OPEN - Open a file for access.
   497                          ;   Inputs: FCB set up.
   498                          ;  Outputs: DE = FCB
   499                          ;           A=0 & Z-flag set indicates Not Found.
   500                          ;           Carry = 0
   501                          ; Destroys: A,D,E,F
   502                          ;
   503  0260  115c00            OPEN:	LD	DE,FCB
   504  0263  3e0f              	LD	A,15
   505  0265  cd1002            	CALL	BDOS1
   506  0268  3c                	INC	A
   507  0269  c9                	RET
   508                          ;
   509                          ;CREATE - Create a disk file for writing.
   510                          ;   Inputs: FCB set up.
   511                          ;  Outputs: DE = FCB
   512                          ;           A=0 & Z-flag set indicates directory full.
   513                          ;           Carry = 0
   514                          ; Destroys: A,D,E,F
   515                          ;
   516  026a  cd7c02            CREATE:	CALL	CHKAMB
   517  026d  115c00            	LD	DE,FCB
   518  0270  3e13              	LD	A,19
   519  0272  cd1002            	CALL	BDOS1		;DELETE
   520  0275  3e16              	LD	A,22
   521  0277  cd1002            	CALL	BDOS1		;MAKE
   522  027a  3c                	INC	A
   523  027b  c9                	RET
   524                          ;
   525                          ;CHKAMB - Check for ambiguous filename.
   526                          ; Destroys: A,D,E,F
   527                          ;
   528  027c  c5                CHKAMB:	PUSH	BC
   529  027d  115c00            	LD	DE,FCB
   530  0280  060c              	LD	B,12
   531  0282  1a                CHKAM1:	LD	A,(DE)
   532  0283  fe3f              	CP	'?'
   533  0285  2805              	JR	Z,AMBIG		;AMBIGUOUS
   534  0287  13                	INC	DE
   535  0288  10f8              	DJNZ	CHKAM1
   536  028a  c1                	POP	BC
   537  028b  c9                	RET
   538  028c  3ecc              AMBIG:	LD	A,204
   539  028e  cd0000            	CALL	EXTERR
   540  0291  426164206e616d65  	DEFM "Bad name"
   541  0299  00                	DEFB	0
   542                          ;
   543                          ;SETDMA - Set "DMA" address.
   544                          ;   Inputs: HL = address
   545                          ; Destroys: A,F
   546                          ;
   547  029a  3e1a              SETDMA:	LD	A,26
   548  029c  eb                	EX	DE,HL
   549  029d  cd2702            	CALL	BDOS0
   550  02a0  eb                	EX	DE,HL
   551  02a1  c9                	RET
   552                          ;
   553                          ;FIND - Find file parameters from channel.
   554                          ;   Inputs: E = channel
   555                          ;  Outputs: DE addresses FCB
   556                          ;           HL addresses pointer byte (FCB+37)
   557                          ; Destroys: A,D,E,H,L,F
   558                          ;
   559  02a2  1c                FIND:	INC	E		;N.B. channel 8 is SPOOL/EXEC
   560  02a3  1d                	DEC	E
   561  02a4  2808              	JR	Z,CHANER
   562  02a6  cdc302            	CALL	FIND1
   563  02a9  212500            	LD	HL,37
   564  02ac  19                	ADD	HL,DE
   565  02ad  c0                	RET	NZ
   566  02ae  3ede              CHANER:	LD	A,222
   567  02b0  cd0000            	CALL	EXTERR
   568  02b3  496e76616c696420  	DEFM "Invalid channel"
              6368616e6e656c    
   569  02c2  00                	DEFB	0
   570                          ;
   571                          ;FIND1 - Look up file table.
   572                          ;   Inputs: E = channel
   573                          ;  Outputs: Z-flag set = file not opened
   574                          ;           If NZ, DE addresses FCB
   575                          ;                  HL points into table
   576                          ; Destroys: A,D,E,H,L,F
   577                          ;
   578  02c3  7b                FIND1:	LD	A,E
   579  02c4  e607              	AND	7
   580  02c6  87                	ADD	A,A
   581  02c7  5f                	LD	E,A
   582  02c8  1600              	LD	D,0
   583  02ca  215b08            	LD	HL,TABLE
   584  02cd  19                	ADD	HL,DE
   585  02ce  5e                	LD	E,(HL)
   586  02cf  23                	INC	HL
   587  02d0  56                	LD	D,(HL)
   588  02d1  7a                	LD	A,D
   589  02d2  b3                	OR	E
   590  02d3  c9                	RET
   591                          ;
   592                          ;SETUP - Set up File Control Block.
   593                          ;   Inputs: HL addresses filename
   594                          ;           Format  [A:]FILENAME[.EXT]
   595                          ;           Device defaults to current drive
   596                          ;           Extension defaults to .BBC
   597                          ;           A = fill character
   598                          ;  Outputs: HL updated
   599                          ;           A = terminator
   600                          ;           BC = 128
   601                          ; Destroys: A,B,C,H,L,F
   602                          ;
   603                          ;FCB FORMAT (36 BYTES TOTAL):
   604                          ; 0      0=SAME DISK, 1=DISK A, 2=DISK B (ETC.)
   605                          ; 1-8    FILENAME, PADDED WITH SPACES
   606                          ; 9-11   EXTENSION, PADDED WITH SPACES
   607                          ; 12     CURRENT EXTENT, SET TO ZERO
   608                          ; 32-35  CLEARED TO ZERO
   609                          ;
   610  02d4  3e20              SETUP0:	LD	A,' '
   611  02d6  d5                SETUP:	PUSH	DE
   612  02d7  e5                	PUSH	HL
   613  02d8  116500            	LD	DE,FCB+9
   614  02db  217f03            	LD	HL,BBC
   615  02de  010300            	LD	BC,3
   616  02e1  edb0              	LDIR
   617  02e3  217c00            	LD	HL,FCB+32
   618  02e6  0604              	LD	B,4
   619  02e8  71                SETUP1:	LD	(HL),C
   620  02e9  23                	INC	HL
   621  02ea  10fc              	DJNZ	SETUP1
   622  02ec  e1                	POP	HL
   623  02ed  4f                	LD	C,A
   624  02ee  af                	XOR	A
   625  02ef  12                	LD	(DE),A
   626  02f0  d1                	POP	DE
   627  02f1  cd7803            	CALL	SKIPSP
   628  02f4  fe22              	CP	'"'
   629  02f6  2027              	JR	NZ,SETUP2
   630  02f8  23                	INC	HL
   631  02f9  cd7803            	CALL	SKIPSP
   632  02fc  cd1f03            	CALL	SETUP2
   633  02ff  fe22              	CP	'"'
   634  0301  23                	INC	HL
   635  0302  2874              	JR	Z,SKIPSP
   636  0304  3efd              BADSTR:	LD	A,253
   637  0306  cd0000            	CALL	EXTERR
   638  0309  4261642073747269  	DEFM "Bad string"
              6e67              
   639  0313  00                	DEFB	0
   640                          ;
   641  0314  7e                PARSE:	LD	A,(HL)
   642  0315  23                	INC	HL
   643  0316  fe60              	CP	'`'
   644  0318  d0                	RET	NC
   645  0319  fe3f              	CP	'?'
   646  031b  d8                	RET	C
   647  031c  ee40              	XOR	40H
   648  031e  c9                	RET
   649                          ;
   650  031f  d5                SETUP2:	PUSH	DE
   651  0320  23                	INC	HL
   652  0321  7e                	LD	A,(HL)
   653  0322  fe3a              	CP	':'
   654  0324  2b                	DEC	HL
   655  0325  78                	LD	A,B
   656  0326  2005              	JR	NZ,DEVICE
   657  0328  7e                	LD	A,(HL)		;DRIVE
   658  0329  e61f              	AND	31
   659  032b  23                	INC	HL
   660  032c  23                	INC	HL
   661  032d  115c00            DEVICE:	LD	DE,FCB
   662  0330  12                	LD	(DE),A
   663  0331  13                	INC	DE
   664  0332  0608              	LD	B,8
   665  0334  7e                COPYF:	LD	A,(HL)
   666  0335  fe2e              	CP	'.'
   667  0337  2822              	JR	Z,COPYF1
   668  0339  fe20              	CP	' '
   669  033b  281e              	JR	Z,COPYF1
   670  033d  fe0d              	CP	CR
   671  033f  281a              	JR	Z,COPYF1
   672  0341  fe3d              	CP	'='
   673  0343  2816              	JR	Z,COPYF1
   674  0345  fe22              	CP	'"'
   675  0347  2812              	JR	Z,COPYF1
   676  0349  0e3f              	LD	C,'?'
   677  034b  fe2a              	CP	'*'
   678  034d  280c              	JR	Z,COPYF1
   679  034f  0e20              	LD	C,' '
   680  0351  23                	INC	HL
   681  0352  fe7c              	CP	'|'
   682  0354  2006              	JR	NZ,COPYF2
   683  0356  cd1403            	CALL	PARSE
   684  0359  1804              	JR	COPYF0
   685  035b  79                COPYF1:	LD	A,C
   686  035c  cd4305            COPYF2:	CALL	UPPRC
   687  035f  12                COPYF0:	LD	(DE),A
   688  0360  13                	INC	DE
   689  0361  10d1              	DJNZ	COPYF
   690  0363  7e                COPYF3:	LD	A,(HL)
   691  0364  23                	INC	HL
   692  0365  fe2a              	CP	'*'
   693  0367  28fa              	JR	Z,COPYF3
   694  0369  fe2e              	CP	'.'
   695  036b  012003            	LD	BC,3*256+' '
   696  036e  116500            	LD	DE,FCB+9
   697  0371  28c1              	JR	Z,COPYF
   698  0373  2b                	DEC	HL
   699  0374  d1                	POP	DE
   700  0375  018000            	LD	BC,128
   701  0378  7e                SKIPSP:	LD	A,(HL)
   702  0379  fe20              	CP	' '
   703  037b  c0                	RET	NZ
   704  037c  23                	INC	HL
   705  037d  18f9              	JR	SKIPSP
   706                          ;
   707  037f  424243            BBC:	DEFM "BBC"
   708                          ;
   709                          ;HEX - Read a hex string and convert to binary.
   710                          ;   Inputs: HL = text pointer
   711                          ;  Outputs: HL = updated text pointer
   712                          ;           DE = value
   713                          ;            A = terminator (spaces skipped)
   714                          ; Destroys: A,D,E,H,L,F
   715                          ;
   716  0382  110000            HEX:	LD	DE,0		;INITIALISE
   717  0385  cd7803            	CALL	SKIPSP
   718  0388  7e                HEX1:	LD	A,(HL)
   719  0389  cd4305            	CALL	UPPRC
   720  038c  fe30              	CP	'0'
   721  038e  38e8              	JR	C,SKIPSP
   722  0390  fe3a              	CP	'9'+1
   723  0392  380a              	JR	C,HEX2
   724  0394  fe41              	CP	'A'
   725  0396  38e0              	JR	C,SKIPSP
   726  0398  fe47              	CP	'F'+1
   727  039a  30dc              	JR	NC,SKIPSP
   728  039c  d607              	SUB	7
   729  039e  e60f              HEX2:	AND	0FH
   730  03a0  eb                	EX	DE,HL
   731  03a1  29                	ADD	HL,HL
   732  03a2  29                	ADD	HL,HL
   733  03a3  29                	ADD	HL,HL
   734  03a4  29                	ADD	HL,HL
   735  03a5  eb                	EX	DE,HL
   736  03a6  b3                	OR	E
   737  03a7  5f                	LD	E,A
   738  03a8  23                	INC	HL
   739  03a9  18dd              	JR	HEX1
   740                          ;
   741                          ;OSCLI - Process an "operating system" command
   742                          ;
   743  03ab  cd7803            OSCLI:	CALL	SKIPSP
   744  03ae  fe0d              	CP	CR
   745  03b0  c8                	RET	Z
   746  03b1  fe7c              	CP	'|'
   747  03b3  c8                	RET	Z
   748  03b4  fe2e              	CP	'.'
   749  03b6  ca8b04            	JP	Z,DOT		;*.
   750  03b9  eb                	EX	DE,HL
   751  03ba  216a05            	LD	HL,COMDS
   752  03bd  1a                OSCLI0:	LD	A,(DE)
   753  03be  cd4305            	CALL	UPPRC
   754  03c1  be                	CP	(HL)
   755  03c2  280b              	JR	Z,OSCLI2
   756  03c4  3875              	JR	C,HUH
   757  03c6  cb7e              OSCLI1:	BIT	7,(HL)
   758  03c8  23                	INC	HL
   759  03c9  28fb              	JR	Z,OSCLI1
   760  03cb  23                	INC	HL
   761  03cc  23                	INC	HL
   762  03cd  18ee              	JR	OSCLI0
   763                          ;
   764  03cf  d5                OSCLI2:	PUSH	DE
   765  03d0  13                OSCLI3:	INC	DE
   766  03d1  23                	INC	HL
   767  03d2  1a                	LD	A,(DE)
   768  03d3  cd4305            	CALL	UPPRC
   769  03d6  fe2e              	CP	'.'		;ABBREVIATED?
   770  03d8  280a              	JR	Z,OSCLI4
   771  03da  ae                	XOR	(HL)
   772  03db  28f3              	JR	Z,OSCLI3
   773  03dd  fe80              	CP	80H
   774  03df  2803              	JR	Z,OSCLI4
   775  03e1  d1                	POP	DE
   776  03e2  18e2              	JR	OSCLI1
   777                          ;
   778  03e4  f1                OSCLI4:	POP	AF
   779  03e5  13                	INC	DE
   780  03e6  cb7e              OSCLI5:	BIT	7,(HL)
   781  03e8  23                	INC	HL
   782  03e9  28fb              	JR	Z,OSCLI5
   783  03eb  7e                	LD	A,(HL)
   784  03ec  23                	INC	HL
   785  03ed  66                	LD	H,(HL)
   786  03ee  6f                	LD	L,A
   787  03ef  e5                	PUSH	HL
   788  03f0  eb                	EX	DE,HL
   789  03f1  c37803            	JP	SKIPSP
   790                          ;
   791                          ;
   792  03f4  cdd402            ERA:	CALL	SETUP0		;*ERA, *ERASE
   793  03f7  0e13              	LD	C,19
   794  03f9  1833              	JR	XEQ		;"DELETE"
   795                          ;
   796  03fb  0e0d              RES:	LD	C,13		;*RESET
   797  03fd  182f              	JR	XEQ		;"RESET"
   798                          ;
   799  03ff  cdd402            DRV:	CALL	SETUP0		;*DRIVE
   800  0402  3a5c00            	LD	A,(FCB)
   801  0405  3d                	DEC	A
   802  0406  fa3b04            	JP	M,HUH
   803  0409  5f                	LD	E,A
   804  040a  0e0e              	LD	C,14
   805  040c  1823              	JR	XEQ0
   806                          ;
   807  040e  cdd402            REN:	CALL	SETUP0		;*REN, *RENAME
   808  0411  fe3d              	CP	'='
   809  0413  2026              	JR	NZ,HUH
   810  0415  23                	INC	HL		;SKIP "="
   811  0416  e5                	PUSH	HL
   812  0417  cd4c04            	CALL	EXISTS
   813  041a  215c00            	LD	HL,FCB
   814  041d  116c00            	LD	DE,FCB+16
   815  0420  010c00            	LD	BC,12
   816  0423  edb0              	LDIR
   817  0425  e1                	POP	HL
   818  0426  cdd402            	CALL	SETUP0
   819  0429  cd7c02            	CALL	CHKAMB
   820  042c  0e17              	LD	C,23
   821  042e  115c00            XEQ:	LD	DE,FCB
   822  0431  7e                XEQ0:	LD	A,(HL)
   823  0432  fe0d              	CP	CR
   824  0434  2005              	JR	NZ,HUH
   825  0436  79                BDC:	LD	A,C
   826  0437  cd1002            	CALL	BDOS1
   827  043a  f0                	RET	P
   828  043b  3efe              HUH:	LD	A,254
   829  043d  cd0000            	CALL	EXTERR
   830  0440  42616420636f6d6d  	DEFM "Bad command"
              616e64            
   831  044b  00                	DEFB	0
   832                          ;
   833  044c  218000            EXISTS:	LD	HL,DSKBUF
   834  044f  cd9a02            	CALL	SETDMA
   835  0452  115c00            	LD	DE,FCB
   836  0455  3e11              	LD	A,17
   837  0457  cd1002            	CALL	BDOS1		;SEARCH
   838  045a  3c                	INC	A
   839  045b  c8                	RET	Z
   840  045c  3ec4              	LD	A,196
   841  045e  cd0000            	CALL	EXTERR
   842  0461  46696c6520657869  	DEFM "File exists"
              737473            
   843  046c  00                	DEFB	0
   844                          ;
   845  046d  cdd402            SAVLOD:	CALL	SETUP0		;PART OF *SAVE, *LOAD
   846  0470  cd8203            	CALL	HEX
   847  0473  fe2b              	CP	'+'
   848  0475  f5                	PUSH	AF
   849  0476  d5                	PUSH	DE
   850  0477  2001              	JR	NZ,SAVLO1
   851  0479  23                	INC	HL
   852  047a  cd8203            SAVLO1:	CALL	HEX
   853  047d  fe0d              	CP	CR
   854  047f  20ba              	JR	NZ,HUH
   855  0481  eb                	EX	DE,HL
   856  0482  d1                	POP	DE
   857  0483  f1                	POP	AF
   858  0484  c8                	RET	Z
   859  0485  b7                	OR	A
   860  0486  ed52              	SBC	HL,DE
   861  0488  c0                	RET	NZ
   862  0489  18b0              	JR	HUH
   863                          ;
   864  048b  23                DOT:	INC	HL
   865  048c  3e3f              DIR:	LD	A,'?'		;*DIR
   866  048e  cdd602            	CALL	SETUP
   867  0491  fe0d              	CP	CR
   868  0493  20a6              	JR	NZ,HUH
   869  0495  0e11              	LD	C,17
   870  0497  0604              DIR0:	LD	B,4
   871  0499  cd1606            DIR1:	CALL	LTRAP
   872  049c  115c00            	LD	DE,FCB
   873  049f  218000            	LD	HL,DSKBUF
   874  04a2  cd9a02            	CALL	SETDMA
   875  04a5  79                	LD	A,C
   876  04a6  cd1002            	CALL	BDOS1		;SEARCH DIRECTORY
   877  04a9  fa0000            	JP	M,CRLF
   878  04ac  0f                	RRCA
   879  04ad  0f                	RRCA
   880  04ae  0f                	RRCA
   881  04af  e660              	AND	60H
   882  04b1  5f                	LD	E,A
   883  04b2  1600              	LD	D,0
   884  04b4  218100            	LD	HL,DSKBUF+1
   885  04b7  19                	ADD	HL,DE
   886  04b8  e5                	PUSH	HL
   887  04b9  110800            	LD	DE,8
   888  04bc  19                	ADD	HL,DE
   889  04bd  5e                	LD	E,(HL)
   890  04be  23                	INC	HL
   891  04bf  cb7e              	BIT	7,(HL)		;SYSTEM FILE?
   892  04c1  e1                	POP	HL
   893  04c2  0e12              	LD	C,18
   894  04c4  20d3              	JR	NZ,DIR1
   895  04c6  c5                	PUSH	BC
   896  04c7  3a5c00            	LD	A,(FCB)
   897  04ca  3d                	DEC	A
   898  04cb  0e19              	LD	C,25
   899  04cd  fc3604            	CALL	M,BDC
   900  04d0  c641              	ADD	A,'A'
   901  04d2  cd9b06            	CALL	OSWRCH
   902  04d5  0608              	LD	B,8
   903  04d7  3e20              	LD	A,' '
   904  04d9  cb7b              	BIT	7,E		;READ ONLY?
   905  04db  2802              	JR	Z,DIR3
   906  04dd  3e2a              	LD	A,'*'
   907  04df  cdd105            DIR3:	CALL	CPTEXT
   908  04e2  0603              	LD	B,3
   909  04e4  3e20              	LD	A,' '
   910  04e6  cdd805            	CALL	SPTEXT
   911  04e9  c1                	POP	BC
   912  04ea  1005              	DJNZ	DIR2
   913  04ec  cd0000            	CALL	CRLF
   914  04ef  18a6              	JR	DIR0
   915                          ;
   916  04f1  c5                DIR2:	PUSH	BC
   917  04f2  0605              	LD	B,5
   918  04f4  3e20              PAD:	LD	A,' '
   919  04f6  cd9b06            	CALL	OSWRCH
   920  04f9  10f9              	DJNZ	PAD
   921  04fb  c1                	POP	BC
   922  04fc  189b              	JR	DIR1
   923                          ;
   924  04fe  cd8203            OPT:	CALL	HEX		;*OPT
   925  0501  7b                	LD	A,E
   926  0502  e603              	AND	3
   927  0504  326f08            SETOPT:	LD	(OPTVAL),A
   928  0507  c9                	RET
   929                          ;
   930  0508  af                RESET:	XOR	A
   931  0509  18f9              	JR	SETOPT
   932                          ;
   933  050b  3e01              EXEC:	LD	A,00000001B	;*EXEC
   934  050d  01                	DEFB	1		;SKIP 2 BYTES (LD BC)
   935  050e  3e02              SPOOL:	LD	A,00000010B	;*SPOOL
   936  0510  f5                	PUSH	AF
   937  0511  e5                	PUSH	HL
   938  0512  cd6300            	CALL	SESHUT		;STOP SPOOL/EXEC
   939  0515  e1                	POP	HL
   940  0516  c1                	POP	BC
   941  0517  7e                	LD	A,(HL)
   942  0518  fe0d              	CP	CR		;JUST SHUT?
   943  051a  c8                	RET	Z
   944  051b  3a6b08            	LD	A,(FLAGS)
   945  051e  b0                	OR	B
   946  051f  326b08            	LD	(FLAGS),A	;SPOOL/EXEC FLAG
   947  0522  1f                	RRA			;CARRY=1 FOR EXEC
   948  0523  cdea00            	CALL	OPENIT		;OPEN SPOOL/EXEC FILE
   949  0526  c8                	RET	Z		;DIR FULL / NOT FOUND
   950  0527  dde1              	POP	IX		;RETURN ADDRESS
   951  0529  2a0000            	LD	HL,(HIMEM)
   952  052c  b7                	OR	A
   953  052d  ed72              	SBC	HL,SP		;SP=HIMEM?
   954  052f  39                	ADD	HL,SP
   955  0530  200f              	JR	NZ,JPIX		;ABORT
   956  0532  015aff            	LD	BC,-FCBSIZ
   957  0535  09                	ADD	HL,BC		;HL=HL-FCBSIZ
   958  0536  220000            	LD	(HIMEM),HL	;NEW HIMEM
   959  0539  225b08            	LD	(TABLE),HL	;FCB/BUFFER
   960  053c  f9                	LD	SP,HL		;NEW SP
   961  053d  eb                	EX	DE,HL
   962  053e  cd2f01            	CALL	OPEN3		;FINISH OPEN OPERATION
   963  0541  dde9              JPIX:	JP	(IX)		;"RETURN"
   964                          ;
   965  0543  e67f              UPPRC:	AND	7FH
   966  0545  fe60              	CP	'`'
   967  0547  d8                	RET	C
   968  0548  e65f              	AND	5FH		;CONVERT TO UPPER CASE
   969  054a  c9                	RET
   970                          ;
   971  054b  0620              HELP:	LD	B,32
   972  054d  210000            	LD	HL,VERMSG
   973  0550  c3db05            	JP	PTEXT
   974                          ;
   975                          ;*ESC COMMAND
   976                          ;
   977  0553  7e                ESCCTL:	LD	A,(HL)
   978  0554  cd4305            	CALL	UPPRC		;**
   979  0557  fe4f              	CP	'O'
   980  0559  2001              	JR	NZ,ESCC1
   981  055b  23                	INC	HL
   982  055c  cd8203            ESCC1:	CALL	HEX
   983  055f  7b                	LD	A,E
   984  0560  b7                	OR	A
   985  0561  216b08            	LD	HL,FLAGS
   986  0564  cbb6              	RES	6,(HL)		;ENABLE ESCAPE
   987  0566  c8                	RET	Z
   988  0567  cbf6              	SET	6,(HL)		;DISABLE ESCAPE
   989  0569  c9                	RET
   990                          ;
   991                          ;
   992  056a  4259              COMDS:	DEFM "BY"
   993  056c  c5                	DEFB	'E'+80H
   994  056d  0000              	DEFW	BYE
   995  056f  4449              	DEFM "DI"
   996  0571  d2                	DEFB	'R'+80H
   997  0572  8c04              	DEFW	DIR
   998  0574  44524956          	DEFM "DRIV"
   999  0578  c5                	DEFB	'E'+80H
  1000  0579  ff03              	DEFW	DRV
  1001  057b  45524153          	DEFM "ERAS"
  1002  057f  c5                	DEFB	'E'+80H
  1003  0580  f403              	DEFW	ERA
  1004  0582  4552              	DEFM "ER"
  1005  0584  c1                	DEFB	'A'+80H
  1006  0585  f403              	DEFW	ERA
  1007  0587  4553              	DEFM "ES"
  1008  0589  c3                	DEFB	'C'+80H
  1009  058a  5305              	DEFW	ESCCTL
  1010  058c  455845            	DEFM "EXE"
  1011  058f  c3                	DEFB	'C'+80H
  1012  0590  0b05              	DEFW	EXEC
  1013  0592  48454c            	DEFM "HEL"
  1014  0595  d0                	DEFB	'P'+80H
  1015  0596  4b05              	DEFW	HELP
  1016  0598  4c4f41            	DEFM "LOA"
  1017  059b  c4                	DEFB	'D'+80H
  1018  059c  af00              	DEFW	STLOAD
  1019  059e  4f50              	DEFM "OP"
  1020  05a0  d4                	DEFB	'T'+80H
  1021  05a1  fe04              	DEFW	OPT
  1022  05a3  515549            	DEFM "QUI"
  1023  05a6  d4                	DEFB	'T'+80H
  1024  05a7  0000              	DEFW	BYE
  1025  05a9  52454e414d        	DEFM "RENAM"
  1026  05ae  c5                	DEFB	'E'+80H
  1027  05af  0e04              	DEFW	REN
  1028  05b1  5245              	DEFM "RE"
  1029  05b3  ce                	DEFB	'N'+80H
  1030  05b4  0e04              	DEFW	REN
  1031  05b6  52455345          	DEFM "RESE"
  1032  05ba  d4                	DEFB	'T'+80H
  1033  05bb  fb03              	DEFW	RES
  1034  05bd  534156            	DEFM "SAV"
  1035  05c0  c5                	DEFB	'E'+80H
  1036  05c1  0000              	DEFW	STSAVE
  1037  05c3  53504f4f          	DEFM "SPOO"
  1038  05c7  cc                	DEFB	'L'+80H
  1039  05c8  0e05              	DEFW	SPOOL
  1040  05ca  545950            	DEFM "TYP"
  1041  05cd  c5                	DEFB	'E'+80H
  1042  05ce  9000              	DEFW	TYPE
  1043  05d0  ff                	DEFB	0FFH
  1044                          ;
  1045                          ;PTEXT - Print text
  1046                          ;   Inputs: HL = address of text
  1047                          ;            B = number of characters to print
  1048                          ; Destroys: A,B,H,L,F
  1049                          ;
  1050  05d1  f5                CPTEXT:	PUSH	AF
  1051  05d2  3e3a              	LD	A,':'
  1052  05d4  cd9b06            	CALL	OSWRCH
  1053  05d7  f1                	POP	AF
  1054  05d8  cd9b06            SPTEXT:	CALL	OSWRCH
  1055  05db  7e                PTEXT:	LD	A,(HL)
  1056  05dc  e67f              	AND	7FH
  1057  05de  23                	INC	HL
  1058  05df  cd9b06            	CALL	OSWRCH
  1059  05e2  10f7              	DJNZ	PTEXT
  1060  05e4  c9                	RET
  1061                          ;
  1062                          ;OSINIT - Initialise RAM mapping etc.
  1063                          ;If BASIC is entered by BBCBASIC FILENAME then file
  1064                          ;FILENAME.BBC is automatically CHAINed.
  1065                          ;   Outputs: DE = initial value of HIMEM (top of RAM)
  1066                          ;            HL = initial value of PAGE (user program)
  1067                          ;            Z-flag reset indicates AUTO-RUN.
  1068                          ;  Destroys: A,B,C,D,E,H,L,F
  1069                          ;
  1070  05e5  0e2d              OSINIT:	LD	C,45		;*
  1071  05e7  1efe              	LD	E,254		;*
  1072  05e9  cd0500            	CALL	BDOS		;*
  1073  05ec  af                	XOR	A
  1074  05ed  0615              	LD	B,INILEN
  1075  05ef  215b08            	LD	HL,TABLE
  1076  05f2  77                CLRTAB:	LD	(HL),A		;CLEAR FILE TABLE ETC.
  1077  05f3  23                	INC	HL
  1078  05f4  10fc              	DJNZ	CLRTAB
  1079  05f6  110000            	LD	DE,ACCS
  1080  05f9  218000            	LD	HL,DSKBUF
  1081  05fc  4e                	LD	C,(HL)
  1082  05fd  23                	INC	HL
  1083  05fe  b9                	CP	C		;N.B. A=B=0
  1084  05ff  2802              	JR	Z,NOBOOT
  1085  0601  edb0              	LDIR			;COPY TO ACCS
  1086  0603  eb                NOBOOT:	EX	DE,HL
  1087  0604  360d              	LD	(HL),CR
  1088  0606  ed5b0600          	LD	DE,(6)		;DE = HIMEM
  1089  060a  5f                	LD	E,A		;PAGE BOUNDARY
  1090  060b  210000            	LD	HL,USER
  1091  060e  c9                	RET
  1092                          ;
  1093                          ;
  1094                          ;TRAP - Test ESCAPE flag and abort if set;
  1095                          ;       every 20th call, test for keypress.
  1096                          ; Destroys: A,H,L,F
  1097                          ;
  1098                          ;LTRAP - Test ESCAPE flag and abort if set.
  1099                          ; Destroys: A,F
  1100                          ;
  1101  060f  215a08            TRAP:	LD	HL,TRPCNT
  1102  0612  35                	DEC	(HL)
  1103  0613  cc2306            	CALL	Z,TEST20	;TEST KEYBOARD
  1104  0616  3a6b08            LTRAP:	LD	A,(FLAGS)	;ESCAPE FLAG
  1105  0619  b7                	OR	A		;TEST
  1106  061a  f0                	RET	P
  1107  061b  216b08            ABORT:	LD	HL,FLAGS	;ACKNOWLEDGE
  1108  061e  cbbe              	RES	7,(HL)		;ESCAPE
  1109  0620  c30000            	JP	ESCAPE		;AND ABORT
  1110                          ;
  1111                          ;TEST - Sample for ESCape and CTRL/S. If ESCape
  1112                          ;       pressed set ESCAPE flag and return.
  1113                          ; Destroys: A,F
  1114                          ;
  1115  0623  3614              TEST20:	LD	(HL),20
  1116  0625  d5                TEST:	PUSH	DE
  1117  0626  3e06              	LD	A,6
  1118  0628  1eff              	LD	E,0FFH
  1119  062a  cd2702            	CALL	BDOS0
  1120  062d  d1                	POP	DE
  1121  062e  b7                	OR	A
  1122  062f  c8                	RET	Z
  1123  0630  fe13              	CP	13H	;PAUSE DISPLAY?
  1124  0632  281e              	JR	Z,OSRDCH
  1125  0634  fe1b              	CP	ESC
  1126  0636  2857              	JR	Z,ESCSET
  1127  0638  326c08            	LD	(INKEY),A
  1128  063b  c9                	RET
  1129                          ;
  1130                          ;OSRDCH - Read from the current input stream (keyboard).
  1131                          ;  Outputs: A = character
  1132                          ; Destroys: A,F
  1133                          ;
  1134  063c  dd46f4            KEYGET:	LD	B,(IX-12)	;SCREEN WIDTH
  1135  063f  cd5206            	CALL	OSRDCH
  1136  0642  fe7f              	CP	DEL
  1137  0644  2809              	JR	Z,KEYDEL
  1138  0646  fee0              	CP	224
  1139  0648  c0                	RET	NZ
  1140  0649  cd5206            	CALL	OSRDCH
  1141  064c  d641              	SUB	65
  1142  064e  c9                	RET
  1143                          ;
  1144  064f  3e08              KEYDEL:	LD	A,BS
  1145  0651  c9                	RET
  1146                          ;
  1147  0652  3a6b08            OSRDCH:	LD	A,(FLAGS)
  1148  0655  1f                	RRA			;*EXEC ACTIVE?
  1149  0656  380a              	JR	C,EXECIN
  1150  0658  e5                	PUSH	HL
  1151  0659  ed62              	SBC	HL,HL		;HL=0
  1152  065b  cd7a06            	CALL	OSKEY
  1153  065e  e1                	POP	HL
  1154  065f  d8                	RET	C
  1155  0660  18f0              	JR	OSRDCH
  1156                          ;
  1157                          ;EXECIN - Read byte from EXEC file
  1158                          ;  Outputs: A = byte read
  1159                          ; Destroys: A,F
  1160                          ;
  1161  0662  c5                EXECIN:	PUSH	BC		;SAVE REGISTERS
  1162  0663  d5                	PUSH	DE
  1163  0664  e5                	PUSH	HL
  1164  0665  1e08              	LD	E,8		;SPOOL/EXEC CHANNEL
  1165  0667  216b08            	LD	HL,FLAGS
  1166  066a  cb86              	RES	0,(HL)
  1167  066c  cd6201            	CALL	OSBGET
  1168  066f  cbc6              	SET	0,(HL)
  1169  0671  f5                	PUSH	AF
  1170  0672  dc6300            	CALL	C,SESHUT	;END EXEC IF EOF
  1171  0675  f1                	POP	AF
  1172  0676  e1                	POP	HL		;RESTORE REGISTERS
  1173  0677  d1                	POP	DE
  1174  0678  c1                	POP	BC
  1175  0679  c9                	RET
  1176                          ;
  1177                          ;
  1178                          ;OSKEY - Read key with time-limit, test for ESCape.
  1179                          ;Main function is carried out in user patch.
  1180                          ;   Inputs: HL = time limit (centiseconds)
  1181                          ;  Outputs: Carry reset if time-out
  1182                          ;           If carry set A = character
  1183                          ; Destroys: A,H,L,F
  1184                          ;
  1185  067a  e5                OSKEY:	PUSH	HL
  1186  067b  216c08            	LD	HL,INKEY
  1187  067e  7e                	LD	A,(HL)
  1188  067f  3600              	LD	(HL),0
  1189  0681  e1                	POP	HL
  1190  0682  b7                	OR	A
  1191  0683  37                	SCF
  1192  0684  c0                	RET	NZ
  1193  0685  d5                	PUSH	DE
  1194  0686  cd0000            	CALL	GETKEY
  1195  0689  d1                	POP	DE
  1196  068a  d0                	RET	NC
  1197  068b  fe1b              	CP	ESC
  1198  068d  37                	SCF
  1199  068e  c0                	RET	NZ
  1200  068f  e5                ESCSET:	PUSH	HL
  1201  0690  216b08            	LD	HL,FLAGS
  1202  0693  cb76              	BIT	6,(HL)		;ESC DISABLED?
  1203  0695  2002              	JR	NZ,ESCDIS
  1204  0697  cbfe              	SET	7,(HL)		;SET ESCAPE FLAG
  1205  0699  e1                ESCDIS:	POP	HL
  1206  069a  c9                	RET
  1207                          ;
  1208                          ;OSWRCH - Write a character to console output.
  1209                          ;   Inputs: A = character.
  1210                          ; Destroys: Nothing
  1211                          ;
  1212  069b  f5                OSWRCH:	PUSH	AF
  1213  069c  d5                	PUSH	DE
  1214  069d  e5                	PUSH	HL
  1215  069e  5f                	LD	E,A
  1216  069f  cd2506            	CALL	TEST
  1217  06a2  cda906            	CALL	EDPUT
  1218  06a5  e1                	POP	HL
  1219  06a6  d1                	POP	DE
  1220  06a7  f1                	POP	AF
  1221  06a8  c9                	RET
  1222                          ;
  1223  06a9  3a6b08            EDPUT:	LD	A,(FLAGS)
  1224  06ac  cb5f              	BIT	3,A
  1225  06ae  2810              	JR	Z,WRCH
  1226  06b0  7b                	LD	A,E
  1227  06b1  fe20              	CP	' '
  1228  06b3  d8                	RET	C
  1229  06b4  2a6d08            	LD	HL,(EDPTR)
  1230  06b7  73                	LD	(HL),E
  1231  06b8  2c                	INC	L
  1232  06b9  c8                	RET	Z
  1233  06ba  226d08            	LD	(EDPTR),HL
  1234  06bd  c9                	RET
  1235                          ;
  1236  06be  1e3e              PROMPT:	LD	E,'>'
  1237  06c0  3a6f08            WRCH:	LD	A,(OPTVAL)	;FAST ENTRY
  1238  06c3  c603              	ADD	A,3
  1239  06c5  fe03              	CP	3
  1240  06c7  2007              	JR	NZ,WRCH1
  1241  06c9  83                	ADD	A,E
  1242  06ca  3e02              	LD	A,2
  1243  06cc  3802              	JR	C,WRCH1
  1244  06ce  3e06              	LD	A,6
  1245  06d0  cd2702            WRCH1:	CALL	BDOS0
  1246  06d3  216b08            	LD	HL,FLAGS
  1247  06d6  cb56              	BIT	2,(HL)
  1248  06d8  3e05              	LD	A,5		;PRINTER O/P
  1249  06da  c42702            	CALL	NZ,BDOS0
  1250  06dd  cb4e              	BIT	1,(HL)		;SPOOLING?
  1251  06df  c8                	RET	Z
  1252  06e0  cb8e              	RES	1,(HL)
  1253  06e2  7b                	LD	A,E		;BYTE TO WRITE
  1254  06e3  1e08              	LD	E,8		;SPOOL/EXEC CHANNEL
  1255  06e5  c5                	PUSH	BC
  1256  06e6  cd4501            	CALL	OSBPUT
  1257  06e9  c1                	POP	BC
  1258  06ea  cbce              	SET	1,(HL)
  1259  06ec  c9                	RET
  1260                          ;
  1261  06ed  010000            TOGGLE:	LD	BC,0
  1262  06f0  3a6b08            	LD	A,(FLAGS)
  1263  06f3  ee04              	XOR	00000100B
  1264  06f5  326b08            	LD	(FLAGS),A
  1265  06f8  c9                	RET
  1266                          ;
  1267  06f9  3a6b08            INSERT:	LD	A,(FLAGS)
  1268  06fc  ee10              	XOR	00010000B
  1269  06fe  326b08            	LD	(FLAGS),A
  1270  0701  c9                	RET
  1271                          ;
  1272                          ;OSLINE - Read/edit a complete line, terminated by CR.
  1273                          ;   Inputs: HL addresses destination buffer.
  1274                          ;           (L=0)
  1275                          ;  Outputs: Buffer filled, terminated by CR.
  1276                          ;           A=0.
  1277                          ; Destroys: A,B,C,D,E,H,L,F
  1278                          ;
  1279  0702  dd210002          OSLINE:	LD	IX,200H
  1280  0706  3a6b08            	LD	A,(FLAGS)
  1281  0709  cb5f              	BIT	3,A		;EDIT MODE?
  1282  070b  2809              	JR	Z,OSLIN1
  1283  070d  cb9f              	RES	3,A
  1284  070f  326b08            	LD	(FLAGS),A
  1285  0712  2a6d08            	LD	HL,(EDPTR)
  1286  0715  bd                	CP	L
  1287  0716  3e0d              OSLIN1:	LD	A,CR
  1288  0718  77                	LD	(HL),A
  1289  0719  c49b06            	CALL	NZ,OSWRCH
  1290  071c  2e00              	LD	L,0
  1291  071e  4d                	LD	C,L		;REPEAT FLAG
  1292  071f  2820              	JR	Z,OSWAIT	;SUPPRESS UNWANTED SPACE
  1293  0721  0600              UPDATE:	LD	B,0
  1294  0723  7e                UPD1:	LD	A,(HL)
  1295  0724  04                	INC	B
  1296  0725  23                	INC	HL
  1297  0726  fe0d              	CP	CR
  1298  0728  f5                	PUSH	AF
  1299  0729  e5                	PUSH	HL
  1300  072a  5f                	LD	E,A
  1301  072b  c4c006            	CALL	NZ,WRCH		;FAST WRCH
  1302  072e  e1                	POP	HL
  1303  072f  f1                	POP	AF
  1304  0730  20f1              	JR	NZ,UPD1
  1305  0732  3e20              	LD	A,' '
  1306  0734  cd9b06            	CALL	OSWRCH
  1307  0737  1e08              	LD	E,BS
  1308  0739  e5                UPD2:	PUSH	HL
  1309  073a  cdc006            	CALL	WRCH		;FAST WRCH
  1310  073d  e1                	POP	HL
  1311  073e  2b                	DEC	HL
  1312  073f  10f8              	DJNZ	UPD2
  1313  0741  79                OSWAIT:	LD	A,C
  1314  0742  05                	DEC	B
  1315  0743  2801              	JR	Z,LIMIT
  1316  0745  b7                	OR	A		;REPEAT COMMAND?
  1317  0746  cc3c06            LIMIT:	CALL	Z,KEYGET	;READ KEYBOARD
  1318  0749  4f                	LD	C,A		;SAVE FOR REPEAT
  1319  074a  114107            	LD	DE,OSWAIT	;RETURN ADDRESS
  1320  074d  d5                	PUSH	DE
  1321  074e  3a6b08            	LD	A,(FLAGS)
  1322  0751  b7                	OR	A		;TEST FOR ESCAPE
  1323  0752  79                	LD	A,C
  1324  0753  faa207            	JP	M,OSEXIT
  1325  0756  fe10              	CP	10H
  1326  0758  caed06            	JP	Z,TOGGLE
  1327  075b  ddbef5            	CP	(IX-11)		;CURSOR UP     (IX-11)
  1328  075e  caee07            	JP	Z,LEFT
  1329  0761  ddbef6            	CP	(IX-10)		;CURSOR DOWN   (IX-10)
  1330  0764  ca3408            	JP	Z,RIGHT
  1331  0767  0600              	LD	B,0
  1332  0769  ddbefb            	CP	(IX-5)		;CLEAR LEFT    (IX-5)
  1333  076c  287f              	JR	Z,BACK
  1334  076e  ddbef7            	CP	(IX-9)		;START OF LINE (IX-9)
  1335  0771  287b              	JR	Z,LEFT
  1336  0773  ddbef8            	CP	(IX-8)		;END OF LINE   (IX-8)
  1337  0776  ca3408            	JP	Z,RIGHT
  1338  0779  ddbef9            	CP	(IX-7)		;CLEAR RIGHT   (IX-7)
  1339  077c  287b              	JR	Z,DELETE
  1340  077e  0e00              	LD	C,0		;INHIBIT REPEAT
  1341  0780  ddbeff            	CP	(IX-1)		;INSERT / OVR  (IX-1)
  1342  0783  caf906            	JP	Z,INSERT
  1343  0786  ddbefa            	CP	(IX-6)		;DELETE LEFT   (IX-6)
  1344  0789  2862              	JR	Z,BACK
  1345  078b  ddbefc            	CP	(IX-4)		;CURSOR LEFT   (IX-4)
  1346  078e  285e              	JR	Z,LEFT
  1347  0790  ddbefe            	CP	(IX-2)		;DELETE RIGHT  (IX-2)
  1348  0793  2864              	JR	Z,DELETE
  1349  0795  ddbefd            	CP	(IX-3)		;CURSOR RIGHT  (IX-3)
  1350  0798  ca3408            	JP	Z,RIGHT
  1351  079b  fe20              	CP	' '		;PRINTING CHARACTER
  1352  079d  306e              	JR	NC,SAVECH
  1353  079f  fe0d              	CP	CR		;ENTER LINE
  1354  07a1  c0                	RET	NZ
  1355  07a2  7e                OSEXIT:	LD	A,(HL)
  1356  07a3  cd9b06            	CALL	OSWRCH		;WRITE REST OF LINE
  1357  07a6  23                	INC	HL
  1358  07a7  d60d              	SUB	CR
  1359  07a9  20f7              	JR	NZ,OSEXIT
  1360  07ab  d1                	POP	DE		;DITCH RETURN ADDRESS
  1361  07ac  b9                	CP	C
  1362  07ad  c21b06            	JP	NZ,ABORT	;ESCAPE
  1363  07b0  3e0a              	LD	A,LF
  1364  07b2  cd9b06            	CALL	OSWRCH
  1365  07b5  af                	XOR	A
  1366  07b6  6f                	LD	L,A
  1367  07b7  226d08            	LD	(EDPTR),HL
  1368  07ba  ed5b0000          	LD	DE,(CURLIN)
  1369  07be  ba                	CP	D
  1370  07bf  c0                	RET	NZ
  1371  07c0  bb                	CP	E
  1372  07c1  c0                	RET	NZ
  1373  07c2  ed5b0000          	LD	DE,(AUTONO)
  1374  07c6  ba                	CP	D
  1375  07c7  c0                	RET	NZ
  1376  07c8  bb                	CP	E
  1377  07c9  c0                	RET	NZ
  1378  07ca  115208            	LD	DE,EDITST
  1379  07cd  0604              	LD	B,4
  1380  07cf  1a                CMPARE:	LD	A,(DE)
  1381  07d0  be                	CP	(HL)
  1382  07d1  3e00              	LD	A,0
  1383  07d3  c0                	RET	NZ
  1384  07d4  23                	INC	HL
  1385  07d5  13                	INC	DE
  1386  07d6  7e                	LD	A,(HL)
  1387  07d7  fe2e              	CP	'.'
  1388  07d9  2802              	JR	Z,ABBR
  1389  07db  10f2              	DJNZ	CMPARE
  1390  07dd  af                ABBR:	XOR	A
  1391  07de  47                	LD	B,A
  1392  07df  4d                	LD	C,L
  1393  07e0  6f                	LD	L,A
  1394  07e1  115608            	LD	DE,LISTST
  1395  07e4  eb                	EX	DE,HL
  1396  07e5  edb0              	LDIR
  1397  07e7  216b08            	LD	HL,FLAGS
  1398  07ea  cbde              	SET	3,(HL)
  1399  07ec  c9                	RET
  1400                          ;
  1401  07ed  37                BACK:	SCF			;DELETE LEFT
  1402  07ee  2c                LEFT:	INC	L		;CURSOR LEFT
  1403  07ef  2d                	DEC	L
  1404  07f0  285d              	JR	Z,STOP
  1405  07f2  3e08              	LD	A,BS
  1406  07f4  cd9b06            	CALL	OSWRCH
  1407  07f7  2d                	DEC	L
  1408  07f8  d0                	RET	NC
  1409  07f9  7e                DELETE:	LD	A,(HL)		;DELETE RIGHT
  1410  07fa  fe0d              	CP	CR
  1411  07fc  2851              	JR	Z,STOP
  1412  07fe  54                	LD	D,H
  1413  07ff  5d                	LD	E,L
  1414  0800  13                DEL1:	INC	DE
  1415  0801  1a                	LD	A,(DE)
  1416  0802  1b                	DEC	DE
  1417  0803  12                	LD	(DE),A
  1418  0804  13                	INC	DE
  1419  0805  fe0d              	CP	CR
  1420  0807  20f7              	JR	NZ,DEL1
  1421  0809  d1                DEL2:	POP	DE		;DITCH
  1422  080a  c32107            	JP	UPDATE
  1423                          ;
  1424  080d  57                SAVECH:	LD	D,A
  1425  080e  3a6b08            	LD	A,(FLAGS)
  1426  0811  e610              	AND	00010000B
  1427  0813  7a                	LD	A,D
  1428  0814  2023              	JR	NZ,RIGHT1
  1429  0816  57                	LD	D,A
  1430  0817  3e0d              	LD	A,CR		;INSERT SPACE
  1431  0819  be                	CP	(HL)
  1432  081a  7a                	LD	A,D
  1433  081b  281c              	JR	Z,RIGHT1
  1434  081d  54                	LD	D,H
  1435  081e  1efe              	LD	E,254
  1436  0820  f5                	PUSH	AF
  1437  0821  13                INS1:	INC	DE
  1438  0822  12                	LD	(DE),A
  1439  0823  1b                	DEC	DE
  1440  0824  7b                	LD	A,E
  1441  0825  bd                	CP	L
  1442  0826  1b                	DEC	DE
  1443  0827  1a                	LD	A,(DE)
  1444  0828  20f7              	JR	NZ,INS1
  1445  082a  f1                	POP	AF
  1446  082b  77                	LD	(HL),A
  1447  082c  2c                	INC	L
  1448  082d  2818              	JR	Z,WONTGO
  1449  082f  cd9b06            	CALL	OSWRCH
  1450  0832  18d5              	JR	DEL2
  1451                          ;
  1452  0834  7e                RIGHT:	LD	A,(HL)		;CURSOR RIGHT
  1453  0835  fe0d              	CP	CR
  1454  0837  2816              	JR	Z,STOP
  1455  0839  56                RIGHT1:	LD	D,(HL)		;PRINTING CHARACTER
  1456  083a  77                	LD	(HL),A
  1457  083b  2c                	INC	L
  1458  083c  2809              	JR	Z,WONTGO	;LINE TOO LONG
  1459  083e  cd9b06            	CALL	OSWRCH
  1460  0841  3e0d              	LD	A,CR
  1461  0843  ba                	CP	D
  1462  0844  c0                	RET	NZ
  1463  0845  77                	LD	(HL),A
  1464  0846  c9                	RET
  1465                          ;
  1466  0847  2d                WONTGO:	DEC	L
  1467  0848  360d              	LD	(HL),CR
  1468  084a  3e07              	LD	A,BEL
  1469  084c  cd9b06            	CALL	OSWRCH		;BEEP!
  1470  084f  0e00              STOP:	LD	C,0		;STOP REPEAT
  1471  0851  c9                	RET
  1472                          ;
  1473                          ;
  1474  0852  45444954          EDITST:	DEFM "EDIT"
  1475  0856  4c495354          LISTST:	DEFM "LIST"
  1476                          ;
  1477                          ; BEL EQU	7
  1478                          ; BS EQU	8
  1479                          ; HT EQU	9
  1480                          ; LF EQU	0AH
  1481                          ; VT EQU	0BH
  1482                          ; CR EQU	0DH
  1483                          ESC	EQU	1BH
  1484                          DEL	EQU	7FH
  1485                          ;
  1486                          BDOS	EQU	5
  1487                          ;
  1488                          ; FCB EQU	5CH
  1489                          ; DSKBUF EQU	80H
  1490                          ;
  1491                          ; FCBSIZ EQU	128+36+2
  1492                          ;
  1493  085a  0a                TRPCNT:	DEFB	10
  1494  085b  0000000000000000  TABLE:	DEFS	16		;FILE BLOCK POINTERS
              0000000000000000  
  1495  086b  00                FLAGS:	DEFB	0
  1496  086c  00                INKEY:	DEFB	0
  1497  086d  0000              EDPTR:	DEFW	0
  1498  086f  00                OPTVAL:	DEFB	0
  1499                          INILEN	EQU	$-TABLE
  1500                          ;
  1501                          FIN: ; END
  1502                          
