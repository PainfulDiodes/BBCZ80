asm/ACORN.asm:
     1                          	; TITLE COPYRIGHT (C) R.T.RUSSELL 1983-2024
     2                          	INCLUDE "constants.inc"
asm/constants.inc:
     1                          ; BBC BASIC Z80 - Shared Constants
     2                          ; Extracted from source modules to avoid duplicate definitions
     3                          
     4                          ; ASCII control characters
     5                          LF      EQU     0AH
     6                          CR      EQU     0DH
     7                          ; Note: ESC conflicts with label in AMOS.Z80, not included
     8                          BEL     EQU     7
     9                          BS      EQU     8
    10                          HT      EQU     9
    11                          VT      EQU     0BH
    12                          ; Note: DEL conflicts with label in MAIN.Z80, not included
    13                          
    14                          ; CP/M system addresses
    15                          ; Note: BDOS conflicts with label in DIST.Z80, not included
    16                          FCB     EQU     5CH
    17                          DSKBUF  EQU     80H
    18                          FCBSIZ  EQU     128+36+2
    19                          
    20                          ; Token values
    21                          TAND    EQU     80H
    22                          TOR     EQU     84H
    23                          TBY     EQU     0FH
    24                          TERROR  EQU     85H
    25                          TLINE   EQU     86H
    26                          TOFF    EQU     87H
    27                          TSTEP   EQU     88H
    28                          TSPC    EQU     89H
    29                          TTAB    EQU     8AH
    30                          TELSE   EQU     8BH
    31                          TTHEN   EQU     8CH
    32                          TLINO   EQU     8DH
    33                          TTO     EQU     0B8H
    34                          TCASE   EQU     0C8H
    35                          TWHILE  EQU     0C7H
    36                          TWHEN   EQU     0C9H
    37                          TOF     EQU     0CAH
    38                          TENDCASE EQU    0CBH
    39                          TOTHERWISE EQU  0CCH
    40                          TENDIF  EQU     0CDH
    41                          TENDWHILE EQU   0CEH
    42                          TCALL   EQU     0D6H
    43                          TDATA   EQU     0DCH
    44                          TDEF    EQU     0DDH
    45                          TDIM    EQU     0DEH
    46                          TEND    EQU     0E0H
    47                          TFOR    EQU     0E3H
    48                          TGOSUB  EQU     0E4H
    49                          TGOTO   EQU     0E5H
    50                          TIF     EQU     0E7H
    51                          TLOCAL  EQU     0EAH
    52                          TMODE   EQU     0EBH
    53                          TNEXT   EQU     0EDH
    54                          TON     EQU     0EEH
    55                          TPROC   EQU     0F2H
    56                          TREM    EQU     0F4H
    57                          TREPEAT EQU     0F5H
    58                          TREPORT EQU     0F6H
    59                          TRESTORE EQU    0F7H
    60                          TRETURN EQU     0F8H
    61                          TSTOP   EQU     0FAH
    62                          TTRACE  EQU     0FCH
    63                          TUNTIL  EQU     0FDH
    64                          TWIDTH  EQU     0FEH
    65                          TEXIT   EQU     10H
    66                          
    67                          ; Error codes
    68                          BADOP   EQU     1
    69                          DIVBY0  EQU     18
    70                          ; Note: TOOBIG conflicts with label in MAIN.Z80, not included
    71                          NGROOT  EQU     21
    72                          LOGRNG  EQU     22
    73                          ACLOST  EQU     23
    74                          EXPRNG  EQU     24
    75                          
asm/ACORN.asm:
     3                          ;
     4                          ;PATCH FOR BBC BASIC TO CP/M 2.2 & 3.0
     5                          ;* ACORN COMPUTERS Z80 TUBE VERSION  *
     6                          ;(C) COPYRIGHT R.T.RUSSELL, 02-01-1984
     7                          ;VERSION 5.0, 12-07-2024
     8                          ;
     9                          OSWRCH	EQU	0FFEEH
    10                          OSWORD	EQU	0FFF1H
    11                          OSBYTE	EQU	0FFF4H
    12                          ;
    13                          ESC	EQU	1BH
    14                          ; TBY EQU	0FH
    15                          ; TTO EQU	0B8H
    16                          TFILL	EQU	03H
    17                          ;
    18                          	EXTERN ITEMI
    19                          	EXTERN EXPRI
    20                          	EXTERN COMMA
    21                          	EXTERN TERMQ
    22                          	EXTERN BRAKET
    23                          	EXTERN EXTERR
    24                          	EXTERN STOREN
    25                          	EXTERN TRAP
    26                          	EXTERN VAR
    27                          	EXTERN NXT
    28                          	EXTERN XEQ
    29                          ;
    30                          	EXTERN ACCS
    31                          	EXTERN COUNT
    32                          	EXTERN WIDTH
    33                          	EXTERN SCRAP
    34                          ;
    35                          	PUBLIC OSCALL
    36                          	PUBLIC CLRSCN
    37                          	PUBLIC PUTCSR
    38                          	PUBLIC GETCSR
    39                          	PUBLIC PUTIME
    40                          	PUBLIC GETIME
    41                          	PUBLIC OSKEY
    42                          ;
    43                          	PUBLIC CLG
    44                          	PUBLIC MOVE
    45                          	PUBLIC DRAW
    46                          	PUBLIC PLOT
    47                          	PUBLIC MODE
    48                          	PUBLIC COLOUR
    49                          	PUBLIC GCOL
    50                          	PUBLIC ADVAL
    51                          	PUBLIC SOUND
    52                          	PUBLIC ENVEL
    53                          	PUBLIC POINT
    54                          ;
    55                          	PUBLIC CIRCLE
    56                          	PUBLIC ELLIPS
    57                          	PUBLIC FILL
    58                          	PUBLIC MOUSE
    59                          	PUBLIC ORIGIN
    60                          	PUBLIC RECTAN
    61                          	PUBLIC LINE
    62                          	PUBLIC TINT
    63                          	PUBLIC WAIT
    64                          	PUBLIC SYS
    65                          	PUBLIC CSRON
    66                          	PUBLIC CSROFF
    67                          ;
    68                          	PUBLIC PUTIMS
    69                          	PUBLIC GETIMS
    70                          	PUBLIC TINTFN
    71                          	PUBLIC MODEFN
    72                          	PUBLIC WIDFN
    73                          ;
    74                          ;GETIME	- Read elapsed-time clock.
    75                          ;  	  Outputs:  DEHL = elapsed time (centiseconds)
    76                          ; 	  Destroys: A,D,E,H,L,F
    77                          ;
    78  0000  3e01              GETIME:	LD	A,1
    79  0002  210000            	LD	HL,SCRAP
    80  0005  cdf1ff            	CALL	OSWORD
    81  0008  210000            	LD	HL,SCRAP
    82  000b  5e                	LD	E,(HL)
    83  000c  23                	INC	HL
    84  000d  56                	LD	D,(HL)
    85  000e  23                	INC	HL
    86  000f  7e                	LD	A,(HL)
    87  0010  23                	INC	HL
    88  0011  66                	LD	H,(HL)
    89  0012  6f                	LD	L,A
    90  0013  eb                	EX	DE,HL
    91  0014  c9                	RET
    92                          ;
    93                          ;GETIMS	- Read real-time clock as string.
    94                          ;  	  Outputs:  TIME$ in string accumulator
    95                          ;                   E = string length (25)
    96                          ; 	  Destroys: A,B,C,D,E,H,L,F
    97                          ;
    98  0015  3e0e              GETIMS:	LD	A,14
    99  0017  210000            	LD	HL,SCRAP
   100  001a  3600              	LD	(HL),0
   101  001c  cdf1ff            	CALL	OSWORD
   102  001f  210000            	LD	HL,SCRAP
   103  0022  110000            	LD	DE,ACCS
   104  0025  7e                	LD	A,(HL)
   105  0026  bb                	CP	E
   106  0027  c8                	RET	Z
   107  0028  011900            	LD	BC,25
   108  002b  edb0              	LDIR
   109  002d  c9                	RET
   110                          ;
   111                          ;
   112                          ;PUTIME	- Load elapsed-time clock.
   113                          ;   	  Inputs:   DEHL = time to load (centiseconds)
   114                          ; 	  Destroys: A,D,E,H,L,F
   115                          ;
   116  002e  dde5              PUTIME:	PUSH	IX
   117  0030  dd210000          	LD	IX,SCRAP
   118  0034  dd7500            	LD	(IX+0),L
   119  0037  dd7401            	LD	(IX+1),H
   120  003a  dd7302            	LD	(IX+2),E
   121  003d  dd7203            	LD	(IX+3),D
   122  0040  3e02              	LD	A,2
   123  0042  210000            	LD	HL,SCRAP
   124  0045  cdf1ff            	CALL	OSWORD
   125  0048  dde1              	POP	IX
   126  004a  c9                	RET
   127                          ;
   128                          ;PUTIMS	- Wtite real-time clock as string.
   129                          ;  	  Inputs:   string in string accumulator
   130                          ;                   E = string length
   131                          ; 	  Destroys: A,B,C,D,E,H,L,F
   132                          ;
   133  004b  7b                PUTIMS:	LD	A,E		;Length
   134  004c  fe1a              	CP	26
   135  004e  d0                	RET	NC
   136  004f  0600              	LD	B,0
   137  0051  4f                	LD	C,A
   138  0052  110100            	LD	DE,SCRAP+1
   139  0055  210000            	LD	HL,ACCS
   140  0058  edb0              	LDIR
   141  005a  210000            	LD	HL,SCRAP
   142  005d  77                	LD	(HL),A
   143  005e  3e0f              	LD	A,15
   144  0060  c3f1ff            	JP	OSWORD
   145                          ;
   146                          ;
   147                          ;CLRSCN	- Clear screen.
   148                          ; 	  Destroys: A,D,E,H,L,F
   149                          ;
   150  0063  3e0c              CLRSCN:	LD	A,0CH
   151  0065  c3eeff            	JP	OSWRCH
   152                          ;
   153                          ;
   154                          ;OSKEY	- Sample keyboard with specified wait.
   155                          ;   	  Inputs:   HL = Time to wait (centiseconds)
   156                          ;  	  Outputs:  Carry reset indicates time-out.
   157                          ;                   If carry set, A = character typed.
   158                          ; 	  Destroys: A,D,E,H,L,F
   159                          ;
   160  0068  3e81              OSKEY:	LD	A,129
   161  006a  cdf4ff            	CALL	OSBYTE
   162  006d  7c                	LD	A,H
   163  006e  b7                	OR	A
   164  006f  c0                	RET	NZ		;TIME-OUT, CARRY RESET
   165  0070  7d                	LD	A,L
   166  0071  37                	SCF
   167  0072  c9                	RET			;NORMAL, CARRY SET
   168                          ;
   169                          ;PUTCSR	- Move cursor to specified position.
   170                          ;   	  Inputs:   DE = horizontal position (LHS=0)
   171                          ;                   HL = vertical position (TOP=0)
   172                          ; 	  Destroys: A,D,E,H,L,F
   173                          ;
   174  0073  3e1f              PUTCSR:	LD	A,1FH
   175  0075  cdeeff            	CALL	OSWRCH
   176  0078  7b                	LD	A,E
   177  0079  cdeeff            	CALL	OSWRCH
   178  007c  7d                	LD	A,L
   179  007d  c3eeff            	JP	OSWRCH
   180                          ;
   181                          ;GETCSR	- Return cursor coordinates.
   182                          ;   	  Outputs:  DE = X coordinate (POS)
   183                          ;                   HL = Y coordinate (VPOS)
   184                          ;  	  Destroys: A,D,E,H,L,F
   185                          ;
   186  0080  3e86              GETCSR:	LD	A,134
   187  0082  cdf4ff            	CALL	OSBYTE
   188  0085  5d                	LD	E,L
   189  0086  6c                	LD	L,H
   190  0087  1600              	LD	D,0
   191  0089  62                	LD	H,D
   192  008a  c9                	RET
   193                          ;
   194                          ;POINT - var=POINT(x,y)
   195                          ;
   196  008b  cd0000            POINT:	CALL	EXPRI
   197  008e  d9                	EXX
   198  008f  e5                	PUSH	HL
   199  0090  cdc803            	CALL	CEXPRI
   200  0093  d9                	EXX
   201  0094  d1                	POP	DE
   202  0095  cd0000            	CALL	BRAKET
   203  0098  dd210000          	LD	IX,SCRAP
   204  009c  dd7300            	LD	(IX+0),E
   205  009f  dd7201            	LD	(IX+1),D
   206  00a2  dd7502            	LD	(IX+2),L
   207  00a5  dd7403            	LD	(IX+3),H
   208  00a8  210000            	LD	HL,SCRAP
   209  00ab  3e09              	LD	A,9
   210  00ad  cdf1ff            	CALL	OSWORD
   211  00b0  dd7e04            	LD	A,(IX+4)
   212  00b3  6f                	LD	L,A
   213  00b4  c601              	ADD	A,1
   214  00b6  9f                	SBC	A,A
   215  00b7  67                	LD	H,A
   216  00b8  d9                RETEXX:	EXX
   217  00b9  67                	LD	H,A
   218  00ba  6f                	LD	L,A
   219  00bb  af                	XOR	A
   220  00bc  4f                	LD	C,A
   221  00bd  c9                	RET
   222                          ;
   223                          ;ADVAL - var=ADVAL(n)
   224                          ;
   225  00be  cd0000            ADVAL:	CALL	ITEMI
   226  00c1  d9                	EXX
   227  00c2  3e80              	LD	A,128
   228  00c4  cdf4ff            	CALL	OSBYTE
   229  00c7  af                	XOR	A
   230  00c8  18ee              	JR	RETEXX
   231                          ;
   232                          ;MODEFN - var=MODE
   233                          ;
   234  00ca  3e87              MODEFN:	LD	A,135
   235  00cc  cdf4ff            	CALL	OSBYTE
   236  00cf  6c                	LD	L,H
   237  00d0  af                RETU8:	XOR	A
   238  00d1  67                	LD	H,A
   239  00d2  18e4              	JR	RETEXX
   240                          ;
   241                          ;WIDFN - var=WIDTH
   242                          ;
   243  00d4  3a0000            WIDFN:	LD	A,(WIDTH)
   244  00d7  6f                	LD	L,A
   245  00d8  18f6              	JR	RETU8
   246                          ;
   247                          ;ENVEL - ENVELOPE var,var,var,var,var,var,var,
   248                          ;                 var,var,var,var,var,var,var
   249                          ;
   250  00da  0600              ENVEL:	LD	B,0
   251  00dc  dd210000          	LD	IX,SCRAP
   252  00e0  c5                	PUSH	BC
   253  00e1  dde5              	PUSH	IX
   254  00e3  cd0000            ENVEL1:	CALL	EXPRI
   255  00e6  d9                	EXX
   256  00e7  dde1              	POP	IX
   257  00e9  c1                	POP	BC
   258  00ea  dd7500            	LD	(IX),L
   259  00ed  78                	LD	A,B
   260  00ee  fe0d              	CP	13
   261  00f0  280b              	JR	Z,ENVEL2
   262  00f2  04                	INC	B
   263  00f3  dd23              	INC	IX
   264  00f5  c5                	PUSH	BC
   265  00f6  dde5              	PUSH	IX
   266  00f8  cd0000            	CALL	COMMA
   267  00fb  18e6              	JR	ENVEL1
   268  00fd  210000            ENVEL2:	LD	HL,SCRAP
   269  0100  3e08              	LD	A,8
   270  0102  cdf1ff            	CALL	OSWORD
   271  0105  c30000            	JP	XEQ
   272                          ;
   273                          ;SOUND - SOUND var,var,var,var
   274                          ;
   275  0108  0600              SOUND:	LD	B,0
   276  010a  dd210000          	LD	IX,SCRAP
   277  010e  c5                	PUSH	BC
   278  010f  dde5              	PUSH	IX
   279  0111  cd0000            SOUND1:	CALL	EXPRI
   280  0114  d9                	EXX
   281  0115  dde1              	POP	IX
   282  0117  c1                	POP	BC
   283  0118  dd7500            	LD	(IX+0),L
   284  011b  dd7401            	LD	(IX+1),H
   285  011e  dd23              	INC	IX
   286  0120  dd23              	INC	IX
   287  0122  04                	INC	B
   288  0123  04                	INC	B
   289  0124  78                	LD	A,B
   290  0125  fe08              	CP	8
   291  0127  2808              	JR	Z,SOUND2
   292  0129  c5                	PUSH	BC
   293  012a  dde5              	PUSH	IX
   294  012c  cd0000            	CALL	COMMA
   295  012f  18e0              	JR	SOUND1
   296  0131  210000            SOUND2:	LD	HL,SCRAP
   297  0134  3e07              	LD	A,7
   298  0136  cdf1ff            	CALL	OSWORD
   299  0139  c30000            	JP	XEQ
   300                          ;
   301                          ;MODE - MODE n
   302                          ;
   303  013c  cd0000            MODE:	CALL	EXPRI
   304  013f  af                	XOR	A
   305  0140  320000            	LD	(COUNT),A
   306  0143  d9                	EXX
   307  0144  65                	LD	H,L
   308  0145  2e16              	LD	L,22
   309  0147  cdaf03            	CALL	WRCH2
   310  014a  1872              	JR	XEQGO1
   311                          ;
   312                          ;CLG
   313                          ;
   314  014c  3e10              CLG:	LD	A,16
   315  014e  cdeeff            	CALL	OSWRCH
   316  0151  186b              	JR	XEQGO1
   317                          ;
   318                          ;ORIGIN x,y
   319                          ;
   320  0153  cd0000            ORIGIN: CALL    EXPRI
   321  0156  d9                        EXX
   322  0157  e5                	PUSH	HL
   323  0158  cdc803                    CALL    CEXPRI
   324  015b  d9                	EXX
   325  015c  d1                        POP	DE
   326  015d  0e1d              	LD	C,29
   327  015f  cda303            	CALL	WRCH5
   328  0162  185a                      JR	XEQGO1
   329                          ;
   330                          ;COLOUR n
   331                          ;COLOUR n,p
   332                          ;COLOUR n,r,g,b
   333                          ;
   334  0164  cd0000            COLOUR:	CALL	EXPRI		;n
   335  0167  d9                	EXX
   336  0168  fd7e00            	LD	A,(IY)
   337  016b  fe2c              	CP	','
   338  016d  2808                      JR      Z,PALCOL
   339  016f  65                	LD	H,L
   340  0170  2e11              	LD	L,17
   341  0172  cdaf03            	CALL	WRCH2
   342  0175  1847              	JR	XEQGO1
   343                          ;
   344  0177  e5                PALCOL:	PUSH	HL
   345  0178  cdc803            	CALL	CEXPRI		;p or r
   346  017b  d9                	EXX
   347  017c  eb                	EX	DE,HL
   348  017d  210000            	LD	HL,0
   349  0180  fd7e00            	LD	A,(IY)
   350  0183  fe2c              	CP	','
   351  0185  2015              	JR	NZ,PALET1
   352  0187  d5                	PUSH	DE
   353  0188  cdc803            	CALL	CEXPRI		;g
   354  018b  d9                	EXX
   355  018c  e5                	PUSH	HL
   356  018d  cdc803            	CALL	CEXPRI		;b
   357  0190  d9                	EXX
   358  0191  d1                	POP	DE
   359  0192  c1                	POP	BC
   360  0193  7d                	LD	A,L
   361  0194  e1                	POP	HL
   362  0195  51                	LD	D,C		;r
   363  0196  4d                	LD	C,L		;n
   364  0197  6b                	LD	L,E		;g
   365  0198  67                	LD	H,A		;b
   366  0199  1e10              	LD	E,16
   367  019b  c5                	PUSH	BC
   368  019c  c1                PALET1:	POP	BC
   369  019d  0613              	LD	B,19
   370  019f  cd9f03            	CALL	WRCH6
   371  01a2  181a              	JR	XEQGO1
   372                          ;
   373                          ;GCOL [a,]b
   374                          ;
   375  01a4  cd0000            GCOL:	CALL	EXPRI
   376  01a7  d9                	EXX
   377  01a8  1e00              	LD	E,0
   378  01aa  fd7e00            	LD	A,(IY)
   379  01ad  fe2c              	CP	','
   380  01af  2006              	JR	NZ,GCOL0
   381  01b1  e5                	PUSH	HL
   382  01b2  cdc803            	CALL	CEXPRI
   383  01b5  d9                	EXX
   384  01b6  d1                	POP	DE
   385  01b7  65                GCOL0:	LD	H,L
   386  01b8  6b                	LD	L,E
   387  01b9  1612              	LD	D,18
   388  01bb  cdab03            	CALL	WRCH3		;DLH
   389  01be  c30000            XEQGO1:	JP	XEQ
   390                          ;
   391                          ;CSRON  - Turn caret on
   392                          ;CSROFF - Turn caret off
   393                          ;
   394  01c1  0e01              CSRON:	LD	C,1
   395  01c3  1802              	JR	CSRGO
   396                          ;
   397  01c5  0e00              CSROFF:	LD	C,0
   398  01c7  3e17              CSRGO:	LD	A,23
   399  01c9  cdeeff            	CALL	OSWRCH
   400  01cc  3e01              	LD	A,1
   401  01ce  cdeeff            	CALL	OSWRCH
   402  01d1  79                	LD	A,C
   403  01d2  0608              	LD	B,8
   404  01d4  cdeeff            CSRGO1:	CALL	OSWRCH
   405  01d7  af                	XOR	A
   406  01d8  10fa              	DJNZ	CSRGO1
   407  01da  18e2              	JR	XEQGO1
   408                          ;
   409                          ;LINE x1,y1,x2,y2
   410                          ;
   411  01dc  cd0000            LINE:	CALL	EXPRI
   412  01df  d9                	EXX
   413  01e0  e5                	PUSH	HL
   414  01e1  cdb703            	CALL	EXPR3
   415  01e4  e3                	EX	(SP),HL		;HL <- x1, (SP) <- y2
   416  01e5  c5                	PUSH	BC
   417  01e6  eb                	EX	DE,HL
   418  01e7  0e04              	LD	C,4
   419  01e9  cd9d03            	CALL	VDU25
   420  01ec  d1                	POP	DE
   421  01ed  e1                	POP	HL
   422  01ee  0e05              	LD	C,5
   423  01f0  182a              	JR	PLOT4A
   424                          ;
   425                          ;CIRCLE [FILL] x,y,r
   426                          ;
   427  01f2  fe03              CIRCLE:	CP	TFILL
   428  01f4  f5                	PUSH	AF
   429  01f5  2002              	JR	NZ,CIRCL0
   430  01f7  fd23              	INC	IY
   431  01f9  cd0000            CIRCL0:	CALL	EXPRI
   432  01fc  d9                	EXX
   433  01fd  e5                	PUSH	HL
   434  01fe  cdc803            	CALL	CEXPRI
   435  0201  d9                	EXX
   436  0202  e5                	PUSH	HL
   437  0203  cdc803            	CALL	CEXPRI
   438  0206  d9                	EXX
   439  0207  c1                	POP	BC		;y
   440  0208  d1                	POP	DE		;x
   441  0209  e5                	PUSH	HL
   442  020a  69                	LD	L,C
   443  020b  60                	LD	H,B
   444  020c  0e04              	LD	C,4		; PLOT 4 = MOVE
   445  020e  cd9d03            	CALL	VDU25
   446  0211  d1                	POP	DE		;r
   447  0212  210000            	LD	HL,0
   448  0215  f1                        POP	AF
   449  0216  0e91              	LD	C,145		; PLOT 145 = outline circle
   450  0218  2002              	JR	NZ,PLOT4A
   451  021a  0e99              	LD	C,153		; PLOT 153 = filled circle
   452  021c  186c              PLOT4A:	JR	PLOT4
   453                          ;
   454                          ;ELLIPSE [FILL] x,y,a,b
   455                          ;
   456  021e  fe03              ELLIPS:	CP	TFILL
   457  0220  f5                	PUSH	AF
   458  0221  2002              	JR	NZ,ELLIP0
   459  0223  fd23              	INC	IY
   460  0225  cd0000            ELLIP0:	CALL	EXPRI
   461  0228  d9                	EXX
   462  0229  e5                	PUSH	HL
   463  022a  cdb703            	CALL	EXPR3
   464  022d  e3                	EX	(SP),HL		;HL <- x, (SP) <- b
   465  022e  c5                	PUSH	BC
   466  022f  eb                	EX	DE,HL
   467  0230  0e04              	LD	C,4		; PLOT 4 = Move absolute
   468  0232  cd9d03            	CALL	VDU25
   469  0235  d1                	POP	DE		;a
   470  0236  d5                	PUSH	DE
   471  0237  210000            	LD	HL,0
   472  023a  4d                	LD	C,L		; PLOT 0 - Move relative
   473  023b  cd9d03            	CALL	VDU25
   474  023e  d1                        POP	DE		;a
   475  023f  af                	XOR	A
   476  0240  6f                	LD	L,A
   477  0241  67                	LD	H,A
   478  0242  ed52              	SBC	HL,DE
   479  0244  eb                	EX	DE,HL
   480  0245  e1                	POP	HL		;b
   481  0246  f1                	POP	AF
   482  0247  0ec1              	LD	C,193		; PLOT 193 = outline ellipse
   483  0249  203f              	JR	NZ,PLOT4
   484  024b  0ec9              	LD	C,201		; PLOT 201 = filled ellipse
   485  024d  183b              	JR	PLOT4
   486                          ;
   487                          ;MOVE [BY} x,y
   488                          ;DRAW [BY] x,y
   489                          ;PLOT [BY] [n,]x,y
   490                          ;FILL [BY] x,y
   491                          ;
   492  024f  0e04              MOVE:	LD	C,4
   493  0251  1823              	JR	PLOT1
   494                          ;
   495  0253  0e05              DRAW:	LD	C,5
   496  0255  181f              	JR	PLOT1
   497                          ;
   498  0257  0e85              FILL:	LD	C,133
   499  0259  181b              	JR	PLOT1
   500                          ;
   501  025b  0e45              PLOT:	LD	C,69
   502  025d  fe0f              	CP	TBY
   503  025f  2815              	JR	Z,PLOT1
   504  0261  cd0000            	CALL	EXPRI
   505  0264  d9                	EXX
   506  0265  e5                	PUSH	HL
   507  0266  cdc803            	CALL	CEXPRI
   508  0269  d9                	EXX
   509  026a  fd7e00            	LD	A,(IY)
   510  026d  fe2c              	CP	','
   511  026f  2812              	JR	Z,PLOT3
   512  0271  d1                	POP	DE
   513  0272  0e45              	LD	C,69
   514  0274  1814              	JR	PLOT4
   515                          ;
   516  0276  fe0f              PLOT1:	CP	TBY
   517  0278  2004              	JR	NZ,PLOT2
   518  027a  fd23              	INC	IY
   519  027c  cb91              	RES	2,C		;Change absolute to relative
   520  027e  c5                PLOT2:	PUSH	BC
   521  027f  cd0000            	CALL	EXPRI
   522  0282  d9                	EXX
   523  0283  e5                PLOT3:	PUSH	HL
   524  0284  cdc803            	CALL	CEXPRI
   525  0287  d9                	EXX
   526  0288  d1                	POP	DE
   527  0289  c1                	POP	BC
   528  028a  cd9d03            PLOT4:	CALL	VDU25
   529  028d  c30000            	JP	XEQ
   530                          ;
   531                          ;RECTANGLE [FILL] x,y,w[,h] [TO xnew,ynew]
   532                          ;
   533  0290  fe03              RECTAN:	CP	TFILL
   534  0292  f5                	PUSH	AF
   535  0293  2002              	JR	NZ,RECT0
   536  0295  fd23              	INC	IY
   537  0297  cd0000            RECT0:	CALL	EXPRI
   538  029a  d9                	EXX
   539  029b  e5                	PUSH	HL
   540  029c  cdc803            	CALL	CEXPRI
   541  029f  d9                	EXX
   542  02a0  e5                	PUSH	HL
   543  02a1  cdc803            	CALL	CEXPRI
   544  02a4  d9                	EXX
   545  02a5  e5                	PUSH	HL
   546  02a6  fd7e00            	LD	A,(IY)
   547  02a9  fe2c              	CP	','
   548  02ab  2004              	JR	NZ,RECT1
   549  02ad  cdc803            	CALL	CEXPRI
   550  02b0  d9                	EXX
   551  02b1  c1                RECT1:	POP	BC		;w
   552  02b2  d1                	POP	DE		;y
   553  02b3  e3                	EX	(SP),HL		;HL <- x, (SP) <- h
   554  02b4  c5                	PUSH	BC
   555  02b5  eb                	EX	DE,HL
   556  02b6  0e04              	LD	C,4
   557  02b8  cd9d03            	CALL	VDU25
   558  02bb  fd7e00            	LD	A,(IY)
   559  02be  feb8              	CP	TTO
   560  02c0  2809              	JR	Z,RECTTO
   561  02c2  d1                	POP	DE		;w
   562  02c3  e1                	POP	HL		;h
   563  02c4  f1                	POP	AF
   564  02c5  2022              	JR	NZ,OUTLIN
   565  02c7  0e61              	LD	C,97
   566  02c9  18bf              	JR	PLOT4
   567                          ;
   568                          ;Block copy / move:
   569                          ;
   570  02cb  fd23              RECTTO:	INC	IY		; Bump over TO
   571  02cd  cd0000            	CALL	EXPRI
   572  02d0  d9                	EXX
   573  02d1  e5                	PUSH	HL
   574  02d2  cdc803            	CALL	CEXPRI
   575  02d5  d9                	EXX
   576  02d6  c1                	POP	BC		;newx
   577  02d7  d1                	POP	DE		;w
   578  02d8  e3                	EX	(SP),HL		;HL <- h, (SP) <- newy
   579  02d9  c5                	PUSH	BC
   580  02da  0e00              	LD	C,0
   581  02dc  cd9d03            	CALL	VDU25
   582  02df  d1                	POP	DE		;newx
   583  02e0  e1                	POP	HL		;newy
   584  02e1  f1                	POP	AF
   585  02e2  0ebe              	LD	C,190		; PLOT 190 - Block copy
   586  02e4  2001              	JR	NZ,PLOT4B
   587  02e6  0d                	DEC	C		; PLOT 189 - Block move
   588  02e7  18a1              PLOT4B:	JR	PLOT4
   589                          ;
   590                          ;Outline rectangle:
   591                          ;
   592  02e9  0e09              OUTLIN:	LD	C,9		; PLOT 9 - draw relative
   593  02eb  e5                	PUSH	HL
   594  02ec  210000            	LD	HL,0
   595  02ef  cd9d03            	CALL	VDU25		; side 1
   596  02f2  e1                	POP	HL
   597  02f3  d5                	PUSH	DE
   598  02f4  110000            	LD	DE,0
   599  02f7  cd9d03            	CALL	VDU25		; side 2
   600  02fa  d1                	POP	DE
   601  02fb  e5                	PUSH	HL
   602  02fc  af                	XOR	A
   603  02fd  6f                	LD	L,A
   604  02fe  67                	LD	H,A
   605  02ff  ed52              	SBC	HL,DE
   606  0301  eb                	EX	DE,HL
   607  0302  6f                	LD	L,A
   608  0303  67                	LD	H,A
   609  0304  cd9d03            	CALL 	VDU25		; side 3
   610  0307  d1                	POP	DE
   611  0308  af                	XOR	A
   612  0309  6f                	LD	L,A
   613  030a  67                	LD	H,A
   614  030b  ed52              	SBC	HL,DE
   615  030d  5f                	LD	E,A
   616  030e  57                	LD	D,A
   617  030f  18d6              	JR	PLOT4B
   618                          ;
   619                          ;MOUSE x, y, b
   620                          ;
   621  0311  3e80              MOUSE:	LD	A,128
   622  0313  210900            	LD	HL,9
   623  0316  cdf4ff            	CALL	OSBYTE
   624  0319  e5                	PUSH	HL
   625  031a  3e80              	LD	A,128
   626  031c  210800            	LD	HL,8
   627  031f  cdf4ff            	CALL	OSBYTE
   628  0322  e5                	PUSH	HL
   629  0323  3e80              	LD	A,128
   630  0325  210700            	LD	HL,7
   631  0328  cdf4ff            	CALL	OSBYTE
   632  032b  e5                	PUSH	HL
   633  032c  cd0000            	CALL	VAR
   634  032f  e1                	POP	HL
   635  0330  cdce03            	CALL	STOREI
   636  0333  cd0000            	CALL	COMMA
   637  0336  cd0000            	CALL	NXT
   638  0339  cd0000            	CALL	VAR
   639  033c  e1                	POP	HL
   640  033d  cdce03            	CALL	STOREI
   641  0340  cd0000            	CALL	COMMA
   642  0343  cd0000            	CALL	NXT
   643  0346  cd0000            	CALL	VAR
   644  0349  e1                	POP	HL
   645  034a  cdce03            	CALL	STOREI
   646  034d  c30000            XEQGO2:	JP	XEQ
   647                          ;
   648                          ;WAIT [n]
   649                          ;
   650  0350  cd0000            WAIT:	CALL	TERMQ
   651  0353  28f8              	JR	Z,XEQGO2
   652  0355  cd0000            	CALL	EXPRI
   653  0358  d9                	EXX
   654  0359  44                	LD	B,H
   655  035a  4d                	LD	C,L
   656  035b  cd0000            	CALL	GETIME
   657  035e  09                	ADD	HL,BC
   658  035f  010000            	LD	BC,0
   659  0362  eb                	EX	DE,HL
   660  0363  ed4a              	ADC	HL,BC
   661  0365  eb                	EX	DE,HL
   662  0366  cd0000            WAIT1:	CALL	TRAP
   663  0369  d5                	PUSH	DE
   664  036a  e5                	PUSH	HL
   665  036b  cd0000            	CALL	GETIME
   666  036e  c1                	POP	BC
   667  036f  b7                	OR	A
   668  0370  ed42              	SBC	HL,BC
   669  0372  60                	LD	H,B
   670  0373  69                	LD	L,C
   671  0374  eb                	EX	DE,HL
   672  0375  c1                	POP	BC
   673  0376  ed42              	SBC	HL,BC
   674  0378  30d3              	JR	NC,XEQGO2
   675  037a  eb                	EX	DE,HL
   676  037b  50                	LD	D,B
   677  037c  59                	LD	E,C
   678  037d  18e7              	JR	WAIT1
   679                          ;
   680                          ;OSCALL - Trap call to FFxx
   681                          ;
   682  037f  e1                OSCALL:	POP	HL		;DITCH RETURN ADDRESS
   683  0380  219203            	LD	HL,OSRET
   684  0383  e5                	PUSH	HL		;NEW RETURN ADDRESS
   685  0384  dd7e04            	LD	A,(IX+4)	;A%
   686  0387  dd5e14            	LD	E,(IX+20)	;E%
   687  038a  dd6664            	LD	H,(IX+100)	;Y%
   688  038d  dd6e60            	LD	L,(IX+96)	;X%
   689  0390  fde9              	JP	(IY)
   690  0392  f5                OSRET:	PUSH	AF
   691  0393  7d                	LD	A,L		;F  H  L  A
   692  0394  6c                	LD	L,H		;|  |  |  |
   693  0395  d9                	EXX			;|  |  |  |
   694  0396  c1                	POP	BC		;|  |  |  |
   695  0397  67                	LD	H,A		;|  |  |  |
   696  0398  68                	LD	L,B		;H  L  H' L'
   697  0399  79                	LD	A,C
   698  039a  d9                	EXX
   699  039b  67                	LD	H,A
   700  039c  c9                	RET
   701                          ;
   702  039d  0619              VDU25:	LD	B,25
   703  039f  78                WRCH6:	LD	A,B
   704  03a0  cdeeff            	CALL	OSWRCH
   705  03a3  79                WRCH5:	LD	A,C
   706  03a4  cdeeff            	CALL	OSWRCH
   707  03a7  7b                WRCH4:	LD	A,E
   708  03a8  cdeeff            	CALL	OSWRCH
   709  03ab  7a                WRCH3:	LD	A,D
   710  03ac  cdeeff            	CALL	OSWRCH
   711  03af  7d                WRCH2:	LD	A,L
   712  03b0  cdeeff            	CALL	OSWRCH
   713  03b3  7c                	LD	A,H
   714  03b4  c3eeff            	JP	OSWRCH
   715                          ;
   716  03b7  cdc803            EXPR3:	CALL	CEXPRI
   717  03ba  d9                	EXX
   718  03bb  e5                	PUSH	HL
   719  03bc  cdc803            	CALL	CEXPRI
   720  03bf  d9                	EXX
   721  03c0  e5                	PUSH	HL
   722  03c1  cdc803            	CALL	CEXPRI
   723  03c4  d9                	EXX
   724  03c5  c1                	POP	BC		;x2
   725  03c6  d1                	POP	DE		;y1
   726  03c7  c9                	RET
   727                          ;
   728  03c8  cd0000            CEXPRI:	CALL	COMMA
   729  03cb  c30000            	JP	EXPRI
   730                          ;
   731  03ce  cb7f              STOREI:	BIT	7,A
   732  03d0  200c              	JR	NZ,EEK
   733  03d2  cb77              	BIT	6,A
   734  03d4  2008              	JR	NZ,EEK
   735  03d6  d9                	EXX
   736  03d7  210000            	LD	HL,0
   737  03da  4d                	LD	C,L
   738  03db  c30000            	JP	STOREN
   739                          ;
   740  03de  3e32              EEK:	LD	A,50
   741  03e0  cd0000            	CALL	EXTERR
   742  03e3  13                	DEFB	13H		;'Bad '
   743  03e4  04                	DEFB	04H		;'MOUSE'
   744  03e5  20                	DEFB	20H
   745  03e6  15                	DEFB	15H		;'variable'
   746  03e7  00                	DEFB	0
   747                          ;
   748                          TINT:
   749                          TINTFN:
   750                          SYS:
   751  03e8  af                	XOR	A
   752  03e9  cd0000            	CALL	EXTERR
   753  03ec  536f727279        	DEFM "Sorry"
   754  03f1  00                	DEFB	0
   755                          ;
   756                          	; END
   757                          
   758                          
