MAIN.asm:
     1                          	; TITLE BBC BASIC (C) R.T.RUSSELL 1981-2025
     2                          	INCLUDE "constants.inc"
constants.inc:
     1                          ; BBC BASIC Z80 - Shared Constants
     2                          ; Extracted from source modules to avoid duplicate definitions
     3                          
     4                          ; ASCII control characters
     5                          LF      EQU     0AH
     6                          CR      EQU     0DH
     7                          ; Note: ESC conflicts with label in AMOS.Z80, not included
     8                          BEL     EQU     7
     9                          BS      EQU     8
    10                          HT      EQU     9
    11                          VT      EQU     0BH
    12                          ; Note: DEL conflicts with label in MAIN.Z80, not included
    13                          
    14                          ; CP/M system addresses
    15                          ; Note: BDOS conflicts with label in DIST.Z80, not included
    16                          FCB     EQU     5CH
    17                          DSKBUF  EQU     80H
    18                          FCBSIZ  EQU     128+36+2
    19                          
    20                          ; Token values
    21                          TAND    EQU     80H
    22                          TOR     EQU     84H
    23                          TBY     EQU     0FH
    24                          TERROR  EQU     85H
    25                          TLINE   EQU     86H
    26                          TOFF    EQU     87H
    27                          TSTEP   EQU     88H
    28                          TSPC    EQU     89H
    29                          TTAB    EQU     8AH
    30                          TELSE   EQU     8BH
    31                          TTHEN   EQU     8CH
    32                          TLINO   EQU     8DH
    33                          TTO     EQU     0B8H
    34                          TCASE   EQU     0C8H
    35                          TWHILE  EQU     0C7H
    36                          TWHEN   EQU     0C9H
    37                          TOF     EQU     0CAH
    38                          TENDCASE EQU    0CBH
    39                          TOTHERWISE EQU  0CCH
    40                          TENDIF  EQU     0CDH
    41                          TENDWHILE EQU   0CEH
    42                          TCALL   EQU     0D6H
    43                          TDATA   EQU     0DCH
    44                          TDEF    EQU     0DDH
    45                          TDIM    EQU     0DEH
    46                          TEND    EQU     0E0H
    47                          TFOR    EQU     0E3H
    48                          TGOSUB  EQU     0E4H
    49                          TGOTO   EQU     0E5H
    50                          TIF     EQU     0E7H
    51                          TLOCAL  EQU     0EAH
    52                          TMODE   EQU     0EBH
    53                          TNEXT   EQU     0EDH
    54                          TON     EQU     0EEH
    55                          TPROC   EQU     0F2H
    56                          TREM    EQU     0F4H
    57                          TREPEAT EQU     0F5H
    58                          TREPORT EQU     0F6H
    59                          TRESTORE EQU    0F7H
    60                          TRETURN EQU     0F8H
    61                          TSTOP   EQU     0FAH
    62                          TTRACE  EQU     0FCH
    63                          TUNTIL  EQU     0FDH
    64                          TWIDTH  EQU     0FEH
    65                          TEXIT   EQU     10H
    66                          
    67                          ; Error codes
    68                          BADOP   EQU     1
    69                          DIVBY0  EQU     18
    70                          ; Note: TOOBIG conflicts with label in MAIN.Z80, not included
    71                          NGROOT  EQU     21
    72                          LOGRNG  EQU     22
    73                          ACLOST  EQU     23
    74                          EXPRNG  EQU     24
    75                          
MAIN.asm:
     3                          ;
     4                          ;BBC BASIC INTERPRETER - Z80 VERSION
     5                          ;COMMANDS AND COMMON MODULE - "MAIN"
     6                          ;(C) COPYRIGHT R.T.RUSSELL 1981-2025
     7                          ;
     8                          ;THE NAME BBC BASIC IS USED WITH THE PERMISSION
     9                          ;OF THE BRITISH BROADCASTING CORPORATION AND IS
    10                          ;NOT TRANSFERRABLE TO A FORKED OR DERIVED WORK.
    11                          ;
    12                          ;VERSION 2.3, 07-05-1984
    13                          ;VERSION 3.0, 01-03-1987
    14                          ;VERSION 5.0, 31-05-2024
    15                          ;VERSION 5.1, 10-08-2024
    16                          ;VERSION 5.2, 16-02-2025
    17                          ;
    18                          	EXTERN XEQ
    19                          	EXTERN RUN0
    20                          	EXTERN CHAIN0
    21                          	EXTERN TERMQ
    22                          	EXTERN MUL16
    23                          	EXTERN X14OR5
    24                          	EXTERN SPACES
    25                          	EXTERN ESCAPE
    26                          	EXTERN CHECK
    27                          	EXTERN SEARCH
    28                          ;
    29                          	EXTERN OSWRCH
    30                          	EXTERN OSLINE
    31                          	EXTERN OSINIT
    32                          	EXTERN OSLOAD
    33                          	EXTERN OSSAVE
    34                          	EXTERN OSBGET
    35                          	EXTERN OSBPUT
    36                          	EXTERN OSSHUT
    37                          	EXTERN OSSTAT
    38                          	EXTERN PROMPT
    39                          	EXTERN LTRAP
    40                          	EXTERN OSCLI
    41                          	EXTERN RESET
    42                          ;
    43                          	EXTERN COMMA
    44                          	EXTERN BRAKET
    45                          	EXTERN ZERO
    46                          	EXTERN ITEMI
    47                          	EXTERN EXPRI
    48                          	EXTERN EXPRS
    49                          	EXTERN DECODE
    50                          	EXTERN LOADN
    51                          	EXTERN SFIX
    52                          ;
    53                          	PUBLIC NXT
    54                          	PUBLIC NLIST
    55                          	PUBLIC START
    56                          	PUBLIC OUTCHR
    57                          	PUBLIC OUT
    58                          	PUBLIC ERROR
    59                          	PUBLIC EXTERR
    60                          	PUBLIC REPORT
    61                          	PUBLIC CLOOP
    62                          	PUBLIC WARM
    63                          	PUBLIC CLEAR
    64                          	PUBLIC CRLF
    65                          	PUBLIC SAYLN
    66                          	PUBLIC LOAD0
    67                          	PUBLIC TELL
    68                          	PUBLIC FINDL
    69                          	PUBLIC GETTOP
    70                          	PUBLIC SETLIN
    71                          	PUBLIC GETVAR
    72                          	PUBLIC PUTVAR
    73                          	PUBLIC GETDEF
    74                          	PUBLIC LOCATE
    75                          	PUBLIC CREATE
    76                          	PUBLIC PBCDL
    77                          	PUBLIC LEXAN2
    78                          	PUBLIC RANGE
    79                          	PUBLIC VERMSG
    80                          	PUBLIC KEYWDS
    81                          	PUBLIC KEYWDL
    82                          ;
    83                          	EXTERN PAGE
    84                          	EXTERN ACCS
    85                          	EXTERN BUFFER
    86                          	EXTERN LOMEM
    87                          	EXTERN HIMEM
    88                          	EXTERN COUNT
    89                          	EXTERN WIDTH
    90                          	EXTERN FREE
    91                          	EXTERN STAVAR
    92                          	EXTERN DYNVAR
    93                          	EXTERN ERRTXT
    94                          	EXTERN ERR
    95                          	EXTERN ERL
    96                          	EXTERN CURLIN
    97                          	EXTERN ERRTRP
    98                          	EXTERN ONERSP
    99                          	EXTERN FNPTR
   100                          	EXTERN PROPTR
   101                          	EXTERN AUTONO
   102                          	EXTERN INCREM
   103                          	EXTERN LISTON
   104                          	EXTERN TRACEN
   105                          ;
   106                          ; CR EQU	0DH
   107                          ; LF EQU	0AH
   108                          ESC	EQU	1BH
   109                          ;
   110                          ; TERROR EQU	85H
   111                          ; TLINE EQU	86H
   112                          ; TELSE EQU	8BH
   113                          ; TTHEN EQU	8CH
   114                          ; TLINO EQU	8DH
   115                          TFN	EQU	0A4H
   116                          ; TTO EQU	0B8H
   117                          ; TWHILE EQU	0C7H
   118                          ; TCASE EQU	0C8H
   119                          ; TWHEN EQU	0C9H
   120                          ; TOF EQU	0CAH
   121                          ; TENDCASE EQU	0CBH
   122                          ; TOTHERWISE EQU	0CCH
   123                          ; TENDIF EQU	0CDH
   124                          ; TENDWHILE EQU	0CEH
   125                          ; TDATA EQU	0DCH
   126                          ; TDIM EQU	0DEH
   127                          ; TFOR EQU	0E3H
   128                          ; TGOSUB EQU	0E4H
   129                          ; TGOTO EQU	0E5H
   130                          ; TIF EQU	0E7H
   131                          ; TLOCAL EQU	0EAH
   132                          ; TNEXT EQU	0EDH
   133                          ; TON EQU	0EEH
   134                          ; TPROC EQU	0F2H
   135                          ; TREM EQU	0F4H
   136                          ; TREPEAT EQU	0F5H
   137                          ; TRESTORE EQU	0F7H
   138                          ; TTRACE EQU	0FCH
   139                          ; TUNTIL EQU	0FDH
   140                          ; TEXIT EQU	10H
   141                          ;
   142                          TOKLO	EQU	8FH
   143                          TOKHI	EQU	93H
   144                          OFFSET	EQU	0CFH-TOKLO
   145                          ;
   146  0000  c32a00            START:	JP	COLD
   147  0003  c39800            	JP	WARM
   148  0006  c30000            	JP	ESCAPE
   149  0009  c33e08            	JP	EXTERR
   150  000c  c3e30d            	JP	TELL
   151  000f  c3d10d            	JP	TEXT
   152  0012  c30000            	JP	ITEMI
   153  0015  c30000            	JP	EXPRI
   154  0018  c30000            	JP	EXPRS
   155  001b  c30000            	JP	OSCLI
   156  001e  c30000            	JP	OSBGET
   157  0021  c30000            	JP	OSBPUT
   158  0024  c30000            	JP	OSSTAT
   159  0027  c30000            	JP	OSSHUT
   160  002a  210000            COLD:	LD	HL,STAVAR	;COLD START
   161  002d  f9                	LD	SP,HL
   162  002e  360a              	LD	(HL),10
   163  0030  2c                	INC	L
   164  0031  3609              	LD	(HL),9
   165  0033  2c                	INC	L
   166  0034  af                	XOR	A
   167  0035  77                PURGE:	LD	(HL),A		;CLEAR SCRATCHPAD
   168  0036  2c                	INC	L
   169  0037  20fc              	JR	NZ,PURGE
   170  0039  3e37              	LD	A,37H		;V3.0
   171  003b  320000            	LD	(LISTON),A
   172  003e  217700            	LD	HL,NOTICE
   173  0041  220000            	LD	(ERRTXT),HL
   174  0044  cd0000            	CALL	OSINIT
   175  0047  ed530000          	LD	(HIMEM),DE
   176  004b  220000            	LD	(PAGE),HL
   177  004e  cd2709            	CALL	NEWIT
   178  0051  c20000            	JP	NZ,CHAIN0	;AUTO-RUN
   179  0054  cde30d            	CALL	TELL
   180  0057  4242432042415349  VERMSG:	DEFM "BBC BASIC (Z80) Version 5.00  "
              4320285a38302920  
              56657273696f6e20  
              352e30302020      
   181  0075  0d                	DEFB	CR
   182  0076  0a                	DEFB	LF
   183  0077  28432920436f7079  NOTICE:	DEFM "(C) Copyright R.T.Russell 2025"
              726967687420522e  
              542e52757373656c  
              6c2032303235      
   184  0095  0d                	DEFB	CR
   185  0096  0a                	DEFB	LF
   186  0097  00                	DEFB	0
   187  0098  f6                WARM:	DEFB	0F6H
   188  0099  37                CLOOP:	SCF
   189  009a  ed7b0000          	LD	SP,(HIMEM)
   190  009e  cd0000            	CALL	PROMPT		;PROMPT USER
   191  00a1  210000            	LD	HL,LISTON
   192  00a4  7e                	LD	A,(HL)
   193  00a5  e60f              	AND	0FH		;LISTO
   194  00a7  f630              	OR	30H		;OPT 3
   195  00a9  77                	LD	(HL),A
   196  00aa  ed62              	SBC	HL,HL		;HL <- 0 (V3.0)
   197  00ac  220000            	LD	(ERRTRP),HL
   198  00af  220000            	LD	(ONERSP),HL
   199  00b2  220000            	LD	(CURLIN),HL	;For CMOS EDIT->LIST
   200  00b5  2a0000            	LD	HL,(AUTONO)
   201  00b8  e5                	PUSH	HL
   202  00b9  7c                	LD	A,H
   203  00ba  b5                	OR	L
   204  00bb  2817              	JR	Z,NOAUTO
   205  00bd  e5                	PUSH	HL
   206  00be  cd7f0a            	CALL	PBCD		;AUTO NUMBER
   207  00c1  e1                	POP	HL
   208  00c2  ed4b0000          	LD	BC,(INCREM)
   209  00c6  0600              	LD	B,0
   210  00c8  09                	ADD	HL,BC
   211  00c9  da980c            	JP	C,TOOBIG
   212  00cc  220000            	LD	(AUTONO),HL
   213  00cf  3e20              	LD	A,' '
   214  00d1  cdeb09            	CALL	OUTCHR
   215  00d4  210000            NOAUTO:	LD	HL,ACCS
   216  00d7  cd0000            	CALL	OSLINE		;GET CONSOLE INPUT
   217  00da  af                	XOR	A
   218  00db  320000            	LD	(COUNT),A
   219  00de  fd210000          	LD	IY,ACCS
   220  00e2  21ca04            	LD	HL,COMNDS
   221  00e5  cd8f08            	CALL	LEX0
   222  00e8  e1                	POP	HL
   223  00e9  2019              	JR	NZ,NOTCMD
   224  00eb  87                	ADD	A,A
   225  00ec  4f                	LD	C,A
   226  00ed  7c                	LD	A,H
   227  00ee  b5                	OR	L
   228  00ef  200f              	JR	NZ,INAUTO
   229  00f1  47                	LD	B,A
   230  00f2  21fa04            	LD	HL,CMDTAB
   231  00f5  09                	ADD	HL,BC
   232  00f6  7e                	LD	A,(HL)		;TABLE ENTRY
   233  00f7  23                	INC	HL
   234  00f8  66                	LD	H,(HL)
   235  00f9  6f                	LD	L,A
   236  00fa  fd23              	INC	IY
   237  00fc  cdf40d            	CALL	NXT
   238  00ff  e9                	JP	(HL)		;EXECUTE COMMAND
   239                          ;
   240  0100  fd210000          INAUTO:	LD	IY,ACCS
   241  0104  7c                NOTCMD:	LD	A,H
   242  0105  b5                	OR	L
   243  0106  cc730c            	CALL	Z,LINNUM
   244  0109  cdf40d            	CALL	NXT
   245  010c  110000            	LD	DE,BUFFER
   246  010f  0e01              	LD	C,1		;LEFT MODE
   247  0111  e5                	PUSH	HL
   248  0112  cd010d            	CALL	LEXAN2		;LEXICAL ANALYSIS
   249  0115  e1                	POP	HL
   250  0116  12                	LD	(DE),A		;TERMINATOR
   251  0117  af                	XOR	A
   252  0118  47                	LD	B,A
   253  0119  4b                	LD	C,E		;BC=LINE LENGTH
   254  011a  13                	INC	DE
   255  011b  12                	LD	(DE),A		;ZERO NEXT
   256  011c  7c                	LD	A,H
   257  011d  b5                	OR	L
   258  011e  fd210000          	LD	IY,BUFFER	;FOR XEQ
   259  0122  ca0000            	JP	Z,XEQ		;DIRECT MODE
   260  0125  c5                	PUSH	BC
   261  0126  cd2c0a            	CALL	FINDL
   262  0129  ccd208            	CALL	Z,DEL
   263  012c  c1                	POP	BC
   264  012d  79                	LD	A,C
   265  012e  b7                	OR	A
   266  012f  2839              	JR	Z,CLOOP2	;DELETE LINE ONLY
   267  0131  c604              	ADD	A,4
   268  0133  4f                	LD	C,A		;LENGTH INCLUSIVE
   269  0134  d5                	PUSH	DE		;LINE NUMBER
   270  0135  c5                	PUSH	BC		;SAVE LINE LENGTH
   271  0136  eb                	EX	DE,HL
   272  0137  c5                	PUSH	BC
   273  0138  cd0e09            	CALL	GETTOP
   274  013b  c1                	POP	BC
   275  013c  e5                	PUSH	HL
   276  013d  09                	ADD	HL,BC
   277  013e  e5                	PUSH	HL
   278  013f  24                	INC	H
   279  0140  af                	XOR	A
   280  0141  ed72              	SBC	HL,SP
   281  0143  e1                	POP	HL
   282  0144  d22d08            	JP	NC,ERROR	;"No room"
   283  0147  e3                	EX	(SP),HL
   284  0148  e5                	PUSH	HL
   285  0149  23                	INC	HL
   286  014a  b7                	OR	A
   287  014b  ed52              	SBC	HL,DE
   288  014d  44                	LD	B,H		;BC=AMOUNT TO MOVE
   289  014e  4d                	LD	C,L
   290  014f  e1                	POP	HL
   291  0150  d1                	POP	DE
   292  0151  2802              	JR	Z,ATEND
   293  0153  edb8              	LDDR			;MAKE SPACE
   294  0155  c1                ATEND:	POP	BC		;LINE LENGTH
   295  0156  d1                	POP	DE		;LINE NUMBER
   296  0157  23                	INC	HL
   297  0158  71                	LD	(HL),C		;STORE LENGTH
   298  0159  23                	INC	HL
   299  015a  73                	LD	(HL),E		;STORE LINE NUMBER
   300  015b  23                	INC	HL
   301  015c  72                	LD	(HL),D
   302  015d  23                	INC	HL
   303  015e  110000            	LD	DE,BUFFER
   304  0161  eb                	EX	DE,HL
   305  0162  0d                	DEC	C
   306  0163  0d                	DEC	C
   307  0164  0d                	DEC	C
   308  0165  edb0              	LDIR			;ADD LINE
   309  0167  cd0309            	CALL	CLEAN
   310  016a  c39900            CLOOP2:	JP	CLOOP
   311                          ;
   312                          ;LIST OF TOKENS AND KEYWORDS.
   313                          ;IF A KEYWORD IS FOLLOWED BY NUL THEN IT WILL
   314                          ; ONLY MATCH WITH THE WORD FOLLOWED IMMEDIATELY
   315                          ; BY A DELIMITER.
   316                          ;
   317  016d  80                KEYWDS:	DEFB	80H
   318  016e  414e44            	DEFM "AND"
   319  0171  94                	DEFB	94H
   320  0172  414253            	DEFM "ABS"
   321  0175  95                	DEFB	95H
   322  0176  414353            	DEFM "ACS"
   323  0179  96                	DEFB	96H
   324  017a  414456414c        	DEFM "ADVAL"
   325  017f  97                	DEFB	97H
   326  0180  415343            	DEFM "ASC"
   327  0183  98                	DEFB	98H
   328  0184  41534e            	DEFM "ASN"
   329  0187  99                	DEFB	99H
   330  0188  41544e            	DEFM "ATN"
   331  018b  9a                	DEFB	9AH
   332  018c  4247455420        	DEFM "BGET "
   333  0191  d5                	DEFB	0D5H
   334  0192  4250555420        	DEFM "BPUT "
   335  0197  0f                	DEFB	0FH
   336  0198  425920            	DEFM "BY "		; v5
   337  019b  fb                	DEFB	0FBH
   338  019c  434f4c4f5552      	DEFM "COLOUR"
   339  01a2  fb                	DEFB	0FBH
   340  01a3  434f4c4f52        	DEFM "COLOR"
   341  01a8  d6                	DEFB	0D6H
   342  01a9  43414c4c          	DEFM "CALL"
   343  01ad  c8                	DEFB	0C8H
   344  01ae  43415345          	DEFM "CASE"		; v5
   345  01b2  d7                	DEFB	0D7H
   346  01b3  434841494e        	DEFM "CHAIN"
   347  01b8  bd                	DEFB	0BDH
   348  01b9  43485224          	DEFM "CHR$"
   349  01bd  d8                	DEFB	0D8H
   350  01be  434c45415220      	DEFM "CLEAR "
   351  01c4  d9                	DEFB	0D9H
   352  01c5  434c4f534520      	DEFM "CLOSE "
   353  01cb  da                	DEFB	0DAH
   354  01cc  434c4720          	DEFM "CLG "
   355  01d0  db                	DEFB	0DBH
   356  01d1  434c5320          	DEFM "CLS "
   357  01d5  9b                	DEFB	9BH
   358  01d6  434f53            	DEFM "COS"
   359  01d9  9c                	DEFB	9CH
   360  01da  434f554e5420      	DEFM "COUNT "
   361  01e0  01                	DEFB	01H
   362  01e1  434952434c45      	DEFM "CIRCLE"	; v5
   363  01e7  dc                	DEFB	0DCH
   364  01e8  44415441          	DEFM "DATA"
   365  01ec  9d                	DEFB	9DH
   366  01ed  444547            	DEFM "DEG"
   367  01f0  dd                	DEFB	0DDH
   368  01f1  444546            	DEFM "DEF"
   369  01f4  81                	DEFB	81H
   370  01f5  444956            	DEFM "DIV"
   371  01f8  de                	DEFB	0DEH
   372  01f9  44494d            	DEFM "DIM"
   373  01fc  df                	DEFB	0DFH
   374  01fd  44524157          	DEFM "DRAW"
   375  0201  e1                	DEFB	0E1H
   376  0202  454e4450524f4320  	DEFM "ENDPROC "
   377  020a  ce                	DEFB	0CEH
   378  020b  454e445748494c45  	DEFM "ENDWHILE "	; v5
              20                
   379  0214  cb                	DEFB	0CBH
   380  0215  454e444341534520  	DEFM "ENDCASE "	; v5
   381  021d  cd                	DEFB	0CDH
   382  021e  454e44494620      	DEFM "ENDIF "	; v5
   383  0224  e0                	DEFB	0E0H
   384  0225  454e4420          	DEFM "END "
   385  0229  e2                	DEFB	0E2H
   386  022a  454e56454c4f5045  	DEFM "ENVELOPE"
   387  0232  8b                	DEFB	8BH
   388  0233  454c5345          	DEFM "ELSE"
   389  0237  a0                	DEFB	0A0H
   390  0238  4556414c          	DEFM "EVAL"
   391  023c  9e                	DEFB	9EH
   392  023d  45524c20          	DEFM "ERL "
   393  0241  85                	DEFB	85H
   394  0242  4552524f52        	DEFM "ERROR"
   395  0247  c5                	DEFB	0C5H
   396  0248  454f4620          	DEFM "EOF "
   397  024c  82                	DEFB	82H
   398  024d  454f52            	DEFM "EOR"
   399  0250  9f                	DEFB	9FH
   400  0251  45525220          	DEFM "ERR "
   401  0255  10                	DEFB	10H
   402  0256  4558495420        	DEFM "EXIT "		; v5
   403  025b  a1                	DEFB	0A1H
   404  025c  455850            	DEFM "EXP"
   405  025f  a2                	DEFB	0A2H
   406  0260  45585420          	DEFM "EXT "
   407  0264  02                	DEFB	02H
   408  0265  454c4c49505345    	DEFM "ELLIPSE"	; v5
   409  026c  e3                	DEFB	0E3H
   410  026d  464f52            	DEFM "FOR"
   411  0270  a3                	DEFB	0A3H
   412  0271  46414c534520      	DEFM "FALSE "
   413  0277  03                	DEFB	03H
   414  0278  46494c4c          	DEFM "FILL"		; v5
   415  027c  a4                	DEFB	0A4H
   416  027d  464e              	DEFM "FN"
   417  027f  e5                	DEFB	0E5H
   418  0280  474f544f          	DEFM "GOTO"
   419  0284  be                	DEFB	0BEH
   420  0285  47455424          	DEFM "GET$"
   421  0289  a5                	DEFB	0A5H
   422  028a  474554            	DEFM "GET"
   423  028d  e4                	DEFB	0E4H
   424  028e  474f535542        	DEFM "GOSUB"
   425  0293  e6                	DEFB	0E6H
   426  0294  47434f4c          	DEFM "GCOL"
   427  0298  93                	DEFB	93H
   428  0299  48494d454d20      	DEFM "HIMEM "
   429  029f  e8                	DEFB	0E8H
   430  02a0  494e505554        	DEFM "INPUT"
   431  02a5  e7                	DEFB	0E7H
   432  02a6  4946              	DEFM "IF"
   433  02a8  bf                	DEFB	0BFH
   434  02a9  494e4b455924      	DEFM "INKEY$"
   435  02af  a6                	DEFB	0A6H
   436  02b0  494e4b4559        	DEFM "INKEY"
   437  02b5  a8                	DEFB	0A8H
   438  02b6  494e54            	DEFM "INT"
   439  02b9  a7                	DEFB	0A7H
   440  02ba  494e53545228      	DEFM "INSTR("
   441  02c0  0c                	DEFB	0CH
   442  02c1  494e5354414c4c    	DEFM "INSTALL"	; v5
   443  02c8  86                	DEFB	86H
   444  02c9  4c494e45          	DEFM "LINE"
   445  02cd  92                	DEFB	92H
   446  02ce  4c4f4d454d20      	DEFM "LOMEM "
   447  02d4  ea                	DEFB	0EAH
   448  02d5  4c4f43414c        	DEFM "LOCAL"
   449  02da  c0                	DEFB	0C0H
   450  02db  4c4546542428      	DEFM "LEFT$("
   451  02e1  a9                	DEFB	0A9H
   452  02e2  4c454e            	DEFM "LEN"
   453  02e5  e9                	DEFB	0E9H
   454  02e6  4c4554            	DEFM "LET"
   455  02e9  ab                	DEFB	0ABH
   456  02ea  4c4f47            	DEFM "LOG"
   457  02ed  aa                	DEFB	0AAH
   458  02ee  4c4e              	DEFM "LN"
   459  02f0  c1                	DEFB	0C1H
   460  02f1  4d49442428        	DEFM "MID$("
   461  02f6  eb                	DEFB	0EBH
   462  02f7  4d4f4445          	DEFM "MODE"
   463  02fb  83                	DEFB	83H
   464  02fc  4d4f44            	DEFM "MOD"
   465  02ff  ec                	DEFB	0ECH
   466  0300  4d4f5645          	DEFM "MOVE"
   467  0304  04                	DEFB	04H
   468  0305  4d4f555345        	DEFM "MOUSE"		; v5
   469  030a  ed                	DEFB	0EDH
   470  030b  4e455854          	DEFM "NEXT"
   471  030f  ac                	DEFB	0ACH
   472  0310  4e4f54            	DEFM "NOT"
   473  0313  ee                	DEFB	0EEH
   474  0314  4f4e              	DEFM "ON"
   475  0316  87                	DEFB	87H
   476  0317  4f464620          	DEFM "OFF "
   477  031b  ca                	DEFB	0CAH
   478  031c  4f4620            	DEFM "OF "		; v5
   479  031f  05                	DEFB	05H
   480  0320  4f524947494e      	DEFM "ORIGIN"	; v5
   481  0326  84                	DEFB	84H
   482  0327  4f52              	DEFM "OR"
   483  0329  8e                	DEFB	8EH
   484  032a  4f50454e494e      	DEFM "OPENIN"
   485  0330  ae                	DEFB	0AEH
   486  0331  4f50454e4f5554    	DEFM "OPENOUT"
   487  0338  ad                	DEFB	0ADH
   488  0339  4f50454e5550      	DEFM "OPENUP"
   489  033f  ff                	DEFB	0FFH
   490  0340  4f53434c49        	DEFM "OSCLI"
   491  0345  cc                	DEFB	0CCH
   492  0346  4f54484552574953  	DEFM "OTHERWISE"	; v5
              45                
   493  034f  f1                	DEFB	0F1H
   494  0350  5052494e54        	DEFM "PRINT"
   495  0355  90                	DEFB	90H
   496  0356  5041474520        	DEFM "PAGE "
   497  035b  8f                	DEFB	8FH
   498  035c  50545220          	DEFM "PTR "
   499  0360  af                	DEFB	0AFH
   500  0361  504920            	DEFM "PI "
   501  0364  f0                	DEFB	0F0H
   502  0365  504c4f54          	DEFM "PLOT"
   503  0369  b0                	DEFB	0B0H
   504  036a  504f494e5428      	DEFM "POINT("
   505  0370  f2                	DEFB	0F2H
   506  0371  50524f43          	DEFM "PROC"
   507  0375  b1                	DEFB	0B1H
   508  0376  504f5320          	DEFM "POS "
   509  037a  0e                	DEFB	0EH
   510  037b  505554            	DEFM "PUT"		; Token changed
   511  037e  06                	DEFB	06H
   512  037f  5155495420        	DEFM "QUIT "		; v5
   513  0384  f8                	DEFB	0F8H
   514  0385  52455455524e20    	DEFM "RETURN "
   515  038c  f5                	DEFB	0F5H
   516  038d  524550454154      	DEFM "REPEAT"
   517  0393  f6                	DEFB	0F6H
   518  0394  5245504f525420    	DEFM "REPORT "
   519  039b  f3                	DEFB	0F3H
   520  039c  52454144          	DEFM "READ"
   521  03a0  f4                	DEFB	0F4H
   522  03a1  52454d            	DEFM "REM"
   523  03a4  f9                	DEFB	0F9H
   524  03a5  52554e20          	DEFM "RUN "
   525  03a9  b2                	DEFB	0B2H
   526  03aa  524144            	DEFM "RAD"
   527  03ad  f7                	DEFB	0F7H
   528  03ae  524553544f5245    	DEFM "RESTORE"
   529  03b5  c2                	DEFB	0C2H
   530  03b6  52494748542428    	DEFM "RIGHT$("
   531  03bd  b3                	DEFB	0B3H
   532  03be  524e4420          	DEFM "RND "
   533  03c2  07                	DEFB	07H
   534  03c3  52454354414e474c  	DEFM "RECTANGLE"	; v5
              45                
   535  03cc  88                	DEFB	88H
   536  03cd  53544550          	DEFM "STEP"
   537  03d1  b4                	DEFB	0B4H
   538  03d2  53474e            	DEFM "SGN"
   539  03d5  b5                	DEFB	0B5H
   540  03d6  53494e            	DEFM "SIN"
   541  03d9  b6                	DEFB	0B6H
   542  03da  535152            	DEFM "SQR"
   543  03dd  89                	DEFB	89H
   544  03de  535043            	DEFM "SPC"
   545  03e1  c3                	DEFB	0C3H
   546  03e2  53545224          	DEFM "STR$"
   547  03e6  c4                	DEFB	0C4H
   548  03e7  535452494e472428  	DEFM "STRING$("
   549  03ef  d4                	DEFB	0D4H
   550  03f0  534f554e44        	DEFM "SOUND"
   551  03f5  fa                	DEFB	0FAH
   552  03f6  53544f5020        	DEFM "STOP "
   553  03fb  c6                	DEFB	0C6H
   554  03fc  53554d            	DEFM "SUM"		; v5
   555  03ff  08                	DEFB	08H
   556  0400  53574150          	DEFM "SWAP"		; v5
   557  0404  09                	DEFB	09H
   558  0405  535953            	DEFM "SYS"		; v5
   559  0408  b7                	DEFB	0B7H
   560  0409  54414e            	DEFM "TAN"
   561  040c  8a                	DEFB	8AH
   562  040d  54414228          	DEFM "TAB("
   563  0411  8c                	DEFB	8CH
   564  0412  5448454e          	DEFM "THEN"
   565  0416  91                	DEFB	91H
   566  0417  54494d4520        	DEFM "TIME "
   567  041c  0a                	DEFB	0AH
   568  041d  54494e54          	DEFM "TINT"
   569  0421  b8                	DEFB	0B8H
   570  0422  544f              	DEFM "TO"
   571  0424  fc                	DEFB	0FCH
   572  0425  5452414345        	DEFM "TRACE"
   573  042a  b9                	DEFB	0B9H
   574  042b  5452554520        	DEFM "TRUE "
   575  0430  fd                	DEFB	0FDH
   576  0431  554e54494c        	DEFM "UNTIL"
   577  0436  ba                	DEFB	0BAH
   578  0437  555352            	DEFM "USR"
   579  043a  ef                	DEFB	0EFH
   580  043b  564455            	DEFM "VDU"
   581  043e  bb                	DEFB	0BBH
   582  043f  56414c            	DEFM "VAL"
   583  0442  bc                	DEFB	0BCH
   584  0443  56504f5320        	DEFM "VPOS "
   585  0448  c7                	DEFB	0C7H
   586  0449  5748494c45        	DEFM "WHILE"		; v5
   587  044e  c9                	DEFB	0C9H
   588  044f  5748454e          	DEFM "WHEN"		; v5
   589  0453  0b                	DEFB	0BH
   590  0454  5741495420        	DEFM "WAIT "		; v5
   591  0459  fe                	DEFB	0FEH
   592  045a  5749445448        	DEFM "WIDTH"
   593                          ;'LEFT' TOKENS:
   594  045f  cf                	DEFB	0CFH
   595  0460  505452            	DEFM "PTR"
   596  0463  d1                	DEFB	0D1H
   597  0464  54494d45          	DEFM "TIME"
   598  0468  d3                	DEFB	0D3H
   599  0469  48494d454d        	DEFM "HIMEM"
   600  046e  d2                	DEFB	0D2H
   601  046f  4c4f4d454d        	DEFM "LOMEM"
   602  0474  d0                	DEFB	0D0H
   603  0475  50414745          	DEFM "PAGE"
   604                          ;
   605  0479  11                	DEFB	11H
   606  047a  4d697373696e6720  	DEFM "Missing "
   607  0482  12                	DEFB	12H
   608  0483  4e6f207375636820  	DEFM "No such "
   609  048b  13                	DEFB	13H
   610  048c  42616420          	DEFM "Bad "
   611  0490  14                	DEFB	14H
   612  0491  2072616e6765      	DEFM " range"
   613  0497  15                	DEFB	15H
   614  0498  7661726961626c65  	DEFM "variable"
   615  04a0  16                	DEFB	16H
   616  04a1  4f7574206f66      	DEFM "Out of"
   617  04a7  17                	DEFB	17H
   618  04a8  4e6f20            	DEFM "No "
   619  04ab  18                	DEFB	18H
   620  04ac  207370616365      	DEFM " space"
   621  04b2  19                	DEFB	19H
   622  04b3  4e6f7420696e2061  	DEFM "Not in a "
              20                
   623  04bc  1a                	DEFB	1AH
   624  04bd  206c6f6f70        	DEFM " loop"
   625  04c2  1b                	DEFB	1BH
   626  04c3  206e6f7420        	DEFM " not "
   627                          KEYWDL	EQU	$-KEYWDS
   628  04c8  ffff              	DEFW	-1
   629                          ;
   630                          ;LIST OF IMMEDIATE MODE COMMANDS:
   631                          ;
   632  04ca  80                COMNDS:	DEFB	80H
   633  04cb  4155544f          	DEFM "AUTO"
   634  04cf  81                	DEFB	81H
   635  04d0  44454c455445      	DEFM "DELETE"
   636  04d6  82                	DEFB	82H
   637  04d7  4c495354          	DEFM "LIST"
   638  04db  83                	DEFB	83H
   639  04dc  4c4f4144          	DEFM "LOAD"
   640  04e0  84                	DEFB	84H
   641  04e1  4e455720          	DEFM "NEW "
   642  04e5  85                	DEFB	85H
   643  04e6  4f4c4420          	DEFM "OLD "
   644  04ea  86                	DEFB	86H
   645  04eb  52454e554d424552  	DEFM "RENUMBER"
   646  04f3  87                	DEFB	87H
   647  04f4  53415645          	DEFM "SAVE"
   648  04f8  ffff              	DEFW	-1
   649                          ;
   650                          ;IMMEDIATE MODE COMMANDS:
   651                          ;
   652  04fa  cc07              CMDTAB:	DEFW	AUTO
   653  04fc  6f06              	DEFW	DELETE
   654  04fe  9706              	DEFW	LIST
   655  0500  eb07              	DEFW	LOAD
   656  0502  e607              	DEFW	NEW
   657  0504  f907              	DEFW	OLD
   658  0506  1c07              	DEFW	RENUM
   659  0508  1208              	DEFW	SAVE
   660                          ;
   661                          ;ERROR MESSAGES:
   662                          ;
   663  050a  17                ERRWDS:	DEFB	17H
   664  050b  726f6f6d          	DEFM "room"
   665  050f  00                	DEFB	0
   666  0510  16                	DEFB	16H
   667  0511  14                	DEFB	14H
   668  0512  0000              	DEFW	0
   669  0514  4d756c7469706c65  	DEFM "Multiple label"
              206c6162656c      
   670  0522  00                	DEFB	0
   671  0523  4d697374616b65    	DEFM "Mistake"
   672  052a  00                	DEFB	0
   673  052b  11                	DEFB	11H
   674  052c  2c                	DEFM ","
   675  052d  00                	DEFB	0
   676  052e  54797065206d6973  	DEFM "Type mismatch"
              6d61746368        
   677  053b  00                	DEFB	0
   678  053c  19                	DEFB	19H
   679  053d  a4                	DEFB	TFN
   680  053e  0000              	DEFW	0
   681  0540  11                	DEFB	11H
   682  0541  22                	DEFB 22H	; double-quote char
   683  0542  00                	DEFB	0
   684  0543  13                	DEFB	13H
   685  0544  de                	DEFB	TDIM
   686  0545  00                	DEFB	0
   687  0546  de                	DEFB	TDIM
   688  0547  18                	DEFB	18H
   689  0548  00                	DEFB	0
   690  0549  19                	DEFB	19H
   691  054a  a4                	DEFB	TFN
   692  054b  206f7220          	DEFM " or "
   693  054f  f2                	DEFB	TPROC
   694  0550  00                	DEFB	0
   695  0551  19                	DEFB	19H
   696  0552  f2                	DEFB	TPROC
   697  0553  00                	DEFB	0
   698  0554  13                	DEFB	13H
   699  0555  757365206f662061  	DEFM "use of array"
              72726179          
   700  0561  00                	DEFB	0
   701  0562  13                	DEFB	13H
   702  0563  7375627363726970  	DEFM "subscript"
              74                
   703  056c  00                	DEFB	0
   704  056d  53796e7461782065  	DEFM "Syntax error"
              72726f72          
   705  0579  00                	DEFB	0
   706  057a  457363617065      	DEFM "Escape"
   707  0580  00                	DEFB	0
   708  0581  4469766973696f6e  	DEFM "Division by zero"
              206279207a65726f  
   709  0591  00                	DEFB	0
   710  0592  537472696e672074  	DEFM "String too long"
              6f6f206c6f6e67    
   711  05a1  00                	DEFB	0
   712  05a2  4e756d6265722074  	DEFM "Number too big"
              6f6f20626967      
   713  05b0  00                	DEFB	0
   714  05b1  2d766520726f6f74  	DEFM "-ve root"
   715  05b9  00                	DEFB	0
   716  05ba  4c6f67            	DEFM "Log"
   717  05bd  14                	DEFB	14H
   718  05be  00                	DEFB	0
   719  05bf  4163637572616379  	DEFM "Accuracy lost"
              206c6f7374        
   720  05cc  00                	DEFB	0
   721  05cd  4578706f6e656e74  	DEFM "Exponent"
   722  05d5  14                	DEFB	14H
   723  05d6  0000              	DEFW	0
   724  05d8  12                	DEFB	12H
   725  05d9  15                	DEFB	15H
   726  05da  00                	DEFB	0
   727  05db  11                	DEFB	11H
   728  05dc  29                	DEFM ")"
   729  05dd  00                	DEFB	0
   730  05de  13                	DEFB	13H
   731  05df  686578206f722062  	DEFM "hex or binary"
              696e617279        
   732  05ec  00                	DEFB	0
   733  05ed  12                	DEFB	12H
   734  05ee  a4                	DEFB	TFN
   735  05ef  2f                	DEFM "/"
   736  05f0  f2                	DEFB	TPROC
   737  05f1  00                	DEFB	0
   738  05f2  13                	DEFB	13H
   739  05f3  63616c6c          	DEFM "call"
   740  05f7  00                	DEFB	0
   741  05f8  13                	DEFB	13H
   742  05f9  617267756d656e74  	DEFM "arguments"
              73                
   743  0602  00                	DEFB	0
   744  0603  19                	DEFB	19H
   745  0604  e3                	DEFB	TFOR
   746  0605  1a                	DEFB	1AH
   747  0606  00                	DEFB	0
   748  0607  43616e2774206d61  	DEFM "Can't match "
              74636820          
   749  0613  e3                	DEFB	TFOR
   750  0614  00                	DEFB	0
   751  0615  13                	DEFB	13H
   752  0616  e3                	DEFB	TFOR
   753  0617  20                	DEFM " "
   754  0618  15                	DEFB	15H
   755  0619  0000              	DEFW	0
   756  061b  11                	DEFB	11H
   757  061c  b8                	DEFB	TTO
   758  061d  0000              	DEFW	0
   759  061f  17                	DEFB	17H
   760  0620  e4                	DEFB	TGOSUB
   761  0621  00                	DEFB	0
   762  0622  ee                	DEFB	TON
   763  0623  2073796e746178    	DEFM " syntax"
   764  062a  00                	DEFB	0
   765  062b  ee                	DEFB	TON
   766  062c  14                	DEFB	14H
   767  062d  00                	DEFB	0
   768  062e  12                	DEFB	12H
   769  062f  6c696e65          	DEFM "line"
   770  0633  00                	DEFB	0
   771  0634  16                	DEFB	16H
   772  0635  20                	DEFM " "
   773  0636  dc                	DEFB	TDATA
   774  0637  00                	DEFB	0
   775  0638  19                	DEFB	19H
   776  0639  f5                	DEFB	TREPEAT
   777  063a  1a                	DEFB	1AH
   778  063b  00                	DEFB	0
   779  063c  13                	DEFB	13H
   780  063d  10                	DEFB	TEXIT
   781  063e  00                	DEFB	0
   782  063f  11                	DEFB	11H
   783  0640  23                	DEFM "#"
   784  0641  00                	DEFB	0
   785  0642  19                	DEFB	19H		;46 Not in a WHILE loop
   786  0643  c7                	DEFB	TWHILE
   787  0644  1a                	DEFB	1AH
   788  0645  00                	DEFB	0
   789  0646  11                	DEFB	11H		;47 Missing ENDCASE
   790  0647  cb                	DEFB	TENDCASE
   791  0648  00                	DEFB	0
   792  0649  ca                	DEFB	TOF		;48 OF not last
   793  064a  1b                	DEFB	1BH
   794  064b  6c617374          	DEFM "last"
   795  064f  00                	DEFB	0
   796  0650  11                	DEFB	11H		;49 Missing ENDIF
   797  0651  cd                	DEFB	TENDIF
   798  0652  00                	DEFB	0
   799  0653  0000              	DEFW	0
   800  0655  00                	DEFB	0
   801  0656  ee                	DEFB	TON		;53 ON ERROR not LOCAL
   802  0657  20                	DEFM " "
   803  0658  85                	DEFB	TERROR
   804  0659  1b                	DEFB	1BH
   805  065a  ea                	DEFB	TLOCAL
   806  065b  00                	DEFB	0
   807  065c  dc                	DEFB	TDATA		;54 DATA not LOCAL
   808  065d  1b                	DEFB	1BH
   809  065e  ea                	DEFB	TLOCAL
   810  065f  00                	DEFB	0
   811                          ;
   812                          ;Indent tokens (first four needn't be at start of line):
   813                          ;
   814  0660  e3                TOKADD:	DEFB	TFOR
   815  0661  f5                	DEFB	TREPEAT
   816  0662  c7                	DEFB	TWHILE
   817  0663  c8                	DEFB	TCASE
   818  0664  8b                	DEFB	TELSE
   819  0665  c9                	DEFB	TWHEN
   820  0666  cc                	DEFB	TOTHERWISE
   821                          LENADD	EQU	$-TOKADD
   822                          ;
   823                          ;Outdent tokens (first three needn't be at start of line):
   824                          ;
   825  0667  ed                TOKSUB:	DEFB	TNEXT
   826  0668  fd                	DEFB	TUNTIL
   827  0669  ce                	DEFB	TENDWHILE
   828  066a  cb                	DEFB	TENDCASE
   829  066b  cd                	DEFB	TENDIF
   830  066c  8b                	DEFB	TELSE
   831  066d  c9                	DEFB	TWHEN
   832  066e  cc                	DEFB	TOTHERWISE
   833                          LENSUB	EQU	$-TOKSUB
   834                          ;
   835                          ;COMMANDS:
   836                          ;
   837                          ;DELETE line,line
   838                          ;
   839  066f  cdc00c            DELETE:	CALL	DLPAIR
   840  0672  7e                DELET1:	LD	A,(HL)
   841  0673  b7                	OR	A
   842  0674  2879              	JR	Z,WARMNC
   843  0676  23                	INC	HL
   844  0677  5e                	LD	E,(HL)
   845  0678  23                	INC	HL
   846  0679  56                	LD	D,(HL)
   847  067a  2b                	DEC	HL
   848  067b  2b                	DEC	HL
   849  067c  eb                	EX	DE,HL
   850  067d  37                	SCF
   851  067e  ed42              	SBC	HL,BC
   852  0680  eb                	EX	DE,HL
   853  0681  306c              	JR	NC,WARMNC
   854  0683  c5                	PUSH	BC
   855  0684  cdd208            	CALL	DEL
   856  0687  c1                	POP	BC
   857  0688  18e8              	JR	DELET1
   858                          ;
   859                          ;LISTO expr
   860                          ;
   861  068a  fd23              LISTO:	INC	IY		;SKIP "O"
   862  068c  cd0000            	CALL	EXPRI
   863  068f  d9                	EXX
   864  0690  7d                	LD	A,L
   865  0691  320000            	LD	(LISTON),A
   866  0694  c39900            	JP	CLOOP
   867                          ;
   868                          ;LIST
   869                          ;LIST line
   870                          ;LIST line,line [IF string]
   871                          ;LIST ,line
   872                          ;LIST line,
   873                          ;
   874  0697  fe4f              LIST:	CP	'O'
   875  0699  28ef              	JR	Z,LISTO
   876  069b  0e01              	LD	C,1
   877  069d  110000            	LD	DE,BUFFER
   878  06a0  cd010d            	CALL	LEXAN2
   879  06a3  12                	LD	(DE),A
   880  06a4  fd210000          	LD	IY,BUFFER
   881  06a8  cdc00c            	CALL	DLPAIR
   882  06ab  cdf40d            	CALL	NXT
   883  06ae  fee7              	CP	TIF		;IF CLAUSE ?
   884  06b0  3e00              	LD	A,0		;INIT IF-CLAUSE LENGTH
   885  06b2  2015              	JR	NZ,LISTB
   886  06b4  fd23              	INC	IY		;SKIP IF
   887  06b6  cdf40d            	CALL	NXT		;SKIP SPACES (IF ANY)
   888  06b9  eb                	EX	DE,HL
   889  06ba  fde5              	PUSH	IY
   890  06bc  e1                	POP	HL		;HL ADDRESSES IF CLAUSE
   891  06bd  3e0d              	LD	A,CR
   892  06bf  c5                	PUSH	BC
   893  06c0  010001            	LD	BC,256
   894  06c3  edb1              	CPIR			;LOCATE CR
   895  06c5  79                	LD	A,C
   896  06c6  2f                	CPL			;A = SUBSTRING LENGTH
   897  06c7  c1                	POP	BC
   898  06c8  eb                	EX	DE,HL
   899  06c9  5f                LISTB:	LD	E,A		;IF-CLAUSE LENGTH
   900  06ca  78                	LD	A,B
   901  06cb  b1                	OR	C
   902  06cc  2001              	JR	NZ,LISTA
   903  06ce  0b                	DEC	BC
   904  06cf  d9                LISTA:	EXX
   905  06d0  dd210000          	LD	IX,LISTON
   906  06d4  1e00              	LD	E,0		;INDENTATION COUNT
   907  06d6  d9                	EXX
   908  06d7  3e14              	LD	A,20
   909                          ;
   910  06d9  c5                LISTC:	PUSH	BC		;SAVE HIGH LINE NUMBER
   911  06da  d5                	PUSH	DE		;SAVE IF-CLAUSE LENGTH
   912  06db  e5                	PUSH	HL		;SAVE PROGRAM POINTER
   913  06dc  08                	EX	AF,AF'
   914  06dd  7e                	LD	A,(HL)
   915  06de  b7                	OR	A
   916  06df  280e              	JR	Z,WARMNC
   917                          ;
   918                          ;CHECK IF PAST TERMINATING LINE NUMBER:
   919                          ;
   920  06e1  7b                	LD	A,E		;A = IF-CLAUSE LENGTH
   921  06e2  23                	INC	HL
   922  06e3  5e                	LD	E,(HL)
   923  06e4  23                	INC	HL
   924  06e5  56                	LD	D,(HL)		;DE = LINE NUMBER
   925  06e6  2b                	DEC	HL
   926  06e7  2b                	DEC	HL
   927  06e8  d5                	PUSH	DE		;SAVE LINE NUMBER
   928  06e9  eb                	EX	DE,HL
   929  06ea  37                	SCF
   930  06eb  ed42              	SBC	HL,BC
   931  06ed  eb                	EX	DE,HL
   932  06ee  d1                	POP	DE		;RESTORE LINE NUMBER
   933  06ef  d29800            WARMNC:	JP	NC,WARM
   934  06f2  4e                	LD	C,(HL)		;C = LINE LENGTH + 4
   935  06f3  47                	LD	B,A		;B = IF-CLAUSE LENGTH
   936                          ;
   937                          ;CHECK FOR IF CLAUSE:
   938                          ;
   939  06f4  23                	INC	HL
   940  06f5  23                	INC	HL
   941  06f6  23                	INC	HL		;HL ADDRESSES LINE TEXT
   942  06f7  0d                	DEC	C
   943  06f8  0d                	DEC	C
   944  06f9  0d                	DEC	C
   945  06fa  0d                	DEC	C		;C = LINE LENGTH
   946  06fb  d5                	PUSH	DE		;SAVE LINE NUMBER
   947  06fc  e5                	PUSH	HL		;SAVE LINE ADDRESS
   948  06fd  af                	XOR	A		;A <- 0
   949  06fe  b8                	CP	B		;WAS THERE AN IF-CLAUSE
   950  06ff  fde5              	PUSH	IY
   951  0701  d1                	POP	DE		;DE ADDRESSES IF-CLAUSE
   952  0702  c40000            	CALL	NZ,SEARCH	;SEARCH FOR IF CLAUSE
   953  0705  e1                	POP	HL		;RESTORE LINE ADDRESS
   954  0706  d1                	POP	DE		;RESTORE LINE NUMBER
   955  0707  fde5              	PUSH	IY
   956  0709  cc4609            	CALL	Z,LISTIT	;LIST IF MATCH
   957  070c  fde1              	POP	IY
   958                          ;
   959  070e  08                	EX	AF,AF'
   960  070f  3d                	DEC	A
   961  0710  cd0000            	CALL	LTRAP
   962  0713  e1                	POP	HL		;RESTORE POINTER
   963  0714  5e                	LD	E,(HL)
   964  0715  1600              	LD	D,0
   965  0717  19                	ADD	HL,DE		;ADDRESS NEXT LINE
   966  0718  d1                	POP	DE		;RESTORE IF-CLAUSE LEN
   967  0719  c1                	POP	BC		;RESTORE HI LINE NUMBER
   968  071a  18bd              	JR	LISTC
   969                          ;
   970                          ;RENUMBER
   971                          ;RENUMBER start
   972                          ;RENUMBER start,increment
   973                          ;RENUMBER ,increment
   974                          ;
   975  071c  cd2c09            RENUM:	CALL	CLEAR		;USES DYNAMIC AREA
   976  071f  cd9d0c            	CALL	PAIR		;LOAD HL,BC
   977  0722  d9                	EXX
   978  0723  2a0000            	LD	HL,(PAGE)
   979  0726  ed5b0000          	LD	DE,(LOMEM)
   980  072a  7e                RENUM1:	LD	A,(HL)		;BUILD TABLE
   981  072b  b7                	OR	A
   982  072c  2828              	JR	Z,RENUM2
   983  072e  23                	INC	HL
   984  072f  4e                	LD	C,(HL)		;OLD LINE NUMBER
   985  0730  23                	INC	HL
   986  0731  46                	LD	B,(HL)
   987  0732  eb                	EX	DE,HL
   988  0733  71                	LD	(HL),C
   989  0734  23                	INC	HL
   990  0735  70                	LD	(HL),B
   991  0736  23                	INC	HL
   992  0737  d9                	EXX
   993  0738  e5                	PUSH	HL
   994  0739  09                	ADD	HL,BC		;ADD INCREMENT
   995  073a  da980c            	JP	C,TOOBIG	;"Too big"
   996  073d  d9                	EXX
   997  073e  c1                	POP	BC
   998  073f  71                	LD	(HL),C
   999  0740  23                	INC	HL
  1000  0741  70                	LD	(HL),B
  1001  0742  23                	INC	HL
  1002  0743  eb                	EX	DE,HL
  1003  0744  2b                	DEC	HL
  1004  0745  2b                	DEC	HL
  1005  0746  af                	XOR	A
  1006  0747  47                	LD	B,A
  1007  0748  4e                	LD	C,(HL)
  1008  0749  09                	ADD	HL,BC		;NEXT LINE
  1009  074a  eb                	EX	DE,HL
  1010  074b  e5                	PUSH	HL
  1011  074c  24                	INC	H
  1012  074d  ed72              	SBC	HL,SP
  1013  074f  e1                	POP	HL
  1014  0750  eb                	EX	DE,HL
  1015  0751  38d7              	JR	C,RENUM1	;CONTINUE
  1016  0753  c32d08            	JP	ERROR		;'No room' (A = 0)
  1017                          ;
  1018  0756  eb                RENUM2:	EX	DE,HL
  1019  0757  36ff              	LD	(HL),-1
  1020  0759  23                	INC	HL
  1021  075a  36ff              	LD	(HL),-1
  1022  075c  ed5b0000          	LD	DE,(LOMEM)
  1023  0760  d9                	EXX
  1024  0761  2a0000            	LD	HL,(PAGE)
  1025  0764  4e                RENUM3:	LD	C,(HL)
  1026  0765  79                	LD	A,C
  1027  0766  b7                	OR	A
  1028  0767  2886              	JR	Z,WARMNC
  1029  0769  d9                	EXX
  1030  076a  eb                	EX	DE,HL
  1031  076b  23                	INC	HL
  1032  076c  23                	INC	HL
  1033  076d  5e                	LD	E,(HL)
  1034  076e  23                	INC	HL
  1035  076f  56                	LD	D,(HL)
  1036  0770  23                	INC	HL
  1037  0771  d5                	PUSH	DE
  1038  0772  eb                	EX	DE,HL
  1039  0773  d9                	EXX
  1040  0774  d1                	POP	DE
  1041  0775  23                	INC	HL
  1042  0776  73                	LD	(HL),E		;NEW LINE NUMBER
  1043  0777  23                	INC	HL
  1044  0778  72                	LD	(HL),D
  1045  0779  23                	INC	HL
  1046  077a  0d                	DEC	C
  1047  077b  0d                	DEC	C
  1048  077c  0d                	DEC	C
  1049  077d  0600              	LD	B,0
  1050  077f  3e8d              RENUM7:	LD	A,TLINO
  1051  0781  edb1              	CPIR			;SEARCH FOR LINE NUMBER
  1052  0783  20df              	JR	NZ,RENUM3
  1053  0785  c5                	PUSH	BC
  1054  0786  e5                	PUSH	HL
  1055  0787  e5                	PUSH	HL
  1056  0788  fde1              	POP	IY
  1057  078a  d9                	EXX
  1058  078b  e5                	PUSH	HL
  1059  078c  cd0000            	CALL	DECODE		;DECODE LINE NUMBER
  1060  078f  e1                	POP	HL
  1061  0790  d9                	EXX
  1062  0791  44                	LD	B,H
  1063  0792  4d                	LD	C,L
  1064  0793  2a0000            	LD	HL,(LOMEM)
  1065  0796  5e                RENUM4:	LD	E,(HL)		;CROSS-REFERENCE TABLE
  1066  0797  23                	INC	HL
  1067  0798  56                	LD	D,(HL)
  1068  0799  23                	INC	HL
  1069  079a  eb                	EX	DE,HL
  1070  079b  b7                	OR	A		;CLEAR CARRY
  1071  079c  ed42              	SBC	HL,BC
  1072  079e  eb                	EX	DE,HL
  1073  079f  5e                	LD	E,(HL)		;NEW NUMBER
  1074  07a0  23                	INC	HL
  1075  07a1  56                	LD	D,(HL)
  1076  07a2  23                	INC	HL
  1077  07a3  38f1              	JR	C,RENUM4
  1078  07a5  eb                	EX	DE,HL
  1079  07a6  281a              	JR	Z,RENUM5	;FOUND
  1080  07a8  cde30d            	CALL	TELL
  1081  07ab  4661696c65642061  	DEFM "Failed at "
              7420              
  1082  07b5  00                	DEFB	0
  1083  07b6  d9                	EXX
  1084  07b7  e5                	PUSH	HL
  1085  07b8  d9                	EXX
  1086  07b9  e1                	POP	HL
  1087  07ba  cd7b0a            	CALL	PBCDL
  1088  07bd  cde409            	CALL	CRLF
  1089  07c0  1806              	JR	RENUM6
  1090  07c2  d1                RENUM5:	POP	DE
  1091  07c3  d5                	PUSH	DE
  1092  07c4  1b                	DEC	DE
  1093  07c5  cda80d            	CALL	ENCODE		;RE-WRITE NUMBER
  1094  07c8  e1                RENUM6:	POP	HL
  1095  07c9  c1                	POP	BC
  1096  07ca  18b3              	JR	RENUM7
  1097                          ;
  1098                          ;AUTO
  1099                          ;AUTO start,increment
  1100                          ;AUTO start
  1101                          ;AUTO ,increment
  1102                          ;
  1103  07cc  cd9d0c            AUTO:	CALL	PAIR
  1104  07cf  220000            	LD	(AUTONO),HL
  1105  07d2  79                	LD	A,C
  1106  07d3  320000            	LD	(INCREM),A
  1107  07d6  1837              	JR	CLOOP0
  1108                          ;
  1109                          ;BAD
  1110                          ;NEW
  1111                          ;
  1112  07d8  cde30d            BAD:	CALL	TELL		;"Bad program'
  1113  07db  13                	DEFB	13H
  1114  07dc  70726f6772616d    	DEFM "program"
  1115  07e3  0d                	DEFB	CR
  1116  07e4  0a                	DEFB	LF
  1117  07e5  00                	DEFB	0
  1118  07e6  cd2709            NEW:	CALL	NEWIT
  1119  07e9  1824              	JR	CLOOP0
  1120                          ;
  1121                          ;LOAD filename
  1122                          ;
  1123  07eb  cd0000            LOAD:	CALL	EXPRS		;GET FILENAME
  1124  07ee  3e0d              	LD	A,CR
  1125  07f0  12                	LD	(DE),A
  1126  07f1  cde908            	CALL	LOAD0
  1127  07f4  cd2c09            	CALL	CLEAR
  1128  07f7  1831              	JR	WARM0
  1129                          ;
  1130                          ;OLD
  1131                          ;
  1132  07f9  2a0000            OLD:	LD	HL,(PAGE)
  1133  07fc  e5                	PUSH	HL
  1134  07fd  23                	INC	HL
  1135  07fe  23                	INC	HL
  1136  07ff  23                	INC	HL
  1137  0800  01fc00            	LD	BC,252
  1138  0803  3e0d              	LD	A,CR
  1139  0805  edb1              	CPIR
  1140  0807  20cf              	JR	NZ,BAD
  1141  0809  7d                	LD	A,L
  1142  080a  e1                	POP	HL
  1143  080b  77                	LD	(HL),A
  1144  080c  cd0309            	CALL	CLEAN
  1145  080f  c39900            CLOOP0:	JP	CLOOP
  1146                          ;
  1147                          ;SAVE filename
  1148                          ;
  1149  0812  cd0000            SAVE:	CALL	EXPRS		;FILENAME
  1150  0815  3e0d              	LD	A,CR
  1151  0817  12                	LD	(DE),A
  1152  0818  ed5b0000          	LD	DE,(PAGE)
  1153  081c  cd0e09            	CALL	GETTOP
  1154  081f  b7                	OR	A
  1155  0820  ed52              	SBC	HL,DE
  1156  0822  44                	LD	B,H		;LENGTH OF PROGRAM
  1157  0823  4d                	LD	C,L
  1158  0824  210000            	LD	HL,ACCS
  1159  0827  cd0000            	CALL	OSSAVE
  1160  082a  c39800            WARM0:	JP	WARM
  1161                          ;
  1162                          ;ERROR
  1163                          ;N.B. CARE NEEDED BECAUSE SP MAY NOT BE VALID (E.G. ABOVE HIMEM)
  1164                          ;
  1165  082d  210a05            ERROR:	LD	HL,ERRWDS
  1166  0830  4f                	LD	C,A
  1167  0831  b7                	OR	A
  1168  0832  280c              	JR	Z,ERROR1
  1169  0834  47                	LD	B,A		;ERROR NUMBER
  1170  0835  af                	XOR	A
  1171  0836  be                ERROR0:	CP	(HL)
  1172  0837  23                	INC	HL
  1173  0838  20fc              	JR	NZ,ERROR0
  1174  083a  10fa              	DJNZ	ERROR0
  1175  083c  1802              	JR	ERROR1		;MUST NOT PUSH HL HERE
  1176                          ;
  1177  083e  e1                EXTERR:	POP	HL
  1178  083f  4f                	LD	C,A
  1179  0840  220000            ERROR1:	LD	(ERRTXT),HL
  1180  0843  2a0000            	LD	HL,(ONERSP)
  1181  0846  7c                	LD	A,H
  1182  0847  b5                	OR	L
  1183  0848  ed7b0000          	LD	SP,(HIMEM)	;MUST SET SP BEFORE 'CALL'
  1184  084c  2801              	JR	Z,ERROR4
  1185  084e  f9                	LD	SP,HL
  1186  084f  79                ERROR4:	LD	A,C		;ERROR NUMBER
  1187  0850  cd440a            	CALL	SETLIN		;SP IS SET NOW
  1188  0853  320000            	LD	(ERR),A
  1189  0856  220000            	LD	(ERL),HL
  1190  0859  b7                	OR	A
  1191  085a  280b              	JR	Z,ERROR2	;'FATAL' ERROR
  1192  085c  2a0000            	LD	HL,(ERRTRP)
  1193  085f  7c                	LD	A,H
  1194  0860  b5                	OR	L
  1195  0861  e5                	PUSH	HL
  1196  0862  fde1              	POP	IY
  1197  0864  c20000            	JP	NZ,XEQ		;ERROR TRAPPED
  1198  0867  ed7b0000          ERROR2:	LD	SP,(HIMEM)
  1199  086b  ed62              	SBC	HL,HL
  1200  086d  220000            	LD	(AUTONO),HL
  1201  0870  220000            	LD	(TRACEN),HL	;CANCEL TRACE
  1202  0873  cd0000            	CALL	RESET		;RESET OPSYS
  1203  0876  cde409            	CALL	CRLF
  1204  0879  cdce0d            	CALL	REPORT		;MESSAGE
  1205  087c  2a0000            	LD	HL,(ERL)
  1206  087f  cd6b0a            	CALL	SAYLN
  1207  0882  1e00              	LD	E,0
  1208  0884  dc0000            	CALL	C,OSSHUT	;CLOSE ALL FILES
  1209  0887  cde409            	CALL	CRLF
  1210  088a  1883              	JR	CLOOP0
  1211                          ;
  1212                          ;SUBROUTINES:
  1213                          ;
  1214                          ;
  1215                          ;LEX - SEARCH FOR KEYWORDS
  1216                          ;   Inputs: HL = start of keyword table
  1217                          ;           IY = start of match text
  1218                          ;  Outputs: If found, Z-flag set, A=token.
  1219                          ;           If not found, Z-flag reset, A=(IY).
  1220                          ;           IY updated (if NZ, IY unchanged).
  1221                          ; Destroys: A,B,H,L,IY,F
  1222                          ;
  1223  088c  216d01            LEX:	LD	HL,KEYWDS
  1224  088f  fd7e00            LEX0:	LD	A,(IY)
  1225  0892  46                	LD	B,(HL)
  1226  0893  23                	INC	HL
  1227  0894  be                	CP	(HL)
  1228  0895  280a              	JR	Z,LEX2
  1229  0897  d8                	RET	C		;FAIL EXIT
  1230  0898  23                LEX1:	INC	HL
  1231  0899  7e                	LD	A,(HL)
  1232  089a  fea0              	CP	160
  1233  089c  ea9808            	JP	PE,LEX1
  1234  089f  18ee              	JR	LEX0
  1235                          ;
  1236  08a1  fde5              LEX2:	PUSH	IY		;SAVE POINTER
  1237  08a3  23                LEX3:	INC	HL
  1238  08a4  7e                	LD	A,(HL)
  1239  08a5  fea0              	CP	160
  1240  08a7  e2ce08            	JP	PO,LEX6		;FOUND
  1241  08aa  fd23              	INC	IY
  1242  08ac  fd7e00            	LD	A,(IY)
  1243  08af  be                	CP	(HL)
  1244  08b0  2005              	JR	NZ,LEX7
  1245  08b2  fea1              	CP	161
  1246  08b4  eaa308            	JP	PE,LEX3
  1247  08b7  fd7e00            LEX7:	LD	A,(IY)
  1248  08ba  fe2e              	CP	'.'
  1249  08bc  2810              	JR	Z,LEX6		;FOUND (ABBREV.)
  1250  08be  cde50c            	CALL	RANGE1
  1251  08c1  3804              	JR	C,LEX5
  1252  08c3  fde1              LEX4:	POP	IY		;RESTORE POINTER
  1253  08c5  18d1              	JR	LEX1
  1254                          ;
  1255  08c7  7e                LEX5:	LD	A,(HL)
  1256  08c8  fe20              	CP	' '
  1257  08ca  20f7              	JR	NZ,LEX4
  1258  08cc  fd2b              	DEC	IY
  1259  08ce  f1                LEX6:	POP	AF
  1260  08cf  af                	XOR	A
  1261  08d0  78                	LD	A,B
  1262  08d1  c9                	RET
  1263                          ;
  1264                          ;DEL - DELETE A PROGRAM LINE.
  1265                          ;   Inputs: HL addresses program line.
  1266                          ; Destroys: B,C,F
  1267                          ;
  1268  08d2  d5                DEL:	PUSH	DE
  1269  08d3  e5                	PUSH	HL
  1270  08d4  e5                	PUSH	HL
  1271  08d5  0600              	LD	B,0
  1272  08d7  4e                	LD	C,(HL)
  1273  08d8  09                	ADD	HL,BC
  1274  08d9  e5                	PUSH	HL
  1275  08da  eb                	EX	DE,HL
  1276  08db  cd0e09            	CALL	GETTOP
  1277  08de  ed52              	SBC	HL,DE
  1278  08e0  44                	LD	B,H
  1279  08e1  4d                	LD	C,L
  1280  08e2  e1                	POP	HL
  1281  08e3  d1                	POP	DE
  1282  08e4  edb0              	LDIR			;DELETE LINE
  1283  08e6  e1                	POP	HL
  1284  08e7  d1                	POP	DE
  1285  08e8  c9                	RET
  1286                          ;
  1287                          ;LOAD0 - LOAD A DISK FILE THEN CLEAN.
  1288                          ;   Inputs: Filename in ACCS (term CR)
  1289                          ; Destroys: A,B,C,D,E,H,L,F
  1290                          ;
  1291                          ;CLEAN - CHECK FOR BAD PROGRAM, FIND END OF TEXT
  1292                          ; AND WRITE FF FF.
  1293                          ; Destroys: A,B,C,H,L,F
  1294                          ;
  1295  08e9  ed5b0000          LOAD0:	LD	DE,(PAGE)
  1296  08ed  2100ff            	LD	HL,-256
  1297  08f0  39                	ADD	HL,SP
  1298  08f1  ed52              	SBC	HL,DE		;FIND AVAILABLE SPACE
  1299  08f3  44                	LD	B,H
  1300  08f4  4d                	LD	C,L
  1301  08f5  210000            	LD	HL,ACCS
  1302  08f8  cd0000            	CALL	OSLOAD		;LOAD
  1303  08fb  d42709            	CALL	NC,NEWIT
  1304  08fe  3e00              	LD	A,0
  1305  0900  d22d08            	JP	NC,ERROR	;"No room"
  1306  0903  cd0e09            CLEAN:	CALL	GETTOP
  1307  0906  2b                	DEC	HL
  1308  0907  36ff              	LD	(HL),-1		;WRITE &FFFF
  1309  0909  2b                	DEC	HL
  1310  090a  36ff              	LD	(HL),-1
  1311  090c  181e              	JR	CLEAR
  1312                          ;
  1313  090e  2a0000            GETTOP:	LD	HL,(PAGE)
  1314  0911  0600              	LD	B,0
  1315  0913  3e0d              	LD	A,CR
  1316  0915  4e                GETOP1:	LD	C,(HL)
  1317  0916  0c                	INC	C
  1318  0917  0d                	DEC	C
  1319  0918  2809              	JR	Z,GETOP2
  1320  091a  09                	ADD	HL,BC
  1321  091b  2b                	DEC	HL
  1322  091c  be                	CP	(HL)
  1323  091d  23                	INC	HL
  1324  091e  28f5              	JR	Z,GETOP1
  1325  0920  c3d807            	JP	BAD
  1326  0923  23                GETOP2:	INC	HL		;N.B. CALLED FROM NEWIT
  1327  0924  23                	INC	HL
  1328  0925  23                	INC	HL
  1329  0926  c9                	RET
  1330                          ;
  1331                          ;NEWIT - NEW PROGRAM THEN CLEAR
  1332                          ;   Destroys: H,L
  1333                          ;
  1334                          ;CLEAR - CLEAR ALL DYNAMIC VARIABLES INCLUDING
  1335                          ; FUNCTION AND PROCEDURE POINTERS.
  1336                          ;   Destroys: Nothing
  1337                          ;
  1338  0927  2a0000            NEWIT:	LD	HL,(PAGE)
  1339  092a  3600              	LD	(HL),0
  1340  092c  e5                CLEAR:	PUSH	HL
  1341  092d  c5                	PUSH	BC
  1342  092e  f5                	PUSH	AF
  1343  092f  cd0e09            	CALL	GETTOP
  1344  0932  220000            	LD	(LOMEM),HL
  1345  0935  220000            	LD	(FREE),HL
  1346  0938  210000            	LD	HL,DYNVAR
  1347  093b  0670              	LD	B,2*(54+2)
  1348  093d  3600              CLEAR1:	LD	(HL),0
  1349  093f  23                	INC	HL
  1350  0940  10fb              	DJNZ	CLEAR1
  1351  0942  f1                	POP	AF
  1352  0943  c1                	POP	BC
  1353  0944  e1                	POP	HL
  1354  0945  c9                	RET
  1355                          ;
  1356                          ;LISTIT - LIST A PROGRAM LINE.
  1357                          ;    Inputs: HL addresses line
  1358                          ;            DE = line number (binary)
  1359                          ;	     E' = indentation count
  1360                          ;            IX addresses LISTON
  1361                          ;  Destroys: A,D,E,B',C',D',E',H',L',IY,F
  1362                          ;
  1363  0946  e5                LISTIT:	PUSH	HL
  1364  0947  eb                	EX	DE,HL
  1365  0948  c5                	PUSH	BC
  1366  0949  cd7f0a            	CALL	PBCD
  1367  094c  c1                	POP	BC
  1368  094d  e1                	POP	HL
  1369  094e  7e                	LD	A,(HL)
  1370  094f  d9                	EXX
  1371  0950  216706            	LD	HL,TOKSUB
  1372  0953  010800            	LD	BC,LENSUB
  1373  0956  edb1              	CPIR
  1374  0958  ccde09            	CALL	Z,INDSUB
  1375  095b  fecb              	CP	TENDCASE
  1376  095d  ccde09            	CALL	Z,INDSUB
  1377  0960  3e20              	LD	A,' '
  1378  0962  ddcb0046          	BIT	0,(IX)
  1379  0966  c4eb09            	CALL	NZ,OUTCHR
  1380  0969  7b                	LD	A,E
  1381  096a  87                	ADD	A,A
  1382  096b  ddcb004e          	BIT	1,(IX)
  1383  096f  c40000            	CALL	NZ,SPACES
  1384  0972  d9                	EXX
  1385  0973  7e                	LD	A,(HL)
  1386  0974  1e00              	LD	E,0
  1387  0976  d9                	EXX
  1388  0977  010700            	LD	BC,LENADD
  1389  097a  216006            LIST5:	LD	HL,TOKADD
  1390  097d  edb1              	CPIR
  1391  097f  cce209            	CALL	Z,INDADD
  1392  0982  fec8              	CP	TCASE
  1393  0984  cce209            	CALL	Z,INDADD
  1394  0987  d9                	EXX
  1395  0988  7e                LIST8:	LD	A,(HL)
  1396  0989  23                	INC	HL
  1397  098a  fe0d              	CP	CR
  1398  098c  2825              	JR	Z,LIST9
  1399  098e  57                	LD	D,A
  1400  098f  fe10              	CP	TEXIT
  1401  0991  2002              	JR	NZ,LIST6
  1402  0993  cbfb              	SET	7,E
  1403  0995  fe22              LIST6:	CP	'"'
  1404  0997  2001              	JR	NZ,LIST7
  1405  0999  1c                	INC	E
  1406  099a  cdd209            LIST7:	CALL	LOUT
  1407  099d  7b                	LD	A,E
  1408  099e  e681              	AND	81H
  1409  09a0  20e6              	JR	NZ,LIST8
  1410  09a2  7e                	LD	A,(HL)
  1411  09a3  d9                	EXX
  1412  09a4  216706            	LD	HL,TOKSUB
  1413  09a7  010300            	LD	BC,3
  1414  09aa  edb1              	CPIR
  1415  09ac  ccde09            	CALL	Z,INDSUB
  1416  09af  0e04              	LD	C,4
  1417  09b1  18c7              	JR	LIST5
  1418                          ;
  1419  09b3  7a                LIST9:	LD	A,D
  1420  09b4  fe8c              	CP	TTHEN
  1421  09b6  d9                	EXX
  1422  09b7  cce209            	CALL	Z,INDADD
  1423  09ba  d9                	EXX
  1424  09bb  1827              	JR	CRLF
  1425                          ;
  1426  09bd  e5                PRLINO:	PUSH	HL
  1427  09be  fde1              	POP	IY
  1428  09c0  c5                	PUSH	BC
  1429  09c1  cd0000            	CALL	DECODE
  1430  09c4  c1                	POP	BC
  1431  09c5  d9                	EXX
  1432  09c6  c5                	PUSH	BC
  1433  09c7  d5                	PUSH	DE
  1434  09c8  cd7b0a            	CALL	PBCDL
  1435  09cb  d1                	POP	DE
  1436  09cc  c1                	POP	BC
  1437  09cd  d9                	EXX
  1438  09ce  fde5              	PUSH	IY
  1439  09d0  e1                	POP	HL
  1440  09d1  c9                	RET
  1441                          ;
  1442  09d2  cb43              LOUT:	BIT	0,E
  1443  09d4  2015              	JR	NZ,OUTCHR
  1444  09d6  fe8d              	CP	TLINO
  1445  09d8  28e3              	JR	Z,PRLINO
  1446  09da  cd040a            	CALL	OUT
  1447  09dd  c9                	RET
  1448                          ;
  1449  09de  1d                INDSUB:	DEC	E
  1450  09df  f2e309            	JP	P,INDRET
  1451  09e2  1c                INDADD:	INC	E
  1452  09e3  c9                INDRET:	RET
  1453                          ;
  1454                          ;CRLF - SEND CARRIAGE RETURN, LINE FEED.
  1455                          ;  Destroys: A,F
  1456                          ;OUTCHR - OUTPUT A CHARACTER TO CONSOLE.
  1457                          ;    Inputs: A = character
  1458                          ;  Destroys: A,F
  1459                          ;
  1460  09e4  3e0d              CRLF:	LD	A,CR
  1461  09e6  cdeb09            	CALL	OUTCHR
  1462  09e9  3e0a              	LD	A,LF
  1463  09eb  cd0000            OUTCHR:	CALL	OSWRCH
  1464  09ee  d60d              	SUB	CR
  1465  09f0  2805              	JR	Z,CARRET
  1466  09f2  d8                	RET	C		;NON-PRINTING
  1467  09f3  3a0000            	LD	A,(COUNT)
  1468  09f6  3c                	INC	A
  1469  09f7  320000            CARRET:	LD	(COUNT),A
  1470  09fa  c8                	RET	Z
  1471  09fb  e5                	PUSH	HL
  1472  09fc  2a0000            	LD	HL,(WIDTH)
  1473  09ff  bd                	CP	L
  1474  0a00  e1                	POP	HL
  1475  0a01  c0                	RET	NZ
  1476  0a02  18e0              	JR	CRLF
  1477                          ;
  1478                          ;OUT - SEND CHARACTER OR KEYWORD
  1479                          ;   Inputs: A = character (>=10, <128)
  1480                          ;           A = Token (<10, >=128)
  1481                          ;  Destroys: A,F
  1482                          ;
  1483  0a04  fea0              OUT:	CP	160
  1484  0a06  eaeb09            	JP	PE,OUTCHR
  1485  0a09  c5                	PUSH	BC
  1486  0a0a  e5                	PUSH	HL
  1487  0a0b  216d01            	LD	HL,KEYWDS
  1488  0a0e  015b03            	LD	BC,KEYWDL
  1489  0a11  edb1              	CPIR
  1490  0a13  c4eb09            	CALL	NZ,OUTCHR
  1491  0a16  06a0              	LD	B,160
  1492  0a18  fe91              	CP	145
  1493  0a1a  ea1e0a            	JP	PE,TOKEN1
  1494  0a1d  04                	INC	B
  1495  0a1e  7e                TOKEN1:	LD	A,(HL)
  1496  0a1f  23                	INC	HL
  1497  0a20  b8                	CP	B
  1498  0a21  f5                	PUSH	AF
  1499  0a22  eceb09            	CALL	PE,OUTCHR
  1500  0a25  f1                	POP	AF
  1501  0a26  ea1e0a            	JP	PE,TOKEN1
  1502  0a29  e1                	POP	HL
  1503  0a2a  c1                	POP	BC
  1504  0a2b  c9                	RET
  1505                          ;
  1506                          ;FINDL - FIND PROGRAM LINE.
  1507                          ;   Inputs: HL = line number (binary)
  1508                          ;  Outputs: HL addresses line (if found)
  1509                          ;           DE = line number
  1510                          ;           Z-flag set if found.
  1511                          ; Destroys: A,B,C,D,E,H,L,F
  1512                          ;
  1513  0a2c  eb                FINDL:	EX	DE,HL
  1514  0a2d  2a0000            	LD	HL,(PAGE)
  1515  0a30  af                	XOR	A		;A=0
  1516  0a31  be                	CP	(HL)
  1517  0a32  3c                	INC	A
  1518  0a33  d0                	RET	NC
  1519  0a34  af                	XOR	A		;CLEAR CARRY
  1520  0a35  47                	LD	B,A
  1521  0a36  4e                FINDL1:	LD	C,(HL)
  1522  0a37  e5                	PUSH	HL
  1523  0a38  23                	INC	HL
  1524  0a39  7e                	LD	A,(HL)
  1525  0a3a  23                	INC	HL
  1526  0a3b  66                	LD	H,(HL)
  1527  0a3c  6f                	LD	L,A
  1528  0a3d  ed52              	SBC	HL,DE
  1529  0a3f  e1                	POP	HL
  1530  0a40  d0                	RET	NC		;FOUND OR PAST
  1531  0a41  09                	ADD	HL,BC
  1532  0a42  18f2              	JR	FINDL1
  1533                          ;
  1534                          ;SETLIN - Search program for line containing address.
  1535                          ;   Inputs: Address in (CURLIN)
  1536                          ;  Outputs: Line number in HL
  1537                          ; Destroys: B,C,D,E,H,L,F
  1538                          ;
  1539  0a44  0600              SETLIN:	LD	B,0
  1540  0a46  ed5b0000          	LD	DE,(CURLIN)
  1541  0a4a  2a0000            	LD	HL,(PAGE)
  1542  0a4d  b7                	OR	A
  1543  0a4e  ed52              	SBC	HL,DE
  1544  0a50  19                	ADD	HL,DE
  1545  0a51  3013              	JR	NC,SET3
  1546  0a53  4e                SET1:	LD	C,(HL)
  1547  0a54  0c                	INC	C
  1548  0a55  0d                	DEC	C
  1549  0a56  280e              	JR	Z,SET3
  1550  0a58  09                	ADD	HL,BC
  1551  0a59  ed52              	SBC	HL,DE
  1552  0a5b  19                	ADD	HL,DE
  1553  0a5c  38f5              	JR	C,SET1
  1554  0a5e  ed42              	SBC	HL,BC
  1555  0a60  23                	INC	HL
  1556  0a61  5e                	LD	E,(HL)		;LINE NUMBER
  1557  0a62  23                	INC	HL
  1558  0a63  56                	LD	D,(HL)
  1559  0a64  eb                	EX	DE,HL
  1560  0a65  c9                SET2:	RET
  1561                          ;
  1562  0a66  210000            SET3:	LD	HL,0
  1563  0a69  18fa              	JR	SET2
  1564                          ;
  1565                          ;SAYLN - PRINT " at line nnnn" MESSAGE.
  1566                          ;   Inputs: HL = line number
  1567                          ;  Outputs: Carry=0 if line number is zero.
  1568                          ;           Carry=1 if line number is non-zero.
  1569                          ; Destroys: A,B,C,D,E,H,L,F
  1570                          ;
  1571  0a6b  7c                SAYLN:	LD	A,H
  1572  0a6c  b5                	OR	L
  1573  0a6d  c8                	RET	Z
  1574  0a6e  cde30d            	CALL	TELL
  1575  0a71  206174206c696e65  	DEFM " at line "
              20                
  1576  0a7a  00                	DEFB	0
  1577  0a7b  0e00              PBCDL:	LD	C,0
  1578  0a7d  1802              	JR	PBCD0
  1579                          ;
  1580                          ;PBCD - PRINT NUMBER AS DECIMAL INTEGER.
  1581                          ;   Inputs: HL = number (binary).
  1582                          ;  Outputs: Carry = 1
  1583                          ; Destroys: A,B,C,D,E,H,L,F
  1584                          ;
  1585  0a7f  0e20              PBCD:	LD	C,' '
  1586  0a81  0605              PBCD0:	LD	B,5
  1587  0a83  111027            	LD	DE,10000
  1588  0a86  af                PBCD1:	XOR	A
  1589  0a87  ed52              PBCD2:	SBC	HL,DE
  1590  0a89  3c                	INC	A
  1591  0a8a  30fb              	JR	NC,PBCD2
  1592  0a8c  19                	ADD	HL,DE
  1593  0a8d  3d                	DEC	A
  1594  0a8e  2804              	JR	Z,PBCD3
  1595  0a90  cbe1              	SET	4,C
  1596  0a92  cbe9              	SET	5,C
  1597  0a94  b1                PBCD3:	OR	C
  1598  0a95  c4eb09            	CALL	NZ,OUTCHR
  1599  0a98  78                	LD	A,B
  1600  0a99  fe05              	CP	5
  1601  0a9b  2806              	JR	Z,PBCD4
  1602  0a9d  29                	ADD	HL,HL
  1603  0a9e  54                	LD	D,H
  1604  0a9f  5d                	LD	E,L
  1605  0aa0  29                	ADD	HL,HL
  1606  0aa1  29                	ADD	HL,HL
  1607  0aa2  19                	ADD	HL,DE
  1608  0aa3  11e803            PBCD4:	LD	DE,1000
  1609  0aa6  10de              	DJNZ	PBCD1
  1610  0aa8  37                	SCF
  1611  0aa9  c9                	RET
  1612                          ;
  1613                          ;HANDLE WHOLE ARRAY:
  1614                          ;
  1615  0aaa  fd23              GETV1:	INC	IY
  1616  0aac  fd23              	INC	IY		;SKIP ()
  1617  0aae  e5                	PUSH	HL		;SET EXIT CONDITIONS
  1618  0aaf  dde1              	POP	IX
  1619  0ab1  7a                	LD	A,D
  1620  0ab2  f640              	OR	64		;FLAG ARRAY
  1621  0ab4  bf                	CP	A
  1622  0ab5  c9                	RET
  1623                          ;
  1624                          ;PUTVAR - CREATE VARIABLE AND INITIALISE TO ZERO.
  1625                          ;   Inputs: HL, IY as returned from GETVAR (NZ).
  1626                          ;  Outputs: As GETVAR.
  1627                          ; Destroys: everything
  1628                          ;
  1629  0ab6  cd250c            PUTVAR:	CALL	CREATE
  1630  0ab9  fd7e00            	LD	A,(IY)
  1631  0abc  fe28              	CP	'('
  1632  0abe  207d              	JR	NZ,GETVZ	;SET EXIT CONDITIONS
  1633  0ac0  fd7e01            	LD	A,(IY+1)
  1634  0ac3  fe29              	CP	')'		;WHOLE ARRAY?
  1635  0ac5  28e3              	JR	Z,GETV1
  1636  0ac7  3e0e              ARRAY:	LD	A,14		;'Bad use of array'
  1637  0ac9  c32d08            ERROR3:	JP	ERROR
  1638                          ;
  1639                          ;GETVAR - GET LOCATION OF VARIABLE, RETURN IN HL & IX
  1640                          ;   Inputs: IY addresses first character.
  1641                          ;  Outputs: Carry set and NZ if illegal character.
  1642                          ;           Z-flag set if variable found, then:
  1643                          ;            A = variable type (0,4,5,128 or 129)
  1644                          ;                (68,69 or 193 for whole array)
  1645                          ;            HL = IX = variable pointer.
  1646                          ;            IY updated
  1647                          ;           If Z-flag & carry reset, then:
  1648                          ;            HL, IY set for subsequent PUTVAR call.
  1649                          ; Destroys: everything
  1650                          ;
  1651  0acc  fd7e00            GETVAR:	LD	A,(IY)
  1652  0acf  fe21              	CP	'!'
  1653  0ad1  2876              	JR	Z,GETV5
  1654  0ad3  fe3f              	CP	'?'
  1655  0ad5  2876              	JR	Z,GETV6
  1656  0ad7  fe7c              	CP	'|'
  1657  0ad9  2875              	JR	Z,GETVF
  1658  0adb  fe24              	CP	'$'
  1659  0add  2875              	JR	Z,GETV4
  1660  0adf  cd990b            	CALL	LOCATE
  1661  0ae2  c0                	RET	NZ
  1662  0ae3  fd7e00            	LD	A,(IY)
  1663  0ae6  fe28              	CP	'('		;ARRAY?
  1664  0ae8  204b              	JR	NZ,GETVX	;EXIT
  1665  0aea  fd7e01            	LD	A,(IY+1)
  1666  0aed  fe29              	CP	')'		;WHOLE ARRAY?
  1667  0aef  28b9              	JR	Z,GETV1
  1668  0af1  d5                	PUSH	DE		;SAVE TYPE
  1669  0af2  7e                	LD	A,(HL)
  1670  0af3  23                	INC	HL
  1671  0af4  66                	LD	H,(HL)
  1672  0af5  6f                	LD	L,A		;INDIRECT LINK
  1673  0af6  e6fe              	AND	0FEH
  1674  0af8  b4                	OR	H
  1675  0af9  28cc              	JR	Z,ARRAY
  1676  0afb  7e                	LD	A,(HL)		;NO. OF DIMENSIONS
  1677  0afc  b7                	OR	A
  1678  0afd  28c8              	JR	Z,ARRAY
  1679  0aff  23                	INC	HL
  1680  0b00  110000            	LD	DE,0		;ACCUMULATOR
  1681  0b03  f5                	PUSH	AF
  1682  0b04  fd23              	INC	IY		;SKIP (
  1683  0b06  e5                GETV3:	PUSH	HL
  1684  0b07  d5                	PUSH	DE
  1685  0b08  cd0000            	CALL	EXPRI		;SUBSCRIPT
  1686  0b0b  d9                	EXX
  1687  0b0c  d1                	POP	DE
  1688  0b0d  e3                	EX	(SP),HL
  1689  0b0e  4e                	LD	C,(HL)
  1690  0b0f  23                	INC	HL
  1691  0b10  46                	LD	B,(HL)
  1692  0b11  23                	INC	HL
  1693  0b12  e3                	EX	(SP),HL
  1694  0b13  eb                	EX	DE,HL
  1695  0b14  d5                	PUSH	DE
  1696  0b15  cd0000            	CALL	MUL16		;HL=HL*BC
  1697  0b18  d1                	POP	DE
  1698  0b19  19                	ADD	HL,DE
  1699  0b1a  eb                	EX	DE,HL
  1700  0b1b  b7                	OR	A
  1701  0b1c  ed42              	SBC	HL,BC
  1702  0b1e  3e0f              	LD	A,15
  1703  0b20  30a7              	JR	NC,ERROR3	;"Subscript"
  1704  0b22  e1                	POP	HL
  1705  0b23  f1                	POP	AF
  1706  0b24  3d                	DEC	A		;DIMENSION COUNTER
  1707  0b25  201c              	JR	NZ,GETV2
  1708  0b27  cd0000            	CALL	BRAKET		;CLOSING BRACKET
  1709  0b2a  f1                	POP	AF		;RESTORE TYPE
  1710  0b2b  e5                	PUSH	HL
  1711  0b2c  cd0000            	CALL	X14OR5		;DE=DE*n
  1712  0b2f  e1                	POP	HL
  1713  0b30  19                	ADD	HL,DE
  1714  0b31  57                	LD	D,A		;TYPE
  1715  0b32  fd7e00            	LD	A,(IY)
  1716  0b35  fe3f              GETVX:	CP	'?'
  1717  0b37  2826              	JR	Z,GETV9
  1718  0b39  fe21              	CP	'!'
  1719  0b3b  281e              	JR	Z,GETV8
  1720  0b3d  e5                GETVZ:	PUSH	HL		;SET EXIT CONDITIONS
  1721  0b3e  dde1              	POP	IX
  1722  0b40  7a                	LD	A,D
  1723  0b41  bf                	CP	A
  1724  0b42  c9                	RET
  1725                          ;
  1726  0b43  f5                GETV2:	PUSH	AF
  1727  0b44  cd0000            	CALL	COMMA
  1728  0b47  18bd              	JR	GETV3
  1729                          ;
  1730                          ;PROCESS UNARY & BINARY INDIRECTION:
  1731                          ;
  1732  0b49  3e04              GETV5:	LD	A,4		;UNARY 32-BIT INDIRN.
  1733  0b4b  1809              	JR	GETV7
  1734  0b4d  af                GETV6:	XOR	A		;UNARY 8-BIT INDIRECTION
  1735  0b4e  1806              	JR	GETV7
  1736  0b50  3e05              GETVF:	LD	A,5		;VARIANT INDIRECTION
  1737  0b52  1802              	JR	GETV7
  1738  0b54  3e80              GETV4:	LD	A,128		;STATIC STRING
  1739  0b56  ed62              GETV7:	SBC	HL,HL
  1740  0b58  f5                	PUSH	AF
  1741  0b59  1815              	JR	GETV0
  1742                          ;
  1743  0b5b  0604              GETV8:	LD	B,4		;32-BIT BINARY INDIRN.
  1744  0b5d  1802              	JR	GETVA
  1745  0b5f  0600              GETV9:	LD	B,0		;8-BIT BINARY INDIRN.
  1746  0b61  e5                GETVA:	PUSH	HL
  1747  0b62  dde1              	POP	IX
  1748  0b64  7a                	LD	A,D		;TYPE
  1749  0b65  fe81              	CP	129
  1750  0b67  c8                	RET	Z		;STRING!
  1751  0b68  c5                	PUSH	BC
  1752  0b69  cd0000            	CALL	LOADN		;LEFT OPERAND
  1753  0b6c  cd0000            	CALL	SFIX
  1754  0b6f  d9                	EXX
  1755  0b70  e5                GETV0:	PUSH	HL
  1756  0b71  fd23              	INC	IY
  1757  0b73  cd0000            	CALL	ITEMI
  1758  0b76  d9                	EXX
  1759  0b77  d1                	POP	DE
  1760  0b78  f1                	POP	AF
  1761  0b79  19                	ADD	HL,DE
  1762  0b7a  e5                	PUSH	HL
  1763  0b7b  dde1              	POP	IX
  1764  0b7d  bf                	CP	A
  1765  0b7e  c9                	RET
  1766                          ;
  1767                          ;GETDEF - Find entry for FN or PROC in dynamic area.
  1768                          ;   Inputs: IY addresses byte following "DEF" token.
  1769                          ;  Outputs: Z flag set if found
  1770                          ;           Carry set if neither FN or PROC first.
  1771                          ;           If Z: HL points to entry
  1772                          ;                 IY addresses delimiter
  1773                          ; Destroys: A,D,E,H,L,IY,F
  1774                          ;
  1775  0b7f  fd7e01            GETDEF:	LD	A,(IY+1)
  1776  0b82  cde50c            	CALL	RANGE1
  1777  0b85  d8                	RET	C
  1778  0b86  fd7e00            	LD	A,(IY)
  1779  0b89  210000            	LD	HL,FNPTR
  1780  0b8c  fea4              	CP	TFN
  1781  0b8e  2843              	JR	Z,LOC2
  1782  0b90  210000            	LD	HL,PROPTR
  1783  0b93  fef2              	CP	TPROC
  1784  0b95  283c              	JR	Z,LOC2
  1785  0b97  37                	SCF
  1786  0b98  c9                	RET
  1787                          ;
  1788                          ;LOCATE - Try to locate variable name in static or
  1789                          ;dynamic variables.  If illegal first character return
  1790                          ;carry, non-zero.  If found, return no-carry, zero.
  1791                          ;If not found, return no-carry, non-zero.
  1792                          ;   Inputs: IY addresses first character of name.
  1793                          ;           A=(IY)
  1794                          ;  Outputs: Z-flag set if found, then:
  1795                          ;            IY addresses terminator
  1796                          ;            HL addresses location of variable
  1797                          ;            D=type of variable:  4 = integer
  1798                          ;                                 5 = floating point
  1799                          ;                               129 = string
  1800                          ; Destroys: A,D,E,H,L,IY,F
  1801                          ;
  1802  0b99  d640              LOCATE:	SUB	'@'
  1803  0b9b  d8                	RET	C
  1804  0b9c  2600              	LD	H,0
  1805  0b9e  fe1b              	CP	'Z'-'@'+1
  1806  0ba0  301d              	JR	NC,LOC0		;NOT STATIC
  1807  0ba2  87                	ADD	A,A
  1808  0ba3  6f                	LD	L,A
  1809  0ba4  fd7e01            	LD	A,(IY+1)	;2nd CHARACTER
  1810  0ba7  fe25              	CP	'%'
  1811  0ba9  2020              	JR	NZ,LOC1		;NOT STATIC
  1812  0bab  fd7e02            	LD	A,(IY+2)
  1813  0bae  fe28              	CP	'('
  1814  0bb0  2819              	JR	Z,LOC1		;NOT STATIC
  1815  0bb2  29                	ADD	HL,HL
  1816  0bb3  110000            	LD	DE,STAVAR	;STATIC VARIABLES
  1817  0bb6  19                	ADD	HL,DE
  1818  0bb7  fd23              	INC	IY
  1819  0bb9  fd23              	INC	IY
  1820  0bbb  1604              	LD	D,4		;INTEGER TYPE
  1821  0bbd  af                	XOR	A
  1822  0bbe  c9                	RET
  1823                          ;
  1824  0bbf  fe1f              LOC0:	CP	'_'-'@'
  1825  0bc1  d8                	RET	C
  1826  0bc2  fe3b              	CP	'z'-'@'+1
  1827  0bc4  3f                	CCF
  1828  0bc5  3d                	DEC	A		;SET NZ
  1829  0bc6  d8                	RET	C
  1830  0bc7  d603              	SUB	3
  1831  0bc9  87                	ADD	A,A
  1832  0bca  6f                	LD	L,A
  1833  0bcb  110000            LOC1:	LD	DE,DYNVAR	;DYNAMIC VARIABLES
  1834  0bce  2d                	DEC	L
  1835  0bcf  2d                	DEC	L
  1836  0bd0  37                	SCF
  1837  0bd1  f8                	RET	M
  1838  0bd2  19                	ADD	HL,DE
  1839  0bd3  5e                LOC2:	LD	E,(HL)
  1840  0bd4  23                	INC	HL
  1841  0bd5  56                	LD	D,(HL)
  1842  0bd6  7a                	LD	A,D
  1843  0bd7  b3                	OR	E
  1844  0bd8  2849              	JR	Z,LOC6		;UNDEFINED VARIABLE
  1845  0bda  62                	LD	H,D
  1846  0bdb  6b                	LD	L,E
  1847  0bdc  23                	INC	HL		;SKIP LINK
  1848  0bdd  23                	INC	HL
  1849  0bde  fde5              	PUSH	IY
  1850  0be0  7e                LOC3:	LD	A,(HL)		;COMPARE
  1851  0be1  23                	INC	HL
  1852  0be2  fd23              	INC	IY
  1853  0be4  fdbe00            	CP	(IY)
  1854  0be7  28f7              	JR	Z,LOC3
  1855  0be9  b7                	OR	A		;0=TERMINATOR
  1856  0bea  2805              	JR	Z,LOC5		;FOUND (MAYBE)
  1857  0bec  fde1              LOC4:	POP	IY
  1858  0bee  eb                	EX	DE,HL
  1859  0bef  18e2              	JR	LOC2		;TRY NEXT ENTRY
  1860                          ;
  1861  0bf1  fd2b              LOC5:	DEC	IY
  1862  0bf3  fd7e00            	LD	A,(IY)
  1863  0bf6  fe28              	CP	'('
  1864  0bf8  2813              	JR	Z,LOCX		;FOUND
  1865  0bfa  fd23              	INC	IY
  1866  0bfc  cdd80c            	CALL	RANGE
  1867  0bff  380c              	JR	C,LOCX		;FOUND
  1868  0c01  fe28              	CP	'('
  1869  0c03  28e7              	JR	Z,LOC4		;KEEP LOOKING
  1870  0c05  fd7eff            	LD	A,(IY-1)
  1871  0c08  cde50c            	CALL	RANGE1
  1872  0c0b  30df              	JR	NC,LOC4		;KEEP LOOKING
  1873  0c0d  d1                LOCX:	POP	DE
  1874  0c0e  fd7eff            TYPE:	LD	A,(IY-1)
  1875  0c11  fe24              	CP	'$'
  1876  0c13  1681              	LD	D,129
  1877  0c15  c8                	RET	Z		;STRING
  1878  0c16  fe26              	CP	'&'
  1879  0c18  1601              	LD	D,1
  1880  0c1a  c8                	RET	Z		;BYTE
  1881  0c1b  fe25              	CP	'%'
  1882  0c1d  1604              	LD	D,4
  1883  0c1f  c8                	RET	Z		;INTEGER
  1884  0c20  14                	INC	D
  1885  0c21  bf                	CP	A
  1886  0c22  c9                	RET
  1887                          ;
  1888  0c23  3c                LOC6:	INC	A		;SET NZ
  1889  0c24  c9                	RET
  1890                          ;
  1891                          ;CREATE - CREATE NEW ENTRY, INITIALISE TO ZERO.
  1892                          ;   Inputs: HL, IY as returned from LOCATE (NZ).
  1893                          ;  Outputs: As LOCATE, GETDEF.
  1894                          ; Destroys: As LOCATE, GETDEF.
  1895                          ;
  1896  0c25  af                CREATE:	XOR	A
  1897  0c26  ed5b0000          	LD	DE,(FREE)
  1898  0c2a  72                	LD	(HL),D
  1899  0c2b  2b                	DEC	HL
  1900  0c2c  73                	LD	(HL),E
  1901  0c2d  eb                	EX	DE,HL
  1902  0c2e  77                	LD	(HL),A
  1903  0c2f  23                	INC	HL
  1904  0c30  77                	LD	(HL),A
  1905  0c31  23                	INC	HL
  1906  0c32  fd23              LOC7:	INC	IY
  1907  0c34  cdd80c            	CALL	RANGE		;END OF VARIABLE?
  1908  0c37  3814              	JR	C,LOC8
  1909  0c39  77                	LD	(HL),A
  1910  0c3a  23                	INC	HL
  1911  0c3b  cde50c            	CALL	RANGE1
  1912  0c3e  30f2              	JR	NC,LOC7
  1913  0c40  fe28              	CP	'('
  1914  0c42  2809              	JR	Z,LOC8
  1915  0c44  fd7e01            	LD	A,(IY+1)
  1916  0c47  fe28              	CP	'('
  1917  0c49  28e7              	JR	Z,LOC7
  1918  0c4b  fd23              	INC	IY
  1919  0c4d  3600              LOC8:	LD	(HL),0		;TERMINATOR
  1920  0c4f  23                	INC	HL
  1921  0c50  e5                	PUSH	HL
  1922  0c51  cd0e0c            	CALL	TYPE
  1923  0c54  fd7e00            	LD	A,(IY)
  1924  0c57  fe28              	CP	'('
  1925  0c59  3e02              	LD	A,2		;SIZE OF INDIRECT LINK
  1926  0c5b  2807              	JR	Z,LOC9
  1927  0c5d  7a                	LD	A,D
  1928  0c5e  b7                	OR	A		;STRING?
  1929  0c5f  f2640c            	JP	P,LOC9
  1930  0c62  3e04              	LD	A,4
  1931  0c64  3600              LOC9:	LD	(HL),0		;INITIALISE TO ZERO
  1932  0c66  23                	INC	HL
  1933  0c67  3d                	DEC	A
  1934  0c68  20fa              	JR	NZ,LOC9
  1935  0c6a  220000            	LD	(FREE),HL
  1936  0c6d  cd0000            	CALL	CHECK
  1937  0c70  e1                	POP	HL
  1938  0c71  af                	XOR	A
  1939  0c72  c9                	RET
  1940                          ;
  1941                          ;LINNUM - GET LINE NUMBER FROM TEXT STRING
  1942                          ;   Inputs: IY = Text Pointer
  1943                          ;  Outputs: HL = Line number (zero if none)
  1944                          ;           IY updated
  1945                          ; Destroys: A,D,E,H,L,IY,F
  1946                          ;
  1947  0c73  cdf40d            LINNUM:	CALL	NXT
  1948  0c76  210000            	LD	HL,0
  1949  0c79  fd7e00            LINNM1:	LD	A,(IY)
  1950  0c7c  d630              	SUB	'0'
  1951  0c7e  d8                	RET	C
  1952  0c7f  fe0a              	CP	10
  1953  0c81  d0                	RET	NC
  1954  0c82  fd23              	INC	IY
  1955  0c84  54                	LD	D,H
  1956  0c85  5d                	LD	E,L
  1957  0c86  29                	ADD	HL,HL		;*2
  1958  0c87  380f              	JR	C,TOOBIG
  1959  0c89  29                	ADD	HL,HL		;*4
  1960  0c8a  380c              	JR	C,TOOBIG
  1961  0c8c  19                	ADD	HL,DE		;*5
  1962  0c8d  3809              	JR	C,TOOBIG
  1963  0c8f  29                	ADD	HL,HL		;*10
  1964  0c90  3806              	JR	C,TOOBIG
  1965  0c92  5f                	LD	E,A
  1966  0c93  1600              	LD	D,0
  1967  0c95  19                	ADD	HL,DE		;ADD IN DIGIT
  1968  0c96  30e1              	JR	NC,LINNM1
  1969  0c98  3e14              TOOBIG:	LD	A,20
  1970  0c9a  c32d08            	JP	ERROR		;"Too big"
  1971                          ;
  1972                          ;PAIR - GET PAIR OF LINE NUMBERS FOR RENUMBER/AUTO.
  1973                          ;   Inputs: IY = text pointer
  1974                          ;  Outputs: HL = first number (10 by default)
  1975                          ;           BC = second number (10 by default)
  1976                          ; Destroys: A,B,C,D,E,H,L,B',C',D',E',H',L',IY,F
  1977                          ;
  1978  0c9d  cd730c            PAIR:	CALL	LINNUM		;FIRST
  1979  0ca0  7c                	LD	A,H
  1980  0ca1  b5                	OR	L
  1981  0ca2  2002              	JR	NZ,PAIR1
  1982  0ca4  2e0a              	LD	L,10
  1983  0ca6  cd0000            PAIR1:	CALL	TERMQ
  1984  0ca9  fd23              	INC	IY
  1985  0cab  e5                	PUSH	HL
  1986  0cac  210a00            	LD	HL,10
  1987  0caf  c4730c            	CALL	NZ,LINNUM	;SECOND
  1988  0cb2  e3                	EX	(SP),HL
  1989  0cb3  c1                	POP	BC
  1990  0cb4  78                	LD	A,B
  1991  0cb5  b1                	OR	C
  1992  0cb6  c0                	RET	NZ
  1993  0cb7  cd3e08            	CALL	EXTERR
  1994  0cba  53696c6c79        	DEFM "Silly"
  1995  0cbf  00                	DEFB	0
  1996                          ;
  1997                          ;DLPAIR - GET PAIR OF LINE NUMBERS FOR DELETE/LIST.
  1998                          ;   Inputs: IY = text pointer
  1999                          ;  Outputs: HL = points to program text
  2000                          ;           BC = second number (0 by default)
  2001                          ; Destroys: A,B,C,D,E,H,L,IY,F
  2002                          ;
  2003  0cc0  cd730c            DLPAIR:	CALL	LINNUM
  2004  0cc3  e5                	PUSH	HL
  2005  0cc4  cd0000            	CALL	TERMQ
  2006  0cc7  2809              	JR	Z,DLP1
  2007  0cc9  fee7              	CP	TIF
  2008  0ccb  2805              	JR	Z,DLP1
  2009  0ccd  fd23              	INC	IY
  2010  0ccf  cd730c            	CALL	LINNUM
  2011  0cd2  e3                DLP1:	EX	(SP),HL
  2012  0cd3  cd2c0a            	CALL	FINDL
  2013  0cd6  c1                	POP	BC
  2014  0cd7  c9                	RET
  2015                          ;
  2016                          ;TEST FOR VALID CHARACTER IN VARIABLE NAME:
  2017                          ;   Inputs: IY addresses character
  2018                          ;  Outputs: Carry set if out-of-range.
  2019                          ; Destroys: A,F
  2020                          ;
  2021  0cd8  fd7e00            RANGE:	LD	A,(IY)
  2022  0cdb  fe24              	CP	'$'
  2023  0cdd  d8                	RET	C
  2024  0cde  fe27              	CP	'&'+1
  2025  0ce0  3f                	CCF
  2026  0ce1  d0                	RET	NC
  2027  0ce2  fe28              	CP	'('
  2028  0ce4  c8                	RET	Z
  2029  0ce5  fe30              RANGE1:	CP	'0'
  2030  0ce7  d8                	RET	C
  2031  0ce8  fe3a              	CP	'9'+1
  2032  0cea  3f                	CCF
  2033  0ceb  d0                	RET	NC
  2034  0cec  fe40              	CP	'@'		;V2.4
  2035  0cee  c8                	RET	Z
  2036  0cef  fe41              RANGE2:	CP	'A'
  2037  0cf1  d8                	RET	C
  2038  0cf2  fe5b              	CP	'Z'+1
  2039  0cf4  3f                	CCF
  2040  0cf5  d0                	RET	NC
  2041  0cf6  fe5f              	CP	'_'
  2042  0cf8  d8                	RET	C
  2043  0cf9  fe7b              	CP	'z'+1
  2044  0cfb  3f                	CCF
  2045  0cfc  c9                	RET
  2046                          ;
  2047                          ;LEXAN - LEXICAL ANALYSIS.
  2048                          ;  Bit 0,C: 1=left, 0=right
  2049                          ;  Bit 3,C: 1=in HEX
  2050                          ;  Bit 4,C: 1=accept line number
  2051                          ;  Bit 5,C: 1=in variable, FN, PROC
  2052                          ;  Bit 6,C: 1=in REM, DATA, *
  2053                          ;  Bit 7,C: 1=in quotes
  2054                          ;   Inputs: IY addresses source string
  2055                          ;           DE addresses destination string
  2056                          ;           (must be page boundary)
  2057                          ;           C  sets initial mode
  2058                          ;  Outputs: DE, IY updated
  2059                          ;           A holds carriage return
  2060                          ;
  2061  0cfd  12                LEXAN1:	LD	(DE),A		;TRANSFER TO BUFFER
  2062  0cfe  13                	INC	DE		;INCREMENT POINTERS
  2063  0cff  fd23              	INC	IY
  2064  0d01  7b                LEXAN2:	LD	A,E		;MAIN ENTRY
  2065  0d02  fefc              	CP	252		;TEST LENGTH
  2066  0d04  3e13              	LD	A,19
  2067  0d06  d22d08            	JP	NC,ERROR	;'String too long'
  2068  0d09  fd7e00            	LD	A,(IY)
  2069  0d0c  fe0d              	CP	CR
  2070  0d0e  c8                	RET	Z		;END OF LINE
  2071  0d0f  cde50c            	CALL	RANGE1
  2072  0d12  3004              	JR	NC,LEXAN3
  2073  0d14  cba9              	RES	5,C		;NOT IN VARIABLE
  2074  0d16  cb99              	RES	3,C		;NOT IN HEX
  2075  0d18  fe20              LEXAN3:	CP	' '
  2076  0d1a  28e1              	JR	Z,LEXAN1	;PASS SPACES
  2077  0d1c  fe2c              	CP	','
  2078  0d1e  28dd              	JR	Z,LEXAN1	;PASS COMMAS
  2079  0d20  fe47              	CP	'G'
  2080  0d22  3802              	JR	C,LEXAN4
  2081  0d24  cb99              	RES	3,C		;NOT IN HEX
  2082  0d26  fe22              LEXAN4:	CP	'"'
  2083  0d28  2005              	JR	NZ,LEXAN5
  2084  0d2a  cb11              	RL	C
  2085  0d2c  3f                	CCF			;TOGGLE C7
  2086  0d2d  cb19              	RR	C
  2087  0d2f  cb61              LEXAN5:	BIT	4,C
  2088  0d31  2810              	JR	Z,LEXAN6
  2089  0d33  cba1              	RES	4,C
  2090  0d35  c5                	PUSH	BC
  2091  0d36  d5                	PUSH	DE
  2092  0d37  cd730c            	CALL	LINNUM		;GET LINE NUMBER
  2093  0d3a  d1                	POP	DE
  2094  0d3b  c1                	POP	BC
  2095  0d3c  7c                	LD	A,H
  2096  0d3d  b5                	OR	L
  2097  0d3e  c4a80d            	CALL	NZ,ENCODE	;ENCODE LINE NUMBER
  2098  0d41  18be              	JR	LEXAN2		;CONTINUE
  2099                          ;
  2100  0d43  0d                LEXAN6:	DEC	C
  2101  0d44  2809              	JR	Z,LEXAN7	;C=1 (LEFT)
  2102  0d46  0c                	INC	C
  2103  0d47  20b4              	JR	NZ,LEXAN1
  2104  0d49  b7                	OR	A
  2105  0d4a  f48c08            	CALL	P,LEX		;TOKENISE IF POSS.
  2106  0d4d  1816              	JR	LEXAN8
  2107                          ;
  2108  0d4f  fe2a              LEXAN7:	CP	'*'
  2109  0d51  2816              	JR	Z,LEXAN9
  2110  0d53  b7                	OR	A
  2111  0d54  f48c08            	CALL	P,LEX		;TOKENISE IF POSS.
  2112  0d57  fedc              	CP	TDATA
  2113  0d59  280e              	JR	Z,LEXAN9
  2114  0d5b  fe8f              	CP	TOKLO
  2115  0d5d  3806              	JR	C,LEXAN8
  2116  0d5f  fe94              	CP	TOKHI+1
  2117  0d61  3002              	JR	NC,LEXAN8
  2118  0d63  c640              	ADD	A,OFFSET	;LEFT VERSION
  2119  0d65  fef4              LEXAN8:	CP	TREM
  2120  0d67  2002              	JR	NZ,LEXANA
  2121  0d69  cbf1              LEXAN9:	SET	6,C		;QUIT TOKENISING
  2122  0d6b  fea4              LEXANA:	CP	TFN
  2123  0d6d  2809              	JR	Z,LEXANB
  2124  0d6f  fef2              	CP	TPROC
  2125  0d71  2805              	JR	Z,LEXANB
  2126  0d73  cdef0c            	CALL	RANGE2
  2127  0d76  3802              	JR	C,LEXANC
  2128  0d78  cbe9              LEXANB:	SET	5,C		;IN VARIABLE/FN/PROC
  2129  0d7a  fe26              LEXANC:	CP	'&'
  2130  0d7c  2002              	JR	NZ,LEXAND
  2131  0d7e  cbd9              	SET	3,C		;IN HEX
  2132  0d80  219f0d            LEXAND:	LD	HL,LIST1
  2133  0d83  c5                	PUSH	BC
  2134  0d84  010600            	LD	BC,LIST1L
  2135  0d87  edb1              	CPIR
  2136  0d89  c1                	POP	BC
  2137  0d8a  2002              	JR	NZ,LEXANE
  2138  0d8c  cbe1              	SET	4,C		;ACCEPT LINE NUMBER
  2139  0d8e  21a30d            LEXANE:	LD	HL,LIST2
  2140  0d91  c5                	PUSH	BC
  2141  0d92  010500            	LD	BC,LIST2L
  2142  0d95  edb1              	CPIR
  2143  0d97  c1                	POP	BC
  2144  0d98  2002              	JR	NZ,LEXANF
  2145  0d9a  cbc1              	SET	0,C		;ENTER LEFT MODE
  2146  0d9c  c3fd0c            LEXANF:	JP	LEXAN1
  2147                          ;
  2148  0d9f  e5                LIST1:	DEFB	TGOTO
  2149  0da0  e4                	DEFB	TGOSUB
  2150  0da1  f7                	DEFB	TRESTORE
  2151  0da2  fc                	DEFB	TTRACE
  2152  0da3  8c                LIST2:	DEFB	TTHEN
  2153  0da4  8b                	DEFB	TELSE
  2154                          LIST1L	EQU	$-LIST1
  2155  0da5  f5                	DEFB	TREPEAT
  2156  0da6  85                	DEFB	TERROR
  2157  0da7  3a                	DEFB	':'
  2158                          LIST2L	EQU	$-LIST2
  2159                          ;
  2160                          ;ENCODE - ENCODE LINE NUMBER INTO PSEUDO-BINARY FORM.
  2161                          ;   Inputs: HL=line number, DE=string pointer
  2162                          ;  Outputs: DE updated, BIT 4,C set.
  2163                          ; Destroys: A,B,C,D,E,H,L,F
  2164                          ;
  2165  0da8  cbe1              ENCODE:	SET	4,C
  2166  0daa  eb                	EX	DE,HL
  2167  0dab  368d              	LD	(HL),TLINO
  2168  0dad  23                	INC	HL
  2169  0dae  7a                	LD	A,D
  2170  0daf  e6c0              	AND	0C0H
  2171  0db1  0f                	RRCA
  2172  0db2  0f                	RRCA
  2173  0db3  47                	LD	B,A
  2174  0db4  7b                	LD	A,E
  2175  0db5  e6c0              	AND	0C0H
  2176  0db7  b0                	OR	B
  2177  0db8  0f                	RRCA
  2178  0db9  0f                	RRCA
  2179  0dba  ee54              	XOR	01010100B
  2180  0dbc  77                	LD	(HL),A
  2181  0dbd  23                	INC	HL
  2182  0dbe  7b                	LD	A,E
  2183  0dbf  e63f              	AND	3FH
  2184  0dc1  f640              	OR	'@'
  2185  0dc3  77                	LD	(HL),A
  2186  0dc4  23                	INC	HL
  2187  0dc5  7a                	LD	A,D
  2188  0dc6  e63f              	AND	3FH
  2189  0dc8  f640              	OR	'@'
  2190  0dca  77                	LD	(HL),A
  2191  0dcb  23                	INC	HL
  2192  0dcc  eb                	EX	DE,HL
  2193  0dcd  c9                	RET
  2194                          ;
  2195                          ;TEXT - OUTPUT MESSAGE.
  2196                          ;   Inputs: HL addresses text (terminated by nul)
  2197                          ;  Outputs: HL addresses character following nul.
  2198                          ; Destroys: A,H,L,F
  2199                          ;
  2200  0dce  2a0000            REPORT:	LD	HL,(ERRTXT)
  2201  0dd1  7e                TEXT:	LD	A,(HL)
  2202  0dd2  23                	INC	HL
  2203  0dd3  b7                	OR	A
  2204  0dd4  c8                	RET	Z
  2205  0dd5  fe0a              	CP	LF
  2206  0dd7  2805              	JR	Z,TEXTLF	;Token for TINT
  2207  0dd9  cd040a            	CALL	OUT
  2208  0ddc  18f3              	JR	TEXT
  2209                          ;
  2210  0dde  cdeb09            TEXTLF:	CALL	OUTCHR
  2211  0de1  18ee              	JR	TEXT
  2212                          ;
  2213                          ;TELL - OUTPUT MESSAGE.
  2214                          ;   Inputs: Text follows subroutine call (term=nul)
  2215                          ; Destroys: A,F
  2216                          ;
  2217  0de3  e3                TELL:	EX	(SP),HL		;GET RETURN ADDRESS
  2218  0de4  cdd10d            	CALL	TEXT
  2219  0de7  e3                	EX	(SP),HL
  2220  0de8  c9                	RET
  2221                          ;
  2222                          ; NLIST - Check for end of list
  2223                          ;
  2224  0de9  cdf40d            NLIST:	CALL	NXT
  2225  0dec  fe2c              	CP	','		;ANOTHER VARIABLE?
  2226  0dee  280a              	JR	Z,NXT1
  2227  0df0  c1                	POP	BC		;DITCH RETURN ADDRESS
  2228  0df1  c30000            	JP	XEQ
  2229                          ;
  2230  0df4  fd7e00            NXT:	LD	A,(IY)
  2231  0df7  fe20              	CP	' '
  2232  0df9  c0                	RET	NZ
  2233  0dfa  fd23              NXT1:	INC	IY
  2234  0dfc  18f6              	JR	NXT
  2235                          ;
  2236                          	; END START
  2237                          
