BMOS.asm:
     1                          ; BMOS.Z80 - BeanZee Machine Operating System
     2                          ;
     3                          ; OS interface for BBC BASIC Z80 on BeanZee hardware.
     4                          ; Console I/O via UM245R USB serial (PORT 0 = status, PORT 1 = data).
     5                          ;
     6                          ; cf. CMOS.Z80 (CP/M MOS), AMOS.Z80 (Acorn MOS)
     7                          ;
     8                              PUBLIC OSINIT
     9                              PUBLIC OSRDCH
    10                              PUBLIC OSWRCH
    11                              PUBLIC OSKEY
    12                              PUBLIC OSLINE
    13                              PUBLIC PROMPT
    14                              PUBLIC OSSAVE
    15                              PUBLIC OSLOAD
    16                              PUBLIC OSOPEN
    17                              PUBLIC OSSHUT
    18                              PUBLIC OSBGET
    19                              PUBLIC OSBPUT
    20                              PUBLIC OSSTAT
    21                              PUBLIC GETEXT
    22                              PUBLIC GETPTR
    23                              PUBLIC PUTPTR
    24                              PUBLIC RESET
    25                              PUBLIC BYE
    26                              PUBLIC TRAP
    27                              PUBLIC LTRAP
    28                              PUBLIC OSCLI
    29                              PUBLIC OSCALL
    30                          ;
    31                              EXTERN ESCAPE       ; MAIN.Z80 - escape handler
    32                              EXTERN EXTERR       ; MAIN.Z80 - external error
    33                              EXTERN CRLF        ; MAIN.Z80 - output CR+LF
    34                              EXTERN VERMSG      ; MAIN.Z80 - version message
    35                          ;
    36                              EXTERN ACCS         ; DATA.Z80 - string accumulator
    37                              EXTERN USER         ; DATA.Z80 - end of data segment (PAGE)
    38                          ;
    39                          ; UM245R port definitions
    40                          ;
    41                          USB_CTRL    EQU 0       ; Status port
    42                          USB_DATA    EQU 1       ; Data port
    43                          ;
    44                          ; USB_CTRL status bits (active low):
    45                          ;   Bit 0: /TXE - transmit buffer empty (0 = ready to send)
    46                          ;   Bit 1: /RXF - receive data available (0 = data ready)
    47                          ;
    48                          ; Character constants
    49                          ;
    50                          CR          EQU 0DH
    51                          LF          EQU 0AH
    52                          ESC         EQU 1BH
    53                          BS          EQU 08H
    54                          DEL         EQU 7FH
    55                          ;
    56                          ;
    57                          ; ---- OS Initialisation ----
    58                          ;
    59                          ;OSINIT - Initialise hardware and return memory layout.
    60                          ;   Outputs: DE = initial value of HIMEM (top of RAM)
    61                          ;            HL = initial value of PAGE (user program)
    62                          ;   Destroys: A,B,C,D,E,H,L,F
    63                          ;
    64                          OSINIT:
    65  0000  af                    XOR A
    66  0001  0602                  LD B,INILEN
    67  0003  213301                LD HL,_FLAGS
    68                          CLRTAB:
    69  0006  77                    LD (HL),A           ; Clear local state
    70  0007  23                    INC HL
    71  0008  10fc                  DJNZ CLRTAB
    72  000a  210000                LD HL,ACCS
    73  000d  360d                  LD (HL),CR          ; No auto-run file
    74  000f  1100ff                LD DE,0FF00H        ; HIMEM - top of RAM with margin
    75  0012  210000                LD HL,USER          ; PAGE  - start of user program area
    76  0015  c9                    RET
    77                          ;
    78                          ;
    79                          ; ---- Console Output ----
    80                          ;
    81                          ;OSWRCH - Write a character to console output.
    82                          ;   Inputs: A = character.
    83                          ;   Destroys: Nothing
    84                          ;
    85                          OSWRCH:
    86  0016  f5                    PUSH AF
    87  0017  c5                    PUSH BC
    88  0018  47                    LD B,A              ; Save character
    89                          _OSWRCH_WAIT:
    90  0019  db00                  IN A,(USB_CTRL)
    91  001b  cb47                  BIT 0,A             ; /TXE: 0 = ready to send
    92  001d  20fa                  JR NZ,_OSWRCH_WAIT
    93  001f  78                    LD A,B              ; Restore character
    94  0020  d301                  OUT (USB_DATA),A
    95  0022  c1                    POP BC
    96  0023  f1                    POP AF
    97  0024  c9                    RET
    98                          ;
    99                          ;PROMPT - Output the command prompt.
   100                          ;   Destroys: A,F
   101                          ;
   102                          PROMPT:
   103  0025  3e3e                  LD A,'>'
   104  0027  c31600                JP OSWRCH
   105                          ;
   106                          ;
   107                          ; ---- Console Input ----
   108                          ;
   109                          ;OSRDCH - Read from the current input stream (keyboard).
   110                          ;   Outputs: A = character
   111                          ;   Destroys: A,F
   112                          ;
   113                          OSRDCH:
   114  002a  3a3401                LD A,(_INKEY)       ; Check for buffered key
   115  002d  b7                    OR A
   116  002e  2808                  JR Z,_OSRDCH_POLL
   117  0030  e5                    PUSH HL
   118  0031  213401                LD HL,_INKEY
   119  0034  3600                  LD (HL),0           ; Clear buffer
   120  0036  e1                    POP HL
   121  0037  c9                    RET
   122                          _OSRDCH_POLL:
   123  0038  db00                  IN A,(USB_CTRL)
   124  003a  cb4f                  BIT 1,A             ; /RXF: 0 = data ready
   125  003c  20fa                  JR NZ,_OSRDCH_POLL  ; No data, keep waiting
   126  003e  db01                  IN A,(USB_DATA)
   127  0040  c9                    RET
   128                          ;
   129                          ;OSKEY - Read key with time-limit, test for ESCape.
   130                          ;   Inputs: HL = time limit (centiseconds)
   131                          ;   Outputs: Carry reset if time-out.
   132                          ;            If carry set, A = character.
   133                          ;   Destroys: A,H,L,F
   134                          ;
   135                          OSKEY:
   136  0041  3a3401                LD A,(_INKEY)       ; Check buffered key
   137  0044  e5                    PUSH HL
   138  0045  213401                LD HL,_INKEY
   139  0048  3600                  LD (HL),0
   140  004a  e1                    POP HL
   141  004b  b7                    OR A
   142  004c  37                    SCF
   143  004d  c0                    RET NZ              ; Return buffered key
   144  004e  d5                    PUSH DE
   145                          _OSKEY_LOOP:
   146  004f  db00                  IN A,(USB_CTRL)
   147  0051  cb4f                  BIT 1,A             ; /RXF: 0 = data ready
   148  0053  2808                  JR Z,_OSKEY_GOT
   149  0055  2b                    DEC HL              ; Decrement timeout
   150  0056  7c                    LD A,H
   151  0057  b5                    OR L
   152  0058  20f5                  JR NZ,_OSKEY_LOOP
   153  005a  d1                    POP DE
   154  005b  b7                    OR A                ; Clear carry = timeout
   155  005c  c9                    RET
   156                          _OSKEY_GOT:
   157  005d  db01                  IN A,(USB_DATA)
   158  005f  d1                    POP DE
   159  0060  fe1b                  CP ESC
   160  0062  37                    SCF
   161  0063  c0                    RET NZ              ; Non-ESC key, carry set
   162  0064  e5                    PUSH HL             ; ESC pressed
   163  0065  213301                LD HL,_FLAGS
   164  0068  cb76                  BIT 6,(HL)          ; Escape disabled?
   165  006a  2002                  JR NZ,_OSKEY_ESCDIS
   166  006c  cbfe                  SET 7,(HL)          ; Set escape flag
   167                          _OSKEY_ESCDIS:
   168  006e  e1                    POP HL
   169  006f  c9                    RET
   170                          ;
   171                          ;OSLINE - Read a complete line, terminated by CR.
   172                          ;   Inputs: HL addresses destination buffer.
   173                          ;           (L=0)
   174                          ;   Outputs: Buffer filled, terminated by CR.
   175                          ;            A=0.
   176                          ;   Destroys: A,B,C,D,E,H,L,F
   177                          ;
   178                          OSLINE:
   179                          _OSLINE_LOOP:
   180  0070  cd2a00                CALL OSRDCH
   181  0073  fe0d                  CP CR
   182  0075  2834                  JR Z,_OSLINE_DONE
   183  0077  fe08                  CP BS
   184  0079  281a                  JR Z,_OSLINE_BS
   185  007b  fe7f                  CP DEL
   186  007d  2816                  JR Z,_OSLINE_BS
   187  007f  fe1b                  CP ESC
   188  0081  2830                  JR Z,_OSLINE_ESC
   189  0083  fe20                  CP ' '
   190  0085  38e9                  JR C,_OSLINE_LOOP   ; Ignore control characters
   191  0087  47                    LD B,A              ; Save character
   192  0088  7d                    LD A,L
   193  0089  fefe                  CP 254              ; Buffer full?
   194  008b  78                    LD A,B              ; Restore character
   195  008c  30e2                  JR NC,_OSLINE_LOOP  ; Full, ignore
   196  008e  77                    LD (HL),A           ; Store character
   197  008f  2c                    INC L
   198  0090  cd1600                CALL OSWRCH         ; Echo
   199  0093  18db                  JR _OSLINE_LOOP
   200                          ;
   201                          _OSLINE_BS:
   202  0095  7d                    LD A,L
   203  0096  b7                    OR A
   204  0097  28d7                  JR Z,_OSLINE_LOOP   ; At start, nothing to delete
   205  0099  2d                    DEC L
   206  009a  3e08                  LD A,BS
   207  009c  cd1600                CALL OSWRCH
   208  009f  3e20                  LD A,' '
   209  00a1  cd1600                CALL OSWRCH
   210  00a4  3e08                  LD A,BS
   211  00a6  cd1600                CALL OSWRCH
   212  00a9  18c5                  JR _OSLINE_LOOP
   213                          ;
   214                          _OSLINE_DONE:
   215  00ab  360d                  LD (HL),CR          ; Terminate line
   216  00ad  cd0000                CALL CRLF
   217  00b0  af                    XOR A               ; A=0
   218  00b1  6f                    LD L,A              ; L=0 (point to buffer start)
   219  00b2  c9                    RET
   220                          ;
   221                          _OSLINE_ESC:
   222  00b3  360d                  LD (HL),CR          ; Terminate line
   223  00b5  cd0000                CALL CRLF
   224  00b8  213301                LD HL,_FLAGS
   225  00bb  cbbe                  RES 7,(HL)          ; Clear escape flag
   226  00bd  c30000                JP ESCAPE           ; Abort
   227                          ;
   228                          ;
   229                          ; ---- Trap Handlers ----
   230                          ;
   231                          ;TRAP - Test ESCAPE flag and abort if set;
   232                          ;       every 20th call, poll keyboard for ESCape.
   233                          ;   Destroys: A,H,L,F
   234                          ;
   235                          TRAP:
   236  00c0  213201                LD HL,_TRPCNT
   237  00c3  35                    DEC (HL)
   238  00c4  ccd400                CALL Z,_TEST
   239                          LTRAP:
   240  00c7  3a3301                LD A,(_FLAGS)
   241  00ca  b7                    OR A
   242  00cb  f0                    RET P               ; Bit 7 clear, no escape
   243  00cc  213301                LD HL,_FLAGS        ; Escape pending
   244  00cf  cbbe                  RES 7,(HL)          ; Acknowledge
   245  00d1  c30000                JP ESCAPE           ; Abort
   246                          ;
   247                          ;_TEST - Non-blocking keyboard poll for ESCape.
   248                          ;   Destroys: A,F
   249                          ;
   250                          _TEST:
   251  00d4  3614                  LD (HL),20          ; Reset trap counter
   252  00d6  db00                  IN A,(USB_CTRL)
   253  00d8  cb4f                  BIT 1,A             ; /RXF: 0 = data ready
   254  00da  c0                    RET NZ              ; No data
   255  00db  db01                  IN A,(USB_DATA)     ; Read character
   256  00dd  fe1b                  CP ESC
   257  00df  2804                  JR Z,_TEST_ESC
   258  00e1  323401                LD (_INKEY),A       ; Buffer non-ESC key
   259  00e4  c9                    RET
   260                          _TEST_ESC:
   261  00e5  213301                LD HL,_FLAGS
   262  00e8  cb76                  BIT 6,(HL)          ; Escape disabled?
   263  00ea  c0                    RET NZ
   264  00eb  cbfe                  SET 7,(HL)          ; Set escape flag
   265  00ed  c9                    RET
   266                          ;
   267                          ;
   268                          ; ---- System Control ----
   269                          ;
   270                          ;RESET - Reset system.
   271                          ;
   272                          RESET:
   273  00ee  c7                    RST 0               ; Jump to address 0x0000
   274                          ;
   275                          ;BYE - Exit to OS (no OS, so restart).
   276                          ;
   277                          BYE:
   278  00ef  c7                    RST 0               ; Jump to address 0x0000
   279                          ;
   280                          ;OSCLI - Process an "operating system" command.
   281                          ;   Inputs: HL addresses command string (after '*')
   282                          ;
   283                          OSCLI:
   284                          _OSCLI_SKIP:
   285  00f0  7e                    LD A,(HL)
   286  00f1  fe20                  CP ' '
   287  00f3  2003                  JR NZ,_OSCLI_CHECK
   288  00f5  23                    INC HL
   289  00f6  18f8                  JR _OSCLI_SKIP
   290                          _OSCLI_CHECK:
   291  00f8  fe0d                  CP CR
   292  00fa  c8                    RET Z               ; Empty command
   293  00fb  fe7c                  CP '|'
   294  00fd  c8                    RET Z               ; Comment
   295  00fe  3efe                  LD A,254
   296  0100  cd0000                CALL EXTERR
   297  0103  42616420636f6d6d      DEFM "Bad command"
              616e64            
   298  010e  00                    DEFB 0
   299                          ;
   300                          ;OSCALL - Call OS function (not used on BeanZee).
   301                          ;
   302                          OSCALL:
   303  010f  c9                    RET
   304                          ;
   305                          ;
   306                          ; ---- File Operations (stubs) ----
   307                          ;
   308                          ;OSSAVE - Save an area of memory to a file.
   309                          ;   Inputs: HL addresses filename (term CR)
   310                          ;           DE = start address of data to save
   311                          ;           BC = length of data to save (bytes)
   312                          ;   Destroys: A,B,C,D,E,H,L,F
   313                          ;
   314                          OSSAVE:
   315                          OSLOAD:
   316  0110  af                    XOR A
   317  0111  cd0000                CALL EXTERR
   318  0114  536f727279            DEFM "Sorry"
   319  0119  00                    DEFB 0
   320                          ;
   321                          ;OSOPEN - Open a file for reading or writing.
   322                          ;   Inputs: HL addresses filename (term CR)
   323                          ;           Carry set for OPENIN, cleared for OPENOUT.
   324                          ;   Outputs: A = file channel (0 = cannot open)
   325                          ;   Destroys: A,B,C,D,E,H,L,F
   326                          ;
   327                          OSOPEN:
   328  011a  af                    XOR A               ; A=0, cannot open
   329  011b  c9                    RET
   330                          ;
   331                          ;OSSHUT - Close disk file(s).
   332                          ;   Inputs: E = file channel
   333                          ;           If E=0 all files are closed.
   334                          ;   Destroys: A,B,C,D,E,H,L,F
   335                          ;
   336                          OSSHUT:
   337  011c  c9                    RET
   338                          ;
   339                          ;OSBGET - Read a byte from a random disk file.
   340                          ;   Inputs: E = file channel
   341                          ;   Outputs: A = byte read
   342                          ;            Carry set if last byte of file.
   343                          ;   Destroys: A,B,C,F
   344                          ;
   345                          OSBGET:
   346  011d  af                    XOR A               ; A=0
   347  011e  37                    SCF                 ; Carry set = EOF
   348  011f  c9                    RET
   349                          ;
   350                          ;OSBPUT - Write a byte to a random disk file.
   351                          ;   Inputs: E = file channel
   352                          ;           A = byte to write
   353                          ;   Destroys: A,B,C,F
   354                          ;
   355                          OSBPUT:
   356  0120  c9                    RET
   357                          ;
   358                          ;OSSTAT - Read file status.
   359                          ;   Inputs: E = file channel
   360                          ;   Outputs: Z flag set = EOF
   361                          ;   Destroys: A,D,E,H,L,F
   362                          ;
   363                          OSSTAT:
   364  0121  af                    XOR A               ; Z set = EOF
   365  0122  c9                    RET
   366                          ;
   367                          ;GETPTR - Return file pointer.
   368                          ;   Inputs: E = file channel
   369                          ;   Outputs: DEHL = pointer (0-&7FFFFF)
   370                          ;   Destroys: A,B,C,D,E,H,L,F
   371                          ;
   372                          GETPTR:
   373  0123  110000                LD DE,0
   374  0126  210000                LD HL,0
   375  0129  c9                    RET
   376                          ;
   377                          ;PUTPTR - Update file pointer.
   378                          ;   Inputs: A = file channel
   379                          ;           DEHL = new pointer
   380                          ;   Destroys: A,B,C,D,E,H,L,F
   381                          ;
   382                          PUTPTR:
   383  012a  c9                    RET
   384                          ;
   385                          ;GETEXT - Find file size.
   386                          ;   Inputs: E = file channel
   387                          ;   Outputs: DEHL = file size
   388                          ;   Destroys: A,B,C,D,E,H,L,F
   389                          ;
   390                          GETEXT:
   391  012b  110000                LD DE,0
   392  012e  210000                LD HL,0
   393  0131  c9                    RET
   394                          ;
   395                          ;
   396                          ; ---- Local State ----
   397                          ;
   398                          ; Flags byte:
   399                          ;   Bit 6: Escape disabled
   400                          ;   Bit 7: Escape flag (pending escape)
   401                          ;
   402                          _TRPCNT:
   403  0132  14                    DEFB 20
   404                          _FLAGS:
   405  0133  00                    DEFB 0
   406                          _INKEY:
   407  0134  00                    DEFB 0
   408                          INILEN  EQU $-_FLAGS
   409                          ;
   410                          FIN:
   411                          
