DIST.asm:
     1                          	; TITLE BBCDIST.Z80 (C) R.T.RUSSELL 1982-2024
     2                          	INCLUDE "constants.inc"
constants.inc:
     1                          ; BBC BASIC Z80 - Shared Constants
     2                          ; Extracted from source modules to avoid duplicate definitions
     3                          
     4                          ; ASCII control characters
     5                          LF      EQU     0AH
     6                          CR      EQU     0DH
     7                          ; Note: ESC conflicts with label in AMOS.Z80, not included
     8                          BEL     EQU     7
     9                          BS      EQU     8
    10                          HT      EQU     9
    11                          VT      EQU     0BH
    12                          ; Note: DEL conflicts with label in MAIN.Z80, not included
    13                          
    14                          ; CP/M system addresses
    15                          ; Note: BDOS conflicts with label in DIST.Z80, not included
    16                          FCB     EQU     5CH
    17                          DSKBUF  EQU     80H
    18                          FCBSIZ  EQU     128+36+2
    19                          
    20                          ; Token values
    21                          TAND    EQU     80H
    22                          TOR     EQU     84H
    23                          TBY     EQU     0FH
    24                          TERROR  EQU     85H
    25                          TLINE   EQU     86H
    26                          TOFF    EQU     87H
    27                          TSTEP   EQU     88H
    28                          TSPC    EQU     89H
    29                          TTAB    EQU     8AH
    30                          TELSE   EQU     8BH
    31                          TTHEN   EQU     8CH
    32                          TLINO   EQU     8DH
    33                          TTO     EQU     0B8H
    34                          TCASE   EQU     0C8H
    35                          TWHILE  EQU     0C7H
    36                          TWHEN   EQU     0C9H
    37                          TOF     EQU     0CAH
    38                          TENDCASE EQU    0CBH
    39                          TOTHERWISE EQU  0CCH
    40                          TENDIF  EQU     0CDH
    41                          TENDWHILE EQU   0CEH
    42                          TCALL   EQU     0D6H
    43                          TDATA   EQU     0DCH
    44                          TDEF    EQU     0DDH
    45                          TDIM    EQU     0DEH
    46                          TEND    EQU     0E0H
    47                          TFOR    EQU     0E3H
    48                          TGOSUB  EQU     0E4H
    49                          TGOTO   EQU     0E5H
    50                          TIF     EQU     0E7H
    51                          TLOCAL  EQU     0EAH
    52                          TMODE   EQU     0EBH
    53                          TNEXT   EQU     0EDH
    54                          TON     EQU     0EEH
    55                          TPROC   EQU     0F2H
    56                          TREM    EQU     0F4H
    57                          TREPEAT EQU     0F5H
    58                          TREPORT EQU     0F6H
    59                          TRESTORE EQU    0F7H
    60                          TRETURN EQU     0F8H
    61                          TSTOP   EQU     0FAH
    62                          TTRACE  EQU     0FCH
    63                          TUNTIL  EQU     0FDH
    64                          TWIDTH  EQU     0FEH
    65                          TEXIT   EQU     10H
    66                          
    67                          ; Error codes
    68                          BADOP   EQU     1
    69                          DIVBY0  EQU     18
    70                          ; Note: TOOBIG conflicts with label in MAIN.Z80, not included
    71                          NGROOT  EQU     21
    72                          LOGRNG  EQU     22
    73                          ACLOST  EQU     23
    74                          EXPRNG  EQU     24
    75                          
DIST.asm:
     3                          ;
     4                          ;BBC BASIC (Z80) - CP/M VERSION 2.20 & 3.00
     5                          ;(C) COPYRIGHT R.T.RUSSELL, 1982-2024.
     6                          ;ALL RIGHTS RESERVED.
     7                          ;
     8                          ;THIS PROGRAM ALLOWS THE USER TO ADAPT BBC BASIC TO THE
     9                          ;PARTICULAR CHARACTERISTICS OF HIS SYSTEM HARDWARE ETC.
    10                          ;
    11                          ;THE PROGRAM RESIDES AT 100H FOR EASE OF LOADING.
    12                          ;*** IT MUST NOT EXCEED 256 BYTES IN TOTAL LENGTH ***
    13                          ;
    14                          ;PLEASE NOTE THAT A Z80 PROCESSOR AND CP/M VERSION 2.2
    15                          ;OR LATER ARE REQUIRED.
    16                          ;
    17                          ;R.T.RUSSELL, 11-03-1984, 03-05-1989, 12-05-2024
    18                          ;
    19                          CPM	EQU	5
    20                          COLD	EQU	200H
    21                          ;
    22                          	PUBLIC CLRSCN
    23                          	PUBLIC PUTCSR
    24                          	PUBLIC GETCSR
    25                          	PUBLIC PUTIME
    26                          	PUBLIC GETIME
    27                          	PUBLIC GETKEY
    28                          	PUBLIC BYE
    29                          ;
    30                          	; ASEG
    31                          	; ORG 100H
    32                          ;
    33                          ;JUMP TABLE - BASIC makes calls to hardware-dependent
    34                          ;features via this table:
    35                          ;
    36  0000  c32400            	JP	INIT
    37  0003  c3c700            CLRSCN:	JP	CLS		;CLEAR SCREEN
    38  0006  c3c800            PUTCSR:	JP	PCSR		;SET CURSOR POSN.
    39  0009  c3c900            GETCSR:	JP	GCSR		;READ CURSOR POSN.
    40  000c  c36800            PUTIME:	JP	PTIME		;SET ELAPSED TIME
    41  000f  c35500            GETIME:	JP	GTIME		;READ ELAPSED TIME
    42  0012  c3a700            GETKEY:	JP	INKEY		;READ KEY (TIME LIMIT)
    43  0015  c35400            BYE:	JP	REBOOT		;RETURN TO CP/M
    44                          ;
    45                          ;BDOS	- Save the IX and IY registers and before performing a
    46                          ;	  CP/M function call.
    47                          ;
    48  0018  dde5              BDOS:	PUSH	IX
    49  001a  fde5              	PUSH	IY
    50  001c  cd0500            	CALL	CPM
    51  001f  fde1              	POP	IY
    52  0021  dde1              	POP	IX
    53  0023  c9                	RET
    54                          ;
    55                          ;INIT	- Perform hardware initialisation (if any).
    56                          ;
    57  0024  3e02              INIT:	LD	A,2
    58  0026  3c                	INC	A
    59  0027  113f00            	LD	DE,NOTZ80
    60  002a  ea3900            	JP	PE,FAIL
    61  002d  0e0c              	LD	C,12
    62  002f  cd1800            	CALL	BDOS
    63  0032  b7                	OR	A
    64  0033  114900            	LD	DE,NOTV2
    65  0036  c20002            	JP	NZ,COLD
    66  0039  0e09              FAIL:	LD	C,9
    67  003b  cd1800            	CALL	BDOS
    68  003e  c7                	RST	0
    69                          ;
    70  003f  4e6f742061205a38  NOTZ80:	DEFB "Not a Z80$"
              3024              
    71  0049  4e6f742043502f4d  NOTV2:	DEFB "Not CP/M 2$"
              203224            
    72                          ;
    73                          ;REBOOT	- Switch off interrupts and return to CP/M
    74                          ;
    75  0054  c7                REBOOT:	RST	0
    76                          ;
    77                          ;GTIME	- Read elapsed-time clock.
    78                          ;  	  Outputs: DEHL = elapsed time (centiseconds)
    79                          ; 	  Destroys: A,D,E,H,L,F
    80                          ;
    81  0055  c5                GTIME:	PUSH	BC
    82  0056  cd8100            	CALL	TICKS
    83  0059  ed4bf000          	LD	BC,(OFFLO)
    84  005d  09                	ADD	HL,BC
    85  005e  eb                	EX	DE,HL
    86  005f  ed4bf200          	LD	BC,(OFFHI)
    87  0063  ed4a              	ADC	HL,BC
    88  0065  eb                	EX	DE,HL
    89  0066  c1                	POP	BC
    90  0067  c9                	RET
    91                          ;
    92                          ;PTIME	- Load elapsed-time clock.
    93                          ;   	  Inputs: DEHL = time to load (centiseconds)
    94                          ; 	  Destroys: A,D,E,H,L,F
    95                          ;
    96  0068  c5                PTIME:	PUSH	BC
    97  0069  d5                	PUSH	DE
    98  006a  e5                	PUSH	HL
    99  006b  cd8100            	CALL	TICKS
   100  006e  44                	LD	B,H
   101  006f  4d                	LD	C,L
   102  0070  e1                	POP	HL
   103  0071  b7                	OR	A
   104  0072  ed42              	SBC	HL,BC
   105  0074  22f000            	LD	(OFFLO),HL
   106  0077  42                	LD	B,D
   107  0078  4b                	LD	C,E
   108  0079  e1                	POP	HL
   109  007a  ed42              	SBC	HL,BC
   110  007c  22f200            	LD	(OFFHI),HL
   111  007f  c1                	POP	BC
   112  0080  c9                	RET
   113                          ;
   114                          ; Get OS elapsed-time clock
   115                          ;  Outputs: DEHL = time (centiseconds)
   116                          ; Destroys: A,B,C,D,E,H,L,F
   117                          ;
   118  0081  0ef8              TICKS:	LD	C,248		;RunCPM-specific function call
   119  0083  cd1800            	CALL	BDOS
   120  0086  d5                	PUSH	DE
   121  0087  eb                	EX	DE,HL
   122  0088  b7                	OR	A
   123  0089  ed62              	SBC	HL,HL
   124  008b  01fbff            	LD	BC,-5
   125  008e  3e20              	LD	A,32
   126  0090  09                DIV0:	ADD	HL,BC
   127  0091  3802              	JR	C,DIV1
   128  0093  ed42              	SBC	HL,BC
   129  0095  cb13              DIV1:	RL	E
   130  0097  cb12              	RL	D
   131  0099  e3                	EX	(SP),HL
   132  009a  cb15              	RL	L
   133  009c  cb14              	RL	H
   134  009e  e3                	EX	(SP),HL
   135  009f  ed6a              	ADC	HL,HL
   136  00a1  3d                	DEC	A
   137  00a2  20ec              	JR	NZ,DIV0
   138  00a4  eb                	EX	DE,HL
   139  00a5  d1                	POP	DE
   140  00a6  c9                	RET
   141                          ;
   142                          ;INKEY	- Sample keyboard with specified wait.
   143                          ;   	  Inputs: HL = Time to wait (centiseconds)
   144                          ;  	  Outputs: Carry reset indicates time-out.
   145                          ;                  If carry set, A = character typed.
   146                          ; 	  Destroys: A,D,E,H,L,F
   147                          ;
   148  00a7  c5                INKEY:	PUSH	BC
   149  00a8  e5                	PUSH	HL
   150  00a9  cd8100            	CALL	TICKS
   151  00ac  d1                	POP	DE
   152  00ad  19                	ADD	HL,DE
   153  00ae  e5                WAIT:	PUSH	HL
   154  00af  0e06              	LD	C,6
   155  00b1  1eff              	LD	E,0FFH
   156  00b3  cd1800            	CALL	BDOS
   157  00b6  e1                	POP	HL
   158  00b7  b7                	OR	A
   159  00b8  37                	SCF
   160  00b9  200a              	JR	NZ,INKEY1
   161  00bb  e5                	PUSH	HL
   162  00bc  cd8100            	CALL	TICKS
   163  00bf  d1                	POP	DE
   164  00c0  ed52              	SBC	HL,DE
   165  00c2  eb                	EX	DE,HL
   166  00c3  38e9              	JR	C,WAIT
   167  00c5  c1                INKEY1:	POP	BC
   168  00c6  c9                	RET
   169                          ;
   170                          ;CLS	- Clear screen.
   171                          ;	  (Customise to suit your VDU)
   172                          ; 	  Destroys: A,D,E,H,L,F
   173                          ;
   174  00c7  c9                CLS:	RET
   175                          ;
   176                          ;PCSR	- Move cursor to specified position.
   177                          ;   	  Inputs: DE = horizontal position (LHS=0)
   178                          ;                 HL = vertical position (TOP=0)
   179                          ; 	  Destroys: A,D,E,H,L,F
   180                          ;
   181  00c8  c9                PCSR:	RET
   182                          ;
   183                          ;GCSR	- Return cursor coordinates.
   184                          ;   	  Outputs:  DE = X coordinate (POS)
   185                          ;                   HL = Y coordinate (VPOS)
   186                          ;  	  Destroys: A,D,E,H,L,F
   187                          ;
   188  00c9  110000            GCSR:	LD	DE,0
   189  00cc  210000            	LD	HL,0
   190  00cf  c9                	RET
   191                          ;
   192                          ;COUT - Output a character to the console
   193                          ;   Inputs: A = character
   194                          ; Destroys: A,F
   195                          ;
   196  00d0  c5                COUT:	PUSH	BC
   197  00d1  d5                	PUSH	DE
   198  00d2  e5                	PUSH	HL
   199  00d3  5f                	LD	E,A
   200  00d4  0e02              	LD	C,2
   201  00d6  cd1800            	CALL	BDOS
   202  00d9  e1                	POP	HL
   203  00da  d1                	POP	DE
   204  00db  c1                	POP	BC
   205  00dc  c9                	RET
   206                          ;
   207                          	; IF $ GT 1F0H
   208                          	; ERROR 'INSUFFICIENT SPACE'
   209                          	; ENDIF
   210                          ;
   211  00dd  0000000000000000  	DEFS 0F0H - $, 0	; Pad to offset 0xF0 (address 0x1F0 when linked at 0x100)
              0000000000000000  
              000000            
   212                          ;
   213  00f0  0000              OFFLO:	DEFW	0		;TIME OFFSET LO
   214  00f2  0000              OFFHI:	DEFW	0		;TIME OFFSET HI
   215  00f4  50                	DEFB	80		;WIDTH
   216  00f5  07                	DEFB	07H	;CURSOR UP
   217  00f6  0f                	DEFB	0FH	;CURSOR DOWN
   218  00f7  06                	DEFB	06H	;START OF LINE
   219  00f8  0e                	DEFB	0EH	;END OF LINE
   220  00f9  18                	DEFB	18H	;DELETE TO END OF LINE
   221  00fa  08                	DEFB	08H		;BACKSPACE & DELETE
   222  00fb  15                	DEFB	15H	;DEL TO START OF LINE
   223  00fc  0a                	DEFB	0AH	;CURSOR LEFT
   224  00fd  0c                	DEFB	0CH	;CURSOR RIGHT
   225  00fe  12                	DEFB	12H	;DELETE CHARACTER
   226  00ff  11                	DEFB	11H	;INS/OVR TOGGLE
   227                          ;
   228                          FIN: ; END
   229                          
